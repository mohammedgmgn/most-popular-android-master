"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.AppiumDriver = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _logger = _interopRequireDefault(require("./logger"));

var _config = require("./config");

var _appiumBaseDriver = require("appium-base-driver");

var _bluebird = _interopRequireDefault(require("bluebird"));

var _asyncLock = _interopRequireDefault(require("async-lock"));

var _utils = require("./utils");

var _semver = _interopRequireDefault(require("semver"));

const PLATFORMS = {
  FAKE: 'fake',
  ANDROID: 'android',
  IOS: 'ios',
  WINDOWS: 'windows',
  MAC: 'mac',
  TIZEN: 'tizen'
};
const AUTOMATION_NAMES = {
  APPIUM: 'Appium',
  SELENDROID: 'Selendroid',
  UIAUTOMATOR2: 'UiAutomator2',
  UIAUTOMATOR1: 'UiAutomator1',
  XCUITEST: 'XCUITest',
  YOUIENGINE: 'YouiEngine',
  ESPRESSO: 'Espresso',
  TIZEN: 'Tizen',
  FAKE: 'Fake',
  INSTRUMENTS: 'Instruments',
  WINDOWS: 'Windows',
  MAC: 'Mac'
};
const DRIVER_MAP = {
  [AUTOMATION_NAMES.SELENDROID.toLowerCase()]: {
    driverClassName: 'SelendroidDriver',
    driverPackage: 'appium-selendroid-driver'
  },
  [AUTOMATION_NAMES.UIAUTOMATOR2.toLowerCase()]: {
    driverClassName: 'AndroidUiautomator2Driver',
    driverPackage: 'appium-uiautomator2-driver'
  },
  [AUTOMATION_NAMES.XCUITEST.toLowerCase()]: {
    driverClassName: 'XCUITestDriver',
    driverPackage: 'appium-xcuitest-driver'
  },
  [AUTOMATION_NAMES.YOUIENGINE.toLowerCase()]: {
    driverClassName: 'YouiEngineDriver',
    driverPackage: 'appium-youiengine-driver'
  },
  [AUTOMATION_NAMES.FAKE.toLowerCase()]: {
    driverClassName: 'FakeDriver',
    driverPackage: 'appium-fake-driver'
  },
  [AUTOMATION_NAMES.UIAUTOMATOR1.toLowerCase()]: {
    driverClassName: 'AndroidDriver',
    driverPackage: 'appium-android-driver'
  },
  [AUTOMATION_NAMES.INSTRUMENTS.toLowerCase()]: {
    driverClassName: 'IosDriver',
    driverPackage: 'appium-ios-driver'
  },
  [AUTOMATION_NAMES.WINDOWS.toLowerCase()]: {
    driverClassName: 'WindowsDriver',
    driverPackage: 'appium-windows-driver'
  },
  [AUTOMATION_NAMES.MAC.toLowerCase()]: {
    driverClassName: 'MacDriver',
    driverPackage: 'appium-mac-driver'
  },
  [AUTOMATION_NAMES.ESPRESSO.toLowerCase()]: {
    driverClassName: 'EspressoDriver',
    driverPackage: 'appium-espresso-driver'
  },
  [AUTOMATION_NAMES.TIZEN.toLowerCase()]: {
    driverClassName: 'TizenDriver',
    driverPackage: 'appium-tizen-driver'
  }
};
const PLATFORMS_MAP = {
  [PLATFORMS.FAKE]: () => AUTOMATION_NAMES.FAKE,
  [PLATFORMS.ANDROID]: caps => {
    const platformVersion = _semver.default.valid(_semver.default.coerce(caps.platformVersion));

    _logger.default.warn(`DeprecationWarning: 'automationName' capability was not provided. ` + `Future versions of Appium will require 'automationName' capability to be set for Android sessions.`);

    _logger.default.info(`Setting automation to '${AUTOMATION_NAMES.UIAUTOMATOR1}'. `);

    if (platformVersion && _semver.default.satisfies(platformVersion, '>=6.0.0')) {
      _logger.default.warn(`Consider setting 'automationName' capability to '${AUTOMATION_NAMES.UIAUTOMATOR2}' ` + 'on Android >= 6, since UIAutomator1 framework ' + 'is not maintained anymore by the OS vendor.');
    }

    return AUTOMATION_NAMES.UIAUTOMATOR1;
  },
  [PLATFORMS.IOS]: caps => {
    const platformVersion = _semver.default.valid(_semver.default.coerce(caps.platformVersion));

    _logger.default.warn(`DeprecationWarning: 'automationName' capability was not provided. ` + `Future versions of Appium will require 'automationName' capability to be set for iOS sessions.`);

    if (platformVersion && _semver.default.satisfies(platformVersion, '>=10.0.0')) {
      _logger.default.info('Requested iOS support with version >= 10, ' + `using '${AUTOMATION_NAMES.XCUITEST}' ` + 'driver instead of UIAutomation-based driver, since the ' + 'latter is unsupported on iOS 10 and up.');

      return AUTOMATION_NAMES.XCUITEST;
    }

    return AUTOMATION_NAMES.INSTRUMENTS;
  },
  [PLATFORMS.WINDOWS]: () => AUTOMATION_NAMES.WINDOWS,
  [PLATFORMS.MAC]: () => AUTOMATION_NAMES.MAC,
  [PLATFORMS.TIZEN]: () => AUTOMATION_NAMES.TIZEN
};
const desiredCapabilityConstraints = {
  automationName: {
    presence: false,
    isString: true,
    inclusionCaseInsensitive: _lodash.default.values(AUTOMATION_NAMES)
  },
  platformName: {
    presence: true,
    isString: true,
    inclusionCaseInsensitive: _lodash.default.keys(PLATFORMS_MAP)
  }
};
const sessionsListGuard = new _asyncLock.default();
const pendingDriversGuard = new _asyncLock.default();

class AppiumDriver extends _appiumBaseDriver.BaseDriver {
  constructor(args) {
    super();
    this.desiredCapConstraints = desiredCapabilityConstraints;
    this.newCommandTimeoutMs = 0;
    this.args = Object.assign({}, args);
    this.sessions = {};
    this.pendingDrivers = {};
    (0, _config.updateBuildInfo)();
  }

  get isCommandsQueueEnabled() {
    return false;
  }

  sessionExists(sessionId) {
    const dstSession = this.sessions[sessionId];
    return dstSession && dstSession.sessionId !== null;
  }

  driverForSession(sessionId) {
    return this.sessions[sessionId];
  }

  getDriverAndVersionForCaps(caps) {
    if (!_lodash.default.isString(caps.platformName)) {
      throw new Error('You must include a platformName capability');
    }

    const platformName = caps.platformName.toLowerCase();
    let automationNameCap = caps.automationName;

    if (!_lodash.default.isString(automationNameCap)) {
      const driverSelector = PLATFORMS_MAP[platformName];

      if (driverSelector) {
        automationNameCap = driverSelector(caps);
      }
    }

    automationNameCap = automationNameCap.toLowerCase();

    try {
      const {
        driverPackage,
        driverClassName
      } = DRIVER_MAP[automationNameCap];

      const driver = require(driverPackage)[driverClassName];

      return {
        driver,
        version: this.getDriverVersion(driver.name, driverPackage)
      };
    } catch (ign) {}

    const msg = _lodash.default.isString(caps.automationName) ? `Could not find a driver for automationName '${caps.automationName}' and platformName ` + `'${caps.platformName}'.` : `Could not find a driver for platformName '${caps.platformName}'.`;
    throw new Error(`${msg} Please check your desired capabilities.`);
  }

  getDriverVersion(driverName, driverPackage) {
    const version = (0, _utils.getPackageVersion)(driverPackage);

    if (version) {
      return version;
    }

    _logger.default.warn(`Unable to get version of driver '${driverName}'`);
  }

  async getStatus() {
    return {
      build: _lodash.default.clone((0, _config.getBuildInfo)())
    };
  }

  async getSessions() {
    const sessions = await sessionsListGuard.acquire(AppiumDriver.name, () => this.sessions);
    return _lodash.default.toPairs(sessions).map(([id, driver]) => {
      return {
        id,
        capabilities: driver.caps
      };
    });
  }

  printNewSessionAnnouncement(caps, driverName, driverVersion) {
    const introString = driverVersion ? `Appium v${_config.APPIUM_VER} creating new ${driverName} (v${driverVersion}) session` : `Appium v${_config.APPIUM_VER} creating new ${driverName} session`;

    _logger.default.info(introString);

    _logger.default.info('Capabilities:');

    (0, _utils.inspectObject)(caps);
  }

  async createSession(jsonwpCaps, reqCaps, w3cCapabilities) {
    const {
      defaultCapabilities
    } = this.args;
    let protocol;
    let innerSessionId, dCaps;

    try {
      const parsedCaps = (0, _utils.parseCapsForInnerDriver)(jsonwpCaps, w3cCapabilities, this.desiredCapConstraints, defaultCapabilities);
      const {
        desiredCaps,
        processedJsonwpCapabilities,
        processedW3CCapabilities,
        error
      } = parsedCaps;
      protocol = parsedCaps.protocol;

      if (error) {
        throw error;
      }

      const {
        driver: InnerDriver,
        version: driverVersion
      } = this.getDriverAndVersionForCaps(desiredCaps);
      this.printNewSessionAnnouncement(desiredCaps, InnerDriver.name, driverVersion);

      if (this.args.sessionOverride) {
        const sessionIdsToDelete = await sessionsListGuard.acquire(AppiumDriver.name, () => _lodash.default.keys(this.sessions));

        if (sessionIdsToDelete.length) {
          _logger.default.info(`Session override is on. Deleting other ${sessionIdsToDelete.length} active session${sessionIdsToDelete.length ? '' : 's'}.`);

          try {
            await _bluebird.default.map(sessionIdsToDelete, id => this.deleteSession(id));
          } catch (ign) {}
        }
      }

      let runningDriversData, otherPendingDriversData;
      const d = new InnerDriver(this.args);

      if (this.args.relaxedSecurityEnabled) {
        _logger.default.info(`Applying relaxed security to '${InnerDriver.name}' as per server command line argument`);

        d.relaxedSecurityEnabled = true;
      }

      d.server = this.server;

      try {
        runningDriversData = await this.curSessionDataForDriver(InnerDriver);
      } catch (e) {
        throw new _appiumBaseDriver.errors.SessionNotCreatedError(e.message);
      }

      await pendingDriversGuard.acquire(AppiumDriver.name, () => {
        this.pendingDrivers[InnerDriver.name] = this.pendingDrivers[InnerDriver.name] || [];
        otherPendingDriversData = this.pendingDrivers[InnerDriver.name].map(drv => drv.driverData);
        this.pendingDrivers[InnerDriver.name].push(d);
      });

      try {
        [innerSessionId, dCaps] = await d.createSession(processedJsonwpCapabilities, reqCaps, processedW3CCapabilities, [...runningDriversData, ...otherPendingDriversData]);
        protocol = d.protocol;
        await sessionsListGuard.acquire(AppiumDriver.name, () => {
          this.sessions[innerSessionId] = d;
        });
      } finally {
        await pendingDriversGuard.acquire(AppiumDriver.name, () => {
          _lodash.default.pull(this.pendingDrivers[InnerDriver.name], d);
        });
      }

      this.attachUnexpectedShutdownHandler(d, innerSessionId);

      _logger.default.info(`New ${InnerDriver.name} session created successfully, session ` + `${innerSessionId} added to master session list`);

      d.startNewCommandTimeout();
    } catch (error) {
      return {
        protocol,
        error
      };
    }

    return {
      protocol,
      value: [innerSessionId, dCaps, protocol]
    };
  }

  async attachUnexpectedShutdownHandler(driver, innerSessionId) {
    try {
      await driver.onUnexpectedShutdown;
      throw new Error('Unexpected shutdown');
    } catch (e) {
      if (e instanceof _bluebird.default.CancellationError) {
        return;
      }

      _logger.default.warn(`Closing session, cause was '${e.message}'`);

      _logger.default.info(`Removing session ${innerSessionId} from our master session list`);

      await sessionsListGuard.acquire(AppiumDriver.name, () => {
        delete this.sessions[innerSessionId];
      });
    }
  }

  async curSessionDataForDriver(InnerDriver) {
    const sessions = await sessionsListGuard.acquire(AppiumDriver.name, () => this.sessions);

    const data = _lodash.default.values(sessions).filter(s => s.constructor.name === InnerDriver.name).map(s => s.driverData);

    for (let datum of data) {
      if (!datum) {
        throw new Error(`Problem getting session data for driver type ` + `${InnerDriver.name}; does it implement 'get ` + `driverData'?`);
      }
    }

    return data;
  }

  async deleteSession(sessionId) {
    let protocol;

    try {
      let otherSessionsData = null;
      let dstSession = null;
      await sessionsListGuard.acquire(AppiumDriver.name, () => {
        if (!this.sessions[sessionId]) {
          return;
        }

        const curConstructorName = this.sessions[sessionId].constructor.name;
        otherSessionsData = _lodash.default.toPairs(this.sessions).filter(([key, value]) => value.constructor.name === curConstructorName && key !== sessionId).map(([, value]) => value.driverData);
        dstSession = this.sessions[sessionId];
        protocol = dstSession.protocol;

        _logger.default.info(`Removing session ${sessionId} from our master session list`);

        delete this.sessions[sessionId];
      });
      return {
        protocol,
        value: await dstSession.deleteSession(sessionId, otherSessionsData)
      };
    } catch (e) {
      _logger.default.error(`Had trouble ending session ${sessionId}: ${e.message}`);

      return {
        protocol,
        error: e
      };
    }
  }

  async executeCommand(cmd, ...args) {
    if (cmd === 'getStatus') {
      return await this.getStatus();
    }

    if (isAppiumDriverCommand(cmd)) {
      return await super.executeCommand(cmd, ...args);
    }

    const sessionId = _lodash.default.last(args);

    const dstSession = await sessionsListGuard.acquire(AppiumDriver.name, () => this.sessions[sessionId]);

    if (!dstSession) {
      throw new Error(`The session with id '${sessionId}' does not exist`);
    }

    let res = {
      protocol: dstSession.protocol
    };

    try {
      res.value = await dstSession.executeCommand(cmd, ...args);
    } catch (e) {
      res.error = e;
    }

    return res;
  }

  proxyActive(sessionId) {
    const dstSession = this.sessions[sessionId];
    return dstSession && _lodash.default.isFunction(dstSession.proxyActive) && dstSession.proxyActive(sessionId);
  }

  getProxyAvoidList(sessionId) {
    const dstSession = this.sessions[sessionId];
    return dstSession ? dstSession.getProxyAvoidList() : [];
  }

  canProxy(sessionId) {
    const dstSession = this.sessions[sessionId];
    return dstSession && dstSession.canProxy(sessionId);
  }

}

exports.AppiumDriver = AppiumDriver;

function isAppiumDriverCommand(cmd) {
  return !(0, _appiumBaseDriver.isSessionCommand)(cmd) || cmd === 'deleteSession';
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9hcHBpdW0uanMiXSwibmFtZXMiOlsiUExBVEZPUk1TIiwiRkFLRSIsIkFORFJPSUQiLCJJT1MiLCJXSU5ET1dTIiwiTUFDIiwiVElaRU4iLCJBVVRPTUFUSU9OX05BTUVTIiwiQVBQSVVNIiwiU0VMRU5EUk9JRCIsIlVJQVVUT01BVE9SMiIsIlVJQVVUT01BVE9SMSIsIlhDVUlURVNUIiwiWU9VSUVOR0lORSIsIkVTUFJFU1NPIiwiSU5TVFJVTUVOVFMiLCJEUklWRVJfTUFQIiwidG9Mb3dlckNhc2UiLCJkcml2ZXJDbGFzc05hbWUiLCJkcml2ZXJQYWNrYWdlIiwiUExBVEZPUk1TX01BUCIsImNhcHMiLCJwbGF0Zm9ybVZlcnNpb24iLCJzZW12ZXIiLCJ2YWxpZCIsImNvZXJjZSIsImxvZyIsIndhcm4iLCJpbmZvIiwic2F0aXNmaWVzIiwiZGVzaXJlZENhcGFiaWxpdHlDb25zdHJhaW50cyIsImF1dG9tYXRpb25OYW1lIiwicHJlc2VuY2UiLCJpc1N0cmluZyIsImluY2x1c2lvbkNhc2VJbnNlbnNpdGl2ZSIsIl8iLCJ2YWx1ZXMiLCJwbGF0Zm9ybU5hbWUiLCJrZXlzIiwic2Vzc2lvbnNMaXN0R3VhcmQiLCJBc3luY0xvY2siLCJwZW5kaW5nRHJpdmVyc0d1YXJkIiwiQXBwaXVtRHJpdmVyIiwiQmFzZURyaXZlciIsImNvbnN0cnVjdG9yIiwiYXJncyIsImRlc2lyZWRDYXBDb25zdHJhaW50cyIsIm5ld0NvbW1hbmRUaW1lb3V0TXMiLCJPYmplY3QiLCJhc3NpZ24iLCJzZXNzaW9ucyIsInBlbmRpbmdEcml2ZXJzIiwiaXNDb21tYW5kc1F1ZXVlRW5hYmxlZCIsInNlc3Npb25FeGlzdHMiLCJzZXNzaW9uSWQiLCJkc3RTZXNzaW9uIiwiZHJpdmVyRm9yU2Vzc2lvbiIsImdldERyaXZlckFuZFZlcnNpb25Gb3JDYXBzIiwiRXJyb3IiLCJhdXRvbWF0aW9uTmFtZUNhcCIsImRyaXZlclNlbGVjdG9yIiwiZHJpdmVyIiwicmVxdWlyZSIsInZlcnNpb24iLCJnZXREcml2ZXJWZXJzaW9uIiwibmFtZSIsImlnbiIsIm1zZyIsImRyaXZlck5hbWUiLCJnZXRTdGF0dXMiLCJidWlsZCIsImNsb25lIiwiZ2V0U2Vzc2lvbnMiLCJhY3F1aXJlIiwidG9QYWlycyIsIm1hcCIsImlkIiwiY2FwYWJpbGl0aWVzIiwicHJpbnROZXdTZXNzaW9uQW5ub3VuY2VtZW50IiwiZHJpdmVyVmVyc2lvbiIsImludHJvU3RyaW5nIiwiQVBQSVVNX1ZFUiIsImNyZWF0ZVNlc3Npb24iLCJqc29ud3BDYXBzIiwicmVxQ2FwcyIsInczY0NhcGFiaWxpdGllcyIsImRlZmF1bHRDYXBhYmlsaXRpZXMiLCJwcm90b2NvbCIsImlubmVyU2Vzc2lvbklkIiwiZENhcHMiLCJwYXJzZWRDYXBzIiwiZGVzaXJlZENhcHMiLCJwcm9jZXNzZWRKc29ud3BDYXBhYmlsaXRpZXMiLCJwcm9jZXNzZWRXM0NDYXBhYmlsaXRpZXMiLCJlcnJvciIsIklubmVyRHJpdmVyIiwic2Vzc2lvbk92ZXJyaWRlIiwic2Vzc2lvbklkc1RvRGVsZXRlIiwibGVuZ3RoIiwiQiIsImRlbGV0ZVNlc3Npb24iLCJydW5uaW5nRHJpdmVyc0RhdGEiLCJvdGhlclBlbmRpbmdEcml2ZXJzRGF0YSIsImQiLCJyZWxheGVkU2VjdXJpdHlFbmFibGVkIiwic2VydmVyIiwiY3VyU2Vzc2lvbkRhdGFGb3JEcml2ZXIiLCJlIiwiZXJyb3JzIiwiU2Vzc2lvbk5vdENyZWF0ZWRFcnJvciIsIm1lc3NhZ2UiLCJkcnYiLCJkcml2ZXJEYXRhIiwicHVzaCIsInB1bGwiLCJhdHRhY2hVbmV4cGVjdGVkU2h1dGRvd25IYW5kbGVyIiwic3RhcnROZXdDb21tYW5kVGltZW91dCIsInZhbHVlIiwib25VbmV4cGVjdGVkU2h1dGRvd24iLCJDYW5jZWxsYXRpb25FcnJvciIsImRhdGEiLCJmaWx0ZXIiLCJzIiwiZGF0dW0iLCJvdGhlclNlc3Npb25zRGF0YSIsImN1ckNvbnN0cnVjdG9yTmFtZSIsImtleSIsImV4ZWN1dGVDb21tYW5kIiwiY21kIiwiaXNBcHBpdW1Ecml2ZXJDb21tYW5kIiwibGFzdCIsInJlcyIsInByb3h5QWN0aXZlIiwiaXNGdW5jdGlvbiIsImdldFByb3h5QXZvaWRMaXN0IiwiY2FuUHJveHkiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBR0EsTUFBTUEsU0FBUyxHQUFHO0FBQ2hCQyxFQUFBQSxJQUFJLEVBQUUsTUFEVTtBQUVoQkMsRUFBQUEsT0FBTyxFQUFFLFNBRk87QUFHaEJDLEVBQUFBLEdBQUcsRUFBRSxLQUhXO0FBSWhCQyxFQUFBQSxPQUFPLEVBQUUsU0FKTztBQUtoQkMsRUFBQUEsR0FBRyxFQUFFLEtBTFc7QUFNaEJDLEVBQUFBLEtBQUssRUFBRTtBQU5TLENBQWxCO0FBU0EsTUFBTUMsZ0JBQWdCLEdBQUc7QUFDdkJDLEVBQUFBLE1BQU0sRUFBRSxRQURlO0FBRXZCQyxFQUFBQSxVQUFVLEVBQUUsWUFGVztBQUd2QkMsRUFBQUEsWUFBWSxFQUFFLGNBSFM7QUFJdkJDLEVBQUFBLFlBQVksRUFBRSxjQUpTO0FBS3ZCQyxFQUFBQSxRQUFRLEVBQUUsVUFMYTtBQU12QkMsRUFBQUEsVUFBVSxFQUFFLFlBTlc7QUFPdkJDLEVBQUFBLFFBQVEsRUFBRSxVQVBhO0FBUXZCUixFQUFBQSxLQUFLLEVBQUUsT0FSZ0I7QUFTdkJMLEVBQUFBLElBQUksRUFBRSxNQVRpQjtBQVV2QmMsRUFBQUEsV0FBVyxFQUFFLGFBVlU7QUFXdkJYLEVBQUFBLE9BQU8sRUFBRSxTQVhjO0FBWXZCQyxFQUFBQSxHQUFHLEVBQUU7QUFaa0IsQ0FBekI7QUFjQSxNQUFNVyxVQUFVLEdBQUc7QUFDakIsR0FBQ1QsZ0JBQWdCLENBQUNFLFVBQWpCLENBQTRCUSxXQUE1QixFQUFELEdBQTZDO0FBQzNDQyxJQUFBQSxlQUFlLEVBQUUsa0JBRDBCO0FBRTNDQyxJQUFBQSxhQUFhLEVBQUU7QUFGNEIsR0FENUI7QUFLakIsR0FBQ1osZ0JBQWdCLENBQUNH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LENBQWQsSUFBc0Q3RSxVQUFVLENBQUM2RSxXQUFYLENBQXVCOUUsU0FBdkIsQ0FBN0Q7QUFDRDs7QUFFRGdGLEVBQUFBLGlCQUFpQixDQUFFaEYsU0FBRixFQUFhO0FBQzVCLFVBQU1DLFVBQVUsR0FBRyxLQUFLTCxRQUFMLENBQWNJLFNBQWQsQ0FBbkI7QUFDQSxXQUFPQyxVQUFVLEdBQUdBLFVBQVUsQ0FBQytFLGlCQUFYLEVBQUgsR0FBb0MsRUFBckQ7QUFDRDs7QUFFREMsRUFBQUEsUUFBUSxDQUFFakYsU0FBRixFQUFhO0FBQ25CLFVBQU1DLFVBQVUsR0FBRyxLQUFLTCxRQUFMLENBQWNJLFNBQWQsQ0FBbkI7QUFDQSxXQUFPQyxVQUFVLElBQUlBLFVBQVUsQ0FBQ2dGLFFBQVgsQ0FBb0JqRixTQUFwQixDQUFyQjtBQUNEOztBQW5VbUM7Ozs7QUF3VXRDLFNBQVMyRSxxQkFBVCxDQUFnQ0QsR0FBaEMsRUFBcUM7QUFDbkMsU0FBTyxDQUFDLHdDQUFpQkEsR0FBakIsQ0FBRCxJQUEwQkEsR0FBRyxLQUFLLGVBQXpDO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IGxvZyBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgeyBnZXRCdWlsZEluZm8sIHVwZGF0ZUJ1aWxkSW5mbywgQVBQSVVNX1ZFUiB9IGZyb20gJy4vY29uZmlnJztcbmltcG9ydCB7IEJhc2VEcml2ZXIsIGVycm9ycywgaXNTZXNzaW9uQ29tbWFuZCB9IGZyb20gJ2FwcGl1bS1iYXNlLWRyaXZlcic7XG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgQXN5bmNMb2NrIGZyb20gJ2FzeW5jLWxvY2snO1xuaW1wb3J0IHsgaW5zcGVjdE9iamVjdCwgcGFyc2VDYXBzRm9ySW5uZXJEcml2ZXIsIGdldFBhY2thZ2VWZXJzaW9uIH0gZnJvbSAnLi91dGlscyc7XG5pbXBvcnQgc2VtdmVyIGZyb20gJ3NlbXZlcic7XG5cblxuY29uc3QgUExBVEZPUk1TID0ge1xuICBGQUtFOiAnZmFrZScsXG4gIEFORFJPSUQ6ICdhbmRyb2lkJyxcbiAgSU9TOiAnaW9zJyxcbiAgV0lORE9XUzogJ3dpbmRvd3MnLFxuICBNQUM6ICdtYWMnLFxuICBUSVpFTjogJ3RpemVuJyxcbn07XG5cbmNvbnN0IEFVVE9NQVRJT05fTkFNRVMgPSB7XG4gIEFQUElVTTogJ0FwcGl1bScsXG4gIFNFTEVORFJPSUQ6ICdTZWxlbmRyb2lkJyxcbiAgVUlBVVRPTUFUT1IyOiAnVWlBdXRvbWF0b3IyJyxcbiAgVUlBVVRPTUFUT1IxOiAnVWlBdXRvbWF0b3IxJyxcbiAgWENVSVRFU1Q6ICdYQ1VJVGVzdCcsXG4gIFlPVUlFTkdJTkU6ICdZb3VpRW5naW5lJyxcbiAgRVNQUkVTU086ICdFc3ByZXNzbycsXG4gIFRJWkVOOiAnVGl6ZW4nLFxuICBGQUtFOiAnRmFrZScsXG4gIElOU1RSVU1FTlRTOiAnSW5zdHJ1bWVudHMnLFxuICBXSU5ET1dTOiAnV2luZG93cycsXG4gIE1BQzogJ01hYycsXG59O1xuY29uc3QgRFJJVkVSX01BUCA9IHtcbiAgW0FVVE9NQVRJT05fTkFNRVMuU0VMRU5EUk9JRC50b0xvd2VyQ2FzZSgpXToge1xuICAgIGRyaXZlckNsYXNzTmFtZTogJ1NlbGVuZHJvaWREcml2ZXInLFxuICAgIGRyaXZlclBhY2thZ2U6ICdhcHBpdW0tc2VsZW5kcm9pZC1kcml2ZXInLFxuICB9LFxuICBbQVVUT01BVElPTl9OQU1FUy5VSUFVVE9NQVRPUjIudG9Mb3dlckNhc2UoKV06IHtcbiAgICBkcml2ZXJDbGFzc05hbWU6ICdBbmRyb2lkVWlhdXRvbWF0b3IyRHJpdmVyJyxcbiAgICBkcml2ZXJQYWNrYWdlOiAnYXBwaXVtLXVpYXV0b21hdG9yMi1kcml2ZXInLFxuICB9LFxuICBbQVVUT01BVElPTl9OQU1FUy5YQ1VJVEVTVC50b0xvd2VyQ2FzZSgpXToge1xuICAgIGRyaXZlckNsYXNzTmFtZTogJ1hDVUlUZXN0RHJpdmVyJyxcbiAgICBkcml2ZXJQYWNrYWdlOiAnYXBwaXVtLXhjdWl0ZXN0LWRyaXZlcicsXG4gIH0sXG4gIFtBVVRPTUFUSU9OX05BTUVTLllPVUlFTkdJTkUudG9Mb3dlckNhc2UoKV06IHtcbiAgICBkcml2ZXJDbGFzc05hbWU6ICdZb3VpRW5naW5lRHJpdmVyJyxcbiAgICBkcml2ZXJQYWNrYWdlOiAnYXBwaXVtLXlvdWllbmdpbmUtZHJpdmVyJyxcbiAgfSxcbiAgW0FVVE9NQVRJT05fTkFNRVMuRkFLRS50b0xvd2VyQ2FzZSgpXToge1xuICAgIGRyaXZlckNsYXNzTmFtZTogJ0Zha2VEcml2ZXInLFxuICAgIGRyaXZlclBhY2thZ2U6ICdhcHBpdW0tZmFrZS1kcml2ZXInLFxuICB9LFxuICBbQVVUT01BVElPTl9OQU1FUy5VSUFVVE9NQVRPUjEudG9Mb3dlckNhc2UoKV06IHtcbiAgICBkcml2ZXJDbGFzc05hbWU6ICdBbmRyb2lkRHJpdmVyJyxcbiAgICBkcml2ZXJQYWNrYWdlOiAnYXBwaXVtLWFuZHJvaWQtZHJpdmVyJyxcbiAgfSxcbiAgW0FVVE9NQVRJT05fTkFNRVMuSU5TVFJVTUVOVFMudG9Mb3dlckNhc2UoKV06IHtcbiAgICBkcml2ZXJDbGFzc05hbWU6ICdJb3NEcml2ZXInLFxuICAgIGRyaXZlclBhY2thZ2U6ICdhcHBpdW0taW9zLWRyaXZlcicsXG4gIH0sXG4gIFtBVVRPTUFUSU9OX05BTUVTLldJTkRPV1MudG9Mb3dlckNhc2UoKV06IHtcbiAgICBkcml2ZXJDbGFzc05hbWU6ICdXaW5kb3dzRHJpdmVyJyxcbiAgICBkcml2ZXJQYWNrYWdlOiAnYXBwaXVtLXdpbmRvd3MtZHJpdmVyJyxcbiAgfSxcbiAgW0FVVE9NQVRJT05fTkFNRVMuTUFDLnRvTG93ZXJDYXNlKCldOiB7XG4gICAgZHJpdmVyQ2xhc3NOYW1lOiAnTWFjRHJpdmVyJyxcbiAgICBkcml2ZXJQYWNrYWdlOiAnYXBwaXVtLW1hYy1kcml2ZXInLFxuICB9LFxuICBbQVVUT01BVElPTl9OQU1FUy5FU1BSRVNTTy50b0xvd2VyQ2FzZSgpXToge1xuICAgIGRyaXZlckNsYXNzTmFtZTogJ0VzcHJlc3NvRHJpdmVyJyxcbiAgICBkcml2ZXJQYWNrYWdlOiAnYXBwaXVtLWVzcHJlc3NvLWRyaXZlcicsXG4gIH0sXG4gIFtBVVRPTUFUSU9OX05BTUVTLlRJWkVOLnRvTG93ZXJDYXNlKCldOiB7XG4gICAgZHJpdmVyQ2xhc3NOYW1lOiAnVGl6ZW5Ecml2ZXInLFxuICAgIGRyaXZlclBhY2thZ2U6ICdhcHBpdW0tdGl6ZW4tZHJpdmVyJyxcbiAgfSxcbn07XG5cbmNvbnN0IFBMQVRGT1JNU19NQVAgPSB7XG4gIFtQTEFURk9STVMuRkFLRV06ICgpID0+IEFVVE9NQVRJT05fTkFNRVMuRkFLRSxcbiAgW1BMQVRGT1JNUy5BTkRST0lEXTogKGNhcHMpID0+IHtcbiAgICBjb25zdCBwbGF0Zm9ybVZlcnNpb24gPSBzZW12ZXIudmFsaWQoc2VtdmVyLmNvZXJjZShjYXBzLnBsYXRmb3JtVmVyc2lvbikpO1xuICAgIGxvZy53YXJuKGBEZXByZWNhdGlvbldhcm5pbmc6ICdhdXRvbWF0aW9uTmFtZScgY2FwYWJpbGl0eSB3YXMgbm90IHByb3ZpZGVkLiBgICtcbiAgICAgIGBGdXR1cmUgdmVyc2lvbnMgb2YgQXBwaXVtIHdpbGwgcmVxdWlyZSAnYXV0b21hdGlvbk5hbWUnIGNhcGFiaWxpdHkgdG8gYmUgc2V0IGZvciBBbmRyb2lkIHNlc3Npb25zLmApO1xuICAgIGxvZy5pbmZvKGBTZXR0aW5nIGF1dG9tYXRpb24gdG8gJyR7QVVUT01BVElPTl9OQU1FUy5VSUFVVE9NQVRPUjF9Jy4gYCk7XG4gICAgaWYgKHBsYXRmb3JtVmVyc2lvbiAmJiBzZW12ZXIuc2F0aXNmaWVzKHBsYXRmb3JtVmVyc2lvbiwgJz49Ni4wLjAnKSkge1xuICAgICAgbG9nLndhcm4oYENvbnNpZGVyIHNldHRpbmcgJ2F1dG9tYXRpb25OYW1lJyBjYXBhYmlsaXR5IHRvICcke0FVVE9NQVRJT05fTkFNRVMuVUlBVVRPTUFUT1IyfScgYCArXG4gICAgICAgICdvbiBBbmRyb2lkID49IDYsIHNpbmNlIFVJQXV0b21hdG9yMSBmcmFtZXdvcmsgJyArXG4gICAgICAgICdpcyBub3QgbWFpbnRhaW5lZCBhbnltb3JlIGJ5IHRoZSBPUyB2ZW5kb3IuJyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIEFVVE9NQVRJT05fTkFNRVMuVUlBVVRPTUFUT1IxO1xuICB9LFxuICBbUExBVEZPUk1TLklPU106IChjYXBzKSA9PiB7XG4gICAgY29uc3QgcGxhdGZvcm1WZXJzaW9uID0gc2VtdmVyLnZhbGlkKHNlbXZlci5jb2VyY2UoY2Fwcy5wbGF0Zm9ybVZlcnNpb24pKTtcbiAgICBsb2cud2FybihgRGVwcmVjYXRpb25XYXJuaW5nOiAnYXV0b21hdGlvbk5hbWUnIGNhcGFiaWxpdHkgd2FzIG5vdCBwcm92aWRlZC4gYCArXG4gICAgICBgRnV0dXJlIHZlcnNpb25zIG9mIEFwcGl1bSB3aWxsIHJlcXVpcmUgJ2F1dG9tYXRpb25OYW1lJyBjYXBhYmlsaXR5IHRvIGJlIHNldCBmb3IgaU9TIHNlc3Npb25zLmApO1xuICAgIGlmIChwbGF0Zm9ybVZlcnNpb24gJiYgc2VtdmVyLnNhdGlzZmllcyhwbGF0Zm9ybVZlcnNpb24sICc+PTEwLjAuMCcpKSB7XG4gICAgICBsb2cuaW5mbygnUmVxdWVzdGVkIGlPUyBzdXBwb3J0IHdpdGggdmVyc2lvbiA+PSAxMCwgJyArXG4gICAgICAgIGB1c2luZyAnJHtBVVRPTUFUSU9OX05BTUVTLlhDVUlURVNUfScgYCArXG4gICAgICAgICdkcml2ZXIgaW5zdGVhZCBvZiBVSUF1dG9tYXRpb24tYmFzZWQgZHJpdmVyLCBzaW5jZSB0aGUgJyArXG4gICAgICAgICdsYXR0ZXIgaXMgdW5zdXBwb3J0ZWQgb24gaU9TIDEwIGFuZCB1cC4nKTtcbiAgICAgIHJldHVybiBBVVRPTUFUSU9OX05BTUVTLlhDVUlURVNUO1xuICAgIH1cblxuICAgIHJldHVybiBBVVRPTUFUSU9OX05BTUVTLklOU1RSVU1FTlRTO1xuICB9LFxuICBbUExBVEZPUk1TLldJTkRPV1NdOiAoKSA9PiBBVVRPTUFUSU9OX05BTUVTLldJTkRPV1MsXG4gIFtQTEFURk9STVMuTUFDXTogKCkgPT4gQVVUT01BVElPTl9OQU1FUy5NQUMsXG4gIFtQTEFURk9STVMuVElaRU5dOiAoKSA9PiBBVVRPTUFUSU9OX05BTUVTLlRJWkVOLFxufTtcblxuY29uc3QgZGVzaXJlZENhcGFiaWxpdHlDb25zdHJhaW50cyA9IHtcbiAgYXV0b21hdGlvbk5hbWU6IHtcbiAgICBwcmVzZW5jZTogZmFsc2UsXG4gICAgaXNTdHJpbmc6IHRydWUsXG4gICAgaW5jbHVzaW9uQ2FzZUluc2Vuc2l0aXZlOiBfLnZhbHVlcyhBVVRPTUFUSU9OX05BTUVTKSxcbiAgfSxcbiAgcGxhdGZvcm1OYW1lOiB7XG4gICAgcHJlc2VuY2U6IHRydWUsXG4gICAgaXNTdHJpbmc6IHRydWUsXG4gICAgaW5jbHVzaW9uQ2FzZUluc2Vuc2l0aXZlOiBfLmtleXMoUExBVEZPUk1TX01BUCksXG4gIH0sXG59O1xuXG5jb25zdCBzZXNzaW9uc0xpc3RHdWFyZCA9IG5ldyBBc3luY0xvY2soKTtcbmNvbnN0IHBlbmRpbmdEcml2ZXJzR3VhcmQgPSBuZXcgQXN5bmNMb2NrKCk7XG5cbmNsYXNzIEFwcGl1bURyaXZlciBleHRlbmRzIEJhc2VEcml2ZXIge1xuICBjb25zdHJ1Y3RvciAoYXJncykge1xuICAgIHN1cGVyKCk7XG5cbiAgICB0aGlzLmRlc2lyZWRDYXBDb25zdHJhaW50cyA9IGRlc2lyZWRDYXBhYmlsaXR5Q29uc3RyYWludHM7XG5cbiAgICAvLyB0aGUgbWFpbiBBcHBpdW0gRHJpdmVyIGhhcyBubyBuZXcgY29tbWFuZCB0aW1lb3V0XG4gICAgdGhpcy5uZXdDb21tYW5kVGltZW91dE1zID0gMDtcblxuICAgIHRoaXMuYXJncyA9IE9iamVjdC5hc3NpZ24oe30sIGFyZ3MpO1xuXG4gICAgLy8gQWNjZXNzIHRvIHNlc3Npb25zIGxpc3QgbXVzdCBiZSBndWFyZGVkIHdpdGggYSBTZW1hcGhvcmUsIGJlY2F1c2VcbiAgICAvLyBpdCBtaWdodCBiZSBjaGFuZ2VkIGJ5IG90aGVyIGFzeW5jIGNhbGxzIGF0IGFueSB0aW1lXG4gICAgLy8gSXQgaXMgbm90IHJlY29tbWVuZGVkIHRvIGFjY2VzcyB0aGlzIHByb3BlcnR5IGRpcmVjdGx5IGZyb20gdGhlIG91dHNpZGVcbiAgICB0aGlzLnNlc3Npb25zID0ge307XG5cbiAgICAvLyBBY2Nlc3MgdG8gcGVuZGluZyBkcml2ZXJzIGxpc3QgbXVzdCBiZSBndWFyZGVkIHdpdGggYSBTZW1hcGhvcmUsIGJlY2F1c2VcbiAgICAvLyBpdCBtaWdodCBiZSBjaGFuZ2VkIGJ5IG90aGVyIGFzeW5jIGNhbGxzIGF0IGFueSB0aW1lXG4gICAgLy8gSXQgaXMgbm90IHJlY29tbWVuZGVkIHRvIGFjY2VzcyB0aGlzIHByb3BlcnR5IGRpcmVjdGx5IGZyb20gdGhlIG91dHNpZGVcbiAgICB0aGlzLnBlbmRpbmdEcml2ZXJzID0ge307XG5cbiAgICAvLyBhbGxvdyB0aGlzIHRvIGhhcHBlbiBpbiB0aGUgYmFja2dyb3VuZCwgc28gbm8gYGF3YWl0YFxuICAgIHVwZGF0ZUJ1aWxkSW5mbygpO1xuICB9XG5cbiAgLyoqXG4gICAqIENhbmNlbCBjb21tYW5kcyBxdWV1ZWluZyBmb3IgdGhlIHVtYnJlbGxhIEFwcGl1bSBkcml2ZXJcbiAgICovXG4gIGdldCBpc0NvbW1hbmRzUXVldWVFbmFibGVkICgpIHtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICBzZXNzaW9uRXhpc3RzIChzZXNzaW9uSWQpIHtcbiAgICBjb25zdCBkc3RTZXNzaW9uID0gdGhpcy5zZXNzaW9uc1tzZXNzaW9uSWRdO1xuICAgIHJldHVybiBkc3RTZXNzaW9uICYmIGRzdFNlc3Npb24uc2Vzc2lvbklkICE9PSBudWxsO1xuICB9XG5cbiAgZHJpdmVyRm9yU2Vzc2lvbiAoc2Vzc2lvbklkKSB7XG4gICAgcmV0dXJuIHRoaXMuc2Vzc2lvbnNbc2Vzc2lvbklkXTtcbiAgfVxuXG4gIGdldERyaXZlckFuZFZlcnNpb25Gb3JDYXBzIChjYXBzKSB7XG4gICAgaWYgKCFfLmlzU3RyaW5nKGNhcHMucGxhdGZvcm1OYW1lKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdZb3UgbXVzdCBpbmNsdWRlIGEgcGxhdGZvcm1OYW1lIGNhcGFiaWxpdHknKTtcbiAgICB9XG5cbiAgICBjb25zdCBwbGF0Zm9ybU5hbWUgPSBjYXBzLnBsYXRmb3JtTmFtZS50b0xvd2VyQ2FzZSgpO1xuXG4gICAgLy8gd2UgZG9uJ3QgbmVjZXNzYXJpbHkgaGF2ZSBhbiBgYXV0b21hdGlvbk5hbWVgIGNhcGFiaWxpdHlcbiAgICBsZXQgYXV0b21hdGlvbk5hbWVDYXAgPSBjYXBzLmF1dG9tYXRpb25OYW1lO1xuICAgIGlmICghXy5pc1N0cmluZyhhdXRvbWF0aW9uTmFtZUNhcCkpIHtcbiAgICAgIGNvbnN0IGRyaXZlclNlbGVjdG9yID0gUExBVEZPUk1TX01BUFtwbGF0Zm9ybU5hbWVdO1xuICAgICAgaWYgKGRyaXZlclNlbGVjdG9yKSB7XG4gICAgICAgIGF1dG9tYXRpb25OYW1lQ2FwID0gZHJpdmVyU2VsZWN0b3IoY2Fwcyk7XG4gICAgICB9XG4gICAgfVxuICAgIGF1dG9tYXRpb25OYW1lQ2FwID0gYXV0b21hdGlvbk5hbWVDYXAudG9Mb3dlckNhc2UoKTtcblxuICAgIHRyeSB7XG4gICAgICBjb25zdCB7ZHJpdmVyUGFja2FnZSwgZHJpdmVyQ2xhc3NOYW1lfSA9IERSSVZFUl9NQVBbYXV0b21hdGlvbk5hbWVDYXBdO1xuICAgICAgY29uc3QgZHJpdmVyID0gcmVxdWlyZShkcml2ZXJQYWNrYWdlKVtkcml2ZXJDbGFzc05hbWVdO1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgZHJpdmVyLFxuICAgICAgICB2ZXJzaW9uOiB0aGlzLmdldERyaXZlclZlcnNpb24oZHJpdmVyLm5hbWUsIGRyaXZlclBhY2thZ2UpLFxuICAgICAgfTtcbiAgICB9IGNhdGNoIChpZ24pIHtcbiAgICAgIC8vIGVycm9yIHdpbGwgYmUgcmVwb3J0ZWQgYmVsb3csIGFuZCBoZXJlIHdvdWxkIGNvbWUgb3V0IGFzIGFuIHVuY2xlYXJcbiAgICAgIC8vIHByb2JsZW0gd2l0aCBkZXN0cnVjdHVyaW5nIHVuZGVmaW5lZFxuICAgIH1cblxuICAgIGNvbnN0IG1zZyA9IF8uaXNTdHJpbmcoY2Fwcy5hdXRvbWF0aW9uTmFtZSlcbiAgICAgID8gYENvdWxkIG5vdCBmaW5kIGEgZHJpdmVyIGZvciBhdXRvbWF0aW9uTmFtZSAnJHtjYXBzLmF1dG9tYXRpb25OYW1lfScgYW5kIHBsYXRmb3JtTmFtZSBgICtcbiAgICAgICAgICAgIGAnJHtjYXBzLnBsYXRmb3JtTmFtZX0nLmBcbiAgICAgIDogYENvdWxkIG5vdCBmaW5kIGEgZHJpdmVyIGZvciBwbGF0Zm9ybU5hbWUgJyR7Y2Fwcy5wbGF0Zm9ybU5hbWV9Jy5gO1xuICAgIHRocm93IG5ldyBFcnJvcihgJHttc2d9IFBsZWFzZSBjaGVjayB5b3VyIGRlc2lyZWQgY2FwYWJpbGl0aWVzLmApO1xuICB9XG5cbiAgZ2V0RHJpdmVyVmVyc2lvbiAoZHJpdmVyTmFtZSwgZHJpdmVyUGFja2FnZSkge1xuICAgIGNvbnN0IHZlcnNpb24gPSBnZXRQYWNrYWdlVmVyc2lvbihkcml2ZXJQYWNrYWdlKTtcbiAgICBpZiAodmVyc2lvbikge1xuICAgICAgcmV0dXJuIHZlcnNpb247XG4gICAgfVxuICAgIGxvZy53YXJuKGBVbmFibGUgdG8gZ2V0IHZlcnNpb24gb2YgZHJpdmVyICcke2RyaXZlck5hbWV9J2ApO1xuICB9XG5cbiAgYXN5bmMgZ2V0U3RhdHVzICgpIHsgLy8gZXNsaW50LWRpc2FibGUtbGluZSByZXF1aXJlLWF3YWl0XG4gICAgcmV0dXJuIHtcbiAgICAgIGJ1aWxkOiBfLmNsb25lKGdldEJ1aWxkSW5mbygpKSxcbiAgICB9O1xuICB9XG5cbiAgYXN5bmMgZ2V0U2Vzc2lvbnMgKCkge1xuICAgIGNvbnN0IHNlc3Npb25zID0gYXdhaXQgc2Vzc2lvbnNMaXN0R3VhcmQuYWNxdWlyZShBcHBpdW1Ecml2ZXIubmFtZSwgKCkgPT4gdGhpcy5zZXNzaW9ucyk7XG4gICAgcmV0dXJuIF8udG9QYWlycyhzZXNzaW9ucylcbiAgICAgIC5tYXAoKFtpZCwgZHJpdmVyXSkgPT4ge1xuICAgICAgICByZXR1cm4ge2lkLCBjYXBhYmlsaXRpZXM6IGRyaXZlci5jYXBzfTtcbiAgICAgIH0pO1xuICB9XG5cbiAgcHJpbnROZXdTZXNzaW9uQW5ub3VuY2VtZW50IChjYXBzLCBkcml2ZXJOYW1lLCBkcml2ZXJWZXJzaW9uKSB7XG4gICAgY29uc3QgaW50cm9TdHJpbmcgPSBkcml2ZXJWZXJzaW9uXG4gICAgICA/IGBBcHBpdW0gdiR7QVBQSVVNX1ZFUn0gY3JlYXRpbmcgbmV3ICR7ZHJpdmVyTmFtZX0gKHYke2RyaXZlclZlcnNpb259KSBzZXNzaW9uYFxuICAgICAgOiBgQXBwaXVtIHYke0FQUElVTV9WRVJ9IGNyZWF0aW5nIG5ldyAke2RyaXZlck5hbWV9IHNlc3Npb25gO1xuICAgIGxvZy5pbmZvKGludHJvU3RyaW5nKTtcbiAgICBsb2cuaW5mbygnQ2FwYWJpbGl0aWVzOicpO1xuICAgIGluc3BlY3RPYmplY3QoY2Fwcyk7XG4gIH1cblxuICAvKipcbiAgICogQ3JlYXRlIGEgbmV3IHNlc3Npb25cbiAgICogQHBhcmFtIHtPYmplY3R9IGpzb253cENhcHMgSlNPTldQIGZvcm1hdHRlZCBkZXNpcmVkIGNhcGFiaWxpdGllc1xuICAgKiBAcGFyYW0ge09iamVjdH0gcmVxQ2FwcyBSZXF1aXJlZCBjYXBhYmlsaXRpZXMgKEpTT05XUCBzdGFuZGFyZClcbiAgICogQHBhcmFtIHtPYmplY3R9IHczY0NhcGFiaWxpdGllcyBXM0MgY2FwYWJpbGl0aWVzXG4gICAqIEByZXR1cm4ge0FycmF5fSBVbmlxdWUgc2Vzc2lvbiBJRCBhbmQgY2FwYWJpbGl0aWVzXG4gICAqL1xuICBhc3luYyBjcmVhdGVTZXNzaW9uIChqc29ud3BDYXBzLCByZXFDYXBzLCB3M2NDYXBhYmlsaXRpZXMpIHtcbiAgICBjb25zdCB7ZGVmYXVsdENhcGFiaWxpdGllc30gPSB0aGlzLmFyZ3M7XG4gICAgbGV0IHByb3RvY29sO1xuICAgIGxldCBpbm5lclNlc3Npb25JZCwgZENhcHM7XG5cbiAgICB0cnkge1xuICAgICAgLy8gUGFyc2UgdGhlIGNhcHMgaW50byBhIGZvcm1hdCB0aGF0IHRoZSBJbm5lckRyaXZlciB3aWxsIGFjY2VwdFxuICAgICAgY29uc3QgcGFyc2VkQ2FwcyA9IHBhcnNlQ2Fwc0ZvcklubmVyRHJpdmVyKFxuICAgICAgICBqc29ud3BDYXBzLFxuICAgICAgICB3M2NDYXBhYmlsaXRpZXMsXG4gICAgICAgIHRoaXMuZGVzaXJlZENhcENvbnN0cmFpbnRzLFxuICAgICAgICBkZWZhdWx0Q2FwYWJpbGl0aWVzXG4gICAgICApO1xuXG4gICAgICBjb25zdCB7ZGVzaXJlZENhcHMsIHByb2Nlc3NlZEpzb253cENhcGFiaWxpdGllcywgcHJvY2Vzc2VkVzNDQ2FwYWJpbGl0aWVzLCBlcnJvcn0gPSBwYXJzZWRDYXBzO1xuICAgICAgcHJvdG9jb2wgPSBwYXJzZWRDYXBzLnByb3RvY29sO1xuXG4gICAgICAvLyBJZiB0aGUgcGFyc2luZyBvZiB0aGUgY2FwcyBwcm9kdWNlZCBhbiBlcnJvciwgdGhyb3cgaXQgaW4gaGVyZVxuICAgICAgaWYgKGVycm9yKSB7XG4gICAgICAgIHRocm93IGVycm9yO1xuICAgICAgfVxuXG4gICAgICBjb25zdCB7ZHJpdmVyOiBJbm5lckRyaXZlciwgdmVyc2lvbjogZHJpdmVyVmVyc2lvbn0gPSB0aGlzLmdldERyaXZlckFuZFZlcnNpb25Gb3JDYXBzKGRlc2lyZWRDYXBzKTtcbiAgICAgIHRoaXMucHJpbnROZXdTZXNzaW9uQW5ub3VuY2VtZW50KGRlc2lyZWRDYXBzLCBJbm5lckRyaXZlci5uYW1lLCBkcml2ZXJWZXJzaW9uKTtcblxuICAgICAgaWYgKHRoaXMuYXJncy5zZXNzaW9uT3ZlcnJpZGUpIHtcbiAgICAgICAgY29uc3Qgc2Vzc2lvbklkc1RvRGVsZXRlID0gYXdhaXQgc2Vzc2lvbnNMaXN0R3VhcmQuYWNxdWlyZShBcHBpdW1Ecml2ZXIubmFtZSwgKCkgPT4gXy5rZXlzKHRoaXMuc2Vzc2lvbnMpKTtcbiAgICAgICAgaWYgKHNlc3Npb25JZHNUb0RlbGV0ZS5sZW5ndGgpIHtcbiAgICAgICAgICBsb2cuaW5mbyhgU2Vzc2lvbiBvdmVycmlkZSBpcyBvbi4gRGVsZXRpbmcgb3RoZXIgJHtzZXNzaW9uSWRzVG9EZWxldGUubGVuZ3RofSBhY3RpdmUgc2Vzc2lvbiR7c2Vzc2lvbklkc1RvRGVsZXRlLmxlbmd0aCA/ICcnIDogJ3MnfS5gKTtcbiAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgYXdhaXQgQi5tYXAoc2Vzc2lvbklkc1RvRGVsZXRlLCAoaWQpID0+IHRoaXMuZGVsZXRlU2Vzc2lvbihpZCkpO1xuICAgICAgICAgIH0gY2F0Y2ggKGlnbikge31cbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBsZXQgcnVubmluZ0RyaXZlcnNEYXRhLCBvdGhlclBlbmRpbmdEcml2ZXJzRGF0YTtcbiAgICAgIGNvbnN0IGQgPSBuZXcgSW5uZXJEcml2ZXIodGhpcy5hcmdzKTtcbiAgICAgIGlmICh0aGlzLmFyZ3MucmVsYXhlZFNlY3VyaXR5RW5hYmxlZCkge1xuICAgICAgICBsb2cuaW5mbyhgQXBwbHlpbmcgcmVsYXhlZCBzZWN1cml0eSB0byAnJHtJbm5lckRyaXZlci5uYW1lfScgYXMgcGVyIHNlcnZlciBjb21tYW5kIGxpbmUgYXJndW1lbnRgKTtcbiAgICAgICAgZC5yZWxheGVkU2VjdXJpdHlFbmFibGVkID0gdHJ1ZTtcbiAgICAgIH1cbiAgICAgIC8vIFRoaXMgYXNzaWdubWVudCBpcyByZXF1aXJlZCBmb3IgY29ycmVjdCB3ZWIgc29ja2V0cyBmdW5jdGlvbmFsaXR5IGluc2lkZSB0aGUgZHJpdmVyXG4gICAgICBkLnNlcnZlciA9IHRoaXMuc2VydmVyO1xuICAgICAgdHJ5IHtcbiAgICAgICAgcnVubmluZ0RyaXZlcnNEYXRhID0gYXdhaXQgdGhpcy5jdXJTZXNzaW9uRGF0YUZvckRyaXZlcihJbm5lckRyaXZlcik7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIHRocm93IG5ldyBlcnJvcnMuU2Vzc2lvbk5vdENyZWF0ZWRFcnJvcihlLm1lc3NhZ2UpO1xuICAgICAgfVxuICAgICAgYXdhaXQgcGVuZGluZ0RyaXZlcnNHdWFyZC5hY3F1aXJlKEFwcGl1bURyaXZlci5uYW1lLCAoKSA9PiB7XG4gICAgICAgIHRoaXMucGVuZGluZ0RyaXZlcnNbSW5uZXJEcml2ZXIubmFtZV0gPSB0aGlzLnBlbmRpbmdEcml2ZXJzW0lubmVyRHJpdmVyLm5hbWVdIHx8IFtdO1xuICAgICAgICBvdGhlclBlbmRpbmdEcml2ZXJzRGF0YSA9IHRoaXMucGVuZGluZ0RyaXZlcnNbSW5uZXJEcml2ZXIubmFtZV0ubWFwKChkcnYpID0+IGRydi5kcml2ZXJEYXRhKTtcbiAgICAgICAgdGhpcy5wZW5kaW5nRHJpdmVyc1tJbm5lckRyaXZlci5uYW1lXS5wdXNoKGQpO1xuICAgICAgfSk7XG5cbiAgICAgIHRyeSB7XG4gICAgICAgIFtpbm5lclNlc3Npb25JZCwgZENhcHNdID0gYXdhaXQgZC5jcmVhdGVTZXNzaW9uKFxuICAgICAgICAgIHByb2Nlc3NlZEpzb253cENhcGFiaWxpdGllcyxcbiAgICAgICAgICByZXFDYXBzLFxuICAgICAgICAgIHByb2Nlc3NlZFczQ0NhcGFiaWxpdGllcyxcbiAgICAgICAgICBbLi4ucnVubmluZ0RyaXZlcnNEYXRhLCAuLi5vdGhlclBlbmRpbmdEcml2ZXJzRGF0YV1cbiAgICAgICAgKTtcbiAgICAgICAgcHJvdG9jb2wgPSBkLnByb3RvY29sO1xuICAgICAgICBhd2FpdCBzZXNzaW9uc0xpc3RHdWFyZC5hY3F1aXJlKEFwcGl1bURyaXZlci5uYW1lLCAoKSA9PiB7XG4gICAgICAgICAgdGhpcy5zZXNzaW9uc1tpbm5lclNlc3Npb25JZF0gPSBkO1xuICAgICAgICB9KTtcbiAgICAgIH0gZmluYWxseSB7XG4gICAgICAgIGF3YWl0IHBlbmRpbmdEcml2ZXJzR3VhcmQuYWNxdWlyZShBcHBpdW1Ecml2ZXIubmFtZSwgKCkgPT4ge1xuICAgICAgICAgIF8ucHVsbCh0aGlzLnBlbmRpbmdEcml2ZXJzW0lubmVyRHJpdmVyLm5hbWVdLCBkKTtcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIC8vIHRoaXMgaXMgYW4gYXN5bmMgZnVuY3Rpb24gYnV0IHdlIGRvbid0IGF3YWl0IGl0IGJlY2F1c2UgaXQgaGFuZGxlc1xuICAgICAgLy8gYW4gb3V0LW9mLWJhbmQgcHJvbWlzZSB3aGljaCBpcyBmdWxmaWxsZWQgaWYgdGhlIGlubmVyIGRyaXZlclxuICAgICAgLy8gdW5leHBlY3RlZGx5IHNodXRzIGRvd25cbiAgICAgIHRoaXMuYXR0YWNoVW5leHBlY3RlZFNodXRkb3duSGFuZGxlcihkLCBpbm5lclNlc3Npb25JZCk7XG5cblxuICAgICAgbG9nLmluZm8oYE5ldyAke0lubmVyRHJpdmVyLm5hbWV9IHNlc3Npb24gY3JlYXRlZCBzdWNjZXNzZnVsbHksIHNlc3Npb24gYCArXG4gICAgICAgICAgICAgIGAke2lubmVyU2Vzc2lvbklkfSBhZGRlZCB0byBtYXN0ZXIgc2Vzc2lvbiBsaXN0YCk7XG5cbiAgICAgIC8vIHNldCB0aGUgTmV3IENvbW1hbmQgVGltZW91dCBmb3IgdGhlIGlubmVyIGRyaXZlclxuICAgICAgZC5zdGFydE5ld0NvbW1hbmRUaW1lb3V0KCk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHByb3RvY29sLFxuICAgICAgICBlcnJvcixcbiAgICAgIH07XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIHByb3RvY29sLFxuICAgICAgdmFsdWU6IFtpbm5lclNlc3Npb25JZCwgZENhcHMsIHByb3RvY29sXVxuICAgIH07XG4gIH1cblxuICBhc3luYyBhdHRhY2hVbmV4cGVjdGVkU2h1dGRvd25IYW5kbGVyIChkcml2ZXIsIGlubmVyU2Vzc2lvbklkKSB7XG4gICAgLy8gUmVtb3ZlIHRoZSBzZXNzaW9uIG9uIHVuZXhwZWN0ZWQgc2h1dGRvd24sIHNvIHRoYXQgd2UgYXJlIGluIGEgcG9zaXRpb25cbiAgICAvLyB0byBvcGVuIGFub3RoZXIgc2Vzc2lvbiBsYXRlciBvbi5cbiAgICAvLyBUT0RPOiB0aGlzIHNob3VsZCBiZSByZW1vdmVkIGFuZCByZXBsYWNlZCBieSBhIG9uU2h1dGRvd24gY2FsbGJhY2suXG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IGRyaXZlci5vblVuZXhwZWN0ZWRTaHV0ZG93bjsgLy8gdGhpcyBpcyBhIGNhbmNlbGxhYmxlIHByb21pc2VcbiAgICAgIC8vIGlmIHdlIGdldCBoZXJlLCB3ZSd2ZSBoYWQgYW4gdW5leHBlY3RlZCBzaHV0ZG93biwgc28gZXJyb3JcbiAgICAgIHRocm93IG5ldyBFcnJvcignVW5leHBlY3RlZCBzaHV0ZG93bicpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGlmIChlIGluc3RhbmNlb2YgQi5DYW5jZWxsYXRpb25FcnJvcikge1xuICAgICAgICAvLyBpZiB3ZSBjYW5jZWxsZWQgdGhlIHVuZXhwZWN0ZWQgc2h1dGRvd24gcHJvbWlzZSwgdGhhdCBtZWFucyB3ZVxuICAgICAgICAvLyBubyBsb25nZXIgY2FyZSBhYm91dCBpdCwgYW5kIGNhbiBzYWZlbHkgaWdub3JlIGl0XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIGxvZy53YXJuKGBDbG9zaW5nIHNlc3Npb24sIGNhdXNlIHdhcyAnJHtlLm1lc3NhZ2V9J2ApO1xuICAgICAgbG9nLmluZm8oYFJlbW92aW5nIHNlc3Npb24gJHtpbm5lclNlc3Npb25JZH0gZnJvbSBvdXIgbWFzdGVyIHNlc3Npb24gbGlzdGApO1xuICAgICAgYXdhaXQgc2Vzc2lvbnNMaXN0R3VhcmQuYWNxdWlyZShBcHBpdW1Ecml2ZXIubmFtZSwgKCkgPT4ge1xuICAgICAgICBkZWxldGUgdGhpcy5zZXNzaW9uc1tpbm5lclNlc3Npb25JZF07XG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBjdXJTZXNzaW9uRGF0YUZvckRyaXZlciAoSW5uZXJEcml2ZXIpIHtcbiAgICBjb25zdCBzZXNzaW9ucyA9IGF3YWl0IHNlc3Npb25zTGlzdEd1YXJkLmFjcXVpcmUoQXBwaXVtRHJpdmVyLm5hbWUsICgpID0+IHRoaXMuc2Vzc2lvbnMpO1xuICAgIGNvbnN0IGRhdGEgPSBfLnZhbHVlcyhzZXNzaW9ucylcbiAgICAgICAgICAgICAgICAgICAuZmlsdGVyKChzKSA9PiBzLmNvbnN0cnVjdG9yLm5hbWUgPT09IElubmVyRHJpdmVyLm5hbWUpXG4gICAgICAgICAgICAgICAgICAgLm1hcCgocykgPT4gcy5kcml2ZXJEYXRhKTtcbiAgICBmb3IgKGxldCBkYXR1bSBvZiBkYXRhKSB7XG4gICAgICBpZiAoIWRhdHVtKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgUHJvYmxlbSBnZXR0aW5nIHNlc3Npb24gZGF0YSBmb3IgZHJpdmVyIHR5cGUgYCArXG4gICAgICAgICAgICAgICAgICAgICAgICBgJHtJbm5lckRyaXZlci5uYW1lfTsgZG9lcyBpdCBpbXBsZW1lbnQgJ2dldCBgICtcbiAgICAgICAgICAgICAgICAgICAgICAgIGBkcml2ZXJEYXRhJz9gKTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGRhdGE7XG4gIH1cblxuICBhc3luYyBkZWxldGVTZXNzaW9uIChzZXNzaW9uSWQpIHtcbiAgICBsZXQgcHJvdG9jb2w7XG4gICAgdHJ5IHtcbiAgICAgIGxldCBvdGhlclNlc3Npb25zRGF0YSA9IG51bGw7XG4gICAgICBsZXQgZHN0U2Vzc2lvbiA9IG51bGw7XG4gICAgICBhd2FpdCBzZXNzaW9uc0xpc3RHdWFyZC5hY3F1aXJlKEFwcGl1bURyaXZlci5uYW1lLCAoKSA9PiB7XG4gICAgICAgIGlmICghdGhpcy5zZXNzaW9uc1tzZXNzaW9uSWRdKSB7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGN1ckNvbnN0cnVjdG9yTmFtZSA9IHRoaXMuc2Vzc2lvbnNbc2Vzc2lvbklkXS5jb25zdHJ1Y3Rvci5uYW1lO1xuICAgICAgICBvdGhlclNlc3Npb25zRGF0YSA9IF8udG9QYWlycyh0aGlzLnNlc3Npb25zKVxuICAgICAgICAgICAgICAuZmlsdGVyKChba2V5LCB2YWx1ZV0pID0+IHZhbHVlLmNvbnN0cnVjdG9yLm5hbWUgPT09IGN1ckNvbnN0cnVjdG9yTmFtZSAmJiBrZXkgIT09IHNlc3Npb25JZClcbiAgICAgICAgICAgICAgLm1hcCgoWywgdmFsdWVdKSA9PiB2YWx1ZS5kcml2ZXJEYXRhKTtcbiAgICAgICAgZHN0U2Vzc2lvbiA9IHRoaXMuc2Vzc2lvbnNbc2Vzc2lvbklkXTtcbiAgICAgICAgcHJvdG9jb2wgPSBkc3RTZXNzaW9uLnByb3RvY29sO1xuICAgICAgICBsb2cuaW5mbyhgUmVtb3Zpbmcgc2Vzc2lvbiAke3Nlc3Npb25JZH0gZnJvbSBvdXIgbWFzdGVyIHNlc3Npb24gbGlzdGApO1xuICAgICAgICAvLyByZWdhcmRsZXNzIG9mIHdoZXRoZXIgdGhlIGRlbGV0ZVNlc3Npb24gY29tcGxldGVzIHN1Y2Nlc3NmdWxseSBvciBub3RcbiAgICAgICAgLy8gbWFrZSB0aGUgc2Vzc2lvbiB1bmF2YWlsYWJsZSwgYmVjYXVzZSB3aG8ga25vd3Mgd2hhdCBzdGF0ZSBpdCBtaWdodFxuICAgICAgICAvLyBiZSBpbiBvdGhlcndpc2VcbiAgICAgICAgZGVsZXRlIHRoaXMuc2Vzc2lvbnNbc2Vzc2lvbklkXTtcbiAgICAgIH0pO1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgcHJvdG9jb2wsXG4gICAgICAgIHZhbHVlOiBhd2FpdCBkc3RTZXNzaW9uLmRlbGV0ZVNlc3Npb24oc2Vzc2lvbklkLCBvdGhlclNlc3Npb25zRGF0YSksXG4gICAgICB9O1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGxvZy5lcnJvcihgSGFkIHRyb3VibGUgZW5kaW5nIHNlc3Npb24gJHtzZXNzaW9uSWR9OiAke2UubWVzc2FnZX1gKTtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHByb3RvY29sLFxuICAgICAgICBlcnJvcjogZSxcbiAgICAgIH07XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgZXhlY3V0ZUNvbW1hbmQgKGNtZCwgLi4uYXJncykge1xuICAgIC8vIGdldFN0YXR1cyBjb21tYW5kIHNob3VsZCBub3QgYmUgcHV0IGludG8gcXVldWUuIElmIHdlIGRvIGl0IGFzIHBhcnQgb2Ygc3VwZXIuZXhlY3V0ZUNvbW1hbmQsIGl0IHdpbGwgYmUgYWRkZWQgdG8gcXVldWUuXG4gICAgLy8gVGhlcmUgd2lsbCBiZSBsb3Qgb2Ygc3RhdHVzIGNvbW1hbmRzIGluIHF1ZXVlIGR1cmluZyBjcmVhdGVTZXNzaW9uIGNvbW1hbmQsIGFzIGNyZWF0ZVNlc3Npb24gY2FuIHRha2UgdXAgdG8gb3IgbW9yZSB0aGFuIGEgbWludXRlLlxuICAgIGlmIChjbWQgPT09ICdnZXRTdGF0dXMnKSB7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5nZXRTdGF0dXMoKTtcbiAgICB9XG5cbiAgICBpZiAoaXNBcHBpdW1Ecml2ZXJDb21tYW5kKGNtZCkpIHtcbiAgICAgIHJldHVybiBhd2FpdCBzdXBlci5leGVjdXRlQ29tbWFuZChjbWQsIC4uLmFyZ3MpO1xuICAgIH1cblxuICAgIGNvbnN0IHNlc3Npb25JZCA9IF8ubGFzdChhcmdzKTtcbiAgICBjb25zdCBkc3RTZXNzaW9uID0gYXdhaXQgc2Vzc2lvbnNMaXN0R3VhcmQuYWNxdWlyZShBcHBpdW1Ecml2ZXIubmFtZSwgKCkgPT4gdGhpcy5zZXNzaW9uc1tzZXNzaW9uSWRdKTtcbiAgICBpZiAoIWRzdFNlc3Npb24pIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVGhlIHNlc3Npb24gd2l0aCBpZCAnJHtzZXNzaW9uSWR9JyBkb2VzIG5vdCBleGlzdGApO1xuICAgIH1cblxuICAgIGxldCByZXMgPSB7XG4gICAgICBwcm90b2NvbDogZHN0U2Vzc2lvbi5wcm90b2NvbFxuICAgIH07XG5cbiAgICB0cnkge1xuICAgICAgcmVzLnZhbHVlID0gYXdhaXQgZHN0U2Vzc2lvbi5leGVjdXRlQ29tbWFuZChjbWQsIC4uLmFyZ3MpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHJlcy5lcnJvciA9IGU7XG4gICAgfVxuICAgIHJldHVybiByZXM7XG4gIH1cblxuICBwcm94eUFjdGl2ZSAoc2Vzc2lvbklkKSB7XG4gICAgY29uc3QgZHN0U2Vzc2lvbiA9IHRoaXMuc2Vzc2lvbnNbc2Vzc2lvbklkXTtcbiAgICByZXR1cm4gZHN0U2Vzc2lvbiAmJiBfLmlzRnVuY3Rpb24oZHN0U2Vzc2lvbi5wcm94eUFjdGl2ZSkgJiYgZHN0U2Vzc2lvbi5wcm94eUFjdGl2ZShzZXNzaW9uSWQpO1xuICB9XG5cbiAgZ2V0UHJveHlBdm9pZExpc3QgKHNlc3Npb25JZCkge1xuICAgIGNvbnN0IGRzdFNlc3Npb24gPSB0aGlzLnNlc3Npb25zW3Nlc3Npb25JZF07XG4gICAgcmV0dXJuIGRzdFNlc3Npb24gPyBkc3RTZXNzaW9uLmdldFByb3h5QXZvaWRMaXN0KCkgOiBbXTtcbiAgfVxuXG4gIGNhblByb3h5IChzZXNzaW9uSWQpIHtcbiAgICBjb25zdCBkc3RTZXNzaW9uID0gdGhpcy5zZXNzaW9uc1tzZXNzaW9uSWRdO1xuICAgIHJldHVybiBkc3RTZXNzaW9uICYmIGRzdFNlc3Npb24uY2FuUHJveHkoc2Vzc2lvbklkKTtcbiAgfVxufVxuXG4vLyBoZWxwIGRlY2lkZSB3aGljaCBjb21tYW5kcyBzaG91bGQgYmUgcHJveGllZCB0byBzdWItZHJpdmVycyBhbmQgd2hpY2hcbi8vIHNob3VsZCBiZSBoYW5kbGVkIGJ5IHRoaXMsIG91ciB1bWJyZWxsYSBkcml2ZXJcbmZ1bmN0aW9uIGlzQXBwaXVtRHJpdmVyQ29tbWFuZCAoY21kKSB7XG4gIHJldHVybiAhaXNTZXNzaW9uQ29tbWFuZChjbWQpIHx8IGNtZCA9PT0gJ2RlbGV0ZVNlc3Npb24nO1xufVxuXG5leHBvcnQgeyBBcHBpdW1Ecml2ZXIgfTtcbiJdLCJmaWxlIjoibGliL2FwcGl1bS5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLiJ9
