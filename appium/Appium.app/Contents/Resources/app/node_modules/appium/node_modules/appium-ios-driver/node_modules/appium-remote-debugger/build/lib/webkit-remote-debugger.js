"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.WebKitRemoteDebugger = exports.default = void 0;

require("source-map-support/register");

var _logger = _interopRequireDefault(require("./logger"));

var _appiumBaseDriver = require("appium-base-driver");

var _remoteDebugger = require("./remote-debugger");

var _webkitRpcClient = _interopRequireDefault(require("./webkit-rpc-client"));

var _lodash = _interopRequireDefault(require("lodash"));

var _url = _interopRequireDefault(require("url"));

var _requestPromise = _interopRequireDefault(require("request-promise"));

var _helpers = require("./helpers");

class WebKitRemoteDebugger extends _remoteDebugger.RemoteDebugger {
  constructor(opts = {}) {
    opts = Object.assign({
      host: 'localhost'
    }, opts);
    super(_lodash.default.defaults({
      debuggerType: _remoteDebugger.DEBUGGER_TYPES.webkit
    }, opts));
    this.webkitResponseTimeout = opts.webkitResponseTimeout || _remoteDebugger.RPC_RESPONSE_TIMEOUT_MS;
    this.dataMethods = {};
  }

  async connect(pageId) {
    this.rpcClient = new _webkitRpcClient.default(this.host, this.port, this.webkitResponseTimeout);
    await this.rpcClient.connect(pageId);
  }

  disconnect() {
    if (this.rpcClient && this.rpcClient.isConnected()) {
      this.rpcClient.disconnect();
    }
  }

  isConnected() {
    return !!(this.rpcClient && this.rpcClient.isConnected());
  }

  async pageArrayFromJson(ignoreAboutBlankUrl = false) {
    _logger.default.debug(`Getting WebKitRemoteDebugger pageArray: ${this.host}, ${this.port}`);

    let pageElementJSON = await this.getJsonFromUrl(this.host, this.port, '/json');

    if (pageElementJSON[0] && pageElementJSON[0].deviceId) {
      _logger.default.debug(`Device JSON: ${(0, _helpers.simpleStringify)(pageElementJSON)}`);

      let devices = pageElementJSON.filter(device => device.deviceId !== 'SIMULATOR');

      if (devices.length > 1) {
        _logger.default.debug(`Connected to ${devices.length} devices. ` + `Choosing the first, with udid '${devices[0].deviceId}'.`);
      }

      this.port = devices[0].url.split(':')[1];

      _logger.default.debug(`Received notification that ios-webkit-debug-proxy is listening on port '${this.port}'`);

      pageElementJSON = await this.getJsonFromUrl(this.host, this.port, '/json');
    }

    _logger.default.debug(`Page element JSON: ${(0, _helpers.simpleStringify)(pageElementJSON)}`);

    let newPageArray = pageElementJSON.filter(pageObject => {
      return pageObject.url && (!ignoreAboutBlankUrl || pageObject.url !== 'about:blank');
    }).map(pageObject => {
      let urlArray = pageObject.webSocketDebuggerUrl.split('/').reverse();
      let id = urlArray[0];
      return {
        id,
        title: pageObject.title,
        url: pageObject.url,
        isKey: !!id
      };
    });
    return newPageArray;
  }

  async getJsonFromUrl(hostname, port, pathname) {
    let uri = _url.default.format({
      protocol: 'http',
      hostname,
      port,
      pathname
    });

    _logger.default.debug(`Sending request to: ${uri}`);

    return JSON.parse((await (0, _requestPromise.default)({
      uri,
      method: 'GET'
    })));
  }

  convertResult(res) {
    if (res && res.wasThrown) {
      let message = res.result.value || res.result;
      throw new _appiumBaseDriver.errors.JavaScriptError(message);
    }

    if (res && res.result && res.result.type === 'undefined') {
      res.result.value = {};
    }

    return super.convertResult(res && res.result ? res.result.value : res);
  }

}

exports.WebKitRemoteDebugger = exports.default = WebKitRemoteDebugger;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi93ZWJraXQtcmVtb3RlLWRlYnVnZ2VyLmpzIl0sIm5hbWVzIjpbIldlYktpdFJlbW90ZURlYnVnZ2VyIiwiUmVtb3RlRGVidWdnZXIiLCJjb25zdHJ1Y3RvciIsIm9wdHMiLCJPYmplY3QiLCJhc3NpZ24iLCJob3N0IiwiXyIsImRlZmF1bHRzIiwiZGVidWdnZXJUeXBlIiwiREVCVUdHRVJfVFlQRVMiLCJ3ZWJraXQiLCJ3ZWJraXRSZXNwb25zZVRpbWVvdXQiLCJSUENfUkVTUE9OU0VfVElNRU9VVF9NUyIsImRhdGFNZXRob2RzIiwiY29ubmVjdCIsInBhZ2VJZCIsInJwY0NsaWVudCIsIldlYktpdFJwY0NsaWVudCIsInBvcnQiLCJkaXNjb25uZWN0IiwiaXNDb25uZWN0ZWQiLCJwYWdlQXJyYXlGcm9tSnNvbiIsImlnbm9yZUFib3V0QmxhbmtVcmwiLCJsb2ciLCJkZWJ1ZyIsInBhZ2VFbGVtZW50SlNPTiIsImdldEpzb25Gcm9tVXJsIiwiZGV2aWNlSWQiLCJkZXZpY2VzIiwiZmlsdGVyIiwiZGV2aWNlIiwibGVuZ3RoIiwidXJsIiwic3BsaXQiLCJuZXdQYWdlQXJyYXkiLCJwYWdlT2JqZWN0IiwibWFwIiwidXJsQXJyYXkiLCJ3ZWJTb2NrZXREZWJ1Z2dlclVybCIsInJldmVyc2UiLCJpZCIsInRpdGxlIiwiaXNLZXkiLCJob3N0bmFtZSIsInBhdGhuYW1lIiwidXJpIiwiZm9ybWF0IiwicHJvdG9jb2wiLCJKU09OIiwicGFyc2UiLCJtZXRob2QiLCJjb252ZXJ0UmVzdWx0IiwicmVzIiwid2FzVGhyb3duIiwibWVzc2FnZSIsInJlc3VsdCIsInZhbHVlIiwiZXJyb3JzIiwiSmF2YVNjcmlwdEVycm9yIiwidHlwZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFFQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFHZSxNQUFNQSxvQkFBTixTQUFtQ0MsOEJBQW5DLENBQWtEO0FBQy9EQyxFQUFBQSxXQUFXLENBQUVDLElBQUksR0FBRyxFQUFULEVBQWE7QUFFdEJBLElBQUFBLElBQUksR0FBR0MsTUFBTSxDQUFDQyxNQUFQLENBQWM7QUFDbkJDLE1BQUFBLElBQUksRUFBRTtBQURhLEtBQWQsRUFFSkgsSUFGSSxDQUFQO0FBR0EsVUFBTUksZ0JBQUVDLFFBQUYsQ0FBVztBQUFDQyxNQUFBQSxZQUFZLEVBQUVDLCtCQUFlQztBQUE5QixLQUFYLEVBQWtEUixJQUFsRCxDQUFOO0FBRUEsU0FBS1MscUJBQUwsR0FBNkJULElBQUksQ0FBQ1MscUJBQUwsSUFBOEJDLHVDQUEzRDtBQUdBLFNBQUtDLFdBQUwsR0FBbUIsRUFBbkI7QUFDRDs7QUFFRCxRQUFNQyxPQUFOLENBQWVDLE1BQWYsRUFBdUI7QUFDckIsU0FBS0MsU0FBTCxHQUFpQixJQUFJQyx3QkFBSixDQUFvQixLQUFLWixJQUF6QixFQUErQixLQUFLYSxJQUFwQyxFQUEwQyxLQUFLUCxxQkFBL0MsQ0FBakI7QUFDQSxVQUFNLEtBQUtLLFNBQUwsQ0FBZUYsT0FBZixDQUF1QkMsTUFBdkIsQ0FBTjtBQUNEOztBQUVESSxFQUFBQSxVQUFVLEdBQUk7QUFDWixRQUFJLEtBQUtILFNBQUwsSUFBa0IsS0FBS0EsU0FBTCxDQUFlSSxXQUFmLEVBQXRCLEVBQW9EO0FBQ2xELFdBQUtKLFNBQUwsQ0FBZUcsVUFBZjtBQUNEO0FBQ0Y7O0FBRURDLEVBQUFBLFdBQVcsR0FBSTtBQUNiLFdBQU8sQ0FBQyxFQUFFLEtBQUtKLFNBQUwsSUFBa0IsS0FBS0EsU0FBTCxDQUFlSSxXQUFmLEVBQXBCLENBQVI7QUFDRDs7QUFFRCxRQUFNQyxpQkFBTixDQUF5QkMsbUJBQW1CLEdBQUcsS0FBL0MsRUFBc0Q7QUFDcERDLG9CQUFJQyxLQUFKLENBQVcsMkNBQTBDLEtBQUtuQixJQUFLLEtBQUksS0FBS2EsSUFBSyxFQUE3RTs7QUFDQSxRQUFJTyxlQUFlLEdBQUcsTUFBTSxLQUFLQyxjQUFMLENBQW9CLEtBQUtyQixJQUF6QixFQUErQixLQUFLYSxJQUFwQyxFQUEwQyxPQUExQyxDQUE1Qjs7QUFDQSxRQUFJTyxlQUFlLENBQUMsQ0FBRCxDQUFmLElBQXNCQSxlQUFlLENBQUMsQ0FBRCxDQUFmLENBQW1CRSxRQUE3QyxFQUF1RDtBQUNyREosc0JBQUlDLEtBQUosQ0FBVyxnQkFBZSw4QkFBZ0JDLGVBQWhCLENBQWlDLEVBQTNEOztBQUVBLFVBQUlHLE9BQU8sR0FBR0gsZUFBZSxDQUFDSSxNQUFoQixDQUF3QkMsTUFBRCxJQUFZQSxNQUFNLENBQUNILFFBQVAsS0FBb0IsV0FBdkQsQ0FBZDs7QUFDQSxVQUFJQyxPQUFPLENBQUNHLE1BQVIsR0FBaUIsQ0FBckIsRUFBd0I7QUFDdEJSLHdCQUFJQyxLQUFKLENBQVcsZ0JBQWVJLE9BQU8sQ0FBQ0csTUFBTyxZQUEvQixHQUNDLGtDQUFpQ0gsT0FBTyxDQUFDLENBQUQsQ0FBUCxDQUFXRCxRQUFTLElBRGhFO0FBRUQ7O0FBQ0QsV0FBS1QsSUFBTCxHQUFZVSxPQUFPLENBQUMsQ0FBRCxDQUFQLENBQVdJLEdBQVgsQ0FBZUMsS0FBZixDQUFxQixHQUFyQixFQUEwQixDQUExQixDQUFaOztBQUNBVixzQkFBSUMsS0FBSixDQUFXLDJFQUEwRSxLQUFLTixJQUFLLEdBQS9GOztBQUVBTyxNQUFBQSxlQUFlLEdBQUcsTUFBTSxLQUFLQyxjQUFMLENBQW9CLEtBQUtyQixJQUF6QixFQUErQixLQUFLYSxJQUFwQyxFQUEwQyxPQUExQyxDQUF4QjtBQUNEOztBQUNESyxvQkFBSUMsS0FBSixDQUFXLHNCQUFxQiw4QkFBZ0JDLGVBQWhCLENBQWlDLEVBQWpFOztBQUdBLFFBQUlTLFlBQVksR0FBR1QsZUFBZSxDQUFDSSxNQUFoQixDQUF3Qk0sVUFBRCxJQUFnQjtBQUN4RCxhQUFPQSxVQUFVLENBQUNILEdBQVgsS0FBbUIsQ0FBQ1YsbUJBQUQsSUFBd0JhLFVBQVUsQ0FBQ0gsR0FBWCxLQUFtQixhQUE5RCxDQUFQO0FBQ0QsS0FGa0IsRUFFaEJJLEdBRmdCLENBRVhELFVBQUQsSUFBZ0I7QUFDckIsVUFBSUUsUUFBUSxHQUFHRixVQUFVLENBQUNHLG9CQUFYLENBQWdDTCxLQUFoQyxDQUFzQyxHQUF0QyxFQUEyQ00sT0FBM0MsRUFBZjtBQUNBLFVBQUlDLEVBQUUsR0FBR0gsUUFBUSxDQUFDLENBQUQsQ0FBakI7QUFDQSxhQUFPO0FBQ0xHLFFBQUFBLEVBREs7QUFFTEMsUUFBQUEsS0FBSyxFQUFFTixVQUFVLENBQUNNLEtBRmI7QUFHTFQsUUFBQUEsR0FBRyxFQUFFRyxVQUFVLENBQUNILEdBSFg7QUFJTFUsUUFBQUEsS0FBSyxFQUFFLENBQUMsQ0FBQ0Y7QUFKSixPQUFQO0FBTUQsS0FYa0IsQ0FBbkI7QUFhQSxXQUFPTixZQUFQO0FBQ0Q7O0FBRUQsUUFBTVIsY0FBTixDQUFzQmlCLFFBQXRCLEVBQWdDekIsSUFBaEMsRUFBc0MwQixRQUF0QyxFQUFnRDtBQUM5QyxRQUFJQyxHQUFHLEdBQUdiLGFBQUljLE1BQUosQ0FBVztBQUNuQkMsTUFBQUEsUUFBUSxFQUFFLE1BRFM7QUFFbkJKLE1BQUFBLFFBRm1CO0FBR25CekIsTUFBQUEsSUFIbUI7QUFJbkIwQixNQUFBQTtBQUptQixLQUFYLENBQVY7O0FBTUFyQixvQkFBSUMsS0FBSixDQUFXLHVCQUFzQnFCLEdBQUksRUFBckM7O0FBQ0EsV0FBT0csSUFBSSxDQUFDQyxLQUFMLEVBQVcsTUFBTSw2QkFBUTtBQUFDSixNQUFBQSxHQUFEO0FBQU1LLE1BQUFBLE1BQU0sRUFBRTtBQUFkLEtBQVIsQ0FBakIsRUFBUDtBQUNEOztBQUVEQyxFQUFBQSxhQUFhLENBQUVDLEdBQUYsRUFBTztBQWdCbEIsUUFBSUEsR0FBRyxJQUFJQSxHQUFHLENBQUNDLFNBQWYsRUFBMEI7QUFFeEIsVUFBSUMsT0FBTyxHQUFHRixHQUFHLENBQUNHLE1BQUosQ0FBV0MsS0FBWCxJQUFvQkosR0FBRyxDQUFDRyxNQUF0QztBQUNBLFlBQU0sSUFBSUUseUJBQU9DLGVBQVgsQ0FBMkJKLE9BQTNCLENBQU47QUFDRDs7QUFFRCxRQUFJRixHQUFHLElBQUlBLEdBQUcsQ0FBQ0csTUFBWCxJQUFxQkgsR0FBRyxDQUFDRyxNQUFKLENBQVdJLElBQVgsS0FBb0IsV0FBN0MsRUFBMEQ7QUFHeERQLE1BQUFBLEdBQUcsQ0FBQ0csTUFBSixDQUFXQyxLQUFYLEdBQW1CLEVBQW5CO0FBQ0Q7O0FBR0QsV0FBTyxNQUFNTCxhQUFOLENBQW9CQyxHQUFHLElBQUlBLEdBQUcsQ0FBQ0csTUFBWCxHQUFvQkgsR0FBRyxDQUFDRyxNQUFKLENBQVdDLEtBQS9CLEdBQXVDSixHQUEzRCxDQUFQO0FBQ0Q7O0FBekc4RCIsInNvdXJjZXNDb250ZW50IjpbIi8vIHRyYW5zcGlsZTptYWluXG5cbmltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IHsgZXJyb3JzIH0gZnJvbSAnYXBwaXVtLWJhc2UtZHJpdmVyJztcbmltcG9ydCB7IFJlbW90ZURlYnVnZ2VyLCBERUJVR0dFUl9UWVBFUywgUlBDX1JFU1BPTlNFX1RJTUVPVVRfTVMgfSBmcm9tICcuL3JlbW90ZS1kZWJ1Z2dlcic7XG5pbXBvcnQgV2ViS2l0UnBjQ2xpZW50IGZyb20gJy4vd2Via2l0LXJwYy1jbGllbnQnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB1cmwgZnJvbSAndXJsJztcbmltcG9ydCByZXF1ZXN0IGZyb20gJ3JlcXVlc3QtcHJvbWlzZSc7XG5pbXBvcnQgeyBzaW1wbGVTdHJpbmdpZnkgfSBmcm9tICcuL2hlbHBlcnMnO1xuXG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFdlYktpdFJlbW90ZURlYnVnZ2VyIGV4dGVuZHMgUmVtb3RlRGVidWdnZXIge1xuICBjb25zdHJ1Y3RvciAob3B0cyA9IHt9KSB7XG4gICAgLy8gbWFrZSBzdXJlIHRoZXJlIGlzIGEgaG9zdFxuICAgIG9wdHMgPSBPYmplY3QuYXNzaWduKHtcbiAgICAgIGhvc3Q6ICdsb2NhbGhvc3QnLFxuICAgIH0sIG9wdHMpO1xuICAgIHN1cGVyKF8uZGVmYXVsdHMoe2RlYnVnZ2VyVHlwZTogREVCVUdHRVJfVFlQRVMud2Via2l0fSwgb3B0cykpO1xuXG4gICAgdGhpcy53ZWJraXRSZXNwb25zZVRpbWVvdXQgPSBvcHRzLndlYmtpdFJlc3BvbnNlVGltZW91dCB8fCBSUENfUkVTUE9OU0VfVElNRU9VVF9NUztcblxuICAgIC8vIHVzZWQgdG8gc3RvcmUgY2FsbGJhY2sgdHlwZXMgd2hlbiBzZW5kaW5nIHJlcXVlc3RzXG4gICAgdGhpcy5kYXRhTWV0aG9kcyA9IHt9O1xuICB9XG5cbiAgYXN5bmMgY29ubmVjdCAocGFnZUlkKSB7XG4gICAgdGhpcy5ycGNDbGllbnQgPSBuZXcgV2ViS2l0UnBjQ2xpZW50KHRoaXMuaG9zdCwgdGhpcy5wb3J0LCB0aGlzLndlYmtpdFJlc3BvbnNlVGltZW91dCk7XG4gICAgYXdhaXQgdGhpcy5ycGNDbGllbnQuY29ubmVjdChwYWdlSWQpO1xuICB9XG5cbiAgZGlzY29ubmVjdCAoKSB7XG4gICAgaWYgKHRoaXMucnBjQ2xpZW50ICYmIHRoaXMucnBjQ2xpZW50LmlzQ29ubmVjdGVkKCkpIHtcbiAgICAgIHRoaXMucnBjQ2xpZW50LmRpc2Nvbm5lY3QoKTtcbiAgICB9XG4gIH1cblxuICBpc0Nvbm5lY3RlZCAoKSB7XG4gICAgcmV0dXJuICEhKHRoaXMucnBjQ2xpZW50ICYmIHRoaXMucnBjQ2xpZW50LmlzQ29ubmVjdGVkKCkpO1xuICB9XG5cbiAgYXN5bmMgcGFnZUFycmF5RnJvbUpzb24gKGlnbm9yZUFib3V0QmxhbmtVcmwgPSBmYWxzZSkge1xuICAgIGxvZy5kZWJ1ZyhgR2V0dGluZyBXZWJLaXRSZW1vdGVEZWJ1Z2dlciBwYWdlQXJyYXk6ICR7dGhpcy5ob3N0fSwgJHt0aGlzLnBvcnR9YCk7XG4gICAgbGV0IHBhZ2VFbGVtZW50SlNPTiA9IGF3YWl0IHRoaXMuZ2V0SnNvbkZyb21VcmwodGhpcy5ob3N0LCB0aGlzLnBvcnQsICcvanNvbicpO1xuICAgIGlmIChwYWdlRWxlbWVudEpTT05bMF0gJiYgcGFnZUVsZW1lbnRKU09OWzBdLmRldmljZUlkKSB7XG4gICAgICBsb2cuZGVidWcoYERldmljZSBKU09OOiAke3NpbXBsZVN0cmluZ2lmeShwYWdlRWxlbWVudEpTT04pfWApO1xuXG4gICAgICBsZXQgZGV2aWNlcyA9IHBhZ2VFbGVtZW50SlNPTi5maWx0ZXIoKGRldmljZSkgPT4gZGV2aWNlLmRldmljZUlkICE9PSAnU0lNVUxBVE9SJyk7XG4gICAgICBpZiAoZGV2aWNlcy5sZW5ndGggPiAxKSB7XG4gICAgICAgIGxvZy5kZWJ1ZyhgQ29ubmVjdGVkIHRvICR7ZGV2aWNlcy5sZW5ndGh9IGRldmljZXMuIGAgK1xuICAgICAgICAgICAgICAgICAgYENob29zaW5nIHRoZSBmaXJzdCwgd2l0aCB1ZGlkICcke2RldmljZXNbMF0uZGV2aWNlSWR9Jy5gKTtcbiAgICAgIH1cbiAgICAgIHRoaXMucG9ydCA9IGRldmljZXNbMF0udXJsLnNwbGl0KCc6JylbMV07XG4gICAgICBsb2cuZGVidWcoYFJlY2VpdmVkIG5vdGlmaWNhdGlvbiB0aGF0IGlvcy13ZWJraXQtZGVidWctcHJveHkgaXMgbGlzdGVuaW5nIG9uIHBvcnQgJyR7dGhpcy5wb3J0fSdgKTtcblxuICAgICAgcGFnZUVsZW1lbnRKU09OID0gYXdhaXQgdGhpcy5nZXRKc29uRnJvbVVybCh0aGlzLmhvc3QsIHRoaXMucG9ydCwgJy9qc29uJyk7XG4gICAgfVxuICAgIGxvZy5kZWJ1ZyhgUGFnZSBlbGVtZW50IEpTT046ICR7c2ltcGxlU3RyaW5naWZ5KHBhZ2VFbGVtZW50SlNPTil9YCk7XG5cbiAgICAvLyBBZGQgZWxlbWVudHMgdG8gYW4gYXJyYXlcbiAgICBsZXQgbmV3UGFnZUFycmF5ID0gcGFnZUVsZW1lbnRKU09OLmZpbHRlcigocGFnZU9iamVjdCkgPT4ge1xuICAgICAgcmV0dXJuIHBhZ2VPYmplY3QudXJsICYmICghaWdub3JlQWJvdXRCbGFua1VybCB8fCBwYWdlT2JqZWN0LnVybCAhPT0gJ2Fib3V0OmJsYW5rJyk7XG4gICAgfSkubWFwKChwYWdlT2JqZWN0KSA9PiB7XG4gICAgICBsZXQgdXJsQXJyYXkgPSBwYWdlT2JqZWN0LndlYlNvY2tldERlYnVnZ2VyVXJsLnNwbGl0KCcvJykucmV2ZXJzZSgpO1xuICAgICAgbGV0IGlkID0gdXJsQXJyYXlbMF07XG4gICAgICByZXR1cm4ge1xuICAgICAgICBpZCxcbiAgICAgICAgdGl0bGU6IHBhZ2VPYmplY3QudGl0bGUsXG4gICAgICAgIHVybDogcGFnZU9iamVjdC51cmwsXG4gICAgICAgIGlzS2V5OiAhIWlkLFxuICAgICAgfTtcbiAgICB9KTtcblxuICAgIHJldHVybiBuZXdQYWdlQXJyYXk7XG4gIH1cblxuICBhc3luYyBnZXRKc29uRnJvbVVybCAoaG9zdG5hbWUsIHBvcnQsIHBhdGhuYW1lKSB7XG4gICAgbGV0IHVyaSA9IHVybC5mb3JtYXQoe1xuICAgICAgcHJvdG9jb2w6ICdodHRwJyxcbiAgICAgIGhvc3RuYW1lLFxuICAgICAgcG9ydCxcbiAgICAgIHBhdGhuYW1lXG4gICAgfSk7XG4gICAgbG9nLmRlYnVnKGBTZW5kaW5nIHJlcXVlc3QgdG86ICR7dXJpfWApO1xuICAgIHJldHVybiBKU09OLnBhcnNlKGF3YWl0IHJlcXVlc3Qoe3VyaSwgbWV0aG9kOiAnR0VUJ30pKTtcbiAgfVxuXG4gIGNvbnZlcnRSZXN1bHQgKHJlcykge1xuICAgIC8vIFdlYktpdCByZXR1cm5zIGEgcmVzdWx0IHdyYXBwZWQgZGVlcGVyIHRoYW4gdGhlIFJlbW90ZSBEZWJ1Z2dlcjpcbiAgICAvLyAgIHtcbiAgICAvLyAgICAgcmVzdWx0OiB7XG4gICAgLy8gICAgICAgdHlwZTogXCJzdHJpbmdcIixcbiAgICAvLyAgICAgICB2YWx1ZToge1xuICAgIC8vICAgICAgICAgc3RhdHVzOiAwLFxuICAgIC8vICAgICAgICAgdmFsdWU6IHtcbiAgICAvLyAgICAgICAgICAgRUxFTUVOVDogXCI6d2RjOjE0NDE4MTk3NDAwNjBcIlxuICAgIC8vICAgICAgICAgfVxuICAgIC8vICAgICAgIH1cbiAgICAvLyAgICAgfSxcbiAgICAvLyAgICAgd2FzVGhyb3duOiBmYWxzZVxuICAgIC8vICAgfVxuXG4gICAgLy8gY2hlY2sgZm9yIGVycm9yc1xuICAgIGlmIChyZXMgJiYgcmVzLndhc1Rocm93bikge1xuICAgICAgLy8gd2UgZ290IHNvbWUgZm9ybSBvZiBlcnJvci5cbiAgICAgIGxldCBtZXNzYWdlID0gcmVzLnJlc3VsdC52YWx1ZSB8fCByZXMucmVzdWx0O1xuICAgICAgdGhyb3cgbmV3IGVycm9ycy5KYXZhU2NyaXB0RXJyb3IobWVzc2FnZSk7XG4gICAgfVxuXG4gICAgaWYgKHJlcyAmJiByZXMucmVzdWx0ICYmIHJlcy5yZXN1bHQudHlwZSA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgIC8vIGlmIGl0IGRvZXNuJ3QgdGhyb3cgYW4gZXJyb3IsIHdlIGp1c3Qgd2FudCB0byBwdXQgaW4gYVxuICAgICAgLy8gcGxhY2UgaG9sZGVyLiB0aGlzIGhhcHBlbnMgd2hlbiB3ZSBoYXZlIGFuIGFzeW5jIGV4ZWN1dGUgcmVxdWVzdFxuICAgICAgcmVzLnJlc3VsdC52YWx1ZSA9IHt9O1xuICAgIH1cblxuICAgIC8vIHNlbmQgdGhlIGFjdHVhbCByZXN1bHQgdG8gdGhlIFJlbW90ZSBEZWJ1Z2dlciBjb252ZXJ0ZXJcbiAgICByZXR1cm4gc3VwZXIuY29udmVydFJlc3VsdChyZXMgJiYgcmVzLnJlc3VsdCA/IHJlcy5yZXN1bHQudmFsdWUgOiByZXMpO1xuICB9XG59XG5cbmV4cG9ydCB7IFdlYktpdFJlbW90ZURlYnVnZ2VyIH07XG4iXSwiZmlsZSI6ImxpYi93ZWJraXQtcmVtb3RlLWRlYnVnZ2VyLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uIn0=
