"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _logger = _interopRequireDefault(require("./logger"));

var _lodash = _interopRequireDefault(require("lodash"));

var _bplistCreator = _interopRequireDefault(require("bplist-creator"));

var _bplistParser = _interopRequireDefault(require("bplist-parser"));

var _bufferpack = _interopRequireDefault(require("bufferpack"));

var _bluebird = _interopRequireDefault(require("bluebird"));

var _remoteDebugger = require("./remote-debugger");

var _uuidJs = _interopRequireDefault(require("uuid-js"));

var _net = _interopRequireDefault(require("net"));

var _remoteDebuggerMessageHandler = _interopRequireDefault(require("./remote-debugger-message-handler"));

var _remoteMessages = _interopRequireDefault(require("./remote-messages"));

const MIN_PLATFORM_FOR_TARGET_BASED = 12.2;

class RemoteDebuggerRpcClient {
  constructor(opts = {}) {
    let {
      platformVersion = {},
      isSafari = true,
      host = '::1',
      port = _remoteDebugger.REMOTE_DEBUGGER_PORT,
      socketPath,
      specialMessageHandlers = {},
      messageProxy
    } = opts;
    this.host = host;
    this.port = port;
    this.socketPath = socketPath;
    this.messageProxy = messageProxy;
    this.socket = null;
    this.connected = false;
    this.connId = _uuidJs.default.create().toString();
    this.senderId = _uuidJs.default.create().toString();
    this.msgId = 0;
    this.received = Buffer.alloc(0);
    this.readPos = 0;
    this.specialMessageHandlers = specialMessageHandlers;

    if (_lodash.default.isString(platformVersion)) {
      platformVersion = parseFloat(platformVersion);
    }

    const isTargetBased = isSafari && platformVersion >= MIN_PLATFORM_FOR_TARGET_BASED;
    this.remoteMessages = new _remoteMessages.default(isTargetBased);
    this.messageHandler = new _remoteDebuggerMessageHandler.default(this.specialMessageHandlers, isTargetBased);

    _logger.default.debug(`Using ${isTargetBased ? 'Target-based' : 'full Web Inspector protocol'} communication`);
  }

  async connect() {
    if (this.socketPath) {
      if (this.messageProxy) {
        _logger.default.debug(`Connecting to remote debugger via proxy through unix domain socket: '${this.messageProxy}'`);

        this.socket = _net.default.connect(this.messageProxy);
        this.socket.once('connect', () => {
          _logger.default.debug(`Forwarding the actual web inspector socket to the proxy: '${this.socketPath}'`);

          this.socket.write(JSON.stringify({
            socketPath: this.socketPath
          }));
        });
      } else {
        _logger.default.debug(`Connecting to remote debugger through unix domain socket: '${this.socketPath}'`);

        this.socket = _net.default.connect(this.socketPath);
      }
    } else {
      if (this.messageProxy) {
        this.port = this.messageProxy;
      }

      _logger.default.debug(`Connecting to remote debugger ${this.messageProxy ? 'via proxy ' : ''}through TCP: ${this.host}:${this.port}`);

      this.socket = new _net.default.Socket({
        type: 'tcp6'
      });
      this.socket.connect(this.port, this.host);
    }

    this.socket.setNoDelay(true);
    this.socket.on('close', () => {
      if (this.connected) {
        _logger.default.debug('Debugger socket disconnected');
      }

      this.connected = false;
      this.socket = null;
    });
    this.socket.on('end', () => {
      this.connected = false;
    });
    this.socket.on('data', this.receive.bind(this));
    return await new _bluebird.default((resolve, reject) => {
      this.socket.on('connect', () => {
        _logger.default.debug(`Debugger socket connected`);

        this.connected = true;
        resolve();
      });
      this.socket.on('error', err => {
        if (this.connected) {
          _logger.default.error(`Socket error: ${err.message}`);

          this.connected = false;
        }

        reject(err);
      });
    });
  }

  async disconnect() {
    if (this.isConnected()) {
      _logger.default.debug('Disconnecting from remote debugger');

      this.socket.destroy();
    }

    this.connected = false;
  }

  isConnected() {
    return this.connected;
  }

  setSpecialMessageHandler(key, errorHandler, handler) {
    this.messageHandler.setSpecialMessageHandler(key, errorHandler, handler);
  }

  getSpecialMessageHandler(key) {
    return this.messageHandler.getSpecialMessageHandler(key);
  }

  setDataMessageHandler(key, errorHandler, handler) {
    this.messageHandler.setDataMessageHandler(key, errorHandler, handler);
  }

  allowNavigationWithoutReload(allow = true) {
    this.messageHandler.allowNavigationWithoutReload(allow);
  }

  async selectApp(appIdKey, applicationConnectedHandler) {
    return await new _bluebird.default((resolve, reject) => {
      let onAppChange = dict => {
        let oldAppIdKey = dict.WIRHostApplicationIdentifierKey;
        let correctAppIdKey = dict.WIRApplicationIdentifierKey;

        if (oldAppIdKey && correctAppIdKey !== oldAppIdKey) {
          _logger.default.debug(`We were notified we might have connected to the wrong app. ` + `Using id ${correctAppIdKey} instead of ${oldAppIdKey}`);
        }

        applicationConnectedHandler(dict);
        reject(new Error('New application has connected'));
      };

      this.setSpecialMessageHandler('_rpc_applicationConnected:', reject, onAppChange);
      return (async () => {
        let [connectedAppIdKey, pageDict] = await this.send('connectToApp', {
          appIdKey
        });

        if (_lodash.default.isEmpty(pageDict)) {
          let msg = 'Empty page dictionary received';

          _logger.default.debug(msg);

          reject(new Error(msg));
        } else {
          resolve([connectedAppIdKey, pageDict]);
        }
      })();
    }).finally(() => {
      this.setSpecialMessageHandler('_rpc_applicationConnected:', null, applicationConnectedHandler);
    });
  }

  async send(command, opts = {}) {
    let onSocketError;
    return await new _bluebird.default((resolve, reject) => {
      const msgId = this.msgId++;
      opts = _lodash.default.defaults({
        connId: this.connId,
        senderId: this.senderId
      }, opts);
      const cmd = this.remoteMessages.getRemoteCommand(command, opts);
      let socketCb = _lodash.default.noop;

      onSocketError = exception => {
        if (this.connected) {
          _logger.default.error(`Socket error: ${exception.message}`);
        }

        reject(exception);
      };

      this.socket.on('error', onSocketError);

      if (this.messageHandler.hasSpecialMessageHandler(cmd.__selector)) {
        const specialMessageHandler = this.getSpecialMessageHandler(cmd.__selector);
        this.setSpecialMessageHandler(cmd.__selector, reject, function (...args) {
          _logger.default.debug(`Received response from socket send: '${_lodash.default.truncate(JSON.stringify(args), {
            length: 50
          })}'`);

          specialMessageHandler(...args);

          if (this.messageHandler.hasSpecialMessageHandler(cmd.__selector)) {
            this.setSpecialMessageHandler(cmd.__selector, null, specialMessageHandler);
          }

          resolve(args);
        }.bind(this));
      } else if (cmd.__argument && cmd.__argument.WIRSocketDataKey) {
        const errorHandler = function (err) {
          const msg = `Remote debugger error with code '${err.code}': ${err.message}`;
          reject(new Error(msg));
        };

        this.setDataMessageHandler(msgId.toString(), errorHandler, function (value) {
          const msg = _lodash.default.truncate(_lodash.default.isString(value) ? value : JSON.stringify(value), {
            length: 50
          });

          _logger.default.debug(`Received data response from socket send: '${msg}'`);

          _logger.default.debug(`Original command: ${command}`);

          resolve(value);
        });

        if (cmd.__argument.WIRSocketDataKey.params) {
          cmd.__argument.WIRSocketDataKey.params.id = msgId;

          if (!cmd.__argument.WIRSocketDataKey.params.targetId) {
            cmd.__argument.WIRSocketDataKey.params.targetId = `page-${opts.pageIdKey}`;
          }

          if (cmd.__argument.WIRSocketDataKey.params.message) {
            cmd.__argument.WIRSocketDataKey.params.message.id = msgId;
            cmd.__argument.WIRSocketDataKey.params.message = JSON.stringify(cmd.__argument.WIRSocketDataKey.params.message);
          }
        }

        cmd.__argument.WIRSocketDataKey.id = msgId;
        cmd.__argument.WIRSocketDataKey = Buffer.from(JSON.stringify(cmd.__argument.WIRSocketDataKey));
      } else {
        socketCb = resolve;
      }

      _logger.default.debug(`Sending '${cmd.__selector}' message to remote debugger (id: ${msgId})`);

      let plist;

      try {
        plist = (0, _bplistCreator.default)(cmd);
      } catch (e) {
        let msg = `Could not create binary plist from data: ${e.message}`;

        _logger.default.error(msg);

        return reject(new Error(msg));
      }

      if (this.socket && this.connected) {
        this.socket.cork();

        try {
          this.socket.write(_bufferpack.default.pack('L', [plist.length]));
          this.socket.write(plist, socketCb);
        } finally {
          this.socket.uncork();
        }
      } else {
        let msg = 'Attempted to write data to socket after it was closed!';

        _logger.default.error(msg);

        reject(new Error(msg));
      }
    }).finally(() => {
      if (_lodash.default.isFunction(onSocketError)) {
        this.socket.removeListener('error', onSocketError);
      }
    });
  }

  async receive(data) {
    this.received = Buffer.concat([this.received, data]);
    let dataLeftOver = true;

    while (dataLeftOver) {
      const oldReadPos = this.readPos;
      const prefix = this.received.slice(this.readPos, this.readPos + 4);

      if (_lodash.default.isEmpty(prefix)) {
        return;
      }

      let msgLength;

      try {
        msgLength = _bufferpack.default.unpack('L', prefix)[0];
      } catch (err) {
        _logger.default.error(`Buffer could not unpack: ${err}`);

        return;
      }

      this.readPos += 4;

      if (this.received.length < msgLength + this.readPos) {
        this.readPos = oldReadPos;
        break;
      }

      const body = this.received.slice(this.readPos, msgLength + this.readPos);
      let plist;

      try {
        plist = _bplistParser.default.parseBuffer(body);
      } catch (e) {
        _logger.default.error(`Error parsing binary plist: ${e}`);

        return;
      }

      if (plist.length === 1) {
        plist = plist[0];
      }

      for (const key of ['WIRMessageDataKey', 'WIRDestinationKey', 'WIRSocketDataKey']) {
        if (!_lodash.default.isUndefined(plist[key])) {
          plist[key] = plist[key].toString('utf8');
        }
      }

      this.readPos += msgLength;
      let leftOver = this.received.length - this.readPos;

      if (leftOver !== 0) {
        let chunk = Buffer.alloc(leftOver);
        this.received.copy(chunk, 0, this.readPos);
        this.received = chunk;
      } else {
        this.received = Buffer.alloc(0);
        dataLeftOver = false;
      }

      this.readPos = 0;

      if (plist) {
        await this.messageHandler.handleMessage(plist);
      }
    }
  }

  setTimelineEventHandler(timelineEventHandler) {
    this.timelineEventHandler = timelineEventHandler;
    this.messageHandler.setTimelineEventHandler(timelineEventHandler);
  }

  setConsoleLogEventHandler(consoleEventHandler) {
    this.consoleEventHandler = consoleEventHandler;
    this.messageHandler.setConsoleLogEventHandler(consoleEventHandler);
  }

  setNetworkLogEventHandler(networkEventHandler) {
    this.networkEventHandler = networkEventHandler;
    this.messageHandler.setNetworkEventHandler(networkEventHandler);
  }

}

exports.default = RemoteDebuggerRpcClient;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9yZW1vdGUtZGVidWdnZXItcnBjLWNsaWVudC5qcyJdLCJuYW1lcyI6WyJNSU5fUExBVEZPUk1fRk9SX1RBUkdFVF9CQVNFRCIsIlJlbW90ZURlYnVnZ2VyUnBjQ2xpZW50IiwiY29uc3RydWN0b3IiLCJvcHRzIiwicGxhdGZvcm1WZXJzaW9uIiwiaXNTYWZhcmkiLCJob3N0IiwicG9ydCIsIlJFTU9URV9ERUJVR0dFUl9QT1JUIiwic29ja2V0UGF0aCIsInNwZWNpYWxNZXNzYWdlSGFuZGxlcnMiLCJtZXNzYWdlUHJveHkiLCJzb2NrZXQiLCJjb25uZWN0ZWQiLCJjb25uSWQiLCJVVUlEIiwiY3JlYXRlIiwidG9TdHJpbmciLCJzZW5kZXJJZCIsIm1zZ0lkIiwicmVjZWl2ZWQiLCJCdWZmZXIiLCJhbGxvYyIsInJlYWRQb3MiLCJfIiwiaXNTdHJpbmciLCJwYXJzZUZsb2F0IiwiaXNUYXJnZXRCYXNlZCIsInJlbW90ZU1lc3NhZ2VzIiwiUmVtb3RlTWVzc2FnZXMiLCJtZXNzYWdlSGFuZGxlciIsIlJwY01lc3NhZ2VIYW5kbGVyIiwibG9nIiwiZGVidWciLCJjb25uZWN0IiwibmV0Iiwib25jZSIsIndyaXRlIiwiSlNPTiIsInN0cmluZ2lmeSIsIlNvY2tldCIsInR5cGUiLCJzZXROb0RlbGF5Iiwib24iLCJyZWNlaXZlIiwiYmluZCIsIkIiLCJyZXNvbHZlIiwicmVqZWN0IiwiZXJyIiwiZXJyb3IiLCJtZXNzYWdlIiwiZGlzY29ubmVjdCIsImlzQ29ubmVjdGVkIiwiZGVzdHJveSIsInNldFNwZWNpYWxNZXNzYWdlSGFuZGxlciIsImtleSIsImVycm9ySGFuZGxlciIsImhhbmRsZXIiLCJnZXRTcGVjaWFsTWVzc2FnZUhhbmRsZXIiLCJzZXREYXRhTWVzc2FnZUhhbmRsZXIiLCJhbGxvd05hdmlnYXRpb25XaXRob3V0UmVsb2FkIiwiYWxsb3ciLCJzZWxlY3RBcHAiLCJhcHBJZEtleSIsImFwcGxpY2F0aW9uQ29ubmVjdGVkSGFuZGxlciIsIm9uQXBwQ2hhbmdlIiwiZGljdCIsIm9sZEFwcElkS2V5IiwiV0lSSG9zdEFwcGxpY2F0aW9uSWRlbnRpZmllcktleSIsImNvcnJlY3RBcHBJZEtleSIsIldJUkFwcGxpY2F0aW9uSWRlbnRpZmllcktleSIsIkVycm9yIiwiY29ubmVjdGVkQXBwSWRLZXkiLCJwYWdlRGljdCIsInNlbmQiLCJpc0VtcHR5IiwibXNnIiwiZmluYWxseSIsImNvbW1hbmQiLCJvblNvY2tldEVycm9yIiwiZGVmYXVsdHMiLCJjbWQiLCJnZXRSZW1vdGVDb21tYW5kIiwic29ja2V0Q2IiLCJub29wIiwiZXhjZXB0aW9uIiwiaGFzU3BlY2lhbE1lc3NhZ2VIYW5kbGVyIiwiX19zZWxlY3RvciIsInNwZWNpYWxNZXNzYWdlSGFuZGxlciIsImFyZ3MiLCJ0cnVuY2F0ZSIsImxlbmd0aCIsIl9fYXJndW1lbnQiLCJXSVJTb2NrZXREYXRhS2V5IiwiY29kZSIsInZhbHVlIiwicGFyYW1zIiwiaWQiLCJ0YXJnZXRJZCIsInBhZ2VJZEtleSIsImZyb20iLCJwbGlzdCIsImUiLCJjb3JrIiwiYnVmZmVycGFjayIsInBhY2siLCJ1bmNvcmsiLCJpc0Z1bmN0aW9uIiwicmVtb3ZlTGlzdGVuZXIiLCJkYXRhIiwiY29uY2F0IiwiZGF0YUxlZnRPdmVyIiwib2xkUmVhZFBvcyIsInByZWZpeCIsInNsaWNlIiwibXNnTGVuZ3RoIiwidW5wYWNrIiwiYm9keSIsImJwbGlzdFBhcnNlciIsInBhcnNlQnVmZmVyIiwiaXNVbmRlZmluZWQiLCJsZWZ0T3ZlciIsImNodW5rIiwiY29weSIsImhhbmRsZU1lc3NhZ2UiLCJzZXRUaW1lbGluZUV2ZW50SGFuZGxlciIsInRpbWVsaW5lRXZlbnRIYW5kbGVyIiwic2V0Q29uc29sZUxvZ0V2ZW50SGFuZGxlciIsImNvbnNvbGVFdmVudEhhbmRsZXIiLCJzZXROZXR3b3JrTG9nRXZlbnRIYW5kbGVyIiwibmV0d29ya0V2ZW50SGFuZGxlciIsInNldE5ldHdvcmtFdmVudEhhbmRsZXIiXSwibWFwcGluZ3MiOiI7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S0FBaEI7QUFDRCxPQUxELE1BS087QUFFTCxhQUFLdkcsUUFBTCxHQUFnQkMsTUFBTSxDQUFDQyxLQUFQLENBQWEsQ0FBYixDQUFoQjtBQUNBMEYsUUFBQUEsWUFBWSxHQUFHLEtBQWY7QUFDRDs7QUFHRCxXQUFLekYsT0FBTCxHQUFlLENBQWY7O0FBR0EsVUFBSStFLEtBQUosRUFBVztBQUNULGNBQU0sS0FBS3hFLGNBQUwsQ0FBb0IrRixhQUFwQixDQUFrQ3ZCLEtBQWxDLENBQU47QUFDRDtBQUNGO0FBQ0Y7O0FBRUR3QixFQUFBQSx1QkFBdUIsQ0FBRUMsb0JBQUYsRUFBd0I7QUFDN0MsU0FBS0Esb0JBQUwsR0FBNEJBLG9CQUE1QjtBQUNBLFNBQUtqRyxjQUFMLENBQW9CZ0csdUJBQXBCLENBQTRDQyxvQkFBNUM7QUFDRDs7QUFFREMsRUFBQUEseUJBQXlCLENBQUVDLG1CQUFGLEVBQXVCO0FBQzlDLFNBQUtBLG1CQUFMLEdBQTJCQSxtQkFBM0I7QUFDQSxTQUFLbkcsY0FBTCxDQUFvQmtHLHlCQUFwQixDQUE4Q0MsbUJBQTlDO0FBQ0Q7O0FBRURDLEVBQUFBLHlCQUF5QixDQUFFQyxtQkFBRixFQUF1QjtBQUM5QyxTQUFLQSxtQkFBTCxHQUEyQkEsbUJBQTNCO0FBQ0EsU0FBS3JHLGNBQUwsQ0FBb0JzRyxzQkFBcEIsQ0FBMkNELG1CQUEzQztBQUNEOztBQXZZMEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgbG9nIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgYnBsaXN0Q3JlYXRlIGZyb20gJ2JwbGlzdC1jcmVhdG9yJztcbmltcG9ydCBicGxpc3RQYXJzZXIgZnJvbSAnYnBsaXN0LXBhcnNlcic7XG5pbXBvcnQgYnVmZmVycGFjayBmcm9tICdidWZmZXJwYWNrJztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCB7IFJFTU9URV9ERUJVR0dFUl9QT1JUIH0gZnJvbSAnLi9yZW1vdGUtZGVidWdnZXInO1xuaW1wb3J0IFVVSUQgZnJvbSAndXVpZC1qcyc7XG5pbXBvcnQgbmV0IGZyb20gJ25ldCc7XG5pbXBvcnQgUnBjTWVzc2FnZUhhbmRsZXIgZnJvbSAnLi9yZW1vdGUtZGVidWdnZXItbWVzc2FnZS1oYW5kbGVyJztcbmltcG9ydCBSZW1vdGVNZXNzYWdlcyBmcm9tICcuL3JlbW90ZS1tZXNzYWdlcyc7XG5cblxuY29uc3QgTUlOX1BMQVRGT1JNX0ZPUl9UQVJHRVRfQkFTRUQgPSAxMi4yO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBSZW1vdGVEZWJ1Z2dlclJwY0NsaWVudCB7XG4gIGNvbnN0cnVjdG9yIChvcHRzID0ge30pIHtcbiAgICBsZXQge1xuICAgICAgcGxhdGZvcm1WZXJzaW9uID0ge30sXG4gICAgICBpc1NhZmFyaSA9IHRydWUsXG4gICAgICBob3N0ID0gJzo6MScsXG4gICAgICBwb3J0ID0gUkVNT1RFX0RFQlVHR0VSX1BPUlQsXG4gICAgICBzb2NrZXRQYXRoLFxuICAgICAgc3BlY2lhbE1lc3NhZ2VIYW5kbGVycyA9IHt9LFxuICAgICAgbWVzc2FnZVByb3h5LFxuICAgIH0gPSBvcHRzO1xuXG4gICAgLy8gaG9zdC9wb3J0IGNvbmZpZyBmb3IgVENQIGNvbW11bmljYXRpb24sIHNvY2tldFBhdGggZm9yIHVuaXggZG9tYWluIHNvY2tldHNcbiAgICB0aGlzLmhvc3QgPSBob3N0O1xuICAgIHRoaXMucG9ydCA9IHBvcnQ7XG4gICAgdGhpcy5zb2NrZXRQYXRoID0gc29ja2V0UGF0aDtcbiAgICB0aGlzLm1lc3NhZ2VQcm94eSA9IG1lc3NhZ2VQcm94eTtcblxuICAgIHRoaXMuc29ja2V0ID0gbnVsbDtcbiAgICB0aGlzLmNvbm5lY3RlZCA9IGZhbHNlO1xuICAgIHRoaXMuY29ubklkID0gVVVJRC5jcmVhdGUoKS50b1N0cmluZygpO1xuICAgIHRoaXMuc2VuZGVySWQgPSBVVUlELmNyZWF0ZSgpLnRvU3RyaW5nKCk7XG4gICAgdGhpcy5tc2dJZCA9IDA7XG4gICAgdGhpcy5yZWNlaXZlZCA9IEJ1ZmZlci5hbGxvYygwKTtcbiAgICB0aGlzLnJlYWRQb3MgPSAwO1xuXG4gICAgLy8gbWVzc2FnZSBoYW5kbGVyc1xuICAgIHRoaXMuc3BlY2lhbE1lc3NhZ2VIYW5kbGVycyA9IHNwZWNpYWxNZXNzYWdlSGFuZGxlcnM7XG5cbiAgICAvLyBvbiBpT1MgMTIuMiB0aGUgbWVzc2FnZXMgZ2V0IHNlbnQgdGhyb3VnaCB0aGUgVGFyZ2V0IGRvbWFpblxuICAgIGlmIChfLmlzU3RyaW5nKHBsYXRmb3JtVmVyc2lvbikpIHtcbiAgICAgIHBsYXRmb3JtVmVyc2lvbiA9IHBhcnNlRmxvYXQocGxhdGZvcm1WZXJzaW9uKTtcbiAgICB9XG4gICAgY29uc3QgaXNUYXJnZXRCYXNlZCA9IGlzU2FmYXJpICYmIHBsYXRmb3JtVmVyc2lvbiA+PSBNSU5fUExBVEZPUk1fRk9SX1RBUkdFVF9CQVNFRDtcbiAgICB0aGlzLnJlbW90ZU1lc3NhZ2VzID0gbmV3IFJlbW90ZU1lc3NhZ2VzKGlzVGFyZ2V0QmFzZWQpO1xuICAgIHRoaXMubWVzc2FnZUhhbmRsZXIgPSBuZXcgUnBjTWVzc2FnZUhhbmRsZXIodGhpcy5zcGVjaWFsTWVzc2FnZUhhbmRsZXJzLCBpc1RhcmdldEJhc2VkKTtcbiAgICBsb2cuZGVidWcoYFVzaW5nICR7aXNUYXJnZXRCYXNlZCA/ICdUYXJnZXQtYmFzZWQnIDogJ2Z1bGwgV2ViIEluc3BlY3RvciBwcm90b2NvbCd9IGNvbW11bmljYXRpb25gKTtcbiAgfVxuXG4gIGFzeW5jIGNvbm5lY3QgKCkge1xuICAgIC8vIGNyZWF0ZSBzb2NrZXQgYW5kIGhhbmRsZSBpdHMgbWVzc2FnZXNcbiAgICBpZiAodGhpcy5zb2NrZXRQYXRoKSB7XG4gICAgICBpZiAodGhpcy5tZXNzYWdlUHJveHkpIHtcbiAgICAgICAgLy8gdW5peCBkb21haW4gc29ja2V0IHZpYSBwcm94eVxuICAgICAgICBsb2cuZGVidWcoYENvbm5lY3RpbmcgdG8gcmVtb3RlIGRlYnVnZ2VyIHZpYSBwcm94eSB0aHJvdWdoIHVuaXggZG9tYWluIHNvY2tldDogJyR7dGhpcy5tZXNzYWdlUHJveHl9J2ApO1xuICAgICAgICB0aGlzLnNvY2tldCA9IG5ldC5jb25uZWN0KHRoaXMubWVzc2FnZVByb3h5KTtcblxuICAgICAgICAvLyBGb3J3YXJkIHRoZSBhY3R1YWwgc29ja2V0UGF0aCB0byB0aGUgcHJveHlcbiAgICAgICAgdGhpcy5zb2NrZXQub25jZSgnY29ubmVjdCcsICgpID0+IHtcbiAgICAgICAgICBsb2cuZGVidWcoYEZvcndhcmRpbmcgdGhlIGFjdHVhbCB3ZWIgaW5zcGVjdG9yIHNvY2tldCB0byB0aGUgcHJveHk6ICcke3RoaXMuc29ja2V0UGF0aH0nYCk7XG4gICAgICAgICAgdGhpcy5zb2NrZXQud3JpdGUoSlNPTi5zdHJpbmdpZnkoe3NvY2tldFBhdGg6IHRoaXMuc29ja2V0UGF0aH0pKTtcbiAgICAgICAgfSk7XG5cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIHVuaXggZG9tYWluIHNvY2tldFxuICAgICAgICBsb2cuZGVidWcoYENvbm5lY3RpbmcgdG8gcmVtb3RlIGRlYnVnZ2VyIHRocm91Z2ggdW5peCBkb21haW4gc29ja2V0OiAnJHt0aGlzLnNvY2tldFBhdGh9J2ApO1xuICAgICAgICB0aGlzLnNvY2tldCA9IG5ldC5jb25uZWN0KHRoaXMuc29ja2V0UGF0aCk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmICh0aGlzLm1lc3NhZ2VQcm94eSkge1xuICAgICAgICAvLyBjb25uZWN0IHRvIHRoZSBwcm94eSBpbnN0ZWFkIG9mIHRoZSByZW1vdGUgZGVidWdnZXIgZGlyZWN0bHlcbiAgICAgICAgdGhpcy5wb3J0ID0gdGhpcy5tZXNzYWdlUHJveHk7XG4gICAgICB9XG5cbiAgICAgIC8vIHRjcCBzb2NrZXRcbiAgICAgIGxvZy5kZWJ1ZyhgQ29ubmVjdGluZyB0byByZW1vdGUgZGVidWdnZXIgJHt0aGlzLm1lc3NhZ2VQcm94eSA/ICd2aWEgcHJveHkgJyA6ICcnfXRocm91Z2ggVENQOiAke3RoaXMuaG9zdH06JHt0aGlzLnBvcnR9YCk7XG4gICAgICB0aGlzLnNvY2tldCA9IG5ldyBuZXQuU29ja2V0KHt0eXBlOiAndGNwNid9KTtcbiAgICAgIHRoaXMuc29ja2V0LmNvbm5lY3QodGhpcy5wb3J0LCB0aGlzLmhvc3QpO1xuICAgIH1cblxuICAgIHRoaXMuc29ja2V0LnNldE5vRGVsYXkodHJ1ZSk7XG4gICAgdGhpcy5zb2NrZXQub24oJ2Nsb3NlJywgKCkgPT4ge1xuICAgICAgaWYgKHRoaXMuY29ubmVjdGVkKSB7XG4gICAgICAgIGxvZy5kZWJ1ZygnRGVidWdnZXIgc29ja2V0IGRpc2Nvbm5lY3RlZCcpO1xuICAgICAgfVxuICAgICAgdGhpcy5jb25uZWN0ZWQgPSBmYWxzZTtcbiAgICAgIHRoaXMuc29ja2V0ID0gbnVsbDtcbiAgICB9KTtcbiAgICB0aGlzLnNvY2tldC5vbignZW5kJywgKCkgPT4ge1xuICAgICAgdGhpcy5jb25uZWN0ZWQgPSBmYWxzZTtcbiAgICB9KTtcbiAgICB0aGlzLnNvY2tldC5vbignZGF0YScsIHRoaXMucmVjZWl2ZS5iaW5kKHRoaXMpKTtcblxuICAgIC8vIGNvbm5lY3QgdGhlIHNvY2tldFxuICAgIHJldHVybiBhd2FpdCBuZXcgQigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAvLyBvbmx5IHJlc29sdmUgdGhpcyBmdW5jdGlvbiB3aGVuIHdlIGFyZSBhY3R1YWxseSBjb25uZWN0ZWRcbiAgICAgIHRoaXMuc29ja2V0Lm9uKCdjb25uZWN0JywgKCkgPT4ge1xuICAgICAgICBsb2cuZGVidWcoYERlYnVnZ2VyIHNvY2tldCBjb25uZWN0ZWRgKTtcbiAgICAgICAgdGhpcy5jb25uZWN0ZWQgPSB0cnVlO1xuXG4gICAgICAgIHJlc29sdmUoKTtcbiAgICAgIH0pO1xuICAgICAgdGhpcy5zb2NrZXQub24oJ2Vycm9yJywgKGVycikgPT4ge1xuICAgICAgICBpZiAodGhpcy5jb25uZWN0ZWQpIHtcbiAgICAgICAgICBsb2cuZXJyb3IoYFNvY2tldCBlcnJvcjogJHtlcnIubWVzc2FnZX1gKTtcbiAgICAgICAgICB0aGlzLmNvbm5lY3RlZCA9IGZhbHNlO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gdGhlIGNvbm5lY3Rpb24gd2FzIHJlZnVzZWQsIHNvIHJlamVjdCB0aGUgY29ubmVjdCBwcm9taXNlXG4gICAgICAgIHJlamVjdChlcnIpO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBkaXNjb25uZWN0ICgpIHsgLy8gZXNsaW50LWRpc2FibGUtbGluZSByZXF1aXJlLWF3YWl0XG4gICAgaWYgKHRoaXMuaXNDb25uZWN0ZWQoKSkge1xuICAgICAgbG9nLmRlYnVnKCdEaXNjb25uZWN0aW5nIGZyb20gcmVtb3RlIGRlYnVnZ2VyJyk7XG4gICAgICB0aGlzLnNvY2tldC5kZXN0cm95KCk7XG4gICAgfVxuICAgIHRoaXMuY29ubmVjdGVkID0gZmFsc2U7XG4gIH1cblxuICBpc0Nvbm5lY3RlZCAoKSB7XG4gICAgcmV0dXJuIHRoaXMuY29ubmVjdGVkO1xuICB9XG5cbiAgc2V0U3BlY2lhbE1lc3NhZ2VIYW5kbGVyIChrZXksIGVycm9ySGFuZGxlciwgaGFuZGxlcikge1xuICAgIHRoaXMubWVzc2FnZUhhbmRsZXIuc2V0U3BlY2lhbE1lc3NhZ2VIYW5kbGVyKGtleSwgZXJyb3JIYW5kbGVyLCBoYW5kbGVyKTtcbiAgfVxuXG4gIGdldFNwZWNpYWxNZXNzYWdlSGFuZGxlciAoa2V5KSB7XG4gICAgcmV0dXJuIHRoaXMubWVzc2FnZUhhbmRsZXIuZ2V0U3BlY2lhbE1lc3NhZ2VIYW5kbGVyKGtleSk7XG4gIH1cblxuICBzZXREYXRhTWVzc2FnZUhhbmRsZXIgKGtleSwgZXJyb3JIYW5kbGVyLCBoYW5kbGVyKSB7XG4gICAgdGhpcy5tZXNzYWdlSGFuZGxlci5zZXREYXRhTWVzc2FnZUhhbmRsZXIoa2V5LCBlcnJvckhhbmRsZXIsIGhhbmRsZXIpO1xuICB9XG5cbiAgYWxsb3dOYXZpZ2F0aW9uV2l0aG91dFJlbG9hZCAoYWxsb3cgPSB0cnVlKSB7XG4gICAgdGhpcy5tZXNzYWdlSGFuZGxlci5hbGxvd05hdmlnYXRpb25XaXRob3V0UmVsb2FkKGFsbG93KTtcbiAgfVxuXG4gIGFzeW5jIHNlbGVjdEFwcCAoYXBwSWRLZXksIGFwcGxpY2F0aW9uQ29ubmVjdGVkSGFuZGxlcikge1xuICAgIHJldHVybiBhd2FpdCBuZXcgQigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAvLyBsb2NhbCBjYWxsYmFjaywgdGVtcG9yYXJpbHkgYWRkZWQgYXMgY2FsbGJhY2sgdG9cbiAgICAgIC8vIGBfcnBjX2FwcGxpY2F0aW9uQ29ubmVjdGVkOmAgcmVtb3RlIGRlYnVnZ2VyIHJlc3BvbnNlXG4gICAgICAvLyB0byBoYW5kbGUgdGhlIGluaXRpYWwgY29ubmVjdGlvblxuICAgICAgbGV0IG9uQXBwQ2hhbmdlID0gKGRpY3QpID0+IHtcbiAgICAgICAgLy8gZnJvbSB0aGUgZGljdGlvbmFyeSByZXR1cm5lZCwgZ2V0IHRoZSBpZHNcbiAgICAgICAgbGV0IG9sZEFwcElkS2V5ID0gZGljdC5XSVJIb3N0QXBwbGljYXRpb25JZGVudGlmaWVyS2V5O1xuICAgICAgICBsZXQgY29ycmVjdEFwcElkS2V5ID0gZGljdC5XSVJBcHBsaWNhdGlvbklkZW50aWZpZXJLZXk7XG5cbiAgICAgICAgLy8gaWYgdGhpcyBpcyBhIHJlcG9ydCBvZiBhIHByb3h5IHJlZGlyZWN0IGZyb20gdGhlIHJlbW90ZSBkZWJ1Z2dlclxuICAgICAgICAvLyB3ZSB3YW50IHRvIHVwZGF0ZSBvdXIgZGljdGlvbmFyeSBhbmQgZ2V0IGEgbmV3IGFwcCBpZFxuICAgICAgICBpZiAob2xkQXBwSWRLZXkgJiYgY29ycmVjdEFwcElkS2V5ICE9PSBvbGRBcHBJZEtleSkge1xuICAgICAgICAgIGxvZy5kZWJ1ZyhgV2Ugd2VyZSBub3RpZmllZCB3ZSBtaWdodCBoYXZlIGNvbm5lY3RlZCB0byB0aGUgd3JvbmcgYXBwLiBgICtcbiAgICAgICAgICAgICAgICAgICAgYFVzaW5nIGlkICR7Y29ycmVjdEFwcElkS2V5fSBpbnN0ZWFkIG9mICR7b2xkQXBwSWRLZXl9YCk7XG4gICAgICAgIH1cblxuICAgICAgICBhcHBsaWNhdGlvbkNvbm5lY3RlZEhhbmRsZXIoZGljdCk7XG4gICAgICAgIHJlamVjdChuZXcgRXJyb3IoJ05ldyBhcHBsaWNhdGlvbiBoYXMgY29ubmVjdGVkJykpO1xuICAgICAgfTtcbiAgICAgIHRoaXMuc2V0U3BlY2lhbE1lc3NhZ2VIYW5kbGVyKCdfcnBjX2FwcGxpY2F0aW9uQ29ubmVjdGVkOicsIHJlamVjdCwgb25BcHBDaGFuZ2UpO1xuXG4gICAgICAvLyBkbyB0aGUgYWN0dWFsIGNvbm5lY3RpbmcgdG8gdGhlIGFwcFxuICAgICAgcmV0dXJuIChhc3luYyAoKSA9PiB7XG4gICAgICAgIGxldCBbY29ubmVjdGVkQXBwSWRLZXksIHBhZ2VEaWN0XSA9IGF3YWl0IHRoaXMuc2VuZCgnY29ubmVjdFRvQXBwJywge1xuICAgICAgICAgIGFwcElkS2V5XG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIHNvbWV0aW1lcyB0aGUgY29ubmVjdCBsb2dpYyBoYXBwZW5zLCBidXQgd2l0aCBhbiBlbXB0eSBkaWN0aW9uYXJ5XG4gICAgICAgIC8vIHdoaWNoIGxlYWRzIHRvIHRoZSByZW1vdGUgZGVidWdnZXIgZ2V0dGluZyBkaXNjb25uZWN0ZWQsIGFuZCBpbnRvIGEgbG9vcFxuICAgICAgICBpZiAoXy5pc0VtcHR5KHBhZ2VEaWN0KSkge1xuICAgICAgICAgIGxldCBtc2cgPSAnRW1wdHkgcGFnZSBkaWN0aW9uYXJ5IHJlY2VpdmVkJztcbiAgICAgICAgICBsb2cuZGVidWcobXNnKTtcbiAgICAgICAgICByZWplY3QobmV3IEVycm9yKG1zZykpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJlc29sdmUoW2Nvbm5lY3RlZEFwcElkS2V5LCBwYWdlRGljdF0pO1xuICAgICAgICB9XG4gICAgICB9KSgpO1xuICAgIH0pLmZpbmFsbHkoKCkgPT4ge1xuICAgICAgLy8gbm8gbWF0dGVyIHdoYXQsIHdlIHdhbnQgdG8gcmVzdG9yZSB0aGUgaGFuZGxlciB0aGF0IHdhcyBjaGFuZ2VkLlxuICAgICAgdGhpcy5zZXRTcGVjaWFsTWVzc2FnZUhhbmRsZXIoJ19ycGNfYXBwbGljYXRpb25Db25uZWN0ZWQ6JywgbnVsbCwgYXBwbGljYXRpb25Db25uZWN0ZWRIYW5kbGVyKTtcbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIHNlbmQgKGNvbW1hbmQsIG9wdHMgPSB7fSkge1xuICAgIC8vIGVycm9yIGxpc3RlbmVyLCB3aGljaCBuZWVkcyB0byBiZSByZW1vdmVkIGFmdGVyIHRoZSBwcm9taXNlIGlzIHJlc29sdmVkXG4gICAgbGV0IG9uU29ja2V0RXJyb3I7XG5cbiAgICByZXR1cm4gYXdhaXQgbmV3IEIoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgLy8gcHJvbWlzZSB0byBiZSByZXNvbHZlZCB3aGVuZXZlciByZW1vdGUgZGVidWdnZXJcbiAgICAgIC8vIHJlcGxpZXMgdG8gb3VyIHJlcXVlc3RcblxuICAgICAgLy8ga2VlcCB0cmFjayBvZiB0aGUgbWVzc2FnZXMgY29taW5nIGFuZCBnb2luZyB1c2luZyBhIHNpbXBsZSBzZXF1ZW50aWFsIGlkXG4gICAgICBjb25zdCBtc2dJZCA9IHRoaXMubXNnSWQrKztcblxuICAgICAgLy8gcmV0cmlldmUgdGhlIGNvcnJlY3QgY29tbWFuZCB0byBzZW5kXG4gICAgICBvcHRzID0gXy5kZWZhdWx0cyh7Y29ubklkOiB0aGlzLmNvbm5JZCwgc2VuZGVySWQ6IHRoaXMuc2VuZGVySWR9LCBvcHRzKTtcbiAgICAgIGNvbnN0IGNtZCA9IHRoaXMucmVtb3RlTWVzc2FnZXMuZ2V0UmVtb3RlQ29tbWFuZChjb21tYW5kLCBvcHRzKTtcblxuICAgICAgLy8gbW9zdCBvZiB0aGUgdGltZSB3ZSBkb24ndCBjYXJlIHdoZW4gc29ja2V0LndyaXRlIGRvZXNcbiAgICAgIC8vIHNvIGdpdmUgaXQgYW4gZW1wdHkgZnVuY3Rpb25cbiAgICAgIGxldCBzb2NrZXRDYiA9IF8ubm9vcDtcblxuICAgICAgLy8gaGFuZGxlIHNvY2tldCBwcm9ibGVtc1xuICAgICAgb25Tb2NrZXRFcnJvciA9IChleGNlcHRpb24pID0+IHtcbiAgICAgICAgaWYgKHRoaXMuY29ubmVjdGVkKSB7XG4gICAgICAgICAgbG9nLmVycm9yKGBTb2NrZXQgZXJyb3I6ICR7ZXhjZXB0aW9uLm1lc3NhZ2V9YCk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyB0aGUgY29ubmVjdGlvbiB3YXMgcmVmdXNlZCwgc28gcmVqZWN0IHRoZSBjb25uZWN0IHByb21pc2VcbiAgICAgICAgcmVqZWN0KGV4Y2VwdGlvbik7XG4gICAgICB9O1xuICAgICAgdGhpcy5zb2NrZXQub24oJ2Vycm9yJywgb25Tb2NrZXRFcnJvcik7XG5cbiAgICAgIGlmICh0aGlzLm1lc3NhZ2VIYW5kbGVyLmhhc1NwZWNpYWxNZXNzYWdlSGFuZGxlcihjbWQuX19zZWxlY3RvcikpIHtcbiAgICAgICAgLy8gc3BlY2lhbCByZXBsaWVzIHdpbGwgcmV0dXJuIGFueSBudW1iZXIgb2YgYXJndW1lbnRzXG4gICAgICAgIC8vIHRlbXBvcmFyaWx5IHdyYXAgd2l0aCBwcm9taXNlIGhhbmRsaW5nXG4gICAgICAgIGNvbnN0IHNwZWNpYWxNZXNzYWdlSGFuZGxlciA9IHRoaXMuZ2V0U3BlY2lhbE1lc3NhZ2VIYW5kbGVyKGNtZC5fX3NlbGVjdG9yKTtcbiAgICAgICAgdGhpcy5zZXRTcGVjaWFsTWVzc2FnZUhhbmRsZXIoY21kLl9fc2VsZWN0b3IsIHJlamVjdCwgZnVuY3Rpb24gKC4uLmFyZ3MpIHtcbiAgICAgICAgICBsb2cuZGVidWcoYFJlY2VpdmVkIHJlc3BvbnNlIGZyb20gc29ja2V0IHNlbmQ6ICcke18udHJ1bmNhdGUoSlNPTi5zdHJpbmdpZnkoYXJncyksIHtsZW5ndGg6IDUwfSl9J2ApO1xuXG4gICAgICAgICAgLy8gY2FsbCB0aGUgb3JpZ2luYWwgbGlzdGVuZXIsIGFuZCBwdXQgaXQgYmFjaywgaWYgbmVjZXNzYXJ5XG4gICAgICAgICAgc3BlY2lhbE1lc3NhZ2VIYW5kbGVyKC4uLmFyZ3MpO1xuICAgICAgICAgIGlmICh0aGlzLm1lc3NhZ2VIYW5kbGVyLmhhc1NwZWNpYWxNZXNzYWdlSGFuZGxlcihjbWQuX19zZWxlY3RvcikpIHtcbiAgICAgICAgICAgIC8vIHRoaXMgbWVhbnMgdGhhdCB0aGUgc3lzdGVtIGhhcyBub3QgcmVtb3ZlZCB0aGlzIGxpc3RlbmVyXG4gICAgICAgICAgICB0aGlzLnNldFNwZWNpYWxNZXNzYWdlSGFuZGxlcihjbWQuX19zZWxlY3RvciwgbnVsbCwgc3BlY2lhbE1lc3NhZ2VIYW5kbGVyKTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICByZXNvbHZlKGFyZ3MpO1xuICAgICAgICB9LmJpbmQodGhpcykpO1xuICAgICAgfSBlbHNlIGlmIChjbWQuX19hcmd1bWVudCAmJiBjbWQuX19hcmd1bWVudC5XSVJTb2NrZXREYXRhS2V5KSB7XG4gICAgICAgIGNvbnN0IGVycm9ySGFuZGxlciA9IGZ1bmN0aW9uIChlcnIpIHtcbiAgICAgICAgICBjb25zdCBtc2cgPSBgUmVtb3RlIGRlYnVnZ2VyIGVycm9yIHdpdGggY29kZSAnJHtlcnIuY29kZX0nOiAke2Vyci5tZXNzYWdlfWA7XG4gICAgICAgICAgcmVqZWN0KG5ldyBFcnJvcihtc2cpKTtcbiAgICAgICAgfTtcblxuICAgICAgICB0aGlzLnNldERhdGFNZXNzYWdlSGFuZGxlcihtc2dJZC50b1N0cmluZygpLCBlcnJvckhhbmRsZXIsIGZ1bmN0aW9uICh2YWx1ZSkge1xuICAgICAgICAgIGNvbnN0IG1zZyA9IF8udHJ1bmNhdGUoXy5pc1N0cmluZyh2YWx1ZSkgPyB2YWx1ZSA6IEpTT04uc3RyaW5naWZ5KHZhbHVlKSwge2xlbmd0aDogNTB9KTtcbiAgICAgICAgICBsb2cuZGVidWcoYFJlY2VpdmVkIGRhdGEgcmVzcG9uc2UgZnJvbSBzb2NrZXQgc2VuZDogJyR7bXNnfSdgKTtcbiAgICAgICAgICBsb2cuZGVidWcoYE9yaWdpbmFsIGNvbW1hbmQ6ICR7Y29tbWFuZH1gKTtcbiAgICAgICAgICByZXNvbHZlKHZhbHVlKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gbWFrZSBzdXJlIHRoZSBtZXNzYWdlIGJlaW5nIHNlbnQgaGFzIGFsbCB0aGUgaW5mb3JtYXRpb24gdGhhdCBpcyBuZWVkZWRcbiAgICAgICAgaWYgKGNtZC5fX2FyZ3VtZW50LldJUlNvY2tldERhdGFLZXkucGFyYW1zKSB7XG4gICAgICAgICAgY21kLl9fYXJndW1lbnQuV0lSU29ja2V0RGF0YUtleS5wYXJhbXMuaWQgPSBtc2dJZDtcbiAgICAgICAgICBpZiAoIWNtZC5fX2FyZ3VtZW50LldJUlNvY2tldERhdGFLZXkucGFyYW1zLnRhcmdldElkKSB7XG4gICAgICAgICAgICBjbWQuX19hcmd1bWVudC5XSVJTb2NrZXREYXRhS2V5LnBhcmFtcy50YXJnZXRJZCA9IGBwYWdlLSR7b3B0cy5wYWdlSWRLZXl9YDtcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKGNtZC5fX2FyZ3VtZW50LldJUlNvY2tldERhdGFLZXkucGFyYW1zLm1lc3NhZ2UpIHtcbiAgICAgICAgICAgIGNtZC5fX2FyZ3VtZW50LldJUlNvY2tldERhdGFLZXkucGFyYW1zLm1lc3NhZ2UuaWQgPSBtc2dJZDtcbiAgICAgICAgICAgIGNtZC5fX2FyZ3VtZW50LldJUlNvY2tldERhdGFLZXkucGFyYW1zLm1lc3NhZ2UgPSBKU09OLnN0cmluZ2lmeShjbWQuX19hcmd1bWVudC5XSVJTb2NrZXREYXRhS2V5LnBhcmFtcy5tZXNzYWdlKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgY21kLl9fYXJndW1lbnQuV0lSU29ja2V0RGF0YUtleS5pZCA9IG1zZ0lkO1xuICAgICAgICBjbWQuX19hcmd1bWVudC5XSVJTb2NrZXREYXRhS2V5ID1cbiAgICAgICAgICBCdWZmZXIuZnJvbShKU09OLnN0cmluZ2lmeShjbWQuX19hcmd1bWVudC5XSVJTb2NrZXREYXRhS2V5KSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyB3ZSB3YW50IHRvIGltbWVkaWF0ZWx5IHJlc29sdmUgdGhpcyBzb2NrZXQud3JpdGVcbiAgICAgICAgLy8gYW55IGxvbmcgdGVybSBjYWxsYmFja3Mgd2lsbCBkbyB0aGVpciBidXNpbmVzcyBpbiB0aGUgYmFja2dyb3VuZFxuICAgICAgICBzb2NrZXRDYiA9IHJlc29sdmU7XG4gICAgICB9XG5cbiAgICAgIGxvZy5kZWJ1ZyhgU2VuZGluZyAnJHtjbWQuX19zZWxlY3Rvcn0nIG1lc3NhZ2UgdG8gcmVtb3RlIGRlYnVnZ2VyIChpZDogJHttc2dJZH0pYCk7XG5cbiAgICAgIC8vIHJlbW90ZSBkZWJ1Z2dlciBleHBlY3RzIGEgYmluYXJ5IHBsaXN0IGFzIGRhdGFcbiAgICAgIGxldCBwbGlzdDtcbiAgICAgIHRyeSB7XG4gICAgICAgIHBsaXN0ID0gYnBsaXN0Q3JlYXRlKGNtZCk7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGxldCBtc2cgPSBgQ291bGQgbm90IGNyZWF0ZSBiaW5hcnkgcGxpc3QgZnJvbSBkYXRhOiAke2UubWVzc2FnZX1gO1xuICAgICAgICBsb2cuZXJyb3IobXNnKTtcbiAgICAgICAgcmV0dXJuIHJlamVjdChuZXcgRXJyb3IobXNnKSk7XG4gICAgICB9XG5cbiAgICAgIGlmICh0aGlzLnNvY2tldCAmJiB0aGlzLmNvbm5lY3RlZCkge1xuICAgICAgICAvLyBjb3JrIGFuZCB1bmNvcmsgaW4gb3JkZXIgdG8gbm90IGJ1ZmZlciB0aGUgd3JpdGVcbiAgICAgICAgLy8gb24gc29tZSBzeXN0ZW1zIHRoaXMgaXMgbmVjZXNzYXJ5IG9yIHRoZSBzZXJ2ZXJcbiAgICAgICAgLy8gZ2V0cyBjb25mdXNlZC5cbiAgICAgICAgdGhpcy5zb2NrZXQuY29yaygpO1xuICAgICAgICB0cnkge1xuICAgICAgICAgIHRoaXMuc29ja2V0LndyaXRlKGJ1ZmZlcnBhY2sucGFjaygnTCcsIFtwbGlzdC5sZW5ndGhdKSk7XG4gICAgICAgICAgdGhpcy5zb2NrZXQud3JpdGUocGxpc3QsIHNvY2tldENiKTtcbiAgICAgICAgfSBmaW5hbGx5IHtcbiAgICAgICAgICB0aGlzLnNvY2tldC51bmNvcmsoKTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbGV0IG1zZyA9ICdBdHRlbXB0ZWQgdG8gd3JpdGUgZGF0YSB0byBzb2NrZXQgYWZ0ZXIgaXQgd2FzIGNsb3NlZCEnO1xuICAgICAgICBsb2cuZXJyb3IobXNnKTtcbiAgICAgICAgcmVqZWN0KG5ldyBFcnJvcihtc2cpKTtcbiAgICAgIH1cbiAgICB9KVxuICAgIC5maW5hbGx5KCgpID0+IHtcbiAgICAgIC8vIHJlbW92ZSB0aGlzIGxpc3RlbmVyLCBzbyB3ZSBkb24ndCBleGhhdXN0IHRoZSBzeXN0ZW1cbiAgICAgIGlmIChfLmlzRnVuY3Rpb24ob25Tb2NrZXRFcnJvcikpIHtcbiAgICAgICAgdGhpcy5zb2NrZXQucmVtb3ZlTGlzdGVuZXIoJ2Vycm9yJywgb25Tb2NrZXRFcnJvcik7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBhc3luYyByZWNlaXZlIChkYXRhKSB7XG4gICAgLy8gQXBwZW5kIHRoaXMgbmV3IGRhdGEgdG8gdGhlIGV4aXN0aW5nIEJ1ZmZlclxuICAgIHRoaXMucmVjZWl2ZWQgPSBCdWZmZXIuY29uY2F0KFt0aGlzLnJlY2VpdmVkLCBkYXRhXSk7XG4gICAgbGV0IGRhdGFMZWZ0T3ZlciA9IHRydWU7XG5cbiAgICAvLyBQYXJzZSBtdWx0aXBsZSBtZXNzYWdlcyBpbiB0aGUgc2FtZSBwYWNrZXRcbiAgICB3aGlsZSAoZGF0YUxlZnRPdmVyKSB7XG4gICAgICAvLyBTdG9yZSBhIHJlZmVyZW5jZSB0byB3aGVyZSB3ZSB3ZXJlXG4gICAgICBjb25zdCBvbGRSZWFkUG9zID0gdGhpcy5yZWFkUG9zO1xuXG4gICAgICAvLyBSZWFkIHRoZSBwcmVmaXggKHBsaXN0IGxlbmd0aCkgdG8gc2VlIGhvdyBmYXIgdG8gcmVhZCBuZXh0XG4gICAgICAvLyBJdCdzIGFsd2F5cyA0IGJ5dGVzIGxvbmdcbiAgICAgIGNvbnN0IHByZWZpeCA9IHRoaXMucmVjZWl2ZWQuc2xpY2UodGhpcy5yZWFkUG9zLCB0aGlzLnJlYWRQb3MgKyA0KTtcbiAgICAgIGlmIChfLmlzRW1wdHkocHJlZml4KSkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIGxldCBtc2dMZW5ndGg7XG4gICAgICB0cnkge1xuICAgICAgICBtc2dMZW5ndGggPSBidWZmZXJwYWNrLnVucGFjaygnTCcsIHByZWZpeClbMF07XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgbG9nLmVycm9yKGBCdWZmZXIgY291bGQgbm90IHVucGFjazogJHtlcnJ9YCk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgLy8gSnVtcCBmb3J3YXJkIDQgYnl0ZXNcbiAgICAgIHRoaXMucmVhZFBvcyArPSA0O1xuXG4gICAgICAvLyBJcyB0aGVyZSBlbm91Z2ggZGF0YSBoZXJlP1xuICAgICAgLy8gSWYgbm90LCBqdW1wIGJhY2sgdG8gb3VyIG9yaWdpbmFsIHBvc2l0aW9uIGFuZCBndGZvXG4gICAgICBpZiAodGhpcy5yZWNlaXZlZC5sZW5ndGggPCBtc2dMZW5ndGggKyB0aGlzLnJlYWRQb3MpIHtcbiAgICAgICAgdGhpcy5yZWFkUG9zID0gb2xkUmVhZFBvcztcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG5cbiAgICAgIC8vIEV4dHJhY3QgdGhlIG1haW4gYm9keSBvZiB0aGUgbWVzc2FnZSAod2hlcmUgdGhlIHBsaXN0IHNob3VsZCBiZSlcbiAgICAgIGNvbnN0IGJvZHkgPSB0aGlzLnJlY2VpdmVkLnNsaWNlKHRoaXMucmVhZFBvcywgbXNnTGVuZ3RoICsgdGhpcy5yZWFkUG9zKTtcblxuICAgICAgLy8gRXh0cmFjdCB0aGUgcGxpc3RcbiAgICAgIGxldCBwbGlzdDtcbiAgICAgIHRyeSB7XG4gICAgICAgIHBsaXN0ID0gYnBsaXN0UGFyc2VyLnBhcnNlQnVmZmVyKGJvZHkpO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBsb2cuZXJyb3IoYEVycm9yIHBhcnNpbmcgYmluYXJ5IHBsaXN0OiAke2V9YCk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgLy8gYnBsaXN0UGFyc2VyLnBhcnNlQnVmZmVyIHJldHVybnMgYW4gYXJyYXlcbiAgICAgIGlmIChwbGlzdC5sZW5ndGggPT09IDEpIHtcbiAgICAgICAgcGxpc3QgPSBwbGlzdFswXTtcbiAgICAgIH1cblxuICAgICAgZm9yIChjb25zdCBrZXkgb2YgWydXSVJNZXNzYWdlRGF0YUtleScsICdXSVJEZXN0aW5hdGlvbktleScsICdXSVJTb2NrZXREYXRhS2V5J10pIHtcbiAgICAgICAgaWYgKCFfLmlzVW5kZWZpbmVkKHBsaXN0W2tleV0pKSB7XG4gICAgICAgICAgcGxpc3Rba2V5XSA9IHBsaXN0W2tleV0udG9TdHJpbmcoJ3V0ZjgnKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICAvLyBKdW1wIGZvcndhcmQgdGhlIGxlbmd0aCBvZiB0aGUgcGxpc3RcbiAgICAgIHRoaXMucmVhZFBvcyArPSBtc2dMZW5ndGg7XG5cbiAgICAgIC8vIENhbGN1bGF0ZSBob3cgbXVjaCBidWZmZXIgaXMgbGVmdFxuICAgICAgbGV0IGxlZnRPdmVyID0gdGhpcy5yZWNlaXZlZC5sZW5ndGggLSB0aGlzLnJlYWRQb3M7XG5cbiAgICAgIC8vIElzIHRoZXJlIHNvbWUgbGVmdCBvdmVyP1xuICAgICAgaWYgKGxlZnRPdmVyICE9PSAwKSB7XG4gICAgICAgIC8vIENvcHkgd2hhdCdzIGxlZnQgb3ZlciBpbnRvIGEgbmV3IGJ1ZmZlciwgYW5kIHNhdmUgaXQgZm9yIG5leHQgdGltZVxuICAgICAgICBsZXQgY2h1bmsgPSBCdWZmZXIuYWxsb2MobGVmdE92ZXIpO1xuICAgICAgICB0aGlzLnJlY2VpdmVkLmNvcHkoY2h1bmssIDAsIHRoaXMucmVhZFBvcyk7XG4gICAgICAgIHRoaXMucmVjZWl2ZWQgPSBjaHVuaztcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIE90aGVyd2lzZSwgZW1wdHkgdGhlIGJ1ZmZlciBhbmQgZ2V0IG91dCBvZiB0aGUgbG9vcFxuICAgICAgICB0aGlzLnJlY2VpdmVkID0gQnVmZmVyLmFsbG9jKDApO1xuICAgICAgICBkYXRhTGVmdE92ZXIgPSBmYWxzZTtcbiAgICAgIH1cblxuICAgICAgLy8gUmVzZXQgdGhlIHJlYWQgcG9zaXRpb25cbiAgICAgIHRoaXMucmVhZFBvcyA9IDA7XG5cbiAgICAgIC8vIE5vdyBkbyBzb21ldGhpbmcgd2l0aCB0aGUgcGxpc3RcbiAgICAgIGlmIChwbGlzdCkge1xuICAgICAgICBhd2FpdCB0aGlzLm1lc3NhZ2VIYW5kbGVyLmhhbmRsZU1lc3NhZ2UocGxpc3QpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHNldFRpbWVsaW5lRXZlbnRIYW5kbGVyICh0aW1lbGluZUV2ZW50SGFuZGxlcikge1xuICAgIHRoaXMudGltZWxpbmVFdmVudEhhbmRsZXIgPSB0aW1lbGluZUV2ZW50SGFuZGxlcjtcbiAgICB0aGlzLm1lc3NhZ2VIYW5kbGVyLnNldFRpbWVsaW5lRXZlbnRIYW5kbGVyKHRpbWVsaW5lRXZlbnRIYW5kbGVyKTtcbiAgfVxuXG4gIHNldENvbnNvbGVMb2dFdmVudEhhbmRsZXIgKGNvbnNvbGVFdmVudEhhbmRsZXIpIHtcbiAgICB0aGlzLmNvbnNvbGVFdmVudEhhbmRsZXIgPSBjb25zb2xlRXZlbnRIYW5kbGVyO1xuICAgIHRoaXMubWVzc2FnZUhhbmRsZXIuc2V0Q29uc29sZUxvZ0V2ZW50SGFuZGxlcihjb25zb2xlRXZlbnRIYW5kbGVyKTtcbiAgfVxuXG4gIHNldE5ldHdvcmtMb2dFdmVudEhhbmRsZXIgKG5ldHdvcmtFdmVudEhhbmRsZXIpIHtcbiAgICB0aGlzLm5ldHdvcmtFdmVudEhhbmRsZXIgPSBuZXR3b3JrRXZlbnRIYW5kbGVyO1xuICAgIHRoaXMubWVzc2FnZUhhbmRsZXIuc2V0TmV0d29ya0V2ZW50SGFuZGxlcihuZXR3b3JrRXZlbnRIYW5kbGVyKTtcbiAgfVxufVxuIl0sImZpbGUiOiJsaWIvcmVtb3RlLWRlYnVnZ2VyLXJwYy1jbGllbnQuanMiLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
