"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _logger = _interopRequireDefault(require("./logger"));

var _lodash = _interopRequireDefault(require("lodash"));

const IGNORED_EVENTS = ['Page.domContentEventFired', 'Page.frameStartedLoading', 'Page.frameStoppedLoading', 'Page.frameScheduledNavigation', 'Page.frameClearedScheduledNavigation', 'Console.messagesCleared'];

class RpcMessageHandler {
  constructor(specialHandlers, isTargetBased = false) {
    this.setHandlers();
    this.errorHandlers = {};
    this.specialHandlers = _lodash.default.clone(specialHandlers);
    this.dataHandlers = {};
    this.willNavigateWithoutReload = false;
    this.isTargetBased = isTargetBased;
  }

  setDataMessageHandler(key, errorHandler, handler) {
    this.errorHandlers[key] = errorHandler;
    this.dataHandlers[key] = handler;
  }

  setSpecialMessageHandler(key, errorHandler, handler) {
    this.errorHandlers[key] = errorHandler;
    this.specialHandlers[key] = handler;
  }

  getSpecialMessageHandler(key) {
    return this.specialHandlers[key];
  }

  setTimelineEventHandler(timelineEventHandler) {
    this.timelineEventHandler = timelineEventHandler;
  }

  setConsoleLogEventHandler(consoleLogEventHandler) {
    this.consoleLogEventHandler = consoleLogEventHandler;
  }

  setNetworkEventHandler(networkLogEventHandler) {
    this.networkLogEventHandler = networkLogEventHandler;
  }

  hasErrorHandler(key) {
    return _lodash.default.has(this.errorHandlers, key);
  }

  hasSpecialMessageHandler(key) {
    return _lodash.default.has(this.specialHandlers, key);
  }

  allowNavigationWithoutReload(allow = true) {
    this.willNavigateWithoutReload = allow;
  }

  async handleMessage(plist) {
    const selector = plist.__selector;

    if (!selector) {
      _logger.default.debug('Got an invalid plist');

      return;
    }

    if (_lodash.default.has(this.handlers, selector)) {
      await this.handlers[selector](plist);
    } else {
      _logger.default.debug(`Debugger got a message for '${selector}' and have no ` + `handler, doing nothing.`);
    }
  }

  async handleSpecialMessage(handler, ...args) {
    const fn = this.specialHandlers[handler];

    if (fn) {
      if (handler !== '_rpc_forwardGetListing:' && handler !== '_rpc_applicationDisconnected:' && handler !== '_rpc_applicationConnected:' && handler !== '_rpc_applicationUpdated:' && handler !== '_rpc_reportConnectedDriverList:') {
        this.specialHandlers[handler] = null;
      }

      await fn(...args);
    } else {
      _logger.default.warn(`Tried to access special message handler '${handler}' ` + `but none was found`);
    }
  }

  parseDataKey(plist) {
    try {
      return JSON.parse(plist.__argument.WIRMessageDataKey.toString('utf8'));
    } catch (err) {
      _logger.default.error(`Unparseable message data: ${_lodash.default.truncate(JSON.stringify(plist), {
        length: 100
      })}`);

      throw new Error(`Unable to parse message data: ${err.message}`);
    }
  }

  async dispatchDataMessage(msgId, method, params, result, error) {
    if (method === 'Profiler.resetProfiles') {
      _logger.default.debug('Device is telling us to reset profiles. Should probably ' + 'do some kind of callback here');
    } else if (method === 'Page.frameNavigated') {
      if (!this.willNavigateWithoutReload && !this.pageLoading) {
        _logger.default.debug('Frame navigated, unloading page');

        if (_lodash.default.isFunction(this.specialHandlers['Page.frameNavigated'])) {
          await this.specialHandlers['Page.frameNavigated']('remote-debugger');
          this.specialHandlers['Page.frameNavigated'] = null;
        }
      } else {
        _logger.default.debug('Frame navigated but we were warned about it, not ' + 'considering page state unloaded');

        this.willNavigateWithoutReload = false;
      }
    } else if (IGNORED_EVENTS.includes(method)) {} else if (method === 'Page.loadEventFired' && _lodash.default.isFunction(this.specialHandlers.pageLoad)) {
      await this.specialHandlers.pageLoad();
    } else if (method === 'Page.frameDetached' && _lodash.default.isFunction(this.specialHandlers.frameDetached)) {
      await this.specialHandlers.frameDetached();
    } else if (method === 'Timeline.eventRecorded' && _lodash.default.isFunction(this.timelineEventHandler)) {
      this.timelineEventHandler(params || params.record);
    } else if (method === 'Console.messageAdded' && _lodash.default.isFunction(this.consoleLogEventHandler)) {
      this.consoleLogEventHandler(params.message);
    } else if (method && method.startsWith('Network.') && _lodash.default.isFunction(this.networkLogEventHandler)) {
      this.networkLogEventHandler(method, params);
    } else if (_lodash.default.isFunction(this.dataHandlers[msgId])) {
      _logger.default.debug('Found data handler for response');

      if (result.result && result.result.value) {
        result = result.result.value;
      }

      this.dataHandlers[msgId](result);
      this.dataHandlers[msgId] = null;
    } else if (this.dataHandlers[msgId] === null) {
      _logger.default.error(`Debugger returned data for message ${msgId} ` + `but we already ran that callback! WTF??`);
    } else {
      if (msgId || result || error) {
        _logger.default.error(`Debugger returned data for message '${msgId}' ` + `but we were not waiting for that message! ` + `result: '${JSON.stringify(result)}'; ` + `error: '${error}'`);
      }
    }
  }

  logFullMessage(plist) {
    const bufferToJSON = Buffer.prototype.toJSON;
    delete Buffer.prototype.toJSON;

    try {
      (0, _logger.default)(JSON.stringify(plist, (k, v) => Buffer.isBuffer(v) ? v.toString('utf8') : v, 2));
    } finally {
      Buffer.prototype.toJSON = bufferToJSON;
    }
  }

  async handleDataMessage(plist) {
    const dataKey = this.parseDataKey(plist);
    let msgId = (dataKey.id || '').toString();
    let result = dataKey.result;
    let error = dataKey.error || null;

    if (result && result.wasThrown) {
      let message = result.result && (result.result.value || result.result.description) ? result.result.value || result.result.description : 'Error occurred in handling data message';
      error = new Error(message);
    }

    if (error) {
      if (this.hasErrorHandler(msgId)) {
        this.errorHandlers[msgId](error);
      } else {
        _logger.default.error(`Error occurred in handling data message: ${error}`);

        _logger.default.error('No error handler present, ignoring');
      }

      return;
    }

    let method = dataKey.method;
    let params;

    if (this.isTargetBased) {
      if (method === 'Target.targetCreated') {
        const app = plist.__argument.WIRApplicationIdentifierKey;
        const targetInfo = dataKey.params.targetInfo;
        await this.specialHandlers.targetCreated(app, targetInfo);
        return;
      }

      if (method === 'Target.targetDestroyed') {
        const app = plist.__argument.WIRApplicationIdentifierKey;
        const targetInfo = dataKey.params.targetInfo;
        await this.specialHandlers.targetDestroyed(app, targetInfo);
        return;
      } else if (dataKey.method !== 'Target.dispatchMessageFromTarget') {
        if (!_lodash.default.isEmpty(msgId)) {
          _logger.default.debug(`Received receipt for message '${msgId}'`);
        }

        return;
      }

      let message;

      try {
        message = JSON.parse(dataKey.params.message);
        msgId = message.id;
        method = message.method;
        result = message.result || message;
        params = result.params;
      } catch (err) {
        _logger.default.error(`Unexpected message format from Web Inspector:`);

        this.logFullMessage(plist);
        throw err;
      }
    } else {
      params = dataKey.params;
    }

    if (!_lodash.default.isEmpty(msgId)) {
      _logger.default.debug(`Received response for message '${msgId}'`);
    }

    await this.dispatchDataMessage(msgId, method, params, result, error);
  }

  setHandlers() {
    this.handlers = {
      '_rpc_reportSetup:': async plist => {
        await this.handleSpecialMessage('_rpc_reportIdentifier:', plist.__argument.WIRSimulatorNameKey, plist.__argument.WIRSimulatorBuildKey, plist.__argument.WIRSimulatorProductVersionKey);
      },
      '_rpc_reportConnectedApplicationList:': async plist => {
        await this.handleSpecialMessage('_rpc_reportConnectedApplicationList:', plist.__argument.WIRApplicationDictionaryKey);
      },
      '_rpc_applicationSentListing:': async plist => {
        await this.handleSpecialMessage('_rpc_forwardGetListing:', plist.__argument.WIRApplicationIdentifierKey, plist.__argument.WIRListingKey);
      },
      '_rpc_applicationConnected:': async plist => {
        await this.handleSpecialMessage('_rpc_applicationConnected:', plist.__argument);
      },
      '_rpc_applicationDisconnected:': async plist => {
        await this.handleSpecialMessage('_rpc_applicationDisconnected:', plist.__argument);
      },
      '_rpc_applicationUpdated:': async plist => {
        await this.handleSpecialMessage('_rpc_applicationUpdated:', plist.__argument);
      },
      '_rpc_reportConnectedDriverList:': async plist => {
        await this.handleSpecialMessage('_rpc_reportConnectedDriverList:', plist.__argument);
      },
      '_rpc_applicationSentData:': this.handleDataMessage.bind(this)
    };
  }

}

exports.default = RpcMessageHandler;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9yZW1vdGUtZGVidWdnZXItbWVzc2FnZS1oYW5kbGVyLmpzIl0sIm5hbWVzIjpbIklHTk9SRURfRVZFTlRTIiwiUnBjTWVzc2FnZUhhbmRsZXIiLCJjb25zdHJ1Y3RvciIsInNwZWNpYWxIYW5kbGVycyIsImlzVGFyZ2V0QmFzZWQiLCJzZXRIYW5kbGVycyIsImVycm9ySGFuZGxlcnMiLCJfIiwiY2xvbmUiLCJkYXRhSGFuZGxlcnMiLCJ3aWxsTmF2aWdhdGVXaXRob3V0UmVsb2FkIiwic2V0RGF0YU1lc3NhZ2VIYW5kbGVyIiwia2V5IiwiZXJyb3JIYW5kbGVyIiwiaGFuZGxlciIsInNldFNwZWNpYWxNZXNzYWdlSGFuZGxlciIsImdldFNwZWNpYWxNZXNzYWdlSGFuZGxlciIsInNldFRpbWVsaW5lRXZlbnRIYW5kbGVyIiwidGltZWxpbmVFdmVudEhhbmRsZXIiLCJzZXRDb25zb2xlTG9nRXZlbnRIYW5kbGVyIiwiY29uc29sZUxvZ0V2ZW50SGFuZGxlciIsInNldE5ldHdvcmtFdmVudEhhbmRsZXIiLCJuZXR3b3JrTG9nRXZlbnRIYW5kbGVyIiwiaGFzRXJyb3JIYW5kbGVyIiwiaGFzIiwiaGFzU3BlY2lhbE1lc3NhZ2VIYW5kbGVyIiwiYWxsb3dOYXZpZ2F0aW9uV2l0aG91dFJlbG9hZCIsImFsbG93IiwiaGFuZGxlTWVzc2FnZSIsInBsaXN0Iiwic2VsZWN0b3IiLCJfX3NlbGVjdG9yIiwibG9nIiwiZGVidWciLCJoYW5kbGVycyIsImhhbmRsZVNwZWNpYWxNZXNzYWdlIiwiYXJncyIsImZuIiwid2FybiIsInBhcnNlRGF0YUtleSIsIkpTT04iLCJwYXJzZSIsIl9fYXJndW1lbnQiLCJXSVJNZXNzYWdlRGF0YUtleSIsInRvU3RyaW5nIiwiZXJyIiwiZXJyb3IiLCJ0cnVuY2F0ZSIsInN0cmluZ2lmeSIsImxlbmd0aCIsIkVycm9yIiwibWVzc2FnZSIsImRpc3BhdGNoRGF0YU1lc3NhZ2UiLCJtc2dJZCIsIm1ldGhvZCIsInBhcmFtcyIsInJlc3VsdCIsInBhZ2VMb2FkaW5nIiwiaXNGdW5jdGlvbiIsImluY2x1ZGVzIiwicGFnZUxvYWQiLCJmcmFtZURldGFjaGVkIiwicmVjb3JkIiwic3RhcnRzV2l0aCIsInZhbHVlIiwibG9nRnVsbE1lc3NhZ2UiLCJidWZmZXJUb0pTT04iLCJCdWZmZXIiLCJwcm90b3R5cGUiLCJ0b0pTT04iLCJrIiwidiIsImlzQnVmZmVyIiwiaGFuZGxlRGF0YU1lc3NhZ2UiLCJkYXRhS2V5IiwiaWQiLCJ3YXNUaHJvd24iLCJkZXNjcmlwdGlvbiIsImFwcCIsIldJUkFwcGxpY2F0aW9uSWRlbnRpZmllcktleSIsInRhcmdldEluZm8iLCJ0YXJnZXRDcmVhdGVkIiwidGFyZ2V0RGVzdHJveWVkIiwiaXNFbXB0eSIsIldJUlNpbXVsYXRvck5hbWVLZXkiLCJXSVJTaW11bGF0b3JCdWlsZEtleSIsIldJUlNpbXVsYXRvclByb2R1Y3RWZXJzaW9uS2V5IiwiV0lSQXBwbGljYXRpb25EaWN0aW9uYXJ5S2V5IiwiV0lSTGlzdGluZ0tleSIsImJpbmQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBS0EsTUFBTUEsY0FBYyxHQUFHLENBQ3JCLDJCQURxQixFQUVyQiwwQkFGcUIsRUFHckIsMEJBSHFCLEVBSXJCLCtCQUpxQixFQUtyQixzQ0FMcUIsRUFNckIseUJBTnFCLENBQXZCOztBQVNlLE1BQU1DLGlCQUFOLENBQXdCO0FBQ3JDQyxFQUFBQSxXQUFXLENBQUVDLGVBQUYsRUFBbUJDLGFBQWEsR0FBRyxLQUFuQyxFQUEwQztBQUNuRCxTQUFLQyxXQUFMO0FBQ0EsU0FBS0MsYUFBTCxHQUFxQixFQUFyQjtBQUNBLFNBQUtILGVBQUwsR0FBdUJJLGdCQUFFQyxLQUFGLENBQVFMLGVBQVIsQ0FBdkI7QUFDQSxTQUFLTSxZQUFMLEdBQW9CLEVBQXBCO0FBQ0EsU0FBS0MseUJBQUwsR0FBaUMsS0FBakM7QUFFQSxTQUFLTixhQUFMLEdBQXFCQSxhQUFyQjtBQUNEOztBQUVETyxFQUFBQSxxQkFBcUIsQ0FB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MUIsRUFDSk4sS0FBSyxDQUFDYSxVQURGLENBQU47QUFFRCxPQXZCYTtBQXdCZCxrQ0FBNEIsTUFBT2IsS0FBUCxJQUFpQjtBQUMzQyxjQUFNLEtBQUtNLG9CQUFMLENBQTBCLDBCQUExQixFQUNKTixLQUFLLENBQUNhLFVBREYsQ0FBTjtBQUVELE9BM0JhO0FBNEJkLHlDQUFtQyxNQUFPYixLQUFQLElBQWlCO0FBQ2xELGNBQU0sS0FBS00sb0JBQUwsQ0FBMEIsaUNBQTFCLEVBQ0pOLEtBQUssQ0FBQ2EsVUFERixDQUFOO0FBRUQsT0EvQmE7QUFnQ2QsbUNBQTZCLEtBQUsrQixpQkFBTCxDQUF1QmdCLElBQXZCLENBQTRCLElBQTVCO0FBaENmLEtBQWhCO0FBa0NEOztBQTdRb0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgbG9nIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5cblxuLy8gd2Ugd2lsbCByZWNlaXZlIGV2ZW50cyB0aGF0IHdlIGRvIG5vdCBsaXN0ZW4gdG8uXG4vLyBpZiB3ZSBzdGFydCB0byBsaXN0ZW4gdG8gb25lIG9mIHRoZXNlLCByZW1vdmUgaXQgZnJvbSB0aGUgbGlzdFxuY29uc3QgSUdOT1JFRF9FVkVOVFMgPSBbXG4gICdQYWdlLmRvbUNvbnRlbnRFdmVudEZpcmVkJyxcbiAgJ1BhZ2UuZnJhbWVTdGFydGVkTG9hZGluZycsXG4gICdQYWdlLmZyYW1lU3RvcHBlZExvYWRpbmcnLFxuICAnUGFnZS5mcmFtZVNjaGVkdWxlZE5hdmlnYXRpb24nLFxuICAnUGFnZS5mcmFtZUNsZWFyZWRTY2hlZHVsZWROYXZpZ2F0aW9uJyxcbiAgJ0NvbnNvbGUubWVzc2FnZXNDbGVhcmVkJyxcbl07XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFJwY01lc3NhZ2VIYW5kbGVyIHtcbiAgY29uc3RydWN0b3IgKHNwZWNpYWxIYW5kbGVycywgaXNUYXJnZXRCYXNlZCA9IGZhbHNlKSB7XG4gICAgdGhpcy5zZXRIYW5kbGVycygpO1xuICAgIHRoaXMuZXJyb3JIYW5kbGVycyA9IHt9O1xuICAgIHRoaXMuc3BlY2lhbEhhbmRsZXJzID0gXy5jbG9uZShzcGVjaWFsSGFuZGxlcnMpO1xuICAgIHRoaXMuZGF0YUhhbmRsZXJzID0ge307XG4gICAgdGhpcy53aWxsTmF2aWdhdGVXaXRob3V0UmVsb2FkID0gZmFsc2U7XG5cbiAgICB0aGlzLmlzVGFyZ2V0QmFzZWQgPSBpc1RhcmdldEJhc2VkO1xuICB9XG5cbiAgc2V0RGF0YU1lc3NhZ2VIYW5kbGVyIChrZXksIGVycm9ySGFuZGxlciwgaGFuZGxlcikge1xuICAgIHRoaXMuZXJyb3JIYW5kbGVyc1trZXldID0gZXJyb3JIYW5kbGVyO1xuICAgIHRoaXMuZGF0YUhhbmRsZXJzW2tleV0gPSBoYW5kbGVyO1xuICB9XG5cbiAgc2V0U3BlY2lhbE1lc3NhZ2VIYW5kbGVyIChrZXksIGVycm9ySGFuZGxlciwgaGFuZGxlcikge1xuICAgIHRoaXMuZXJyb3JIYW5kbGVyc1trZXldID0gZXJyb3JIYW5kbGVyO1xuICAgIHRoaXMuc3BlY2lhbEhhbmRsZXJzW2tleV0gPSBoYW5kbGVyO1xuICB9XG5cbiAgZ2V0U3BlY2lhbE1lc3NhZ2VIYW5kbGVyIChrZXkpIHtcbiAgICByZXR1cm4gdGhpcy5zcGVjaWFsSGFuZGxlcnNba2V5XTtcbiAgfVxuXG4gIHNldFRpbWVsaW5lRXZlbnRIYW5kbGVyICh0aW1lbGluZUV2ZW50SGFuZGxlcikge1xuICAgIHRoaXMudGltZWxpbmVFdmVudEhhbmRsZXIgPSB0aW1lbGluZUV2ZW50SGFuZGxlcjtcbiAgfVxuXG4gIHNldENvbnNvbGVMb2dFdmVudEhhbmRsZXIgKGNvbnNvbGVMb2dFdmVudEhhbmRsZXIpIHtcbiAgICB0aGlzLmNvbnNvbGVMb2dFdmVudEhhbmRsZXIgPSBjb25zb2xlTG9nRXZlbnRIYW5kbGVyO1xuICB9XG5cbiAgc2V0TmV0d29ya0V2ZW50SGFuZGxlciAobmV0d29ya0xvZ0V2ZW50SGFuZGxlcikge1xuICAgIHRoaXMubmV0d29ya0xvZ0V2ZW50SGFuZGxlciA9IG5ldHdvcmtMb2dFdmVudEhhbmRsZXI7XG4gIH1cblxuICBoYXNFcnJvckhhbmRsZXIgKGtleSkge1xuICAgIHJldHVybiBfLmhhcyh0aGlzLmVycm9ySGFuZGxlcnMsIGtleSk7XG4gIH1cblxuICBoYXNTcGVjaWFsTWVzc2FnZUhhbmRsZXIgKGtleSkge1xuICAgIHJldHVybiBfLmhhcyh0aGlzLnNwZWNpYWxIYW5kbGVycywga2V5KTtcbiAgfVxuXG4gIGFsbG93TmF2aWdhdGlvbldpdGhvdXRSZWxvYWQgKGFsbG93ID0gdHJ1ZSkge1xuICAgIHRoaXMud2lsbE5hdmlnYXRlV2l0aG91dFJlbG9hZCA9IGFsbG93O1xuICB9XG5cbiAgYXN5bmMgaGFuZGxlTWVzc2FnZSAocGxpc3QpIHtcbiAgICBjb25zdCBzZWxlY3RvciA9IHBsaXN0Ll9fc2VsZWN0b3I7XG4gICAgaWYgKCFzZWxlY3Rvcikge1xuICAgICAgbG9nLmRlYnVnKCdHb3QgYW4gaW52YWxpZCBwbGlzdCcpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmIChfLmhhcyh0aGlzLmhhbmRsZXJzLCBzZWxlY3RvcikpIHtcbiAgICAgIGF3YWl0IHRoaXMuaGFuZGxlcnNbc2VsZWN0b3JdKHBsaXN0KTtcbiAgICB9IGVsc2Uge1xuICAgICAgbG9nLmRlYnVnKGBEZWJ1Z2dlciBnb3QgYSBtZXNzYWdlIGZvciAnJHtzZWxlY3Rvcn0nIGFuZCBoYXZlIG5vIGAgK1xuICAgICAgICAgICAgICAgIGBoYW5kbGVyLCBkb2luZyBub3RoaW5nLmApO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGhhbmRsZVNwZWNpYWxNZXNzYWdlIChoYW5kbGVyLCAuLi5hcmdzKSB7XG4gICAgY29uc3QgZm4gPSB0aGlzLnNwZWNpYWxIYW5kbGVyc1toYW5kbGVyXTtcblxuICAgIGlmIChmbikge1xuICAgICAgLy8gbW9zdCByZXNwb25zZXMgYXJlIG9ubHkgdG8gYmUgY2FsbGVkIG9uY2UsIHRoZW5cbiAgICAgIC8vIHJlbW92ZWQuIEJ1dCBub3QgdGhlIG9uZXMgYmVsb3csIHdoaWNoIGhhbmRsZVxuICAgICAgLy8gcGFnZSBjaGFuZ2UgYW5kIGFwcCBjb25uZWN0L2Rpc2Nvbm5lY3RcbiAgICAgIGlmIChoYW5kbGVyICE9PSAnX3JwY19mb3J3YXJkR2V0TGlzdGluZzonICYmXG4gICAgICAgICAgaGFuZGxlciAhPT0gJ19ycGNfYXBwbGljYXRpb25EaXNjb25uZWN0ZWQ6JyAmJlxuICAgICAgICAgIGhhbmRsZXIgIT09ICdfcnBjX2FwcGxpY2F0aW9uQ29ubmVjdGVkOicgJiZcbiAgICAgICAgICBoYW5kbGVyICE9PSAnX3JwY19hcHBsaWNhdGlvblVwZGF0ZWQ6JyAmJlxuICAgICAgICAgIGhhbmRsZXIgIT09ICdfcnBjX3JlcG9ydENvbm5lY3RlZERyaXZlckxpc3Q6Jykge1xuICAgICAgICB0aGlzLnNwZWNpYWxIYW5kbGVyc1toYW5kbGVyXSA9IG51bGw7XG4gICAgICB9XG4gICAgICBhd2FpdCBmbiguLi5hcmdzKTtcbiAgICB9IGVsc2Uge1xuICAgICAgbG9nLndhcm4oYFRyaWVkIHRvIGFjY2VzcyBzcGVjaWFsIG1lc3NhZ2UgaGFuZGxlciAnJHtoYW5kbGVyfScgYCArXG4gICAgICAgICAgICAgICBgYnV0IG5vbmUgd2FzIGZvdW5kYCk7XG4gICAgfVxuICB9XG5cbiAgcGFyc2VEYXRhS2V5IChwbGlzdCkge1xuICAgIHRyeSB7XG4gICAgICByZXR1cm4gSlNPTi5wYXJzZShwbGlzdC5fX2FyZ3VtZW50LldJUk1lc3NhZ2VEYXRhS2V5LnRvU3RyaW5nKCd1dGY4JykpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nLmVycm9yKGBVbnBhcnNlYWJsZSBtZXNzYWdlIGRhdGE6ICR7Xy50cnVuY2F0ZShKU09OLnN0cmluZ2lmeShwbGlzdCksIHtsZW5ndGg6IDEwMH0pfWApO1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmFibGUgdG8gcGFyc2UgbWVzc2FnZSBkYXRhOiAke2Vyci5tZXNzYWdlfWApO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGRpc3BhdGNoRGF0YU1lc3NhZ2UgKG1zZ0lkLCBtZXRob2QsIHBhcmFtcywgcmVzdWx0LCBlcnJvcikge1xuICAgIGlmIChtZXRob2QgPT09ICdQcm9maWxlci5yZXNldFByb2ZpbGVzJykge1xuICAgICAgbG9nLmRlYnVnKCdEZXZpY2UgaXMgdGVsbGluZyB1cyB0byByZXNldCBwcm9maWxlcy4gU2hvdWxkIHByb2JhYmx5ICcgK1xuICAgICAgICAgICAgICAgICdkbyBzb21lIGtpbmQgb2YgY2FsbGJhY2sgaGVyZScpO1xuICAgIH0gZWxzZSBpZiAobWV0aG9kID09PSAnUGFnZS5mcmFtZU5hdmlnYXRlZCcpIHtcbiAgICAgIGlmICghdGhpcy53aWxsTmF2aWdhdGVXaXRob3V0UmVsb2FkICYmICF0aGlzLnBhZ2VMb2FkaW5nKSB7XG4gICAgICAgIGxvZy5kZWJ1ZygnRnJhbWUgbmF2aWdhdGVkLCB1bmxvYWRpbmcgcGFnZScpO1xuICAgICAgICBpZiAoXy5pc0Z1bmN0aW9uKHRoaXMuc3BlY2lhbEhhbmRsZXJzWydQYWdlLmZyYW1lTmF2aWdhdGVkJ10pKSB7XG4gICAgICAgICAgYXdhaXQgdGhpcy5zcGVjaWFsSGFuZGxlcnNbJ1BhZ2UuZnJhbWVOYXZpZ2F0ZWQnXSgncmVtb3RlLWRlYnVnZ2VyJyk7XG4gICAgICAgICAgdGhpcy5zcGVjaWFsSGFuZGxlcnNbJ1BhZ2UuZnJhbWVOYXZpZ2F0ZWQnXSA9IG51bGw7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGxvZy5kZWJ1ZygnRnJhbWUgbmF2aWdhdGVkIGJ1dCB3ZSB3ZXJlIHdhcm5lZCBhYm91dCBpdCwgbm90ICcgK1xuICAgICAgICAgICAgICAgICAgJ2NvbnNpZGVyaW5nIHBhZ2Ugc3RhdGUgdW5sb2FkZWQnKTtcbiAgICAgICAgdGhpcy53aWxsTmF2aWdhdGVXaXRob3V0UmVsb2FkID0gZmFsc2U7XG4gICAgICB9XG4gICAgfSBlbHNlIGlmIChJR05PUkVEX0VWRU5UUy5pbmNsdWRlcyhtZXRob2QpKSB7XG4gICAgICAvLyBwYXNzXG4gICAgfSBlbHNlIGlmIChtZXRob2QgPT09ICdQYWdlLmxvYWRFdmVudEZpcmVkJyAmJiBfLmlzRnVuY3Rpb24odGhpcy5zcGVjaWFsSGFuZGxlcnMucGFnZUxvYWQpKSB7XG4gICAgICBhd2FpdCB0aGlzLnNwZWNpYWxIYW5kbGVycy5wYWdlTG9hZCgpO1xuICAgIH0gZWxzZSBpZiAobWV0aG9kID09PSAnUGFnZS5mcmFtZURldGFjaGVkJyAmJiBfLmlzRnVuY3Rpb24odGhpcy5zcGVjaWFsSGFuZGxlcnMuZnJhbWVEZXRhY2hlZCkpIHtcbiAgICAgIGF3YWl0IHRoaXMuc3BlY2lhbEhhbmRsZXJzLmZyYW1lRGV0YWNoZWQoKTtcbiAgICB9IGVsc2UgaWYgKG1ldGhvZCA9PT0gJ1RpbWVsaW5lLmV2ZW50UmVjb3JkZWQnICYmIF8uaXNGdW5jdGlvbih0aGlzLnRpbWVsaW5lRXZlbnRIYW5kbGVyKSkge1xuICAgICAgdGhpcy50aW1lbGluZUV2ZW50SGFuZGxlcihwYXJhbXMgfHwgcGFyYW1zLnJlY29yZCk7XG4gICAgfSBlbHNlIGlmIChtZXRob2QgPT09ICdDb25zb2xlLm1lc3NhZ2VBZGRlZCcgJiYgXy5pc0Z1bmN0aW9uKHRoaXMuY29uc29sZUxvZ0V2ZW50SGFuZGxlcikpIHtcbiAgICAgIHRoaXMuY29uc29sZUxvZ0V2ZW50SGFuZGxlcihwYXJhbXMubWVzc2FnZSk7XG4gICAgfSBlbHNlIGlmIChtZXRob2QgJiYgbWV0aG9kLnN0YXJ0c1dpdGgoJ05ldHdvcmsuJykgJiYgXy5pc0Z1bmN0aW9uKHRoaXMubmV0d29ya0xvZ0V2ZW50SGFuZGxlcikpIHtcbiAgICAgIHRoaXMubmV0d29ya0xvZ0V2ZW50SGFuZGxlcihtZXRob2QsIHBhcmFtcyk7XG4gICAgfSBlbHNlIGlmIChfLmlzRnVuY3Rpb24odGhpcy5kYXRhSGFuZGxlcnNbbXNnSWRdKSkge1xuICAgICAgbG9nLmRlYnVnKCdGb3VuZCBkYXRhIGhhbmRsZXIgZm9yIHJlc3BvbnNlJyk7XG5cbiAgICAgIC8vIHdlIHdpbGwgZWl0aGVyIGdldCBiYWNrIGEgcmVzdWx0IG9iamVjdCB0aGF0IGhhcyBhIHJlc3VsdC52YWx1ZVxuICAgICAgLy8gaW4gd2hpY2ggY2FzZSB0aGF0IGlzIHdoYXQgd2Ugd2FudCxcbiAgICAgIC8vIG9yIGVsc2Ugd2UgcmV0dXJuIHRoZSB3aG9sZSB0aGluZ1xuICAgICAgaWYgKHJlc3VsdC5yZXN1bHQgJiYgcmVzdWx0LnJlc3VsdC52YWx1ZSkge1xuICAgICAgICByZXN1bHQgPSByZXN1bHQucmVzdWx0LnZhbHVlO1xuICAgICAgfVxuICAgICAgdGhpcy5kYXRhSGFuZGxlcnNbbXNnSWRdKHJlc3VsdCk7XG4gICAgICB0aGlzLmRhdGFIYW5kbGVyc1ttc2dJZF0gPSBudWxsO1xuICAgIH0gZWxzZSBpZiAodGhpcy5kYXRhSGFuZGxlcnNbbXNnSWRdID09PSBudWxsKSB7XG4gICAgICBsb2cuZXJyb3IoYERlYnVnZ2VyIHJldHVybmVkIGRhdGEgZm9yIG1lc3NhZ2UgJHttc2dJZH0gYCArXG4gICAgICAgICAgICAgICAgYGJ1dCB3ZSBhbHJlYWR5IHJhbiB0aGF0IGNhbGxiYWNrISBXVEY/P2ApO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAobXNnSWQgfHwgcmVzdWx0IHx8IGVycm9yKSB7XG4gICAgICAgIGxvZy5lcnJvcihgRGVidWdnZXIgcmV0dXJuZWQgZGF0YSBmb3IgbWVzc2FnZSAnJHttc2dJZH0nIGAgK1xuICAgICAgICAgICAgICAgICAgYGJ1dCB3ZSB3ZXJlIG5vdCB3YWl0aW5nIGZvciB0aGF0IG1lc3NhZ2UhIGAgK1xuICAgICAgICAgICAgICAgICAgYHJlc3VsdDogJyR7SlNPTi5zdHJpbmdpZnkocmVzdWx0KX0nOyBgICtcbiAgICAgICAgICAgICAgICAgIGBlcnJvcjogJyR7ZXJyb3J9J2ApO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGxvZ0Z1bGxNZXNzYWdlIChwbGlzdCkge1xuICAgIC8vIEJ1ZmZlcnMgY2Fubm90IGJlIHNlcmlhbGl6ZWQgaW4gYSByZWFkYWJsZSB3YXlcbiAgICBjb25zdCBidWZmZXJUb0pTT04gPSBCdWZmZXIucHJvdG90eXBlLnRvSlNPTjtcbiAgICBkZWxldGUgQnVmZmVyLnByb3RvdHlwZS50b0pTT047XG4gICAgdHJ5IHtcbiAgICAgIGxvZyhKU09OLnN0cmluZ2lmeShwbGlzdCwgKGssIHYpID0+IEJ1ZmZlci5pc0J1ZmZlcih2KSA/IHYudG9TdHJpbmcoJ3V0ZjgnKSA6IHYsIDIpKTtcbiAgICB9IGZpbmFsbHkge1xuICAgICAgLy8gcmVzdG9yZSB0aGUgZnVuY3Rpb24sIHNvIGFzIHRvIG5vdCBicmVhayBmdXJ0aGVyIHNlcmlhbGl6YXRpb25cbiAgICAgIEJ1ZmZlci5wcm90b3R5cGUudG9KU09OID0gYnVmZmVyVG9KU09OO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGhhbmRsZURhdGFNZXNzYWdlIChwbGlzdCkge1xuICAgIGNvbnN0IGRhdGFLZXkgPSB0aGlzLnBhcnNlRGF0YUtleShwbGlzdCk7XG4gICAgbGV0IG1zZ0lkID0gKGRhdGFLZXkuaWQgfHwgJycpLnRvU3RyaW5nKCk7XG4gICAgbGV0IHJlc3VsdCA9IGRhdGFLZXkucmVzdWx0O1xuXG4gICAgLy8gd2UgY2FuIGdldCBhbiBlcnJvciwgb3Igd2UgY2FuIGdldCBhIHJlc3BvbnNlIHRoYXQgaXMgYW4gZXJyb3JcbiAgICBsZXQgZXJyb3IgPSBkYXRhS2V5LmVycm9yIHx8IG51bGw7XG4gICAgaWYgKHJlc3VsdCAmJiByZXN1bHQud2FzVGhyb3duKSB7XG4gICAgICBsZXQgbWVzc2FnZSA9IChyZXN1bHQucmVzdWx0ICYmIChyZXN1bHQucmVzdWx0LnZhbHVlIHx8IHJlc3VsdC5yZXN1bHQuZGVzY3JpcHRpb24pKVxuICAgICAgICA/IChyZXN1bHQucmVzdWx0LnZhbHVlIHx8IHJlc3VsdC5yZXN1bHQuZGVzY3JpcHRpb24pXG4gICAgICAgIDogJ0Vycm9yIG9jY3VycmVkIGluIGhhbmRsaW5nIGRhdGEgbWVzc2FnZSc7XG4gICAgICBlcnJvciA9IG5ldyBFcnJvcihtZXNzYWdlKTtcbiAgICB9XG5cbiAgICBpZiAoZXJyb3IpIHtcbiAgICAgIGlmICh0aGlzLmhhc0Vycm9ySGFuZGxlcihtc2dJZCkpIHtcbiAgICAgICAgdGhpcy5lcnJvckhhbmRsZXJzW21zZ0lkXShlcnJvcik7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBsb2cuZXJyb3IoYEVycm9yIG9jY3VycmVkIGluIGhhbmRsaW5nIGRhdGEgbWVzc2FnZTogJHtlcnJvcn1gKTtcbiAgICAgICAgbG9nLmVycm9yKCdObyBlcnJvciBoYW5kbGVyIHByZXNlbnQsIGlnbm9yaW5nJyk7XG4gICAgICB9XG5cbiAgICAgIC8vIHNob3J0IGNpcmN1aXRcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBsZXQgbWV0aG9kID0gZGF0YUtleS5tZXRob2Q7XG4gICAgbGV0IHBhcmFtcztcbiAgICBpZiAodGhpcy5pc1RhcmdldEJhc2VkKSB7XG4gICAgICBpZiAobWV0aG9kID09PSAnVGFyZ2V0LnRhcmdldENyZWF0ZWQnKSB7XG4gICAgICAgIC8vIHRoaXMgaXMgaW4gcmVzcG9uc2UgdG8gYSBgX3JwY19mb3J3YXJkU29ja2V0U2V0dXA6YCBjYWxsXG4gICAgICAgIC8vIHRhcmdldEluZm86IHsgdGFyZ2V0SWQ6ICdwYWdlLTEnLCB0eXBlOiAncGFnZScgfVxuICAgICAgICBjb25zdCBhcHAgPSBwbGlzdC5fX2FyZ3VtZW50LldJUkFwcGxpY2F0aW9uSWRlbnRpZmllcktleTtcbiAgICAgICAgY29uc3QgdGFyZ2V0SW5mbyA9IGRhdGFLZXkucGFyYW1zLnRhcmdldEluZm87XG4gICAgICAgIGF3YWl0IHRoaXMuc3BlY2lhbEhhbmRsZXJzLnRhcmdldENyZWF0ZWQoYXBwLCB0YXJnZXRJbmZvKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfSBpZiAobWV0aG9kID09PSAnVGFyZ2V0LnRhcmdldERlc3Ryb3llZCcpIHtcbiAgICAgICAgY29uc3QgYXBwID0gcGxpc3QuX19hcmd1bWVudC5XSVJBcHBsaWNhdGlvbklkZW50aWZpZXJLZXk7XG4gICAgICAgIGNvbnN0IHRhcmdldEluZm8gPSBkYXRhS2V5LnBhcmFtcy50YXJnZXRJbmZvO1xuICAgICAgICBhd2FpdCB0aGlzLnNwZWNpYWxIYW5kbGVycy50YXJnZXREZXN0cm95ZWQoYXBwLCB0YXJnZXRJbmZvKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfSBlbHNlIGlmIChkYXRhS2V5Lm1ldGhvZCAhPT0gJ1RhcmdldC5kaXNwYXRjaE1lc3NhZ2VGcm9tVGFyZ2V0Jykge1xuICAgICAgICAvLyB0aGlzIHNvcnQgb2YgbWVzc2FnZSwgYXQgdGhpcyBwb2ludCwgaXMganVzdCBhbiBhY2tub3dsZWRnZW1lbnRcbiAgICAgICAgLy8gdGhhdCB0aGUgb3JpZ2luYWwgbWVzc2FnZSB3YXMgcmVjZWl2ZWRcbiAgICAgICAgaWYgKCFfLmlzRW1wdHkobXNnSWQpKSB7XG4gICAgICAgICAgbG9nLmRlYnVnKGBSZWNlaXZlZCByZWNlaXB0IGZvciBtZXNzYWdlICcke21zZ0lkfSdgKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIC8vIGF0IHRoaXMgcG9pbnQsIHdlIGhhdmUgYSBUYXJnZXQtYmFzZWQgbWVzc2FnZSB3cmFwcGluZyBhIHByb3RvY29sIG1lc3NhZ2VcbiAgICAgIGxldCBtZXNzYWdlO1xuICAgICAgdHJ5IHtcbiAgICAgICAgbWVzc2FnZSA9IEpTT04ucGFyc2UoZGF0YUtleS5wYXJhbXMubWVzc2FnZSk7XG4gICAgICAgIG1zZ0lkID0gbWVzc2FnZS5pZDtcbiAgICAgICAgbWV0aG9kID0gbWVzc2FnZS5tZXRob2Q7XG4gICAgICAgIHJlc3VsdCA9IG1lc3NhZ2UucmVzdWx0IHx8IG1lc3NhZ2U7XG4gICAgICAgIHBhcmFtcyA9IHJlc3VsdC5wYXJhbXM7XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgLy8gaWYgdGhpcyBoYXBwZW5zIHRoZW4gc29tZSBhc3BlY3Qgb2YgdGhlIHByb3RvY29sIGlzIG1pc3NpbmcgdG8gdXNcbiAgICAgICAgLy8gc28gcHJpbnQgdGhlIGVudGlyZSBtZXNzYWdlIHRvIGdldCB2aXNpYmlpdHkgaW50byB3aGF0IGlzIGdvaW5nIG9uXG4gICAgICAgIGxvZy5lcnJvcihgVW5leHBlY3RlZCBtZXNzYWdlIGZvcm1hdCBmcm9tIFdlYiBJbnNwZWN0b3I6YCk7XG4gICAgICAgIHRoaXMubG9nRnVsbE1lc3NhZ2UocGxpc3QpO1xuICAgICAgICB0aHJvdyBlcnI7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHBhcmFtcyA9IGRhdGFLZXkucGFyYW1zO1xuICAgIH1cblxuICAgIGlmICghXy5pc0VtcHR5KG1zZ0lkKSkge1xuICAgICAgbG9nLmRlYnVnKGBSZWNlaXZlZCByZXNwb25zZSBmb3IgbWVzc2FnZSAnJHttc2dJZH0nYCk7XG4gICAgfVxuXG4gICAgYXdhaXQgdGhpcy5kaXNwYXRjaERhdGFNZXNzYWdlKG1zZ0lkLCBtZXRob2QsIHBhcmFtcywgcmVzdWx0LCBlcnJvcik7XG4gIH1cblxuICBzZXRIYW5kbGVycyAoKSB7XG4gICAgdGhpcy5oYW5kbGVycyA9IHtcbiAgICAgICdfcnBjX3JlcG9ydFNldHVwOic6IGFzeW5jIChwbGlzdCkgPT4ge1xuICAgICAgICBhd2FpdCB0aGlzLmhhbmRsZVNwZWNpYWxNZXNzYWdlKCdfcnBjX3JlcG9ydElkZW50aWZpZXI6JyxcbiAgICAgICAgICBwbGlzdC5fX2FyZ3VtZW50LldJUlNpbXVsYXRvck5hbWVLZXksXG4gICAgICAgICAgcGxpc3QuX19hcmd1bWVudC5XSVJTaW11bGF0b3JCdWlsZEtleSxcbiAgICAgICAgICBwbGlzdC5fX2FyZ3VtZW50LldJUlNpbXVsYXRvclByb2R1Y3RWZXJzaW9uS2V5KTtcbiAgICAgIH0sXG4gICAgICAnX3JwY19yZXBvcnRDb25uZWN0ZWRBcHBsaWNhdGlvbkxpc3Q6JzogYXN5bmMgKHBsaXN0KSA9PiB7XG4gICAgICAgIGF3YWl0IHRoaXMuaGFuZGxlU3BlY2lhbE1lc3NhZ2UoJ19ycGNfcmVwb3J0Q29ubmVjdGVkQXBwbGljYXRpb25MaXN0OicsXG4gICAgICAgICAgcGxpc3QuX19hcmd1bWVudC5XSVJBcHBsaWNhdGlvbkRpY3Rpb25hcnlLZXkpO1xuICAgICAgfSxcbiAgICAgICdfcnBjX2FwcGxpY2F0aW9uU2VudExpc3Rpbmc6JzogYXN5bmMgKHBsaXN0KSA9PiB7XG4gICAgICAgIGF3YWl0IHRoaXMuaGFuZGxlU3BlY2lhbE1lc3NhZ2UoJ19ycGNfZm9yd2FyZEdldExpc3Rpbmc6JyxcbiAgICAgICAgICBwbGlzdC5fX2FyZ3VtZW50LldJUkFwcGxpY2F0aW9uSWRlbnRpZmllcktleSxcbiAgICAgICAgICBwbGlzdC5fX2FyZ3VtZW50LldJUkxpc3RpbmdLZXkpO1xuICAgICAgfSxcbiAgICAgICdfcnBjX2FwcGxpY2F0aW9uQ29ubmVjdGVkOic6IGFzeW5jIChwbGlzdCkgPT4ge1xuICAgICAgICBhd2FpdCB0aGlzLmhhbmRsZVNwZWNpYWxNZXNzYWdlKCdfcnBjX2FwcGxpY2F0aW9uQ29ubmVjdGVkOicsXG4gICAgICAgICAgcGxpc3QuX19hcmd1bWVudCk7XG4gICAgICB9LFxuICAgICAgJ19ycGNfYXBwbGljYXRpb25EaXNjb25uZWN0ZWQ6JzogYXN5bmMgKHBsaXN0KSA9PiB7XG4gICAgICAgIGF3YWl0IHRoaXMuaGFuZGxlU3BlY2lhbE1lc3NhZ2UoJ19ycGNfYXBwbGljYXRpb25EaXNjb25uZWN0ZWQ6JyxcbiAgICAgICAgICBwbGlzdC5fX2FyZ3VtZW50KTtcbiAgICAgIH0sXG4gICAgICAnX3JwY19hcHBsaWNhdGlvblVwZGF0ZWQ6JzogYXN5bmMgKHBsaXN0KSA9PiB7XG4gICAgICAgIGF3YWl0IHRoaXMuaGFuZGxlU3BlY2lhbE1lc3NhZ2UoJ19ycGNfYXBwbGljYXRpb25VcGRhdGVkOicsXG4gICAgICAgICAgcGxpc3QuX19hcmd1bWVudCk7XG4gICAgICB9LFxuICAgICAgJ19ycGNfcmVwb3J0Q29ubmVjdGVkRHJpdmVyTGlzdDonOiBhc3luYyAocGxpc3QpID0+IHtcbiAgICAgICAgYXdhaXQgdGhpcy5oYW5kbGVTcGVjaWFsTWVzc2FnZSgnX3JwY19yZXBvcnRDb25uZWN0ZWREcml2ZXJMaXN0OicsXG4gICAgICAgICAgcGxpc3QuX19hcmd1bWVudCk7XG4gICAgICB9LFxuICAgICAgJ19ycGNfYXBwbGljYXRpb25TZW50RGF0YTonOiB0aGlzLmhhbmRsZURhdGFNZXNzYWdlLmJpbmQodGhpcyksXG4gICAgfTtcbiAgfVxufVxuIl0sImZpbGUiOiJsaWIvcmVtb3RlLWRlYnVnZ2VyLW1lc3NhZ2UtaGFuZGxlci5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLiJ9
