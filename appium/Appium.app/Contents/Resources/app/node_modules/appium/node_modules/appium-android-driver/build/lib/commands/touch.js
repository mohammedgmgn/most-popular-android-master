"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.helpers = exports.commands = void 0;

require("source-map-support/register");

var _logger = _interopRequireDefault(require("../logger"));

var _lodash = _interopRequireDefault(require("lodash"));

var _androidHelpers = _interopRequireDefault(require("../android-helpers"));

var _bluebird = _interopRequireDefault(require("bluebird"));

var _appiumBaseDriver = require("appium-base-driver");

var _asyncbox = require("asyncbox");

let commands = {},
    helpers = {},
    extensions = {};
exports.helpers = helpers;
exports.commands = commands;

commands.doTouchAction = async function (action, opts) {
  switch (action) {
    case 'tap':
      return await this.tap(opts.element, opts.x, opts.y, opts.count);

    case 'press':
      return await this.touchDown(opts.element, opts.x, opts.y);

    case 'release':
      return await this.touchUp(opts.element, opts.x, opts.y);

    case 'moveTo':
      return await this.touchMove(opts.element, opts.x, opts.y);

    case 'wait':
      return await _bluebird.default.delay(opts.ms);

    case 'longPress':
      if (typeof opts.duration === 'undefined' || !opts.duration) {
        opts.duration = 1000;
      }

      return await this.touchLongClick(opts.element, opts.x, opts.y, opts.duration);

    case 'cancel':
      _logger.default.warn('Cancel action currently has no effect');

      break;

    default:
      _logger.default.errorAndThrow(`unknown action ${action}`);

  }
};

helpers.doTouchDrag = async function (gestures) {
  let longPress = gestures[0];
  let moveTo = gestures[1];
  let startX = longPress.options.x || 0,
      startY = longPress.options.y || 0,
      endX = moveTo.options.x || 0,
      endY = moveTo.options.y || 0;

  if (longPress.options.element) {
    let {
      x,
      y
    } = await this.getLocationInView(longPress.options.element);
    startX += x || 0;
    startY += y || 0;
  }

  if (moveTo.options.element) {
    let {
      x,
      y
    } = await this.getLocationInView(moveTo.options.element);
    endX += x || 0;
    endY += y || 0;
  }

  let apiLevel = await this.adb.getApiLevel();
  let duration = apiLevel >= 5 ? 2 : 1;

  if (longPress.options && longPress.options.duration) {
    duration = Math.max(longPress.options.duration / 1000, duration);
  }

  return await this.drag(startX, startY, endX, endY, duration, 1, longPress.options.element, moveTo.options.element);
};

helpers.fixRelease = async function (gestures) {
  let release = _lodash.default.last(gestures);

  release.options = release.options || {};

  if (release.options.element || release.options.x && release.options.y) {
    return;
  }

  gestures = _lodash.default.clone(gestures);
  let ref = null;

  for (let gesture of gestures.reverse()) {
    let opts = gesture.options;

    if (opts.element || opts.x && opts.y) {
      ref = gesture;
      break;
    }
  }

  if (ref) {
    let opts = ref.options;

    if (opts.element) {
      let loc = await this.getLocationInView(opts.element);

      if (opts.x && opts.y) {
        release.options = {
          x: loc.x + opts.x,
          y: loc.y + opts.y
        };
      } else {
        let size = await this.getSize(opts.element);
        release.options = {
          x: loc.x + size.width / 2,
          y: loc.y + size.height / 2
        };
      }
    } else {
      release.options = _lodash.default.pick(opts, 'x', 'y');
    }
  }

  return release;
};

helpers.performGesture = async function (gesture) {
  try {
    return await this.doTouchAction(gesture.action, gesture.options || {});
  } catch (e) {
    if ((0, _appiumBaseDriver.isErrorType)(e, _appiumBaseDriver.errors.NoSuchElementError) && gesture.action === 'release' && gesture.options.element) {
      delete gesture.options.element;

      _logger.default.debug(`retrying release without element opts: ${gesture.options}.`);

      return await this.doTouchAction(gesture.action, gesture.options || {});
    }

    throw e;
  }
};

commands.performTouch = async function (gestures) {
  if (this.isWebContext()) {
    throw new _appiumBaseDriver.errors.NotYetImplementedError();
  }

  if (gestures.length === 4 && gestures[0].action === 'press' && gestures[1].action === 'wait' && gestures[2].action === 'moveTo' && gestures[3].action === 'release') {
    let swipeOpts = await this.getSwipeOptions(gestures);
    return await this.swipe(swipeOpts.startX, swipeOpts.startY, swipeOpts.endX, swipeOpts.endY, swipeOpts.duration, swipeOpts.touchCount, swipeOpts.element);
  }

  let actions = _lodash.default.map(gestures, 'action');

  if (actions[0] === 'longPress' && actions[1] === 'moveTo' && actions[2] === 'release') {
    return await this.doTouchDrag(gestures);
  } else {
    if (actions.length === 2) {
      if (_lodash.default.head(actions) === 'press' && _lodash.default.last(actions) === 'release') {
        actions[0] = 'tap';
        gestures[0].action = 'tap';
      }

      if ((_lodash.default.head(actions) === 'tap' || _lodash.default.head(actions) === 'longPress') && _lodash.default.last(actions) === 'release') {
        gestures.pop();
        actions.pop();
      }
    } else {
      if (actions[0] === 'longPress') {
        actions = ['press', 'wait', ...actions.slice(1)];
        let press = gestures.shift();
        press.action = 'press';
        let wait = {
          action: 'wait',
          options: {
            ms: press.options.duration || 1000
          }
        };
        delete press.options.duration;
        gestures = [press, wait, ...gestures];
      }
    }

    let fixedGestures = await this.parseTouch(gestures, false);

    if (actions[actions.length - 1] === 'release') {
      actions[actions.length - 1] = await this.fixRelease(gestures);
    }

    for (let g of fixedGestures) {
      await this.performGesture(g);
    }
  }
};

helpers.parseTouch = async function (gestures, multi) {
  if (multi && _lodash.default.last(gestures).action === 'release') {
    gestures.pop();
  }

  let touchStateObjects = await (0, _asyncbox.asyncmap)(gestures, async gesture => {
    let options = gesture.options || {};

    if (_lodash.default.includes(['press', 'moveTo', 'tap', 'longPress'], gesture.action)) {
      options.offset = false;
      let elementId = gesture.options.element;

      if (elementId) {
        let pos = await this.getLocationInView(elementId);

        if (gesture.options.x || gesture.options.y) {
          options.x = pos.x + (gesture.options.x || 0);
          options.y = pos.y + (gesture.options.y || 0);
        } else {
          const {
            width,
            height
          } = await this.getSize(elementId);
          options.x = pos.x + width / 2;
          options.y = pos.y + height / 2;
        }

        let touchStateObject = {
          action: gesture.action,
          options,
          timeOffset: 0.005
        };
        return touchStateObject;
      } else {
        options.x = gesture.options.x || 0;
        options.y = gesture.options.y || 0;
        let touchStateObject = {
          action: gesture.action,
          options,
          timeOffset: 0.005
        };
        return touchStateObject;
      }
    } else {
      let offset = 0.005;

      if (gesture.action === 'wait') {
        options = gesture.options;
        offset = parseInt(gesture.options.ms, 10) / 1000;
      }

      let touchStateObject = {
        action: gesture.action,
        options,
        timeOffset: offset
      };
      return touchStateObject;
    }
  }, false);
  let prevPos = null,
      time = 0;

  for (let state of touchStateObjects) {
    if (_lodash.default.isUndefined(state.options.x) && _lodash.default.isUndefined(state.options.y) && prevPos !== null) {
      state.options.x = prevPos.x;
      state.options.y = prevPos.y;
    }

    if (state.options.offset && prevPos) {
      state.options.x += prevPos.x;
      state.options.y += prevPos.y;
    }

    delete state.options.offset;

    if (!_lodash.default.isUndefined(state.options.x) && !_lodash.default.isUndefined(state.options.y)) {
      prevPos = state.options;
    }

    if (multi) {
      let timeOffset = state.timeOffset;
      time += timeOffset;
      state.time = _androidHelpers.default.truncateDecimals(time, 3);

      if (!_lodash.default.isUndefined(state.options.x) && !_lodash.default.isUndefined(state.options.y)) {
        state.touch = {
          x: state.options.x,
          y: state.options.y
        };
      }

      delete state.options;
    }

    delete state.timeOffset;
  }

  return touchStateObjects;
};

commands.performMultiAction = async function (actions, elementId) {
  if (this.isWebContext()) {
    throw new _appiumBaseDriver.errors.NotYetImplementedError();
  }

  if (actions.length === 1) {
    throw new Error('Multi Pointer Gestures need at least two actions. ' + 'Use Touch Actions for a single action.');
  }

  let states = await (0, _asyncbox.asyncmap)(actions, async action => {
    return await this.parseTouch(action, true);
  }, false);
  return await this.doPerformMultiAction(elementId, states);
};

commands.doPerformMultiAction = async function (elementId, states) {
  let opts;

  if (elementId) {
    opts = {
      elementId,
      actions: states
    };
    return await this.bootstrap.sendAction('element:performMultiPointerGesture', opts);
  } else {
    opts = {
      actions: states
    };
    return await this.bootstrap.sendAction('performMultiPointerGesture', opts);
  }
};

Object.assign(extensions, commands, helpers);
var _default = extensions;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy90b3VjaC5qcyJdLCJuYW1lcyI6WyJjb21tYW5kcyIsImhlbHBlcnMiLCJleHRlbnNpb25zIiwiZG9Ub3VjaEFjdGlvbiIsImFjdGlvbiIsIm9wdHMiLCJ0YXAiLCJlbGVtZW50IiwieCIsInkiLCJjb3VudCIsInRvdWNoRG93biIsInRvdWNoVXAiLCJ0b3VjaE1vdmUiLCJCIiwiZGVsYXkiLCJtcyIsImR1cmF0aW9uIiwidG91Y2hMb25nQ2xpY2siLCJsb2ciLCJ3YXJuIiwiZXJyb3JBbmRUaHJvdyIsImRvVG91Y2hEcmFnIiwiZ2VzdHVyZXMiLCJsb25nUHJlc3MiLCJtb3ZlVG8iLCJzdGFydFgiLCJvcHRpb25zIiwic3RhcnRZIiwiZW5kWCIsImVuZFkiLCJnZXRMb2NhdGlvbkluVmlldyIsImFwaUxldmVsIiwiYWRiIiwiZ2V0QXBpTGV2ZWwiLCJNYXRoIiwibWF4IiwiZHJhZyIsImZpeFJlbGVhc2UiLCJyZWxlYXNlIiwiXyIsImxhc3QiLCJjbG9uZSIsInJlZiIsImdlc3R1cmUiLCJyZXZlcnNlIiwibG9jIiwic2l6ZSIsImdldFNpemUiLCJ3aWR0aCIsImhlaWdodCIsInBpY2siLCJwZXJmb3JtR2VzdHVyZSIsImUiLCJlcnJvcnMiLCJOb1N1Y2hFbGVtZW50RXJyb3IiLCJkZWJ1ZyIsInBlcmZvcm1Ub3VjaCIsImlzV2ViQ29udGV4dCIsIk5vdFlldEltcGxlbWVudGVkRXJyb3IiLCJsZW5ndGgiLCJzd2lwZU9wdHMiLCJnZXRTd2lwZU9wdGlvbnMiLCJzd2lwZSIsInRvdWNoQ291bnQiLCJhY3Rpb25zIiwibWFwIiwiaGVhZCIsInBvcCIsInNsaWNlIiwicHJlc3MiLCJzaGlmdCIsIndhaXQiLCJmaXhlZEdlc3R1cmVzIiwicGFyc2VUb3VjaCIsImciLCJtdWx0aSIsInRvdWNoU3RhdGVPYmplY3RzIiwiaW5jbHVkZXMiLCJvZmZzZXQiLCJlbGVtZW50SWQiLCJwb3MiLCJ0b3VjaFN0YXRlT2JqZWN0IiwidGltZU9mZnNldCIsInBhcnNlSW50IiwicHJldlBvcyIsInRpbWUiLCJzdGF0ZSIsImlzVW5kZWZpbmVkIiwiYW5kcm9pZEhlbHBlcnMiLCJ0cnVuY2F0ZURlY2ltYWxzIiwidG91Y2giLCJwZXJmb3JtTXVsdGlBY3Rpb24iLCJFcnJvciIsInN0YXRlcyIsImRvUGVyZm9ybU11bHRpQWN0aW9uIiwiYm9vdHN0cmFwIiwic2VuZEFjdGlvbiIsIk9iamVjdCIsImFzc2lnbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQSxJQUFJQSxRQUFRLEdBQUcsRUFBZjtBQUFBLElBQW1CQyxPQUFPLEdBQUcsRUFBN0I7QUFBQSxJQUFpQ0MsVUFBVSxHQUFHLEVBQTlDOzs7O0FBRUFGLFFBQVEsQ0FBQ0csYUFBVCxHQUF5QixnQkFBZ0JDLE1BQWhCLEVBQXdCQyxJQUF4QixFQUE4QjtBQUNyRCxVQUFRRCxNQUFSO0FBQ0UsU0FBSyxLQUFMO0FBQ0UsYUFBTyxNQUFNLEtBQUtFLEdBQUwsQ0FBU0QsSUFBSSxDQUFDRSxPQUFkLEVBQXVCRixJQUFJLENBQUNHLENBQTVCLEVBQStCSCxJQUFJLENBQUNJLENBQXBDLEVBQXVDSixJQUFJLENBQUNLLEtBQTVDLENBQWI7O0FBQ0YsU0FBSyxPQUFMO0FBQ0UsYUFBTyxNQUFNLEtBQUtDLFNBQUwsQ0FBZU4sSUFBSSxDQUFDRSxPQUFwQixFQUE2QkYsSUFBSSxDQUFDRyxDQUFsQyxFQUFxQ0gsSUFBSSxDQUFDSSxDQUExQyxDQUFiOztBQUNGLFNBQUssU0FBTDtBQUNFLGFBQU8sTUFBTSxLQUFLRyxPQUFMLENBQWFQLElBQUksQ0FBQ0UsT0FBbEIsRUFBMkJGLElBQUksQ0FBQ0csQ0FBaEMsRUFBbUNILElBQUksQ0FBQ0ksQ0FBeEMsQ0FBYjs7QUFDRixTQUFLLFFBQUw7QUFDRSxhQUFPLE1BQU0sS0FBS0ksU0FBTCxDQUFlUixJQUFJLENBQUNFLE9BQXBCLEVBQTZCRixJQUFJLENBQUNHLENBQWxDLEVBQXFDSCxJQUFJ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Q0FBMEJmLFNBQTFCLEVBQXFDYyxNQUFyQyxDQUFiO0FBQ0QsQ0FoQkQ7O0FBd0JBOUYsUUFBUSxDQUFDK0Ysb0JBQVQsR0FBZ0MsZ0JBQWdCZixTQUFoQixFQUEyQmMsTUFBM0IsRUFBbUM7QUFDakUsTUFBSXpGLElBQUo7O0FBQ0EsTUFBSTJFLFNBQUosRUFBZTtBQUNiM0UsSUFBQUEsSUFBSSxHQUFHO0FBQ0wyRSxNQUFBQSxTQURLO0FBRUxmLE1BQUFBLE9BQU8sRUFBRTZCO0FBRkosS0FBUDtBQUlBLFdBQU8sTUFBTSxLQUFLRSxTQUFMLENBQWVDLFVBQWYsQ0FBMEIsb0NBQTFCLEVBQWdFNUYsSUFBaEUsQ0FBYjtBQUNELEdBTkQsTUFNTztBQUNMQSxJQUFBQSxJQUFJLEdBQUc7QUFDTDRELE1BQUFBLE9BQU8sRUFBRTZCO0FBREosS0FBUDtBQUdBLFdBQU8sTUFBTSxLQUFLRSxTQUFMLENBQWVDLFVBQWYsQ0FBMEIsNEJBQTFCLEVBQXdENUYsSUFBeEQsQ0FBYjtBQUNEO0FBQ0YsQ0FkRDs7QUFnQkE2RixNQUFNLENBQUNDLE1BQVAsQ0FBY2pHLFVBQWQsRUFBMEJGLFFBQTFCLEVBQW9DQyxPQUFwQztlQUVlQyxVIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGxvZyBmcm9tICcuLi9sb2dnZXInO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBhbmRyb2lkSGVscGVycyBmcm9tICcuLi9hbmRyb2lkLWhlbHBlcnMnO1xuaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuaW1wb3J0IHsgZXJyb3JzLCBpc0Vycm9yVHlwZSB9IGZyb20gJ2FwcGl1bS1iYXNlLWRyaXZlcic7XG5pbXBvcnQgeyBhc3luY21hcCB9IGZyb20gJ2FzeW5jYm94JztcblxubGV0IGNvbW1hbmRzID0ge30sIGhlbHBlcnMgPSB7fSwgZXh0ZW5zaW9ucyA9IHt9O1xuXG5jb21tYW5kcy5kb1RvdWNoQWN0aW9uID0gYXN5bmMgZnVuY3Rpb24gKGFjdGlvbiwgb3B0cykge1xuICBzd2l0Y2ggKGFjdGlvbikge1xuICAgIGNhc2UgJ3RhcCc6XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy50YXAob3B0cy5lbGVtZW50LCBvcHRzLngsIG9wdHMueSwgb3B0cy5jb3VudCk7XG4gICAgY2FzZSAncHJlc3MnOlxuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMudG91Y2hEb3duKG9wdHMuZWxlbWVudCwgb3B0cy54LCBvcHRzLnkpO1xuICAgIGNhc2UgJ3JlbGVhc2UnOlxuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMudG91Y2hVcChvcHRzLmVsZW1lbnQsIG9wdHMueCwgb3B0cy55KTtcbiAgICBjYXNlICdtb3ZlVG8nOlxuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMudG91Y2hNb3ZlKG9wdHMuZWxlbWVudCwgb3B0cy54LCBvcHRzLnkpO1xuICAgIGNhc2UgJ3dhaXQnOlxuICAgICAgcmV0dXJuIGF3YWl0IEIuZGVsYXkob3B0cy5tcyk7XG4gICAgY2FzZSAnbG9uZ1ByZXNzJzpcbiAgICAgIGlmICh0eXBlb2Ygb3B0cy5kdXJhdGlvbiA9PT0gJ3VuZGVmaW5lZCcgfHwgIW9wdHMuZHVyYXRpb24pIHtcbiAgICAgICAgb3B0cy5kdXJhdGlvbiA9IDEwMDA7XG4gICAgICB9XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy50b3VjaExvbmdDbGljayhvcHRzLmVsZW1lbnQsIG9wdHMueCwgb3B0cy55LCBvcHRzLmR1cmF0aW9uKTtcbiAgICBjYXNlICdjYW5jZWwnOlxuICAgICAgLy8gVE9ETzogY2xhcmlmeSBiZWhhdmlvciBvZiAnY2FuY2VsJyBhY3Rpb24gYW5kIGZpeCB0aGlzXG4gICAgICBsb2cud2FybignQ2FuY2VsIGFjdGlvbiBjdXJyZW50bHkgaGFzIG5vIGVmZmVjdCcpO1xuICAgICAgYnJlYWs7XG4gICAgZGVmYXVsdDpcbiAgICAgIGxvZy5lcnJvckFuZFRocm93KGB1bmtub3duIGFjdGlvbiAke2FjdGlvbn1gKTtcbiAgfVxufTtcblxuXG4vLyBkcmFnIGlzICpub3QqIHByZXNzLW1vdmUtcmVsZWFzZSwgc28gd2UgbmVlZCB0byB0cmFuc2xhdGVcbi8vIGRyYWcgd29ya3MgZmluZSBmb3Igc2Nyb2xsLCBhcyB3ZWxsXG5oZWxwZXJzLmRvVG91Y2hEcmFnID0gYXN5bmMgZnVuY3Rpb24gKGdlc3R1cmVzKSB7XG4gIGxldCBsb25nUHJlc3MgPSBnZXN0dXJlc1swXTtcbiAgbGV0IG1vdmVUbyA9IGdlc3R1cmVzWzFdO1xuICBsZXQgc3RhcnRYID0gbG9uZ1ByZXNzLm9wdGlvbnMueCB8fCAwLFxuICAgICAgc3RhcnRZID0gbG9uZ1ByZXNzLm9wdGlvbnMueSB8fCAwLFxuICAgICAgZW5kWCA9IG1vdmVUby5vcHRpb25zLnggfHwgMCxcbiAgICAgIGVuZFkgPSBtb3ZlVG8ub3B0aW9ucy55IHx8IDA7XG4gIGlmIChsb25nUHJlc3Mub3B0aW9ucy5lbGVtZW50KSB7XG4gICAgbGV0IHt4LCB5fSA9IGF3YWl0IHRoaXMuZ2V0TG9jYXRpb25JblZpZXcobG9uZ1ByZXNzLm9wdGlvbnMuZWxlbWVudCk7XG4gICAgc3RhcnRYICs9IHggfHwgMDtcbiAgICBzdGFydFkgKz0geSB8fCAwO1xuICB9XG4gIGlmIChtb3ZlVG8ub3B0aW9ucy5lbGVtZW50KSB7XG4gICAgbGV0IHt4LCB5fSA9IGF3YWl0IHRoaXMuZ2V0TG9jYXRpb25JblZpZXcobW92ZVRvLm9wdGlvbnMuZWxlbWVudCk7XG4gICAgZW5kWCArPSB4IHx8IDA7XG4gICAgZW5kWSArPSB5IHx8IDA7XG4gIH1cblxuICBsZXQgYXBpTGV2ZWwgPSBhd2FpdCB0aGlzLmFkYi5nZXRBcGlMZXZlbCgpO1xuICAvLyBsb2xsaXBvcCB0YWtlcyBhIGxpdHRsZSBsb25nZXIgdG8gZ2V0IHRoaW5ncyByb2xsaW5nXG4gIGxldCBkdXJhdGlvbiA9IGFwaUxldmVsID49IDUgPyAyIDogMTtcbiAgLy8gbWFrZSBzdXJlIHRoYXQgaWYgdGhlIGxvbmcgcHJlc3MgaGFzIGEgZHVyYXRpb24sIHdlIHVzZSBpdC5cbiAgaWYgKGxvbmdQcmVzcy5vcHRpb25zICYmIGxvbmdQcmVzcy5vcHRpb25zLmR1cmF0aW9uKSB7XG4gICAgZHVyYXRpb24gPSBNYXRoLm1heChsb25nUHJlc3Mub3B0aW9ucy5kdXJhdGlvbiAvIDEwMDAsIGR1cmF0aW9uKTtcbiAgfVxuXG4gIC8vIGBkcmFnYCB3aWxsIHRha2UgY2FyZSBvZiB3aGV0aGVyIHRoZXJlIGlzIGFuIGVsZW1lbnQgb3Igbm90IGF0IHRoYXQgbGV2ZWxcbiAgcmV0dXJuIGF3YWl0IHRoaXMuZHJhZyhzdGFydFgsIHN0YXJ0WSwgZW5kWCwgZW5kWSwgZHVyYXRpb24sIDEsIGxvbmdQcmVzcy5vcHRpb25zLmVsZW1lbnQsIG1vdmVUby5vcHRpb25zLmVsZW1lbnQpO1xufTtcblxuLy8gUmVsZWFzZSBnZXN0dXJlIG5lZWRzIGVsZW1lbnQgb3IgY28tb3JkaW5hdGVzIHRvIHJlbGVhc2UgaXQgZnJvbSB0aGF0IHBvc2l0aW9uXG4vLyBvciBlbHNlIHJlbGVhc2UgZ2VzdHVyZSBpcyBwZXJmb3JtZWQgZnJvbSBjZW50ZXIgb2YgdGhlIHNjcmVlbiwgc28gdG8gZml4IGl0XG4vLyBUaGlzIG1ldGhvZCBzZXRzIGNvLW9yZGluYXRlcy9lbGVtZW50IHRvIHJlbGVhc2UgZ2VzdHVyZSBpZiBpdCBoYXMgbm8gb3B0aW9ucyBzZXQgYWxyZWFkeS5cbmhlbHBlcnMuZml4UmVsZWFzZSA9IGFzeW5jIGZ1bmN0aW9uIChnZXN0dXJlcykge1xuICBsZXQgcmVsZWFzZSA9IF8ubGFzdChnZXN0dXJlcyk7XG4gIC8vIHNvbWV0aW1lcyB0aGVyZSBhcmUgbm8gb3B0aW9uc1xuICByZWxlYXNlLm9wdGlvbnMgPSByZWxlYXNlLm9wdGlvbnMgfHwge307XG4gIC8vIG5vdGhpbmcgdG8gZG8gaWYgcmVsZWFzZSBvcHRpb25zIGFyZSBhbHJlYWR5IHNldFxuICBpZiAocmVsZWFzZS5vcHRpb25zLmVsZW1lbnQgfHwgKHJlbGVhc2Uub3B0aW9ucy54ICYmIHJlbGVhc2Uub3B0aW9ucy55KSkge1xuICAgIHJldHVybjtcbiAgfVxuICAvLyB3aXRob3V0IGNvb3JkaW5hdGVzLCBgcmVsZWFzZWAgdXNlcyB0aGUgY2VudGVyIG9mIHRoZSBzY3JlZW4sIHdoaWNoLFxuICAvLyBnZW5lcmFsbHkgc3BlYWtpbmcsIGlzIG5vdCB3aGF0IHdlIHdhbnRcbiAgLy8gdGhlcmVmb3JlOiBsb29wIGJhY2t3YXJkcyBhbmQgdXNlIHRoZSBsYXN0IGNvbW1hbmQgd2l0aCBhbiBlbGVtZW50IGFuZC9vclxuICAvLyBvZmZzZXQgY29vcmRpbmF0ZXNcbiAgZ2VzdHVyZXMgPSBfLmNsb25lKGdlc3R1cmVzKTtcbiAgbGV0IHJlZiA9IG51bGw7XG4gIGZvciAobGV0IGdlc3R1cmUgb2YgZ2VzdHVyZXMucmV2ZXJzZSgpKSB7XG4gICAgbGV0IG9wdHMgPSBnZXN0dXJlLm9wdGlvbnM7XG4gICAgaWYgKG9wdHMuZWxlbWVudCB8fCAob3B0cy54ICYmIG9wdHMueSkpIHtcbiAgICAgIHJlZiA9IGdlc3R1cmU7XG4gICAgICBicmVhaztcbiAgICB9XG4gIH1cbiAgaWYgKHJlZikge1xuICAgIGxldCBvcHRzID0gcmVmLm9wdGlvbnM7XG4gICAgaWYgKG9wdHMuZWxlbWVudCkge1xuICAgICAgbGV0IGxvYyA9IGF3YWl0IHRoaXMuZ2V0TG9jYXRpb25JblZpZXcob3B0cy5lbGVtZW50KTtcbiAgICAgIGlmIChvcHRzLnggJiYgb3B0cy55KSB7XG4gICAgICAgIC8vIHRoaXMgaXMgYW4gb2Zmc2V0IGZyb20gdGhlIGVsZW1lbnRcbiAgICAgICAgcmVsZWFzZS5vcHRpb25zID0ge1xuICAgICAgICAgIHg6IGxvYy54ICsgb3B0cy54LFxuICAgICAgICAgIHk6IGxvYy55ICsgb3B0cy55XG4gICAgICAgIH07XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyB0aGlzIGlzIHRoZSBjZW50ZXIgb2YgdGhlIGVsZW1lbnRcbiAgICAgICAgbGV0IHNpemUgPSBhd2FpdCB0aGlzLmdldFNpemUob3B0cy5lbGVtZW50KTtcbiAgICAgICAgcmVsZWFzZS5vcHRpb25zID0ge1xuICAgICAgICAgIHg6IGxvYy54ICsgc2l6ZS53aWR0aCAvIDIsXG4gICAgICAgICAgeTogbG9jLnkgKyBzaXplLmhlaWdodCAvIDJcbiAgICAgICAgfTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgcmVsZWFzZS5vcHRpb25zID0gXy5waWNrKG9wdHMsICd4JywgJ3knKTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIHJlbGVhc2U7XG59O1xuXG4vLyBQZXJmb3JtIG9uZSBnZXN0dXJlXG5oZWxwZXJzLnBlcmZvcm1HZXN0dXJlID0gYXN5bmMgZnVuY3Rpb24gKGdlc3R1cmUpIHtcbiAgdHJ5IHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5kb1RvdWNoQWN0aW9uKGdlc3R1cmUuYWN0aW9uLCBnZXN0dXJlLm9wdGlvbnMgfHwge30pO1xuICB9IGNhdGNoIChlKSB7XG4gICAgLy8gc29tZXRpbWUgdGhlIGVsZW1lbnQgaXMgbm90IGF2YWlsYWJsZSB3aGVuIHJlbGVhc2luZywgcmV0cnkgd2l0aG91dCBpdFxuICAgIGlmIChpc0Vycm9yVHlwZShlLCBlcnJvcnMuTm9TdWNoRWxlbWVudEVycm9yKSAmJiBnZXN0dXJlLmFjdGlvbiA9PT0gJ3JlbGVhc2UnICYmXG4gICAgICAgIGdlc3R1cmUub3B0aW9ucy5lbGVtZW50KSB7XG4gICAgICBkZWxldGUgZ2VzdHVyZS5vcHRpb25zLmVsZW1lbnQ7XG4gICAgICBsb2cuZGVidWcoYHJldHJ5aW5nIHJlbGVhc2Ugd2l0aG91dCBlbGVtZW50IG9wdHM6ICR7Z2VzdHVyZS5vcHRpb25zfS5gKTtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLmRvVG91Y2hBY3Rpb24oZ2VzdHVyZS5hY3Rpb24sIGdlc3R1cmUub3B0aW9ucyB8fCB7fSk7XG4gICAgfVxuICAgIHRocm93IGU7XG4gIH1cbn07XG5cbmNvbW1hbmRzLnBlcmZvcm1Ub3VjaCA9IGFzeW5jIGZ1bmN0aW9uIChnZXN0dXJlcykge1xuICBpZiAodGhpcy5pc1dlYkNvbnRleHQoKSkge1xuICAgIHRocm93IG5ldyBlcnJvcnMuTm90WWV0SW1wbGVtZW50ZWRFcnJvcigpO1xuICB9XG5cbiAgLy8gcHJlc3Mtd2FpdC1tb3ZlVG8tcmVsZWFzZSBpcyBgc3dpcGVgLCBzbyB1c2UgbmF0aXZlIG1ldGhvZFxuICBpZiAoZ2VzdHVyZXMubGVuZ3RoID09PSA0ICYmXG4gICAgICBnZXN0dXJlc1swXS5hY3Rpb24gPT09ICdwcmVzcycgJiZcbiAgICAgIGdlc3R1cmVzWzFdLmFjdGlvbiA9PT0gJ3dhaXQnICYmXG4gICAgICBnZXN0dXJlc1syXS5hY3Rpb24gPT09ICdtb3ZlVG8nICYmXG4gICAgICBnZXN0dXJlc1szXS5hY3Rpb24gPT09ICdyZWxlYXNlJykge1xuXG4gICAgbGV0IHN3aXBlT3B0cyA9IGF3YWl0IHRoaXMuZ2V0U3dpcGVPcHRpb25zKGdlc3R1cmVzKTtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5zd2lwZShzd2lwZU9wdHMuc3RhcnRYLCBzd2lwZU9wdHMuc3RhcnRZLCBzd2lwZU9wdHMuZW5kWCxcbiAgICAgICAgc3dpcGVPcHRzLmVuZFksIHN3aXBlT3B0cy5kdXJhdGlvbiwgc3dpcGVPcHRzLnRvdWNoQ291bnQsXG4gICAgICAgIHN3aXBlT3B0cy5lbGVtZW50KTtcbiAgfVxuICBsZXQgYWN0aW9ucyA9IF8ubWFwKGdlc3R1cmVzLCAnYWN0aW9uJyk7XG5cbiAgaWYgKGFjdGlvbnNbMF0gPT09ICdsb25nUHJlc3MnICYmIGFjdGlvbnNbMV0gPT09ICdtb3ZlVG8nICYmIGFjdGlvbnNbMl0gPT09ICdyZWxlYXNlJykge1xuICAgIC8vIHNvbWUgdGhpbmdzIGFyZSBzcGVjaWFsXG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuZG9Ub3VjaERyYWcoZ2VzdHVyZXMpO1xuICB9IGVsc2Uge1xuICAgIGlmIChhY3Rpb25zLmxlbmd0aCA9PT0gMikge1xuICAgICAgLy8gYHByZXNzYCB3aXRob3V0IGEgd2FpdCBpcyB0b28gc2xvdyBhbmQgZ2V0cyBpbnRlcnByZXR0ZWQgYXMgYSBgbG9uZ1ByZXNzYFxuICAgICAgaWYgKF8uaGVhZChhY3Rpb25zKSA9PT0gJ3ByZXNzJyAmJiBfLmxhc3QoYWN0aW9ucykgPT09ICdyZWxlYXNlJykge1xuICAgICAgICBhY3Rpb25zWzBdID0gJ3RhcCc7XG4gICAgICAgIGdlc3R1cmVzWzBdLmFjdGlvbiA9ICd0YXAnO1xuICAgICAgfVxuXG4gICAgICAvLyB0aGUgYGxvbmdQcmVzc2AgYW5kIGB0YXBgIG1ldGhvZHMgcmVsZWFzZSBvbiB0aGVpciBvd25cbiAgICAgIGlmICgoXy5oZWFkKGFjdGlvbnMpID09PSAndGFwJyB8fCBfLmhlYWQoYWN0aW9ucykgPT09ICdsb25nUHJlc3MnKSAmJiBfLmxhc3QoYWN0aW9ucykgPT09ICdyZWxlYXNlJykge1xuICAgICAgICBnZXN0dXJlcy5wb3AoKTtcbiAgICAgICAgYWN0aW9ucy5wb3AoKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgLy8gbG9uZ3ByZXNzIGZvbGxvd2VkIGJ5IGFueXRoaW5nIG90aGVyIHRoYW4gcmVsZWFzZSBzaG91bGQgYmVjb21lIGEgcHJlc3MgYW5kIHdhaXRcbiAgICAgIGlmIChhY3Rpb25zWzBdID09PSAnbG9uZ1ByZXNzJykge1xuICAgICAgICBhY3Rpb25zID0gWydwcmVzcycsICd3YWl0JywgLi4uYWN0aW9ucy5zbGljZSgxKV07XG5cbiAgICAgICAgbGV0IHByZXNzID0gZ2VzdHVyZXMuc2hpZnQoKTtcbiAgICAgICAgcHJlc3MuYWN0aW9uID0gJ3ByZXNzJztcbiAgICAgICAgbGV0IHdhaXQgPSB7XG4gICAgICAgICAgYWN0aW9uOiAnd2FpdCcsXG4gICAgICAgICAgb3B0aW9uczoge21zOiBwcmVzcy5vcHRpb25zLmR1cmF0aW9uIHx8IDEwMDB9XG4gICAgICAgIH07XG4gICAgICAgIGRlbGV0ZSBwcmVzcy5vcHRpb25zLmR1cmF0aW9uO1xuICAgICAgICBnZXN0dXJlcyA9IFtwcmVzcywgd2FpdCwgLi4uZ2VzdHVyZXNdO1xuICAgICAgfVxuICAgIH1cblxuICAgIGxldCBmaXhlZEdlc3R1cmVzID0gYXdhaXQgdGhpcy5wYXJzZVRvdWNoKGdlc3R1cmVzLCBmYWxzZSk7XG4gICAgLy8gZml4IHJlbGVhc2UgYWN0aW9uIHRoZW4gcGVyZm9ybSBhbGwgYWN0aW9uc1xuICAgIGlmIChhY3Rpb25zW2FjdGlvbnMubGVuZ3RoIC0gMV0gPT09ICdyZWxlYXNlJykge1xuICAgICAgYWN0aW9uc1thY3Rpb25zLmxlbmd0aCAtIDFdID0gYXdhaXQgdGhpcy5maXhSZWxlYXNlKGdlc3R1cmVzKTtcbiAgICB9XG4gICAgZm9yIChsZXQgZyBvZiBmaXhlZEdlc3R1cmVzKSB7XG4gICAgICBhd2FpdCB0aGlzLnBlcmZvcm1HZXN0dXJlKGcpO1xuICAgIH1cbiAgfVxufTtcblxuaGVscGVycy5wYXJzZVRvdWNoID0gYXN5bmMgZnVuY3Rpb24gKGdlc3R1cmVzLCBtdWx0aSkge1xuICAvLyBiZWNhdXNlIG11bHRpLXRvdWNoIHJlbGVhc2VzIGF0IHRoZSBlbmQgYnkgZGVmYXVsdFxuICBpZiAobXVsdGkgJiYgXy5sYXN0KGdlc3R1cmVzKS5hY3Rpb24gPT09ICdyZWxlYXNlJykge1xuICAgIGdlc3R1cmVzLnBvcCgpO1xuICB9XG5cbiAgbGV0IHRvdWNoU3RhdGVPYmplY3RzID0gYXdhaXQgYXN5bmNtYXAoZ2VzdHVyZXMsIGFzeW5jIChnZXN0dXJlKSA9PiB7XG4gICAgbGV0IG9wdGlvbnMgPSBnZXN0dXJlLm9wdGlvbnMgfHwge307XG4gICAgaWYgKF8uaW5jbHVkZXMoWydwcmVzcycsICdtb3ZlVG8nLCAndGFwJywgJ2xvbmdQcmVzcyddLCBnZXN0dXJlLmFjdGlvbikpIHtcbiAgICAgIG9wdGlvbnMub2Zmc2V0ID0gZmFsc2U7XG4gICAgICBsZXQgZWxlbWVudElkID0gZ2VzdHVyZS5vcHRpb25zLmVsZW1lbnQ7XG4gICAgICBpZiAoZWxlbWVudElkKSB7XG4gICAgICAgIGxldCBwb3MgPSBhd2FpdCB0aGlzLmdldExvY2F0aW9uSW5WaWV3KGVsZW1lbnRJZCk7XG4gICAgICAgIGlmIChnZXN0dXJlLm9wdGlvbnMueCB8fCBnZXN0dXJlLm9wdGlvbnMueSkge1xuICAgICAgICAgIG9wdGlvbnMueCA9IHBvcy54ICsgKGdlc3R1cmUub3B0aW9ucy54IHx8IDApO1xuICAgICAgICAgIG9wdGlvbnMueSA9IHBvcy55ICsgKGdlc3R1cmUub3B0aW9ucy55IHx8IDApO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGNvbnN0IHt3aWR0aCwgaGVpZ2h0fSA9IGF3YWl0IHRoaXMuZ2V0U2l6ZShlbGVtZW50SWQpO1xuICAgICAgICAgIG9wdGlvbnMueCA9IHBvcy54ICsgKHdpZHRoIC8gMik7XG4gICAgICAgICAgb3B0aW9ucy55ID0gcG9zLnkgKyAoaGVpZ2h0IC8gMik7XG4gICAgICAgIH1cbiAgICAgICAgbGV0IHRvdWNoU3RhdGVPYmplY3QgPSB7XG4gICAgICAgICAgYWN0aW9uOiBnZXN0dXJlLmFjdGlvbixcbiAgICAgICAgICBvcHRpb25zLFxuICAgICAgICAgIHRpbWVPZmZzZXQ6IDAuMDA1LFxuICAgICAgICB9O1xuICAgICAgICByZXR1cm4gdG91Y2hTdGF0ZU9iamVjdDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG9wdGlvbnMueCA9IChnZXN0dXJlLm9wdGlvbnMueCB8fCAwKTtcbiAgICAgICAgb3B0aW9ucy55ID0gKGdlc3R1cmUub3B0aW9ucy55IHx8IDApO1xuXG4gICAgICAgIGxldCB0b3VjaFN0YXRlT2JqZWN0ID0ge1xuICAgICAgICAgIGFjdGlvbjogZ2VzdHVyZS5hY3Rpb24sXG4gICAgICAgICAgb3B0aW9ucyxcbiAgICAgICAgICB0aW1lT2Zmc2V0OiAwLjAwNSxcbiAgICAgICAgfTtcbiAgICAgICAgcmV0dXJuIHRvdWNoU3RhdGVPYmplY3Q7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGxldCBvZmZzZXQgPSAwLjAwNTtcbiAgICAgIGlmIChnZXN0dXJlLmFjdGlvbiA9PT0gJ3dhaXQnKSB7XG4gICAgICAgIG9wdGlvbnMgPSBnZXN0dXJlLm9wdGlvbnM7XG4gICAgICAgIG9mZnNldCA9IChwYXJzZUludChnZXN0dXJlLm9wdGlvbnMubXMsIDEwKSAvIDEwMDApO1xuICAgICAgfVxuICAgICAgbGV0IHRvdWNoU3RhdGVPYmplY3QgPSB7XG4gICAgICAgIGFjdGlvbjogZ2VzdHVyZS5hY3Rpb24sXG4gICAgICAgIG9wdGlvbnMsXG4gICAgICAgIHRpbWVPZmZzZXQ6IG9mZnNldCxcbiAgICAgIH07XG4gICAgICByZXR1cm4gdG91Y2hTdGF0ZU9iamVjdDtcbiAgICB9XG4gIH0sIGZhbHNlKTtcbiAgLy8gd2UgbmVlZCB0byBjaGFuZ2UgdGhlIHRpbWUgKHdoaWNoIGlzIG5vdyBhbiBvZmZzZXQpXG4gIC8vIGFuZCB0aGUgcG9zaXRpb24gKHdoaWNoIG1heSBiZSBhbiBvZmZzZXQpXG4gIGxldCBwcmV2UG9zID0gbnVsbCxcbiAgICAgIHRpbWUgPSAwO1xuICBmb3IgKGxldCBzdGF0ZSBvZiB0b3VjaFN0YXRlT2JqZWN0cykge1xuICAgIGlmIChfLmlzVW5kZWZpbmVkKHN0YXRlLm9wdGlvbnMueCkgJiYgXy5pc1VuZGVmaW5lZChzdGF0ZS5vcHRpb25zLnkpICYmIHByZXZQb3MgIT09IG51bGwpIHtcbiAgICAgIC8vIHRoaXMgaGFwcGVucyB3aXRoIHdhaXRcbiAgICAgIHN0YXRlLm9wdGlvbnMueCA9IHByZXZQb3MueDtcbiAgICAgIHN0YXRlLm9wdGlvbnMueSA9IHByZXZQb3MueTtcbiAgICB9XG4gICAgaWYgKHN0YXRlLm9wdGlvbnMub2Zmc2V0ICYmIHByZXZQb3MpIHtcbiAgICAgIC8vIHRoZSBjdXJyZW50IHBvc2l0aW9uIGlzIGFuIG9mZnNldFxuICAgICAgc3RhdGUub3B0aW9ucy54ICs9IHByZXZQb3MueDtcbiAgICAgIHN0YXRlLm9wdGlvbnMueSArPSBwcmV2UG9zLnk7XG4gICAgfVxuICAgIGRlbGV0ZSBzdGF0ZS5vcHRpb25zLm9mZnNldDtcbiAgICBpZiAoIV8uaXNVbmRlZmluZWQoc3RhdGUub3B0aW9ucy54KSAmJiAhXy5pc1VuZGVmaW5lZChzdGF0ZS5vcHRpb25zLnkpKSB7XG4gICAgICBwcmV2UG9zID0gc3RhdGUub3B0aW9ucztcbiAgICB9XG5cbiAgICBpZiAobXVsdGkpIHtcbiAgICAgIGxldCB0aW1lT2Zmc2V0ID0gc3RhdGUudGltZU9mZnNldDtcbiAgICAgIHRpbWUgKz0gdGltZU9mZnNldDtcbiAgICAgIHN0YXRlLnRpbWUgPSBhbmRyb2lkSGVscGVycy50cnVuY2F0ZURlY2ltYWxzKHRpbWUsIDMpO1xuXG4gICAgICAvLyBtdWx0aSBnZXN0dXJlcyByZXF1aXJlICd0b3VjaCcgcmF0aGVyIHRoYW4gJ29wdGlvbnMnXG4gICAgICBpZiAoIV8uaXNVbmRlZmluZWQoc3RhdGUub3B0aW9ucy54KSAmJiAhXy5pc1VuZGVmaW5lZChzdGF0ZS5vcHRpb25zLnkpKSB7XG4gICAgICAgIHN0YXRlLnRvdWNoID0ge1xuICAgICAgICAgIHg6IHN0YXRlLm9wdGlvbnMueCxcbiAgICAgICAgICB5OiBzdGF0ZS5vcHRpb25zLnlcbiAgICAgICAgfTtcbiAgICAgIH1cbiAgICAgIGRlbGV0ZSBzdGF0ZS5vcHRpb25zO1xuICAgIH1cbiAgICBkZWxldGUgc3RhdGUudGltZU9mZnNldDtcbiAgfVxuICByZXR1cm4gdG91Y2hTdGF0ZU9iamVjdHM7XG59O1xuXG5cbmNvbW1hbmRzLnBlcmZvcm1NdWx0aUFjdGlvbiA9IGFzeW5jIGZ1bmN0aW9uIChhY3Rpb25zLCBlbGVtZW50SWQpIHtcbiAgaWYgKHRoaXMuaXNXZWJDb250ZXh0KCkpIHtcbiAgICB0aHJvdyBuZXcgZXJyb3JzLk5vdFlldEltcGxlbWVudGVkRXJyb3IoKTtcbiAgfVxuXG4gIC8vIEFuZHJvaWQgbmVlZHMgYXQgbGVhc3QgdHdvIGFjdGlvbnMgdG8gYmUgYWJsZSB0byBwZXJmb3JtIGEgbXVsdGkgcG9pbnRlciBnZXN0dXJlXG4gIGlmIChhY3Rpb25zLmxlbmd0aCA9PT0gMSkge1xuICAgIHRocm93IG5ldyBFcnJvcignTXVsdGkgUG9pbnRlciBHZXN0dXJlcyBuZWVkIGF0IGxlYXN0IHR3byBhY3Rpb25zLiAnICtcbiAgICAgICAgJ1VzZSBUb3VjaCBBY3Rpb25zIGZvciBhIHNpbmdsZSBhY3Rpb24uJyk7XG4gIH1cblxuICBsZXQgc3RhdGVzID0gYXdhaXQgYXN5bmNtYXAoYWN0aW9ucywgYXN5bmMgKGFjdGlvbikgPT4ge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLnBhcnNlVG91Y2goYWN0aW9uLCB0cnVlKTtcbiAgfSwgZmFsc2UpO1xuXG4gIHJldHVybiBhd2FpdCB0aGlzLmRvUGVyZm9ybU11bHRpQWN0aW9uKGVsZW1lbnRJZCwgc3RhdGVzKTtcbn07XG5cbi8qKlxuICogUmVhc29uIGZvciBpc29sYXRpbmcgZG9QZXJmb3JtTXVsdGlBY3Rpb24gZnJvbSBwZXJmb3JtTXVsdGlBY3Rpb24gaXMgZm9yIHJldXNpbmcgcGVyZm9ybU11bHRpQWN0aW9uXG4gKiBhY3Jvc3MgYW5kcm9pZC1kcml2ZXJzIChsaWtlIGFwcGl1bS11aWF1dG9tYXRvcjItZHJpdmVyKSBhbmQgdG8gYXZvaWQgY29kZSBkdXBsaWNhdGlvbi5cbiAqIE90aGVyIGFuZHJvaWQtZHJpdmVycyAobGlrZSBhcHBpdW0tdWlhdXRvbWF0b3IyLWRyaXZlcikgbmVlZCB0byBvdmVycmlkZSBkb1BlcmZvcm1NdWx0aUFjdGlvblxuICogdG8gZmFjaWxpdGF0ZSBwZXJmb3JtTXVsdGlBY3Rpb24uXG4gKi9cbmNvbW1hbmRzLmRvUGVyZm9ybU11bHRpQWN0aW9uID0gYXN5bmMgZnVuY3Rpb24gKGVsZW1lbnRJZCwgc3RhdGVzKSB7XG4gIGxldCBvcHRzO1xuICBpZiAoZWxlbWVudElkKSB7XG4gICAgb3B0cyA9IHtcbiAgICAgIGVsZW1lbnRJZCxcbiAgICAgIGFjdGlvbnM6IHN0YXRlc1xuICAgIH07XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuYm9vdHN0cmFwLnNlbmRBY3Rpb24oJ2VsZW1lbnQ6cGVyZm9ybU11bHRpUG9pbnRlckdlc3R1cmUnLCBvcHRzKTtcbiAgfSBlbHNlIHtcbiAgICBvcHRzID0ge1xuICAgICAgYWN0aW9uczogc3RhdGVzXG4gICAgfTtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5ib290c3RyYXAuc2VuZEFjdGlvbigncGVyZm9ybU11bHRpUG9pbnRlckdlc3R1cmUnLCBvcHRzKTtcbiAgfVxufTtcblxuT2JqZWN0LmFzc2lnbihleHRlbnNpb25zLCBjb21tYW5kcywgaGVscGVycyk7XG5leHBvcnQgeyBjb21tYW5kcywgaGVscGVycyB9O1xuZXhwb3J0IGRlZmF1bHQgZXh0ZW5zaW9ucztcbiJdLCJmaWxlIjoibGliL2NvbW1hbmRzL3RvdWNoLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
