"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.commands = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _appiumBaseDriver = require("appium-base-driver");

var _appiumIosDriver = require("appium-ios-driver");

var _appiumSupport = require("appium-support");

var _asyncbox = require("asyncbox");

var _logger = _interopRequireDefault(require("../logger"));

let commands = {},
    extensions = {};
exports.commands = commands;
Object.assign(extensions, _appiumIosDriver.iosCommands.element);

commands.getNativeAttribute = async function getNativeAttribute(attribute, el) {
  if (attribute === 'contentSize') {
    return await this.getContentSize(el);
  }

  let value = await this.proxyCommand(`/element/${el}/attribute/${attribute}`, 'GET');

  if ([0, 1].includes(value)) {
    value = !!value;
  }

  return _lodash.default.isNull(value) || _lodash.default.isString(value) ? value : JSON.stringify(value);
};

commands.getAttribute = async function getAttribute(attribute, el) {
  el = _appiumSupport.util.unwrapElement(el);

  if (!this.isWebContext()) {
    return await this.getNativeAttribute(attribute, el);
  }

  let atomsElement = this.getAtomsElement(el);

  if (_lodash.default.isNull(atomsElement)) {
    throw new _appiumBaseDriver.errors.UnknownError(`Error converting element ID for using in WD atoms: '${el}`);
  }

  return await this.executeAtom('get_attribute_value', [atomsElement, attribute]);
};

commands.getText = async function getText(el) {
  el = _appiumSupport.util.unwrapElement(el);

  if (!this.isWebContext()) {
    return await this.proxyCommand(`/element/${el}/text`, 'GET');
  }

  let atomsElement = this.useAtomsElement(el);
  return await this.executeAtom('get_text', [atomsElement]);
};

commands.getElementRect = async function getElementRect(el) {
  if (this.isWebContext()) {
    const {
      x,
      y
    } = await this.getLocation(el);
    const {
      width,
      height
    } = await this.getSize(el);
    return {
      x,
      y,
      width,
      height
    };
  }

  el = _appiumSupport.util.unwrapElement(el);
  return await this.getNativeRect(el);
};

extensions.getNativeRect = async function getNativeRect(el) {
  return await this.proxyCommand(`/element/${el}/rect`, 'GET');
};

commands.getLocation = async function getLocation(el) {
  el = _appiumSupport.util.unwrapElement(el);

  if (this.isWebContext()) {
    const atomsElement = await this.useAtomsElement(el);
    let loc = await this.executeAtom('get_top_left_coordinates', [atomsElement]);

    if (this.opts.absoluteWebLocations) {
      const script = 'return [document.body.scrollLeft, document.body.scrollTop];';
      const [xOffset, yOffset] = await this.execute(script);
      loc.x += xOffset;
      loc.y += yOffset;
    }

    return loc;
  }

  const rect = await this.getElementRect(el);
  return {
    x: rect.x,
    y: rect.y
  };
};

commands.getLocationInView = async function getLocationInView(el) {
  return await this.getLocation(el);
};

commands.getSize = async function getSize(el) {
  el = _appiumSupport.util.unwrapElement(el);

  if (this.isWebContext()) {
    let atomsElement = this.getAtomsElement(el);

    if (atomsElement === null) {
      throw new _appiumBaseDriver.errors.UnknownError(`Error converting element ID for using in WD atoms: '${el}'`);
    }

    return await this.executeAtom('get_size', [atomsElement]);
  }

  const rect = await this.getElementRect(el);
  return {
    width: rect.width,
    height: rect.height
  };
};

function hasSpecialKeys(keys) {
  for (let char of keys) {
    if (isSpecialKey(char)) {
      return true;
    }
  }

  return false;
}

function isSpecialKey(k) {
  if (k === '\uE003' || k === '\ue017') {
    return true;
  } else if (k === '\uE006' || k === '\uE007') {
    return true;
  }

  return false;
}

function translateKey(k) {
  if (k === '\uE006' || k === '\uE007') {
    return '\n';
  } else if (k === '\uE003' || k === '\ue017') {
    return '\b';
  }

  return k;
}

extensions.bringUpKeyboard = async function bringUpKeyboard(element) {
  let implicitWaitMs = this.implicitWaitMs;
  await this.setImplicitWait(0);

  try {
    await (0, _asyncbox.retryInterval)(10, 10, async () => {
      try {
        await this.findNativeElementOrElements('class name', 'XCUIElementTypeKeyboard', false);

        _logger.default.debug('Keyboard found. Continuing with text input.');
      } catch (err) {
        _logger.default.debug('No keyboard found. Clicking element to open it.');

        await this.nativeClick(element);
        await this.findNativeElementOrElements('class name', 'XCUIElementTypeKeyboard', false);
      }
    });
  } finally {
    await this.setImplicitWait(implicitWaitMs);
  }
};

commands.setValueImmediate = async function setValueImmediate(value, el) {
  _logger.default.info('There is currently no way to bypass typing using XCUITest. Setting value through keyboard');

  await this.setValue(value, el);
};

commands.setValue = async function setValue(value, el) {
  el = _appiumSupport.util.unwrapElement(el);

  if (this.isWebContext()) {
    let atomsElement = this.useAtomsElement(el);
    await this.executeAtom('click', [atomsElement]);
    await this.executeAtom('type', [atomsElement, value]);
  } else {
    const setFormattedValue = async (input, isKeyboardPresenceCheckEnabled) => {
      if (typeof input !== 'string' && !(input instanceof Array)) {
        input = input.toString().split('');
      }

      try {
        await this.proxyCommand(`/element/${el}/value`, 'POST', {
          value: input
        });
      } catch (err) {
        if (isKeyboardPresenceCheckEnabled && (await this.getAttribute('type', el)) === 'XCUIElementTypeTextField') {
          _logger.default.info(`Cannot type in the text field because of ${err}.\nTrying to apply a workaround...`);

          await this.bringUpKeyboard(el);
          await this.proxyCommand(`/element/${el}/value`, 'POST', {
            value: input
          });
        } else {
          throw err;
        }
      }
    };

    if (_lodash.default.isNull(value) || _lodash.default.isUndefined(value) || _lodash.default.isPlainObject(value)) {
      throw new Error(`Only strings and arrays of strings are supported as input arguments. Received: '${JSON.stringify(value)}'`);
    }

    if (_lodash.default.isArray(value)) {
      value = _lodash.default.flatMap(value, v => (_lodash.default.isString(v) ? v : JSON.stringify(v)).split(''));
    } else {
      value = (value || '').toString().split('');
    }

    if (!hasSpecialKeys(value)) {
      await setFormattedValue(value, true);
      return;
    }

    let buffer = [];
    let isFirstChar = true;

    for (let k of value) {
      let char = translateKey(k);

      if (char === k) {
        buffer.push(char);
        continue;
      }

      await setFormattedValue(buffer, isFirstChar);
      isFirstChar = false;
      buffer = [];
      await setFormattedValue([char], isFirstChar);
    }

    if (buffer.length) {
      await setFormattedValue(buffer, false);
    }
  }
};

commands.keys = async function keys(value) {
  if (_lodash.default.isArray(value)) {
    value = value.join('');
  }

  if (_lodash.default.isString(value)) {
    value = value.split('');
  }

  let buffer = [];

  for (let k of value) {
    let char = translateKey(k);
    buffer.push(char);
  }

  await this.proxyCommand('/wda/keys', 'POST', {
    value: buffer
  });
};

commands.clear = async function clear(el) {
  el = _appiumSupport.util.unwrapElement(el);

  if (this.isWebContext()) {
    let atomsElement = this.useAtomsElement(el);
    await this.executeAtom('clear', [atomsElement]);
    return;
  }

  await (0, _asyncbox.retry)(5, this.proxyCommand.bind(this), `/element/${el}/clear`, 'POST');
};

commands.getContentSize = async function getContentSize(el) {
  if (this.isWebContext()) {
    throw new _appiumBaseDriver.errors.NotYetImplementedError('Support for getContentSize for webcontext is not yet implemented. Please contact an Appium dev');
  }

  const type = await this.getAttribute('type', el);

  if (type !== 'XCUIElementTypeTable' && type !== 'XCUIElementTypeCollectionView') {
    throw new Error(`Can't get content size for type '${type}', only for ` + `tables and collection views`);
  }

  let locator = '*';

  if (type === 'XCUIElementTypeTable') {
    locator = 'XCUIElementTypeCell';
  }

  let contentHeight = 0;
  let children = await this.findElOrEls(`class chain`, locator, true, el);

  if (children.length === 1) {
    const rect = await this.getElementRect(_lodash.default.head(children));
    contentHeight = rect.height;
  } else if (children.length) {
    switch (type) {
      case 'XCUIElementTypeTable':
        {
          const firstRect = await this.getElementRect(_lodash.default.head(children));
          const lastRect = await this.getElementRect(_lodash.default.last(children));
          contentHeight = lastRect.y + lastRect.height - firstRect.y;
          break;
        }

      case 'XCUIElementTypeCollectionView':
        {
          let elsInRow = 1;
          let firstRect = await this.getElementRect(_lodash.default.head(children));
          let initialRects = [firstRect];

          for (let i = 1; i < children.length; i++) {
            const rect = await this.getElementRect(children[i]);
            initialRects.push(rect);

            if (rect.y !== firstRect.y) {
              elsInRow = i;
              break;
            }
          }

          const spaceBetweenEls = initialRects[elsInRow].y - initialRects[elsInRow - 1].y - initialRects[elsInRow - 1].height;
          const numRows = Math.ceil(children.length / elsInRow);
          contentHeight = numRows * firstRect.height + spaceBetweenEls * (numRows - 1);
          break;
        }

      default:
        throw new Error(`Programming error: type '${type}' was not ` + `valid but should have already been rejected`);
    }
  }

  const size = await this.getSize(el);
  const origin = await this.getLocationInView(el);
  return JSON.stringify({
    width: size.width,
    height: size.height,
    top: origin.y,
    left: origin.x,
    scrollableOffset: contentHeight
  });
};

commands.isKeyboardShown = async function isKeyboardShown() {
  try {
    await this.findNativeElementOrElements('class name', 'XCUIElementTypeKeyboard', false);
    return true;
  } catch (ign) {
    return false;
  }
};

Object.assign(extensions, commands);
var _default = extensions;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9lbGVtZW50LmpzIl0sIm5hbWVzIjpbImNvbW1hbmRzIiwiZXh0ZW5zaW9ucyIsIk9iamVjdCIsImFzc2lnbiIsImlvc0NvbW1hbmRzIiwiZWxlbWVudCIsImdldE5hdGl2ZUF0dHJpYnV0ZSIsImF0dHJpYnV0ZSIsImVsIiwiZ2V0Q29udGVudFNpemUiLCJ2YWx1ZSIsInByb3h5Q29tbWFuZCIsImluY2x1ZGVzIiwiXyIsImlzTnVsbCIsImlzU3RyaW5nIiwiSlNPTiIsInN0cmluZ2lmeSIsImdldEF0dHJpYnV0ZSIsInV0aWwiLCJ1bndyYXBFbGVtZW50IiwiaXNXZWJDb250ZXh0IiwiYXRvbXNFbGVtZW50IiwiZ2V0QXRvbXNFbGVtZW50IiwiZXJyb3JzIiwiVW5rbm93bkVycm9yIiwiZXhlY3V0ZUF0b20iLCJnZXRUZXh0IiwidXNlQXRvbXNFbGVtZW50IiwiZ2V0RWxlbWVudFJlY3QiLCJ4IiwieSIsImdldExvY2F0aW9uIiwid2lkdGgiLCJoZWlnaHQiLCJnZXRTaXplIiwiZ2V0TmF0aXZlUmVjdCIsImxvYyIsIm9wdHMiLCJhYnNvbHV0ZVdlYkxvY2F0aW9ucyIsInNjcmlwdCIsInhPZmZzZXQiLCJ5T2Zmc2V0IiwiZXhlY3V0ZSIsInJlY3QiLCJnZXRMb2NhdGlvbkluVmlldyIsImhhc1NwZWNpYWxLZXlzIiwia2V5cyIsImNoYXIiLCJpc1NwZWNpYWxLZXkiLCJrIiwidHJhbnNsYXRlS2V5IiwiYnJpbmdVcEtleWJvYXJkIiwiaW1wbGljaXRXYWl0TXMiLCJzZXRJbXBsaWNpdFdhaXQiLCJmaW5kTmF0aXZlRWxlbWVudE9yRWxlbWVudHMiLCJsb2ciLCJkZWJ1ZyIsImVyciIsIm5hdGl2ZUNsaWNrIiwic2V0VmFsdWVJbW1lZGlhdGUiLCJpbmZvIiwic2V0VmFsdWUiLCJzZXRGb3JtYXR0ZWRWYWx1ZSIsImlucHV0IiwiaXNLZXlib2FyZFByZXNlbmNlQ2hlY2tFbmFibGVkIiwiQXJyYXkiLCJ0b1N0cmluZyIsInNwbGl0IiwiaXNVbmRlZmluZWQiLCJpc1BsYWluT2JqZWN0IiwiRXJyb3IiLCJpc0FycmF5IiwiZmxhdE1hcCIsInYiLCJidWZmZXIiLCJpc0ZpcnN0Q2hhciIsInB1c2giLCJsZW5ndGgiLCJqb2luIiwiY2xlYXIiLCJiaW5kIiwiTm90WWV0SW1wbGVtZW50ZWRFcnJvciIsInR5cGUiLCJsb2NhdG9yIiwiY29udGVudEhlaWdodCIsImNoaWxkcmVuIiwiZmluZEVsT3JFbHMiLCJoZWFkIiwiZmlyc3RSZWN0IiwibGFzdFJlY3QiLCJsYXN0IiwiZWxzSW5Sb3ciLCJpbml0aWFsUmVjdHMiLCJpIiwic3BhY2VCZXR3ZWVuRWxzIiwibnVtUm93cyIsIk1hdGgiLCJjZWlsIiwic2l6ZSIsIm9yaWdpbiIsInRvcCIsImxlZnQiLCJzY3JvbGxhYmxlT2Zmc2V0IiwiaXNLZXlib2FyZFNob3duIiwiaWduIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUdBLElBQUlBLFFBQVEsR0FBRyxFQUFmO0FBQUEsSUFBbUJDLFVBQVUsR0FBRyxFQUFoQzs7QUFJQUMsTUFBTSxDQUFDQyxNQUFQLENBQWNGLFVBQWQsRUFBMEJHLDZCQUFZQyxPQUF0Qzs7QUFFQUwsUUFBUSxDQUFDTSxrQkFBVCxHQUE4QixlQUFlQSxrQkFBZixDQUFtQ0MsU0FBbkMsRUFBOENDLEVBQTlDLEVBQWtEO0FBQzlFLE1BQUlELFNBQVMsS0FBSyxhQUFsQixFQUFpQztBQUUvQixXQUFPLE1BQU0sS0FBS0UsY0FBTCxDQUFvQkQsRUFBcEIsQ0FBYjtBQUNEOztBQUdELE1BQUlFLEtBQUssR0FBRyxNQUFNLEtBQUtDLFlBQUwsQ0FBbUIsWUFBV0gsRUFBRyxjQUFhRCxTQUFVLEVBQXhELEVBQTJELEtBQTNELENBQWxCOztBQUVBLE1BQUksQ0FBQyxDQUFELEVBQUksQ0FBSixFQUFPSyxRQUFQLENBQWdCRixLQUFoQixDQUFKLEVBQTRCO0FBQzFCQSxJQUFBQSxLQUFLLEdBQUcsQ0FBQyxD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RCxHQUhELENBR0UsT0FBT2tELEdBQVAsRUFBWTtBQUNaLFdBQU8sS0FBUDtBQUNEO0FBQ0YsQ0FQRDs7QUFTQXZHLE1BQU0sQ0FBQ0MsTUFBUCxDQUFjRixVQUFkLEVBQTBCRCxRQUExQjtlQUVlQyxVIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IGVycm9ycyB9IGZyb20gJ2FwcGl1bS1iYXNlLWRyaXZlcic7XG5pbXBvcnQgeyBpb3NDb21tYW5kcyB9IGZyb20gJ2FwcGl1bS1pb3MtZHJpdmVyJztcbmltcG9ydCB7IHV0aWwgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgeyByZXRyeUludGVydmFsLCByZXRyeSB9IGZyb20gJ2FzeW5jYm94JztcbmltcG9ydCBsb2cgZnJvbSAnLi4vbG9nZ2VyJztcblxuXG5sZXQgY29tbWFuZHMgPSB7fSwgZXh0ZW5zaW9ucyA9IHt9O1xuXG4vLyBwdWxsIGluIGFsbCB0aGUgZWxlbWVudCBjb21tYW5kcyBhbmQgaGVscGVycyBmcm9tIGlvcy1kcml2ZXIsXG4vLyB0aGVuIG92ZXJyaWRlIGFueXRoaW5nIHdlIHdhbnQgYmVsb3dcbk9iamVjdC5hc3NpZ24oZXh0ZW5zaW9ucywgaW9zQ29tbWFuZHMuZWxlbWVudCk7XG5cbmNvbW1hbmRzLmdldE5hdGl2ZUF0dHJpYnV0ZSA9IGFzeW5jIGZ1bmN0aW9uIGdldE5hdGl2ZUF0dHJpYnV0ZSAoYXR0cmlidXRlLCBlbCkge1xuICBpZiAoYXR0cmlidXRlID09PSAnY29udGVudFNpemUnKSB7XG4gICAgLy8gZG9uJ3QgcHJveHkgcmVxdWVzdHMgZm9yIHRoZSBjb250ZW50IHNpemUgb2YgYSBzY3JvbGxhYmxlIGVsZW1lbnRcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5nZXRDb250ZW50U2l6ZShlbCk7XG4gIH1cblxuICAvLyBvdGhlcndpc2UgbGV0IFdEQSBoYW5kbGUgYXR0cmlidXRlIHJlcXVlc3RzXG4gIGxldCB2YWx1ZSA9IGF3YWl0IHRoaXMucHJveHlDb21tYW5kKGAvZWxlbWVudC8ke2VsfS9hdHRyaWJ1dGUvJHthdHRyaWJ1dGV9YCwgJ0dFVCcpO1xuICAvLyBUcmFuc2Zvcm0gdGhlIHJlc3VsdCBmb3IgdGhlIGNhc2Ugd2hlbiBXREEgcmV0dXJucyBhbiBpbnRlZ2VyIHJlcHJlc2VudGF0aW9uIGZvciBhIGJvb2xlYW4gdmFsdWVcbiAgaWYgKFswLCAxXS5pbmNsdWRlcyh2YWx1ZSkpIHtcbiAgICB2YWx1ZSA9ICEhdmFsdWU7XG4gIH1cbiAgLy8gVGhlIHJldHVybmVkIHZhbHVlIG11c3QgYmUgb2YgdHlwZSBzdHJpbmcgYWNjb3JkaW5nIHRvIGh0dHBzOi8vd3d3LnczLm9yZy9UUi93ZWJkcml2ZXIvI2dldC1lbGVtZW50LWF0dHJpYnV0ZVxuICByZXR1cm4gKF8uaXNOdWxsKHZhbHVlKSB8fCBfLmlzU3RyaW5nKHZhbHVlKSkgPyB2YWx1ZSA6IEpTT04uc3RyaW5naWZ5KHZhbHVlKTtcbn07XG5cbmNvbW1hbmRzLmdldEF0dHJpYnV0ZSA9IGFzeW5jIGZ1bmN0aW9uIGdldEF0dHJpYnV0ZSAoYXR0cmlidXRlLCBlbCkge1xuICBlbCA9IHV0aWwudW53cmFwRWxlbWVudChlbCk7XG4gIGlmICghdGhpcy5pc1dlYkNvbnRleHQoKSkge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmdldE5hdGl2ZUF0dHJpYnV0ZShhdHRyaWJ1dGUsIGVsKTtcbiAgfVxuICBsZXQgYXRvbXNFbGVtZW50ID0gdGhpcy5nZXRBdG9tc0VsZW1lbnQoZWwpO1xuICBpZiAoXy5pc051bGwoYXRvbXNFbGVtZW50KSkge1xuICAgIHRocm93IG5ldyBlcnJvcnMuVW5rbm93bkVycm9yKGBFcnJvciBjb252ZXJ0aW5nIGVsZW1lbnQgSUQgZm9yIHVzaW5nIGluIFdEIGF0b21zOiAnJHtlbH1gKTtcbiAgfVxuICByZXR1cm4gYXdhaXQgdGhpcy5leGVjdXRlQXRvbSgnZ2V0X2F0dHJpYnV0ZV92YWx1ZScsIFthdG9tc0VsZW1lbnQsIGF0dHJpYnV0ZV0pO1xufTtcblxuY29tbWFuZHMuZ2V0VGV4dCA9IGFzeW5jIGZ1bmN0aW9uIGdldFRleHQgKGVsKSB7XG4gIGVsID0gdXRpbC51bndyYXBFbGVtZW50KGVsKTtcbiAgaWYgKCF0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMucHJveHlDb21tYW5kKGAvZWxlbWVudC8ke2VsfS90ZXh0YCwgJ0dFVCcpO1xuICB9XG4gIGxldCBhdG9tc0VsZW1lbnQgPSB0aGlzLnVzZUF0b21zRWxlbWVudChlbCk7XG4gIHJldHVybiBhd2FpdCB0aGlzLmV4ZWN1dGVBdG9tKCdnZXRfdGV4dCcsIFthdG9tc0VsZW1lbnRdKTtcbn07XG5cbmNvbW1hbmRzLmdldEVsZW1lbnRSZWN0ID0gYXN5bmMgZnVuY3Rpb24gZ2V0RWxlbWVudFJlY3QgKGVsKSB7XG4gIGlmICh0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgLy8gTW9iaWxlIHNhZmFyaSBkb2Vzbid0IHN1cHBvcnQgcmVjdFxuICAgIGNvbnN0IHt4LCB5fSA9IGF3YWl0IHRoaXMuZ2V0TG9jYXRpb24oZWwpO1xuICAgIGNvbnN0IHt3aWR0aCwgaGVpZ2h0fSA9IGF3YWl0IHRoaXMuZ2V0U2l6ZShlbCk7XG4gICAgcmV0dXJuIHt4LCB5LCB3aWR0aCwgaGVpZ2h0fTtcbiAgfVxuXG4gIGVsID0gdXRpbC51bndyYXBFbGVtZW50KGVsKTtcbiAgcmV0dXJuIGF3YWl0IHRoaXMuZ2V0TmF0aXZlUmVjdChlbCk7XG59O1xuXG5leHRlbnNpb25zLmdldE5hdGl2ZVJlY3QgPSBhc3luYyBmdW5jdGlvbiBnZXROYXRpdmVSZWN0IChlbCkge1xuICByZXR1cm4gYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoYC9lbGVtZW50LyR7ZWx9L3JlY3RgLCAnR0VUJyk7XG59O1xuXG5jb21tYW5kcy5nZXRMb2NhdGlvbiA9IGFzeW5jIGZ1bmN0aW9uIGdldExvY2F0aW9uIChlbCkge1xuICBlbCA9IHV0aWwudW53cmFwRWxlbWVudChlbCk7XG4gIGlmICh0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgY29uc3QgYXRvbXNFbGVtZW50ID0gYXdhaXQgdGhpcy51c2VBdG9tc0VsZW1lbnQoZWwpO1xuICAgIGxldCBsb2MgPSBhd2FpdCB0aGlzLmV4ZWN1dGVBdG9tKCdnZXRfdG9wX2xlZnRfY29vcmRpbmF0ZXMnLCBbYXRvbXNFbGVtZW50XSk7XG4gICAgaWYgKHRoaXMub3B0cy5hYnNvbHV0ZVdlYkxvY2F0aW9ucykge1xuICAgICAgY29uc3Qgc2NyaXB0ID0gJ3JldHVybiBbZG9jdW1lbnQuYm9keS5zY3JvbGxMZWZ0LCBkb2N1bWVudC5ib2R5LnNjcm9sbFRvcF07JztcbiAgICAgIGNvbnN0IFt4T2Zmc2V0LCB5T2Zmc2V0XSA9IGF3YWl0IHRoaXMuZXhlY3V0ZShzY3JpcHQpO1xuICAgICAgbG9jLnggKz0geE9mZnNldDtcbiAgICAgIGxvYy55ICs9IHlPZmZzZXQ7XG4gICAgfVxuICAgIHJldHVybiBsb2M7XG4gIH1cblxuICBjb25zdCByZWN0ID0gYXdhaXQgdGhpcy5nZXRFbGVtZW50UmVjdChlbCk7XG4gIHJldHVybiB7eDogcmVjdC54LCB5OiByZWN0Lnl9O1xufTtcblxuY29tbWFuZHMuZ2V0TG9jYXRpb25JblZpZXcgPSBhc3luYyBmdW5jdGlvbiBnZXRMb2NhdGlvbkluVmlldyAoZWwpIHtcbiAgcmV0dXJuIGF3YWl0IHRoaXMuZ2V0TG9jYXRpb24oZWwpO1xufTtcblxuY29tbWFuZHMuZ2V0U2l6ZSA9IGFzeW5jIGZ1bmN0aW9uIGdldFNpemUgKGVsKSB7XG4gIGVsID0gdXRpbC51bndyYXBFbGVtZW50KGVsKTtcbiAgaWYgKHRoaXMuaXNXZWJDb250ZXh0KCkpIHtcbiAgICBsZXQgYXRvbXNFbGVtZW50ID0gdGhpcy5nZXRBdG9tc0VsZW1lbnQoZWwpO1xuICAgIGlmIChhdG9tc0VsZW1lbnQgPT09IG51bGwpIHtcbiAgICAgIHRocm93IG5ldyBlcnJvcnMuVW5rbm93bkVycm9yKGBFcnJvciBjb252ZXJ0aW5nIGVsZW1lbnQgSUQgZm9yIHVzaW5nIGluIFdEIGF0b21zOiAnJHtlbH0nYCk7XG4gICAgfVxuICAgIHJldHVybiBhd2FpdCB0aGlzLmV4ZWN1dGVBdG9tKCdnZXRfc2l6ZScsIFthdG9tc0VsZW1lbnRdKTtcbiAgfVxuXG4gIGNvbnN0IHJlY3QgPSBhd2FpdCB0aGlzLmdldEVsZW1lbnRSZWN0KGVsKTtcbiAgcmV0dXJuIHt3aWR0aDogcmVjdC53aWR0aCwgaGVpZ2h0OiByZWN0LmhlaWdodH07XG59O1xuXG5mdW5jdGlvbiBoYXNTcGVjaWFsS2V5cyAoa2V5cykge1xuICBmb3IgKGxldCBjaGFyIG9mIGtleXMpIHtcbiAgICBpZiAoaXNTcGVjaWFsS2V5KGNoYXIpKSB7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIGZhbHNlO1xufVxuXG5mdW5jdGlvbiBpc1NwZWNpYWxLZXkgKGspIHtcbiAgaWYgKGsgPT09ICdcXHVFMDAzJyB8fCBrID09PSAnXFx1ZTAxNycpIHsgLy8gQkFDS1NQQUNFIG9yIERFTEVURVxuICAgIHJldHVybiB0cnVlO1xuICB9IGVsc2UgaWYgKGsgPT09ICdcXHVFMDA2JyB8fCBrID09PSAnXFx1RTAwNycpIHsgLy8gUkVUVVJOIG9yIEVOVEVSXG4gICAgcmV0dXJuIHRydWU7XG4gIH1cbiAgcmV0dXJuIGZhbHNlO1xufVxuXG5mdW5jdGlvbiB0cmFuc2xhdGVLZXkgKGspIHtcbiAgaWYgKGsgPT09ICdcXHVFMDA2JyB8fCBrID09PSAnXFx1RTAwNycpIHsgLy8gUkVUVVJOIG9yIEVOVEVSXG4gICAgcmV0dXJuICdcXG4nO1xuICB9IGVsc2UgaWYgKGsgPT09ICdcXHVFMDAzJyB8fCBrID09PSAnXFx1ZTAxNycpIHsgLy8gQkFDS1NQQUNFIG9yIERFTEVURVxuICAgIHJldHVybiAnXFxiJztcbiAgfVxuICByZXR1cm4gaztcbn1cblxuZXh0ZW5zaW9ucy5icmluZ1VwS2V5Ym9hcmQgPSBhc3luYyBmdW5jdGlvbiBicmluZ1VwS2V5Ym9hcmQgKGVsZW1lbnQpIHtcbiAgLy8gc29tZXRpbWVzIGlucHV0IGlzIGF0dGVtcHRlZCBiZWZvcmUgd2UgaGF2ZSBhIGtleWJvYXJkLiBUcnkgdG8gYnJpbmcgb25lIHVwXG4gIC8vIGJ1dCB3ZSB3YW50IHRvIGhhbmRsZSB0aGUgcmV0cmllcyBvbiBmaW5kXG4gIGxldCBpbXBsaWNpdFdhaXRNcyA9IHRoaXMuaW1wbGljaXRXYWl0TXM7XG4gIGF3YWl0IHRoaXMuc2V0SW1wbGljaXRXYWl0KDApO1xuICB0cnkge1xuICAgIGF3YWl0IHJldHJ5SW50ZXJ2YWwoMTAsIDEwLCBhc3luYyAoKSA9PiB7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCB0aGlzLmZpbmROYXRpdmVFbGVtZW50T3JFbGVtZW50cygnY2xhc3MgbmFtZScsICdYQ1VJRWxlbWVudFR5cGVLZXlib2FyZCcsIGZhbHNlKTtcbiAgICAgICAgbG9nLmRlYnVnKCdLZXlib2FyZCBmb3VuZC4gQ29udGludWluZyB3aXRoIHRleHQgaW5wdXQuJyk7XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgLy8gbm8ga2V5Ym9hcmQgZm91bmRcbiAgICAgICAgbG9nLmRlYnVnKCdObyBrZXlib2FyZCBmb3VuZC4gQ2xpY2tpbmcgZWxlbWVudCB0byBvcGVuIGl0LicpO1xuICAgICAgICBhd2FpdCB0aGlzLm5hdGl2ZUNsaWNrKGVsZW1lbnQpO1xuXG4gICAgICAgIGF3YWl0IHRoaXMuZmluZE5hdGl2ZUVsZW1lbnRPckVsZW1lbnRzKCdjbGFzcyBuYW1lJywgJ1hDVUlFbGVtZW50VHlwZUtleWJvYXJkJywgZmFsc2UpO1xuICAgICAgfVxuICAgIH0pO1xuICB9IGZpbmFsbHkge1xuICAgIC8vIG5vIG1hdHRlciB3aGF0IHdlIGRvLCBtYWtlIHN1cmUgd2UgaGF2ZSB0aGUgaW1wbGljaXQgd2FpdCBzZXQgdXAgY29ycmVjdGx5XG4gICAgYXdhaXQgdGhpcy5zZXRJbXBsaWNpdFdhaXQoaW1wbGljaXRXYWl0TXMpO1xuICB9XG59O1xuXG5jb21tYW5kcy5zZXRWYWx1ZUltbWVkaWF0ZSA9IGFzeW5jIGZ1bmN0aW9uIHNldFZhbHVlSW1tZWRpYXRlICh2YWx1ZSwgZWwpIHtcbiAgLy8gV0RBIGRvZXMgbm90IHByb3ZpZGUgbm8gd2F5IHRvIHNldCB0aGUgdmFsdWUgZGlyZWN0bHlcbiAgbG9nLmluZm8oJ1RoZXJlIGlzIGN1cnJlbnRseSBubyB3YXkgdG8gYnlwYXNzIHR5cGluZyB1c2luZyBYQ1VJVGVzdC4gU2V0dGluZyB2YWx1ZSB0aHJvdWdoIGtleWJvYXJkJyk7XG4gIGF3YWl0IHRoaXMuc2V0VmFsdWUodmFsdWUsIGVsKTtcbn07XG5cbmNvbW1hbmRzLnNldFZhbHVlID0gYXN5bmMgZnVuY3Rpb24gc2V0VmFsdWUgKHZhbHVlLCBlbCkge1xuICBlbCA9IHV0aWwudW53cmFwRWxlbWVudChlbCk7XG4gIGlmICh0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgbGV0IGF0b21zRWxlbWVudCA9IHRoaXMudXNlQXRvbXNFbGVtZW50KGVsKTtcbiAgICBhd2FpdCB0aGlzLmV4ZWN1dGVBdG9tKCdjbGljaycsIFthdG9tc0VsZW1lbnRdKTtcbiAgICBhd2FpdCB0aGlzLmV4ZWN1dGVBdG9tKCd0eXBlJywgW2F0b21zRWxlbWVudCwgdmFsdWVdKTtcbiAgfSBlbHNlIHtcbiAgICBjb25zdCBzZXRGb3JtYXR0ZWRWYWx1ZSA9IGFzeW5jIChpbnB1dCwgaXNLZXlib2FyZFByZXNlbmNlQ2hlY2tFbmFibGVkKSA9PiB7XG4gICAgICBpZiAodHlwZW9mIGlucHV0ICE9PSAnc3RyaW5nJyAmJiAhKGlucHV0IGluc3RhbmNlb2YgQXJyYXkpKSB7XG4gICAgICAgIGlucHV0ID0gaW5wdXQudG9TdHJpbmcoKS5zcGxpdCgnJyk7XG4gICAgICB9XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCB0aGlzLnByb3h5Q29tbWFuZChgL2VsZW1lbnQvJHtlbH0vdmFsdWVgLCAnUE9TVCcsIHt2YWx1ZTogaW5wdXR9KTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAvLyBtYWtlIHN1cmUgdGhlcmUgaXMgYSBrZXlib2FyZCBpZiB0aGlzIGlzIGEgdGV4dCBmaWVsZFxuICAgICAgICBpZiAoaXNLZXlib2FyZFByZXNlbmNlQ2hlY2tFbmFibGVkICYmIGF3YWl0IHRoaXMuZ2V0QXR0cmlidXRlKCd0eXBlJywgZWwpID09PSAnWENVSUVsZW1lbnRUeXBlVGV4dEZpZWxkJykge1xuICAgICAgICAgIGxvZy5pbmZvKGBDYW5ub3QgdHlwZSBpbiB0aGUgdGV4dCBmaWVsZCBiZWNhdXNlIG9mICR7ZXJyfS5cXG5UcnlpbmcgdG8gYXBwbHkgYSB3b3JrYXJvdW5kLi4uYCk7XG4gICAgICAgICAgYXdhaXQgdGhpcy5icmluZ1VwS2V5Ym9hcmQoZWwpO1xuICAgICAgICAgIGF3YWl0IHRoaXMucHJveHlDb21tYW5kKGAvZWxlbWVudC8ke2VsfS92YWx1ZWAsICdQT1NUJywge3ZhbHVlOiBpbnB1dH0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRocm93IGVycjtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH07XG5cbiAgICAvLyBwb3NzaWJsZSB2YWx1ZXMgb2YgYHZhbHVlYDpcbiAgICAvLyAgIFsnc29tZSB0ZXh0J11cbiAgICAvLyAgIFsncycsICdvJywgJ20nLCAnZScsICcgJywgJ3QnLCAnZScsICd4JywgJ3QnXVxuICAgIC8vICAgJ3NvbWUgdGV4dCdcbiAgICBpZiAoXy5pc051bGwodmFsdWUpIHx8IF8uaXNVbmRlZmluZWQodmFsdWUpIHx8IF8uaXNQbGFpbk9iamVjdCh2YWx1ZSkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgT25seSBzdHJpbmdzIGFuZCBhcnJheXMgb2Ygc3RyaW5ncyBhcmUgc3VwcG9ydGVkIGFzIGlucHV0IGFyZ3VtZW50cy4gUmVjZWl2ZWQ6ICcke0pTT04uc3RyaW5naWZ5KHZhbHVlKX0nYCk7XG4gICAgfVxuICAgIGlmIChfLmlzQXJyYXkodmFsdWUpKSB7XG4gICAgICAvLyBtYWtlIHN1cmUgdGhhdCBhbGwgdGhlIHN0cmluZ3MgaW5zaWRlIGFyZSBhIHNpbmdsZSBjaGFyYWN0ZXIgbG9uZ1xuICAgICAgdmFsdWUgPSBfLmZsYXRNYXAodmFsdWUsICh2KSA9PiAoXy5pc1N0cmluZyh2KSA/IHYgOiBKU09OLnN0cmluZ2lmeSh2KSkuc3BsaXQoJycpKTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gbWFrZSBpdCBpbnRvIGFuIGFycmF5IG9mIGNoYXJhY3RlcnNcbiAgICAgIHZhbHVlID0gKHZhbHVlIHx8ICcnKS50b1N0cmluZygpLnNwbGl0KCcnKTtcbiAgICB9XG5cbiAgICBpZiAoIWhhc1NwZWNpYWxLZXlzKHZhbHVlKSkge1xuICAgICAgLy8gbm90aGluZyBzcGVjaWFsLCBzbyBqdXN0IHNlbmQgaXQgaW5cbiAgICAgIGF3YWl0IHNldEZvcm1hdHRlZFZhbHVlKHZhbHVlLCB0cnVlKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICAvLyBpZiB0aGVyZSBhcmUgc3BlY2lhbCBjaGFyYWN0ZXJzLCBnbyB0aHJvdWdoIHRoZSB2YWx1ZSB1bnRpbCB3ZSBnZXQgdG8gb25lLFxuICAgIC8vIGFuZCB0aGVuIHByaW50IGl0IGluZGl2aWR1YWxseVxuICAgIC8vIGN1cnJlbnRseSBvbmx5IHN1cHBvcnRpbmcgcmV0dXJuLCBlbnRlciwgYmFja3NwYWNlLCBhbmQgZGVsZXRlXG4gICAgbGV0IGJ1ZmZlciA9IFtdO1xuICAgIGxldCBpc0ZpcnN0Q2hhciA9IHRydWU7XG4gICAgZm9yIChsZXQgayBvZiB2YWx1ZSkge1xuICAgICAgbGV0IGNoYXIgPSB0cmFuc2xhdGVLZXkoayk7XG5cbiAgICAgIGlmIChjaGFyID09PSBrKSB7XG4gICAgICAgIGJ1ZmZlci5wdXNoKGNoYXIpO1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cblxuICAgICAgLy8gd3JpdGUgYW5kIGNsZWFyIHRoZSBidWZmZXJcbiAgICAgIGF3YWl0IHNldEZvcm1hdHRlZFZhbHVlKGJ1ZmZlciwgaXNGaXJzdENoYXIpO1xuICAgICAgaXNGaXJzdENoYXIgPSBmYWxzZTtcbiAgICAgIGJ1ZmZlciA9IFtdO1xuXG4gICAgICAvLyB3cml0ZSB0aGUgY2hhcmFjdGVyXG4gICAgICBhd2FpdCBzZXRGb3JtYXR0ZWRWYWx1ZShbY2hhcl0sIGlzRmlyc3RDaGFyKTtcbiAgICB9XG4gICAgLy8gZmluYWxseSwgc2VuZCBhbnl0aGluZyB0aGF0IG1pZ2h0IGJlIGxlZnRcbiAgICBpZiAoYnVmZmVyLmxlbmd0aCkge1xuICAgICAgYXdhaXQgc2V0Rm9ybWF0dGVkVmFsdWUoYnVmZmVyLCBmYWxzZSk7XG4gICAgfVxuICB9XG59O1xuXG5jb21tYW5kcy5rZXlzID0gYXN5bmMgZnVuY3Rpb24ga2V5cyAodmFsdWUpIHtcbiAgaWYgKF8uaXNBcnJheSh2YWx1ZSkpIHtcbiAgICAvLyBjb25jYXRlbmF0ZSBhbnkgaW5kaXZpZHVhbCBzdHJpbmdzXG4gICAgdmFsdWUgPSB2YWx1ZS5qb2luKCcnKTtcbiAgfVxuICBpZiAoXy5pc1N0cmluZyh2YWx1ZSkpIHtcbiAgICAvLyBzcGxpdCBpbnRvIGNvbXBvbmVudCBjaGFyYWN0ZXJzXG4gICAgdmFsdWUgPSB2YWx1ZS5zcGxpdCgnJyk7XG4gIH1cblxuICBsZXQgYnVmZmVyID0gW107XG4gIGZvciAobGV0IGsgb2YgdmFsdWUpIHtcbiAgICBsZXQgY2hhciA9IHRyYW5zbGF0ZUtleShrKTtcblxuICAgIGJ1ZmZlci5wdXNoKGNoYXIpO1xuICB9XG4gIGF3YWl0IHRoaXMucHJveHlDb21tYW5kKCcvd2RhL2tleXMnLCAnUE9TVCcsIHt2YWx1ZTogYnVmZmVyfSk7XG59O1xuXG5jb21tYW5kcy5jbGVhciA9IGFzeW5jIGZ1bmN0aW9uIGNsZWFyIChlbCkge1xuICBlbCA9IHV0aWwudW53cmFwRWxlbWVudChlbCk7XG4gIGlmICh0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgbGV0IGF0b21zRWxlbWVudCA9IHRoaXMudXNlQXRvbXNFbGVtZW50KGVsKTtcbiAgICBhd2FpdCB0aGlzLmV4ZWN1dGVBdG9tKCdjbGVhcicsIFthdG9tc0VsZW1lbnRdKTtcbiAgICByZXR1cm47XG4gIH1cbiAgYXdhaXQgcmV0cnkoNSwgdGhpcy5wcm94eUNvbW1hbmQuYmluZCh0aGlzKSwgYC9lbGVtZW50LyR7ZWx9L2NsZWFyYCwgJ1BPU1QnKTtcbn07XG5cbmNvbW1hbmRzLmdldENvbnRlbnRTaXplID0gYXN5bmMgZnVuY3Rpb24gZ2V0Q29udGVudFNpemUgKGVsKSB7XG4gIGlmICh0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5Ob3RZZXRJbXBsZW1lbnRlZEVycm9yKCdTdXBwb3J0IGZvciBnZXRDb250ZW50U2l6ZSBmb3Igd2ViY29udGV4dCBpcyBub3QgeWV0IGltcGxlbWVudGVkLiBQbGVhc2UgY29udGFjdCBhbiBBcHBpdW0gZGV2Jyk7XG4gIH1cblxuICBjb25zdCB0eXBlID0gYXdhaXQgdGhpcy5nZXRBdHRyaWJ1dGUoJ3R5cGUnLCBlbCk7XG5cbiAgaWYgKHR5cGUgIT09ICdYQ1VJRWxlbWVudFR5cGVUYWJsZScgJiZcbiAgICAgIHR5cGUgIT09ICdYQ1VJRWxlbWVudFR5cGVDb2xsZWN0aW9uVmlldycpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYENhbid0IGdldCBjb250ZW50IHNpemUgZm9yIHR5cGUgJyR7dHlwZX0nLCBvbmx5IGZvciBgICtcbiAgICAgICAgICAgICAgICAgICAgYHRhYmxlcyBhbmQgY29sbGVjdGlvbiB2aWV3c2ApO1xuICB9XG4gIGxldCBsb2NhdG9yID0gJyonO1xuICBpZiAodHlwZSA9PT0gJ1hDVUlFbGVtZW50VHlwZVRhYmxlJykge1xuICAgIC8vIG9ubHkgZmluZCB0YWJsZSBjZWxscywgbm90IGp1c3QgYW55IGNoaWxkcmVuXG4gICAgbG9jYXRvciA9ICdYQ1VJRWxlbWVudFR5cGVDZWxsJztcbiAgfVxuXG4gIGxldCBjb250ZW50SGVpZ2h0ID0gMDtcbiAgbGV0IGNoaWxkcmVuID0gYXdhaXQgdGhpcy5maW5kRWxPckVscyhgY2xhc3MgY2hhaW5gLCBsb2NhdG9yLCB0cnVlLCBlbCk7XG4gIGlmIChjaGlsZHJlbi5sZW5ndGggPT09IDEpIHtcbiAgICAvLyBpZiB3ZSBrbm93IHRoZXJlJ3Mgb25seSBvbmUgZWxlbWVudCwgd2UgY2FuIG9wdGltaXplIHRvIG1ha2UganVzdCBvbmVcbiAgICAvLyBjYWxsIHRvIFdEQVxuICAgIGNvbnN0IHJlY3QgPSBhd2FpdCB0aGlzLmdldEVsZW1lbnRSZWN0KF8uaGVhZChjaGlsZHJlbikpO1xuICAgIGNvbnRlbnRIZWlnaHQgPSByZWN0LmhlaWdodDtcbiAgfSBlbHNlIGlmIChjaGlsZHJlbi5sZW5ndGgpIHtcbiAgICAvLyBvdGhlcndpc2UgaWYgd2UgaGF2ZSBtdWx0aXBsZSBlbGVtZW50cywgbG9naWMgZGlmZmVycyBiYXNlZCBvbiBlbGVtZW50XG4gICAgLy8gdHlwZVxuICAgIHN3aXRjaCAodHlwZSkge1xuICAgICAgY2FzZSAnWENVSUVsZW1lbnRUeXBlVGFibGUnOiB7XG4gICAgICAgIGNvbnN0IGZpcnN0UmVjdCA9IGF3YWl0IHRoaXMuZ2V0RWxlbWVudFJlY3QoXy5oZWFkKGNoaWxkcmVuKSk7XG4gICAgICAgIGNvbnN0IGxhc3RSZWN0ID0gYXdhaXQgdGhpcy5nZXRFbGVtZW50UmVjdChfLmxhc3QoY2hpbGRyZW4pKTtcbiAgICAgICAgY29udGVudEhlaWdodCA9IGxhc3RSZWN0LnkgKyBsYXN0UmVjdC5oZWlnaHQgLSBmaXJzdFJlY3QueTtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgICBjYXNlICdYQ1VJRWxlbWVudFR5cGVDb2xsZWN0aW9uVmlldyc6IHtcbiAgICAgICAgbGV0IGVsc0luUm93ID0gMTsgLy8gd2Uga25vdyB0aGVyZSBtdXN0IGJlIGF0IGxlYXN0IG9uZSBlbGVtZW50IGluIHRoZSByb3dcbiAgICAgICAgbGV0IGZpcnN0UmVjdCA9IGF3YWl0IHRoaXMuZ2V0RWxlbWVudFJlY3QoXy5oZWFkKGNoaWxkcmVuKSk7XG4gICAgICAgIGxldCBpbml0aWFsUmVjdHMgPSBbZmlyc3RSZWN0XTtcbiAgICAgICAgZm9yIChsZXQgaSA9IDE7IGkgPCBjaGlsZHJlbi5sZW5ndGg7IGkrKykge1xuICAgICAgICAgIGNvbnN0IHJlY3QgPSBhd2FpdCB0aGlzLmdldEVsZW1lbnRSZWN0KGNoaWxkcmVuW2ldKTtcbiAgICAgICAgICBpbml0aWFsUmVjdHMucHVzaChyZWN0KTtcbiAgICAgICAgICBpZiAocmVjdC55ICE9PSBmaXJzdFJlY3QueSkge1xuICAgICAgICAgICAgZWxzSW5Sb3cgPSBpO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHNwYWNlQmV0d2VlbkVscyA9IGluaXRpYWxSZWN0c1tlbHNJblJvd10ueSAtIGluaXRpYWxSZWN0c1tlbHNJblJvdyAtIDFdLnkgLSBpbml0aWFsUmVjdHNbZWxzSW5Sb3cgLSAxXS5oZWlnaHQ7XG4gICAgICAgIGNvbnN0IG51bVJvd3MgPSBNYXRoLmNlaWwoY2hpbGRyZW4ubGVuZ3RoIC8gZWxzSW5Sb3cpO1xuXG4gICAgICAgIC8vIGFzc3VtZSBhbGwgY2VsbHMgYXJlIHRoZSBzYW1lIGhlaWdodFxuICAgICAgICBjb250ZW50SGVpZ2h0ID0gKG51bVJvd3MgKiBmaXJzdFJlY3QuaGVpZ2h0KSArIChzcGFjZUJldHdlZW5FbHMgKiAobnVtUm93cyAtIDEpKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgICBkZWZhdWx0OiB0aHJvdyBuZXcgRXJyb3IoYFByb2dyYW1taW5nIGVycm9yOiB0eXBlICcke3R5cGV9JyB3YXMgbm90IGAgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGB2YWxpZCBidXQgc2hvdWxkIGhhdmUgYWxyZWFkeSBiZWVuIHJlamVjdGVkYCk7XG4gICAgfVxuICB9XG4gIGNvbnN0IHNpemUgPSBhd2FpdCB0aGlzLmdldFNpemUoZWwpO1xuICBjb25zdCBvcmlnaW4gPSBhd2FpdCB0aGlzLmdldExvY2F0aW9uSW5WaWV3KGVsKTtcbiAgLy8gYXR0cmlidXRlcyBoYXZlIHRvIGJlIHN0cmluZ3MsIHNvIHN0cmluZ2lmeSB0aGlzIHVwXG4gIHJldHVybiBKU09OLnN0cmluZ2lmeSh7XG4gICAgd2lkdGg6IHNpemUud2lkdGgsXG4gICAgaGVpZ2h0OiBzaXplLmhlaWdodCxcbiAgICB0b3A6IG9yaWdpbi55LFxuICAgIGxlZnQ6IG9yaWdpbi54LFxuICAgIHNjcm9sbGFibGVPZmZzZXQ6IGNvbnRlbnRIZWlnaHRcbiAgfSk7XG59O1xuXG5jb21tYW5kcy5pc0tleWJvYXJkU2hvd24gPSBhc3luYyBmdW5jdGlvbiBpc0tleWJvYXJkU2hvd24gKCkge1xuICB0cnkge1xuICAgIGF3YWl0IHRoaXMuZmluZE5hdGl2ZUVsZW1lbnRPckVsZW1lbnRzKCdjbGFzcyBuYW1lJywgJ1hDVUlFbGVtZW50VHlwZUtleWJvYXJkJywgZmFsc2UpO1xuICAgIHJldHVybiB0cnVlO1xuICB9IGNhdGNoIChpZ24pIHtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cbn07XG5cbk9iamVjdC5hc3NpZ24oZXh0ZW5zaW9ucywgY29tbWFuZHMpO1xuZXhwb3J0IHsgY29tbWFuZHMgfTtcbmV4cG9ydCBkZWZhdWx0IGV4dGVuc2lvbnM7XG4iXSwiZmlsZSI6ImxpYi9jb21tYW5kcy9lbGVtZW50LmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
