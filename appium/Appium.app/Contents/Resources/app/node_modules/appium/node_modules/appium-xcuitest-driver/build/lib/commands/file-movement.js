"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.commands = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _appiumSupport = require("appium-support");

var _path = _interopRequireDefault(require("path"));

var _appiumIosDriver = require("appium-ios-driver");

var _logger = _interopRequireDefault(require("../logger"));

var _teen_process = require("teen_process");

var _nodeSimctl = require("node-simctl");

const CONTAINER_PATH_MARKER = '@';
const CONTAINER_PATH_PATTERN = new RegExp(`^${CONTAINER_PATH_MARKER}([^/]+)/(.+)`);
const CONTAINER_TYPE_SEPARATOR = ':';
let commands = _appiumIosDriver.iosCommands.file;
exports.commands = commands;

async function verifyIFusePresence() {
  if (!(await _appiumSupport.fs.which('ifuse'))) {
    _logger.default.errorAndThrow(`'ifuse' tool is required to be installed on the machine. ` + `Install it using 'brew cask install osxfuse && brew install ifuse' or check ` + `if it is available in PATH environment variable if the tool is already installed. ` + `Current PATH value: ${process.env.PATH}`);
  }
}

async function mountDevice(device, iFuseArgs) {
  _logger.default.debug(`Starting ifuse with args '${iFuseArgs}'...`);

  try {
    await (0, _teen_process.exec)('ifuse', iFuseArgs);
  } catch (e) {
    _logger.default.errorAndThrow(`Cannot mount the media folder of the device with UDID ${device.udid}. ` + `Make sure osxfuse plugin has necessary permissions in System Preferences->Security & Privacy. ` + `Error code: ${e.code}; stderr output: ${e.stderr}`);
  }
}

function verifyIsSubPath(originalPath, root) {
  const normalizedRoot = _path.default.normalize(root);

  const normalizedPath = _path.default.normalize(_path.default.dirname(originalPath));

  if (!normalizedPath.startsWith(normalizedRoot)) {
    _logger.default.errorAndThrow(`'${normalizedPath}' is expected to be a subpath of '${normalizedRoot}'`);
  }
}

async function parseContainerPath(remotePath, containerRootSupplier) {
  const match = CONTAINER_PATH_PATTERN.exec(remotePath);

  if (!match) {
    _logger.default.errorAndThrow(`It is expected that package identifier ` + `starts with '${CONTAINER_PATH_MARKER}' and is separated from the ` + `relative path with a single slash. '${remotePath}' is given instead`);
  }

  let [, bundleId, relativePath] = match;
  let containerType = null;
  const typeSeparatorPos = bundleId.indexOf(CONTAINER_TYPE_SEPARATOR);

  if (typeSeparatorPos > 0 && typeSeparatorPos < bundleId.length - 1) {
    containerType = bundleId.substring(typeSeparatorPos + 1);

    _logger.default.debug(`Parsed container type: ${containerType}`);

    bundleId = bundleId.substring(0, typeSeparatorPos);
  }

  const containerRoot = _lodash.default.isFunction(containerRootSupplier) ? await containerRootSupplier(bundleId, containerType) : containerRootSupplier;

  const resultPath = _path.default.posix.resolve(containerRoot, relativePath);

  verifyIsSubPath(resultPath, containerRoot);
  return [bundleId, resultPath];
}

async function pushFileToSimulator(device, remotePath, base64Data) {
  const buffer = Buffer.from(base64Data, 'base64');

  if (CONTAINER_PATH_PATTERN.test(remotePath)) {
    const [bundleId, dstPath] = await parseContainerPath(remotePath, async (appBundle, containerType) => await (0, _nodeSimctl.getAppContainer)(device.udid, appBundle, null, containerType));

    _logger.default.info(`Parsed bundle identifier '${bundleId}' from '${remotePath}'. ` + `Will put the data into '${dstPath}'`);

    if (!(await _appiumSupport.fs.exists(_path.default.dirname(dstPath)))) {
      _logger.default.debug(`The destination folder '${_path.default.dirname(dstPath)}' does not exist. Creating...`);

      await (0, _appiumSupport.mkdirp)(_path.default.dirname(dstPath));
    }

    await _appiumSupport.fs.writeFile(dstPath, buffer);
    return;
  }

  const dstFolder = await _appiumSupport.tempDir.openDir();

  const dstPath = _path.default.resolve(dstFolder, _path.default.basename(remotePath));

  try {
    await _appiumSupport.fs.writeFile(dstPath, buffer);
    await (0, _nodeSimctl.addMedia)(device.udid, dstPath);
  } finally {
    await _appiumSupport.fs.rimraf(dstFolder);
  }
}

async function pushFileToRealDevice(device, remotePath, base64Data) {
  await verifyIFusePresence();
  const mntRoot = await _appiumSupport.tempDir.openDir();
  let isUnmountSuccessful = true;

  try {
    let dstPath = _path.default.resolve(mntRoot, remotePath);

    let ifuseArgs = ['-u', device.udid, mntRoot];

    if (CONTAINER_PATH_PATTERN.test(remotePath)) {
      const [bundleId, pathInContainer] = await parseContainerPath(remotePath, mntRoot);
      dstPath = pathInContainer;

      _logger.default.info(`Parsed bundle identifier '${bundleId}' from '${remotePath}'. ` + `Will put the data into '${dstPath}'`);

      ifuseArgs = ['-u', device.udid, '--container', bundleId, mntRoot];
    } else {
      verifyIsSubPath(dstPath, mntRoot);
    }

    await mountDevice(device, ifuseArgs);
    isUnmountSuccessful = false;

    try {
      if (!(await _appiumSupport.fs.exists(_path.default.dirname(dstPath)))) {
        _logger.default.debug(`The destination folder '${_path.default.dirname(dstPath)}' does not exist. Creating...`);

        await (0, _appiumSupport.mkdirp)(_path.default.dirname(dstPath));
      }

      await _appiumSupport.fs.writeFile(dstPath, Buffer.from(base64Data, 'base64'));
    } finally {
      await (0, _teen_process.exec)('umount', [mntRoot]);
      isUnmountSuccessful = true;
    }
  } finally {
    if (isUnmountSuccessful) {
      await _appiumSupport.fs.rimraf(mntRoot);
    } else {
      _logger.default.warn(`Umount has failed, so not removing '${mntRoot}'`);
    }
  }
}

async function pullFromSimulator(device, remotePath, isFile) {
  let pathOnServer;

  if (CONTAINER_PATH_PATTERN.test(remotePath)) {
    const [bundleId, dstPath] = await parseContainerPath(remotePath, async (appBundle, containerType) => await (0, _nodeSimctl.getAppContainer)(device.udid, appBundle, null, containerType));

    _logger.default.info(`Parsed bundle identifier '${bundleId}' from '${remotePath}'. ` + `Will get the data from '${dstPath}'`);

    pathOnServer = dstPath;
  } else {
    const simRoot = device.getDir();
    pathOnServer = _path.default.posix.join(simRoot, remotePath);
    verifyIsSubPath(pathOnServer, simRoot);

    _logger.default.info(`Got the full item path: ${pathOnServer}`);
  }

  if (!(await _appiumSupport.fs.exists(pathOnServer))) {
    _logger.default.errorAndThrow(`The remote ${isFile ? 'file' : 'folder'} at '${pathOnServer}' does not exist`);
  }

  const buffer = isFile ? await _appiumSupport.fs.readFile(pathOnServer) : await _appiumSupport.zip.toInMemoryZip(pathOnServer);
  return Buffer.from(buffer).toString('base64');
}

async function pullFromRealDevice(device, remotePath, isFile) {
  await verifyIFusePresence();
  const mntRoot = await _appiumSupport.tempDir.openDir();
  let isUnmountSuccessful = true;

  try {
    let dstPath = _path.default.resolve(mntRoot, remotePath);

    let ifuseArgs = ['-u', device.udid, mntRoot];

    if (CONTAINER_PATH_PATTERN.test(remotePath)) {
      const [bundleId, pathInContainer] = await parseContainerPath(remotePath, mntRoot);
      dstPath = pathInContainer;

      _logger.default.info(`Parsed bundle identifier '${bundleId}' from '${remotePath}'. ` + `Will get the data from '${dstPath}'`);

      ifuseArgs = ['-u', device.udid, '--container', bundleId, mntRoot];
    } else {
      verifyIsSubPath(dstPath, mntRoot);
    }

    await mountDevice(device, ifuseArgs);
    isUnmountSuccessful = false;

    try {
      if (!(await _appiumSupport.fs.exists(dstPath))) {
        _logger.default.errorAndThrow(`The remote ${isFile ? 'file' : 'folder'} at '${dstPath}' does not exist`);
      }

      const buffer = isFile ? await _appiumSupport.fs.readFile(dstPath) : await _appiumSupport.zip.toInMemoryZip(dstPath);
      return Buffer.from(buffer).toString('base64');
    } finally {
      await (0, _teen_process.exec)('umount', [mntRoot]);
      isUnmountSuccessful = true;
    }
  } finally {
    if (isUnmountSuccessful) {
      await _appiumSupport.fs.rimraf(mntRoot);
    } else {
      _logger.default.warn(`Umount has failed, so not removing '${mntRoot}'`);
    }
  }
}

commands.pushFile = async function pushFile(remotePath, base64Data) {
  if (remotePath.endsWith('/')) {
    _logger.default.errorAndThrow(`It is expected that remote path points to a file and not to a folder. ` + `'${remotePath}' is given instead`);
  }

  if (_lodash.default.isArray(base64Data)) {
    base64Data = Buffer.from(base64Data).toString('utf8');
  }

  return this.isSimulator() ? await pushFileToSimulator(this.opts.device, remotePath, base64Data) : await pushFileToRealDevice(this.opts.device, remotePath, base64Data);
};

commands.pullFile = async function pullFile(remotePath) {
  if (remotePath.endsWith('/')) {
    _logger.default.errorAndThrow(`It is expected that remote path points to a file and not to a folder. ` + `'${remotePath}' is given instead`);
  }

  return this.isSimulator() ? await pullFromSimulator(this.opts.device, remotePath, true) : await pullFromRealDevice(this.opts.device, remotePath, true);
};

commands.getSimFileFullPath = async function getSimFileFullPath(remotePath) {
  let basePath = this.opts.device.getDir();
  let appName = null;

  if (this.opts.app) {
    let appNameRegex = new RegExp(`\\${_path.default.sep}([\\w-]+\\.app)`);
    let appNameMatches = appNameRegex.exec(this.opts.app);

    if (appNameMatches) {
      appName = appNameMatches[1];
    }
  }

  if (_appiumSupport.system.isWindows()) {
    if (remotePath.indexof('://') === 1) {
      remotePath = remotePath.slice(4);
    }
  } else {
    if (remotePath.indexOf('/') === 0) {
      remotePath = remotePath.slice(1);
    }
  }

  if (remotePath.startsWith(appName)) {
    let findPath = basePath;

    if (_appiumSupport.util.compareVersions(this.opts.platformVersion, '>=', '8.0')) {
      findPath = _path.default.resolve(basePath, 'Containers', 'Bundle');
    }

    findPath = findPath.replace(/\s/g, '\\ ');
    let {
      stdout
    } = await (0, _teen_process.exec)('find', [findPath, '-name', appName]);
    let appRoot = stdout.replace(/\n$/, '');
    let subPath = remotePath.substring(appName.length + 1);

    let fullPath = _path.default.resolve(appRoot, subPath);

    _logger.default.debug(`Finding app-relative file: '${fullPath}'`);

    return fullPath;
  }

  let fullPath = _path.default.resolve(basePath, remotePath);

  _logger.default.debug(`Finding sim-relative file: ${fullPath}`);

  return fullPath;
};

commands.pullFolder = async function pullFolder(remotePath) {
  if (!remotePath.endsWith('/')) {
    remotePath = `${remotePath}/`;
  }

  return this.isSimulator() ? await pullFromSimulator(this.opts.device, remotePath, false) : await pullFromRealDevice(this.opts.device, remotePath, false);
};

var _default = commands;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9maWxlLW1vdmVtZW50LmpzIl0sIm5hbWVzIjpbIkNPTlRBSU5FUl9QQVRIX01BUktFUiIsIkNPTlRBSU5FUl9QQVRIX1BBVFRFUk4iLCJSZWdFeHAiLCJDT05UQUlORVJfVFlQRV9TRVBBUkFUT1IiLCJjb21tYW5kcyIsImlvc0NvbW1hbmRzIiwiZmlsZSIsInZlcmlmeUlGdXNlUHJlc2VuY2UiLCJmcyIsIndoaWNoIiwibG9nIiwiZXJyb3JBbmRUaHJvdyIsInByb2Nlc3MiLCJlbnYiLCJQQVRIIiwibW91bnREZXZpY2UiLCJkZXZpY2UiLCJpRnVzZUFyZ3MiLCJkZWJ1ZyIsImUiLCJ1ZGlkIiwiY29kZSIsInN0ZGVyciIsInZlcmlmeUlzU3ViUGF0aCIsIm9yaWdpbmFsUGF0aCIsInJvb3QiLCJub3JtYWxpemVkUm9vdCIsInBhdGgiLCJub3JtYWxpemUiLCJub3JtYWxpemVkUGF0aCIsImRpcm5hbWUiLCJzdGFydHNXaXRoIiwicGFyc2VDb250YWluZXJQYXRoIiwicmVtb3RlUGF0aCIsImNvbnRhaW5lclJvb3RTdXBwbGllciIsIm1hdGNoIiwiZXhlYyIsImJ1bmRsZUlkIiwicmVsYXRpdmVQYXRoIiwiY29udGFpbmVyVHlwZSIsInR5cGVTZXBhcmF0b3JQb3MiLCJpbmRleE9mIiwibGVuZ3RoIiwic3Vic3RyaW5nIiwiY29udGFpbmVyUm9vdCIsIl8iLCJpc0Z1bmN0aW9uIiwicmVzdWx0UGF0aCIsInBvc2l4IiwicmVzb2x2ZSIsInB1c2hGaWxlVG9TaW11bGF0b3IiLCJiYXNlNjREYXRhIiwiYnVmZmVyIiwiQnVmZmVyIiwiZnJvbSIsInRlc3QiLCJkc3RQYXRoIiwiYXBwQnVuZGxlIiwiaW5mbyIsImV4aXN0cyIsIndyaXRlRmlsZSIsImRzdEZvbGRlciIsInRlbXBEaXIiLCJvcGVuRGlyIiwiYmFzZW5hbWUiLCJyaW1yYWYiLCJwdXNoRmlsZVRvUmVhbERldmljZSIsIm1udFJvb3QiLCJpc1VubW91bnRTdWNjZXNzZnVsIiwiaWZ1c2VBcmdzIiwicGF0aEluQ29udGFpbmVyIiwid2FybiIsInB1bGxGcm9tU2ltdWxhdG9yIiwiaXNGaWxlIiwicGF0aE9uU2VydmVyIiwic2ltUm9vdCIsImdldERpciIsImpvaW4iLCJyZWFkRmlsZSIsInppcCIsInRvSW5NZW1vcnlaaXAiLCJ0b1N0cmluZyIsInB1bGxGcm9tUmVhbERldmljZSIsInB1c2hGaWxlIiwiZW5kc1dpdGgiLCJpc0FycmF5IiwiaXNTaW11bGF0b3IiLCJvcHRzIiwicHVsbEZpbGUiLCJnZXRTaW1GaWxlRnVsbFBhdGgiLCJiYXNlUGF0aCIsImFwcE5hbWUiLCJhcHAiLCJhcHBOYW1lUmVnZXgiLCJzZXAiLCJhcHBOYW1lTWF0Y2hlcyIsInN5c3RlbSIsImlzV2luZG93cyIsImluZGV4b2YiLCJzbGljZSIsImZpbmRQYXRoIiwidXRpbCIsImNvbXBhcmVWZXJzaW9ucyIsInBsYXRmb3JtVmVyc2lvbiIsInJlcGxhY2UiLCJzdGRvdXQiLCJhcHBSb290Iiwic3ViUGF0aCIsImZ1bGxQYXRoIiwicHVsbEZvbGRlciJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQSxNQUFNQSxxQkFBcUIsR0FBRyxHQUE5QjtBQUVBLE1BQU1DLHNCQUFzQixHQUFHLElBQUlDLE1BQUosQ0FBWSxJQUFHRixxQkFBc0IsY0FBckMsQ0FBL0I7QUFDQSxNQUFNRyx3QkFBd0IsR0FBRyxHQUFqQztBQUdBLElBQUlDLFFBQVEsR0FBR0MsNkJBQVlDLElBQTNCOzs7QUFFQSxlQUFlQyxtQkFBZixHQUFzQztBQUNwQyxNQUFJLEVBQUMsTUFBTUMsa0JBQUdDLEtBQUgsQ0FBUyxPQUFULENBQVAsQ0FBSixFQUE4QjtBQUM1QkMsb0JBQUlDLGFBQUosQ0FBbUIsMkRBQUQsR0FDQyw4RUFERCxHQUVDLG9GQUZELEdBR0MsdUJBQXNCQyxPQUFPLENBQUNDLEdBQVIsQ0FBWUMsSUFBSyxFQUgxRDtBQUlEO0FBQ0Y7O0FB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S3FELFdBQUwsS0FDSCxNQUFNZCxpQkFBaUIsQ0FBQyxLQUFLZSxJQUFMLENBQVV2RSxNQUFYLEVBQW1CaUIsVUFBbkIsRUFBK0IsS0FBL0IsQ0FEcEIsR0FFSCxNQUFNaUQsa0JBQWtCLENBQUMsS0FBS0ssSUFBTCxDQUFVdkUsTUFBWCxFQUFtQmlCLFVBQW5CLEVBQStCLEtBQS9CLENBRjVCO0FBR0QsQ0FQRDs7ZUFVZTdCLFEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgc3lzdGVtLCBmcywgdGVtcERpciwgbWtkaXJwLCB6aXAsIHV0aWwgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IGlvc0NvbW1hbmRzIH0gZnJvbSAnYXBwaXVtLWlvcy1kcml2ZXInO1xuaW1wb3J0IGxvZyBmcm9tICcuLi9sb2dnZXInO1xuaW1wb3J0IHsgZXhlYyB9IGZyb20gJ3RlZW5fcHJvY2Vzcyc7XG5pbXBvcnQgeyBhZGRNZWRpYSwgZ2V0QXBwQ29udGFpbmVyIH0gZnJvbSAnbm9kZS1zaW1jdGwnO1xuXG5jb25zdCBDT05UQUlORVJfUEFUSF9NQVJLRVIgPSAnQCc7XG4vLyBodHRwczovL3JlZ2V4MTAxLmNvbS9yL1BMZEIwRy8yXG5jb25zdCBDT05UQUlORVJfUEFUSF9QQVRURVJOID0gbmV3IFJlZ0V4cChgXiR7Q09OVEFJTkVSX1BBVEhfTUFSS0VSfShbXi9dKykvKC4rKWApO1xuY29uc3QgQ09OVEFJTkVSX1RZUEVfU0VQQVJBVE9SID0gJzonO1xuXG5cbmxldCBjb21tYW5kcyA9IGlvc0NvbW1hbmRzLmZpbGU7XG5cbmFzeW5jIGZ1bmN0aW9uIHZlcmlmeUlGdXNlUHJlc2VuY2UgKCkge1xuICBpZiAoIWF3YWl0IGZzLndoaWNoKCdpZnVzZScpKSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coYCdpZnVzZScgdG9vbCBpcyByZXF1aXJlZCB0byBiZSBpbnN0YWxsZWQgb24gdGhlIG1hY2hpbmUuIGAgK1xuICAgICAgICAgICAgICAgICAgICAgIGBJbnN0YWxsIGl0IHVzaW5nICdicmV3IGNhc2sgaW5zdGFsbCBvc3hmdXNlICYmIGJyZXcgaW5zdGFsbCBpZnVzZScgb3IgY2hlY2sgYCArXG4gICAgICAgICAgICAgICAgICAgICAgYGlmIGl0IGlzIGF2YWlsYWJsZSBpbiBQQVRIIGVudmlyb25tZW50IHZhcmlhYmxlIGlmIHRoZSB0b29sIGlzIGFscmVhZHkgaW5zdGFsbGVkLiBgICtcbiAgICAgICAgICAgICAgICAgICAgICBgQ3VycmVudCBQQVRIIHZhbHVlOiAke3Byb2Nlc3MuZW52LlBBVEh9YCk7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gbW91bnREZXZpY2UgKGRldmljZSwgaUZ1c2VBcmdzKSB7XG4gIGxvZy5kZWJ1ZyhgU3RhcnRpbmcgaWZ1c2Ugd2l0aCBhcmdzICcke2lGdXNlQXJnc30nLi4uYCk7XG4gIHRyeSB7XG4gICAgYXdhaXQgZXhlYygnaWZ1c2UnLCBpRnVzZUFyZ3MpO1xuICB9IGNhdGNoIChlKSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coYENhbm5vdCBtb3VudCB0aGUgbWVkaWEgZm9sZGVyIG9mIHRoZSBkZXZpY2Ugd2l0aCBVRElEICR7ZGV2aWNlLnVkaWR9LiBgICtcbiAgICAgICAgICAgICAgICAgICAgICBgTWFrZSBzdXJlIG9zeGZ1c2UgcGx1Z2luIGhhcyBuZWNlc3NhcnkgcGVybWlzc2lvbnMgaW4gU3lzdGVtIFByZWZlcmVuY2VzLT5TZWN1cml0eSAmIFByaXZhY3kuIGAgK1xuICAgICAgICAgICAgICAgICAgICAgIGBFcnJvciBjb2RlOiAke2UuY29kZX07IHN0ZGVyciBvdXRwdXQ6ICR7ZS5zdGRlcnJ9YCk7XG4gIH1cbn1cblxuZnVuY3Rpb24gdmVyaWZ5SXNTdWJQYXRoIChvcmlnaW5hbFBhdGgsIHJvb3QpIHtcbiAgY29uc3Qgbm9ybWFsaXplZFJvb3QgPSBwYXRoLm5vcm1hbGl6ZShyb290KTtcbiAgY29uc3Qgbm9ybWFsaXplZFBhdGggPSBwYXRoLm5vcm1hbGl6ZShwYXRoLmRpcm5hbWUob3JpZ2luYWxQYXRoKSk7XG4gIGlmICghbm9ybWFsaXplZFBhdGguc3RhcnRzV2l0aChub3JtYWxpemVkUm9vdCkpIHtcbiAgICBsb2cuZXJyb3JBbmRUaHJvdyhgJyR7bm9ybWFsaXplZFBhdGh9JyBpcyBleHBlY3RlZCB0byBiZSBhIHN1YnBhdGggb2YgJyR7bm9ybWFsaXplZFJvb3R9J2ApO1xuICB9XG59XG5cbi8qKlxuICogUGFyc2VzIHRoZSBhY3R1YWwgcGF0aCBhbmQgdGhlIGJ1bmRsZSBpZGVudGlmaWVyIGZyb20gdGhlIGdpdmVuIHBhdGggc3RyaW5nXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IHJlbW90ZVBhdGggLSBUaGUgZ2l2ZW4gcGF0aCBzdHJpbmcuIFRoZSBzdHJpbmcgc2hvdWxkXG4gKiBtYXRjaCBgQ09OVEFJTkVSX1BBVEhfUEFUVEVSTmAgcmVnZXhwLCBvdGhlcndpc2UgYW4gZXJyb3IgaXMgZ29pbmdcbiAqIHRvIGJlIHRocm93bi4gQSB2YWxpZCBzdHJpbmcgZXhhbXBsZTogYEBidW5kbGUuaWRlbnRpZmllcjpjb250YWluZXJfdHlwZS9yZWxhdGl2ZV9wYXRoX2luX2NvbnRhaW5lcmBcbiAqIEBwYXJhbSB7RnVuY3Rpb258c3RyaW5nfSBjb250YWluZXJSb290U3VwcGxpZXIgLSBFaXRoZXIgYSBzdHJpbmcsIHRoYXQgY29udGFpbnNcbiAqIGZ1bGwgcGF0aCB0byB0aGUgbW91bnQgcm9vdCBmb3IgcmVhbCBkZXZpY2VzIG9yIGEgZnVuY3Rpb24sIHdoaWNoIGFjY2VwdHMgdHdvIHBhcmFtZXRlcnNcbiAqIChidW5kbGUgaWRlbnRpZmllciBhbmQgb3B0aW9uYWwgY29udGFpbmVyIHR5cGUpIGFuZCByZXR1cm5zIGZ1bGwgcGF0aCB0byBjb250YWluZXJcbiAqIHJvb3QgZm9sZGVyIG9uIHRoZSBsb2NhbCBmaWxlIHN5c3RlbSwgZm9yIFNpbXVsYXRvclxuICogQHJldHVybnMge0FycmF5PHN0cmluZz59IC0gQW4gYXJyYXkgd2hlcmUgdGhlIGZpcnN0IGl0ZW0gaXMgdGhlIHBhcnNlZCBidW5kbGVcbiAqIGlkZW50aWZpZXIgYW5kIHRoZSBzZWNvbmQgb25lIGlzIHRoZSBhYnNvbHV0ZSBmdWxsIHBhdGggb2YgdGhlIGl0ZW0gb24gdGhlIGxvY2FsXG4gKiBmaWxlIHN5c3RlbVxuICovXG5hc3luYyBmdW5jdGlvbiBwYXJzZUNvbnRhaW5lclBhdGggKHJlbW90ZVBhdGgsIGNvbnRhaW5lclJvb3RTdXBwbGllcikge1xuICBjb25zdCBtYXRjaCA9IENPTlRBSU5FUl9QQVRIX1BBVFRFUk4uZXhlYyhyZW1vdGVQYXRoKTtcbiAgaWYgKCFtYXRjaCkge1xuICAgIGxvZy5lcnJvckFuZFRocm93KGBJdCBpcyBleHBlY3RlZCB0aGF0IHBhY2thZ2UgaWRlbnRpZmllciBgICtcbiAgICAgIGBzdGFydHMgd2l0aCAnJHtDT05UQUlORVJfUEFUSF9NQVJLRVJ9JyBhbmQgaXMgc2VwYXJhdGVkIGZyb20gdGhlIGAgK1xuICAgICAgYHJlbGF0aXZlIHBhdGggd2l0aCBhIHNpbmdsZSBzbGFzaC4gJyR7cmVtb3RlUGF0aH0nIGlzIGdpdmVuIGluc3RlYWRgKTtcbiAgfVxuICBsZXQgWywgYnVuZGxlSWQsIHJlbGF0aXZlUGF0aF0gPSBtYXRjaDtcbiAgbGV0IGNvbnRhaW5lclR5cGUgPSBudWxsO1xuICBjb25zdCB0eXBlU2VwYXJhdG9yUG9zID0gYnVuZGxlSWQuaW5kZXhPZihDT05UQUlORVJfVFlQRV9TRVBBUkFUT1IpO1xuICAvLyBXZSBvbmx5IGNvbnNpZGVyIGNvbnRhaW5lciB0eXBlIGV4aXN0cyBpZiBpdHMgbGVuZ3RoIGlzIGdyZWF0ZXIgdGhhbiB6ZXJvXG4gIC8vIG5vdCBjb3VudGluZyB0aGUgY29sb25cbiAgaWYgKHR5cGVTZXBhcmF0b3JQb3MgPiAwICYmIHR5cGVTZXBhcmF0b3JQb3MgPCBidW5kbGVJZC5sZW5ndGggLSAxKSB7XG4gICAgY29udGFpbmVyVHlwZSA9IGJ1bmRsZUlkLnN1YnN0cmluZyh0eXBlU2VwYXJhdG9yUG9zICsgMSk7XG4gICAgbG9nLmRlYnVnKGBQYXJzZWQgY29udGFpbmVyIHR5cGU6ICR7Y29udGFpbmVyVHlwZX1gKTtcbiAgICBidW5kbGVJZCA9IGJ1bmRsZUlkLnN1YnN0cmluZygwLCB0eXBlU2VwYXJhdG9yUG9zKTtcbiAgfVxuICBjb25zdCBjb250YWluZXJSb290ID0gXy5pc0Z1bmN0aW9uKGNvbnRhaW5lclJvb3RTdXBwbGllcilcbiAgICA/IGF3YWl0IGNvbnRhaW5lclJvb3RTdXBwbGllcihidW5kbGVJZCwgY29udGFpbmVyVHlwZSlcbiAgICA6IGNvbnRhaW5lclJvb3RTdXBwbGllcjtcbiAgY29uc3QgcmVzdWx0UGF0aCA9IHBhdGgucG9zaXgucmVzb2x2ZShjb250YWluZXJSb290LCByZWxhdGl2ZVBhdGgpO1xuICB2ZXJpZnlJc1N1YlBhdGgocmVzdWx0UGF0aCwgY29udGFpbmVyUm9vdCk7XG4gIHJldHVybiBbYnVuZGxlSWQsIHJlc3VsdFBhdGhdO1xufVxuXG4vKipcbiAqIFNhdmUgdGhlIGdpdmVuIGJhc2U2NCBkYXRhIGNodW5rIGFzIGEgYmluYXJ5IGZpbGUgb24gdGhlIFNpbXVsYXRvciB1bmRlciB0ZXN0LlxuICpcbiAqIEBwYXJhbSB7T2JqZWN0fSBkZXZpY2UgLSBUaGUgZGV2aWNlIG9iamVjdCwgd2hpY2ggcmVwcmVzZW50cyB0aGUgZGV2aWNlIHVuZGVyIHRlc3QuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgVGhpcyBvYmplY3QgaXMgZXhwZWN0ZWQgdG8gaGF2ZSB0aGUgYHVkaWRgIHByb3BlcnR5IGNvbnRhaW5pbmcgdGhlXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsaWQgZGV2aWNlIElELlxuICogQHBhcmFtIHtzdHJpbmd9IHJlbW90ZVBhdGggLSBUaGUgcmVtb3RlIHBhdGggb24gdGhlIGRldmljZS4gVGhpcyB2YXJpYWJsZSBjYW4gYmUgcHJlZml4ZWQgd2l0aFxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBidW5kbGUgaWQsIHNvIHRoZW4gdGhlIGZpbGUgd2lsbCBiZSB1cGxvYWRlZCB0byB0aGUgY29ycmVzcG9uZGluZ1xuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcHBsaWNhdGlvbiBjb250YWluZXIgaW5zdGVhZCBvZiB0aGUgZGVmYXVsdCBtZWRpYSBmb2xkZXIsIGZvciBleGFtcGxlXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdAY29tLm15YXBwLmJsYTpkYXRhL1JlbGF0aXZlUGF0aEluQ29udGFpbmVyLzExMS5wbmcnLiBUaGUgJ0AnIGNoYXJhY3RlciBhdCB0aGVcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmVnaW5uaW5nIG9mIHRoZSBhcmd1bWVudCBpcyBtYW5kYXRvcnkgaW4gc3VjaCBjYXNlLiBUaGUgY29sb24gYXQgdGhlIGVuZCBvZiBidW5kbGUgaWRlbnRpZmllclxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpcyBvcHRpb25hbCBhbmQgaXMgdXNlZCB0byBkaXN0aW5ndWlzaCB0aGUgY29udGFpbmVyIHR5cGUuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFBvc3NpYmxlIHZhbHVlcyB0aGVyZSBhcmUgJ2FwcCcsICdkYXRhJywgJ2dyb3VwcycsICc8QSBzcGVjaWZpYyBBcHAgR3JvdXAgY29udGFpbmVyPicuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFRoZSBkZWZhdWx0IHZhbHVlIGlzICdhcHAnLlxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBUaGUgcmVsYXRpdmUgZm9sZGVyIHBhdGggaXMgaWdub3JlZCBpZiB0aGUgZmlsZSBpcyBnb2luZyB0byBiZSB1cGxvYWRlZFxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0byB0aGUgZGVmYXVsdCBtZWRpYSBmb2xkZXIgYW5kIG9ubHkgdGhlIGZpbGUgbmFtZSBpcyBjb25zaWRlcmVkIGltcG9ydGFudC5cbiAqIEBwYXJhbSB7c3RyaW5nfSBiYXNlNjREYXRhIC0gQmFzZS02NCBlbmNvZGVkIGNvbnRlbnQgb2YgdGhlIGZpbGUgdG8gYmUgdXBsb2FkZWQuXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIHB1c2hGaWxlVG9TaW11bGF0b3IgKGRldmljZSwgcmVtb3RlUGF0aCwgYmFzZTY0RGF0YSkge1xuICBjb25zdCBidWZmZXIgPSBCdWZmZXIuZnJvbShiYXNlNjREYXRhLCAnYmFzZTY0Jyk7XG4gIGlmIChDT05UQUlORVJfUEFUSF9QQVRURVJOLnRlc3QocmVtb3RlUGF0aCkpIHtcbiAgICBjb25zdCBbYnVuZGxlSWQsIGRzdFBhdGhdID0gYXdhaXQgcGFyc2VDb250YWluZXJQYXRoKHJlbW90ZVBhdGgsXG4gICAgICBhc3luYyAoYXBwQnVuZGxlLCBjb250YWluZXJUeXBlKSA9PiBhd2FpdCBnZXRBcHBDb250YWluZXIoZGV2aWNlLnVkaWQsIGFwcEJ1bmRsZSwgbnVsbCwgY29udGFpbmVyVHlwZSkpO1xuICAgIGxvZy5pbmZvKGBQYXJzZWQgYnVuZGxlIGlkZW50aWZpZXIgJyR7YnVuZGxlSWR9JyBmcm9tICcke3JlbW90ZVBhdGh9Jy4gYCArXG4gICAgICBgV2lsbCBwdXQgdGhlIGRhdGEgaW50byAnJHtkc3RQYXRofSdgKTtcbiAgICBpZiAoIWF3YWl0IGZzLmV4aXN0cyhwYXRoLmRpcm5hbWUoZHN0UGF0aCkpKSB7XG4gICAgICBsb2cuZGVidWcoYFRoZSBkZXN0aW5hdGlvbiBmb2xkZXIgJyR7cGF0aC5kaXJuYW1lKGRzdFBhdGgpfScgZG9lcyBub3QgZXhpc3QuIENyZWF0aW5nLi4uYCk7XG4gICAgICBhd2FpdCBta2RpcnAocGF0aC5kaXJuYW1lKGRzdFBhdGgpKTtcbiAgICB9XG4gICAgYXdhaXQgZnMud3JpdGVGaWxlKGRzdFBhdGgsIGJ1ZmZlcik7XG4gICAgcmV0dXJuO1xuICB9XG4gIGNvbnN0IGRzdEZvbGRlciA9IGF3YWl0IHRlbXBEaXIub3BlbkRpcigpO1xuICBjb25zdCBkc3RQYXRoID0gcGF0aC5yZXNvbHZlKGRzdEZvbGRlciwgcGF0aC5iYXNlbmFtZShyZW1vdGVQYXRoKSk7XG4gIHRyeSB7XG4gICAgYXdhaXQgZnMud3JpdGVGaWxlKGRzdFBhdGgsIGJ1ZmZlcik7XG4gICAgYXdhaXQgYWRkTWVkaWEoZGV2aWNlLnVkaWQsIGRzdFBhdGgpO1xuICB9IGZpbmFsbHkge1xuICAgIGF3YWl0IGZzLnJpbXJhZihkc3RGb2xkZXIpO1xuICB9XG59XG5cbi8qKlxuICogU2F2ZSB0aGUgZ2l2ZW4gYmFzZTY0IGRhdGEgY2h1bmsgYXMgYSBiaW5hcnkgZmlsZSBvbiB0aGUgZGV2aWNlIHVuZGVyIHRlc3QuXG4gKiBpZnVzZS9vc3hmdXNlIHNob3VsZCBiZSBpbnN0YWxsZWQgYW5kIGNvbmZpZ3VyZWQgb24gdGhlIHRhcmdldCBtYWNoaW5lIGluIG9yZGVyXG4gKiBmb3IgdGhpcyBmdW5jdGlvbiB0byB3b3JrIHByb3Blcmx5LiBSZWFkIGh0dHBzOi8vZ2l0aHViLmNvbS9saWJpbW9iaWxlZGV2aWNlL2lmdXNlXG4gKiBhbmQgaHR0cHM6Ly9naXRodWIuY29tL29zeGZ1c2Uvb3N4ZnVzZS93aWtpL0ZBUSBmb3IgbW9yZSBkZXRhaWxzLlxuICpcbiAqIEBwYXJhbSB7T2JqZWN0fSBkZXZpY2UgLSBUaGUgZGV2aWNlIG9iamVjdCwgd2hpY2ggcmVwcmVzZW50cyB0aGUgZGV2aWNlIHVuZGVyIHRlc3QuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgVGhpcyBvYmplY3QgaXMgZXhwZWN0ZWQgdG8gaGF2ZSB0aGUgYHVkaWRgIHByb3BlcnR5IGNvbnRhaW5pbmcgdGhlXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsaWQgZGV2aWNlIElELlxuICogQHBhcmFtIHtzdHJpbmd9IHJlbW90ZVBhdGggLSBUaGUgcmVtb3RlIHBhdGggb24gdGhlIGRldmljZS4gVGhpcyB2YXJpYWJsZSBjYW4gYmUgcHJlZml4ZWQgd2l0aFxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBidW5kbGUgaWQsIHNvIHRoZW4gdGhlIGZpbGUgd2lsbCBiZSB1cGxvYWRlZCB0byB0aGUgY29ycmVzcG9uZGluZ1xuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcHBsaWNhdGlvbiBjb250YWluZXIgaW5zdGVhZCBvZiB0aGUgZGVmYXVsdCBtZWRpYSBmb2xkZXIsIGZvciBleGFtcGxlXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdAY29tLm15YXBwLmJsYS9SZWxhdGl2ZVBhdGhJbkNvbnRhaW5lci8xMTEucG5nJy4gVGhlICdAJyBjaGFyYWN0ZXIgYXQgdGhlXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJlZ2lubmluZyBvZiB0aGUgYXJndW1lbnQgaXMgbWFuZGF0b3J5IGluIHN1Y2ggY2FzZS5cbiAqIEBwYXJhbSB7c3RyaW5nfSBiYXNlNjREYXRhIC0gQmFzZS02NCBlbmNvZGVkIGNvbnRlbnQgb2YgdGhlIGZpbGUgdG8gYmUgdXBsb2FkZWQuXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIHB1c2hGaWxlVG9SZWFsRGV2aWNlIChkZXZpY2UsIHJlbW90ZVBhdGgsIGJhc2U2NERhdGEpIHtcbiAgYXdhaXQgdmVyaWZ5SUZ1c2VQcmVzZW5jZSgpO1xuICBjb25zdCBtbnRSb290ID0gYXdhaXQgdGVtcERpci5vcGVuRGlyKCk7XG4gIGxldCBpc1VubW91bnRTdWNjZXNzZnVsID0gdHJ1ZTtcbiAgdHJ5IHtcbiAgICBsZXQgZHN0UGF0aCA9IHBhdGgucmVzb2x2ZShtbnRSb290LCByZW1vdGVQYXRoKTtcbiAgICBsZXQgaWZ1c2VBcmdzID0gWyctdScsIGRldmljZS51ZGlkLCBtbnRSb290XTtcbiAgICBpZiAoQ09OVEFJTkVSX1BBVEhfUEFUVEVSTi50ZXN0KHJlbW90ZVBhdGgpKSB7XG4gICAgICBjb25zdCBbYnVuZGxlSWQsIHBhdGhJbkNvbnRhaW5lcl0gPSBhd2FpdCBwYXJzZUNvbnRhaW5lclBhdGgocmVtb3RlUGF0aCwgbW50Um9vdCk7XG4gICAgICBkc3RQYXRoID0gcGF0aEluQ29udGFpbmVyO1xuICAgICAgbG9nLmluZm8oYFBhcnNlZCBidW5kbGUgaWRlbnRpZmllciAnJHtidW5kbGVJZH0nIGZyb20gJyR7cmVtb3RlUGF0aH0nLiBgICtcbiAgICAgICAgYFdpbGwgcHV0IHRoZSBkYXRhIGludG8gJyR7ZHN0UGF0aH0nYCk7XG4gICAgICBpZnVzZUFyZ3MgPSBbJy11JywgZGV2aWNlLnVkaWQsICctLWNvbnRhaW5lcicsIGJ1bmRsZUlkLCBtbnRSb290XTtcbiAgICB9IGVsc2Uge1xuICAgICAgdmVyaWZ5SXNTdWJQYXRoKGRzdFBhdGgsIG1udFJvb3QpO1xuICAgIH1cbiAgICBhd2FpdCBtb3VudERldmljZShkZXZpY2UsIGlmdXNlQXJncyk7XG4gICAgaXNVbm1vdW50U3VjY2Vzc2Z1bCA9IGZhbHNlO1xuICAgIHRyeSB7XG4gICAgICBpZiAoIWF3YWl0IGZzLmV4aXN0cyhwYXRoLmRpcm5hbWUoZHN0UGF0aCkpKSB7XG4gICAgICAgIGxvZy5kZWJ1ZyhgVGhlIGRlc3RpbmF0aW9uIGZvbGRlciAnJHtwYXRoLmRpcm5hbWUoZHN0UGF0aCl9JyBkb2VzIG5vdCBleGlzdC4gQ3JlYXRpbmcuLi5gKTtcbiAgICAgICAgYXdhaXQgbWtkaXJwKHBhdGguZGlybmFtZShkc3RQYXRoKSk7XG4gICAgICB9XG4gICAgICBhd2FpdCBmcy53cml0ZUZpbGUoZHN0UGF0aCwgQnVmZmVyLmZyb20oYmFzZTY0RGF0YSwgJ2Jhc2U2NCcpKTtcbiAgICB9IGZpbmFsbHkge1xuICAgICAgYXdhaXQgZXhlYygndW1vdW50JywgW21udFJvb3RdKTtcbiAgICAgIGlzVW5tb3VudFN1Y2Nlc3NmdWwgPSB0cnVlO1xuICAgIH1cbiAgfSBmaW5hbGx5IHtcbiAgICBpZiAoaXNVbm1vdW50U3VjY2Vzc2Z1bCkge1xuICAgICAgYXdhaXQgZnMucmltcmFmKG1udFJvb3QpO1xuICAgIH0gZWxzZSB7XG4gICAgICBsb2cud2FybihgVW1vdW50IGhhcyBmYWlsZWQsIHNvIG5vdCByZW1vdmluZyAnJHttbnRSb290fSdgKTtcbiAgICB9XG4gIH1cbn1cblxuLyoqXG4gKiBHZXQgdGhlIGNvbnRlbnQgb2YgZ2l2ZW4gZmlsZSBvciBmb2xkZXIgZnJvbSBpT1MgU2ltdWxhdG9yIGFuZCByZXR1cm4gaXQgYXMgYmFzZS02NCBlbmNvZGVkIHN0cmluZy5cbiAqIEZvbGRlciBjb250ZW50IGlzIHJlY3Vyc2l2ZWx5IHBhY2tlZCBpbnRvIGEgemlwIGFyY2hpdmUuXG4gKlxuICogQHBhcmFtIHtPYmplY3R9IGRldmljZSAtIFRoZSBkZXZpY2Ugb2JqZWN0LCB3aGljaCByZXByZXNlbnRzIHRoZSBkZXZpY2UgdW5kZXIgdGVzdC5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICBUaGlzIG9iamVjdCBpcyBleHBlY3RlZCB0byBoYXZlIHRoZSBgdWRpZGAgcHJvcGVydHkgY29udGFpbmluZyB0aGVcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICB2YWxpZCBkZXZpY2UgSUQuXG4gKiBAcGFyYW0ge3N0cmluZ30gcmVtb3RlUGF0aCAtIFRoZSBwYXRoIHRvIGEgZmlsZSBvciBhIGZvbGRlciwgd2hpY2ggZXhpc3RzIGluIHRoZSBjb3JyZXNwb25kaW5nIGFwcGxpY2F0aW9uXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lciBvbiBTaW11bGF0b3IuIFVzZVxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBAPGFwcF9idW5kbGVfaWQ+OjxvcHRpb25hbF9jb250YWluZXJfdHlwZT4vPHBhdGhfdG9fdGhlX2ZpbGVfb3JfZm9sZGVyX2luc2lkZV9jb250YWluZXI+XG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcm1hdCB0byBwdWxsIGEgZmlsZSBvciBhIGZvbGRlciBmcm9tIGFuIGFwcGxpY2F0aW9uIGNvbnRhaW5lciBvZiB0aGUgZ2l2ZW4gdHlwZS5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgUG9zc2libGUgY29udGFpbmVyIHR5cGVzIGFyZSAnYXBwJywgJ2RhdGEnLCAnZ3JvdXBzJywgJzxBIHNwZWNpZmljIEFwcCBHcm91cCBjb250YWluZXI+Jy5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgVGhlIGRlZmF1bHQgdHlwZSBpcyAnYXBwJy5cbiAqIEBwYXJhbSB7Ym9vbGVhbn0gaXNGaWxlIC0gV2hldGhlciB0aGUgZGVzdGluYXRpb24gaXRlbSBpcyBhIGZpbGUgb3IgYSBmb2xkZXJcbiAqIEByZXR1cm5zIHtzdHJpbmd9IEJhc2UtNjQgZW5jb2RlZCBjb250ZW50IG9mIHRoZSBmaWxlLlxuICovXG5hc3luYyBmdW5jdGlvbiBwdWxsRnJvbVNpbXVsYXRvciAoZGV2aWNlLCByZW1vdGVQYXRoLCBpc0ZpbGUpIHtcbiAgbGV0IHBhdGhPblNlcnZlcjtcbiAgaWYgKENPTlRBSU5FUl9QQVRIX1BBVFRFUk4udGVzdChyZW1vdGVQYXRoKSkge1xuICAgIGNvbnN0IFtidW5kbGVJZCwgZHN0UGF0aF0gPSBhd2FpdCBwYXJzZUNvbnRhaW5lclBhdGgocmVtb3RlUGF0aCxcbiAgICAgIGFzeW5jIChhcHBCdW5kbGUsIGNvbnRhaW5lclR5cGUpID0+IGF3YWl0IGdldEFwcENvbnRhaW5lcihkZXZpY2UudWRpZCwgYXBwQnVuZGxlLCBudWxsLCBjb250YWluZXJUeXBlKSk7XG4gICAgbG9nLmluZm8oYFBhcnNlZCBidW5kbGUgaWRlbnRpZmllciAnJHtidW5kbGVJZH0nIGZyb20gJyR7cmVtb3RlUGF0aH0nLiBgICtcbiAgICAgIGBXaWxsIGdldCB0aGUgZGF0YSBmcm9tICcke2RzdFBhdGh9J2ApO1xuICAgIHBhdGhPblNlcnZlciA9IGRzdFBhdGg7XG4gIH0gZWxzZSB7XG4gICAgY29uc3Qgc2ltUm9vdCA9IGRldmljZS5nZXREaXIoKTtcbiAgICBwYXRoT25TZXJ2ZXIgPSBwYXRoLnBvc2l4LmpvaW4oc2ltUm9vdCwgcmVtb3RlUGF0aCk7XG4gICAgdmVyaWZ5SXNTdWJQYXRoKHBhdGhPblNlcnZlciwgc2ltUm9vdCk7XG4gICAgbG9nLmluZm8oYEdvdCB0aGUgZnVsbCBpdGVtIHBhdGg6ICR7cGF0aE9uU2VydmVyfWApO1xuICB9XG4gIGlmICghYXdhaXQgZnMuZXhpc3RzKHBhdGhPblNlcnZlcikpIHtcbiAgICBsb2cuZXJyb3JBbmRUaHJvdyhgVGhlIHJlbW90ZSAke2lzRmlsZSA/ICdmaWxlJyA6ICdmb2xkZXInfSBhdCAnJHtwYXRoT25TZXJ2ZXJ9JyBkb2VzIG5vdCBleGlzdGApO1xuICB9XG4gIGNvbnN0IGJ1ZmZlciA9IGlzRmlsZVxuICAgID8gYXdhaXQgZnMucmVhZEZpbGUocGF0aE9uU2VydmVyKVxuICAgIDogYXdhaXQgemlwLnRvSW5NZW1vcnlaaXAocGF0aE9uU2VydmVyKTtcbiAgcmV0dXJuIEJ1ZmZlci5mcm9tKGJ1ZmZlcikudG9TdHJpbmcoJ2Jhc2U2NCcpO1xufVxuXG4vKipcbiAqIEdldCB0aGUgY29udGVudCBvZiBnaXZlbiBmaWxlIG9yIGZvbGRlciBmcm9tIHRoZSByZWFsIGRldmljZSB1bmRlciB0ZXN0IGFuZCByZXR1cm4gaXQgYXMgYmFzZS02NCBlbmNvZGVkIHN0cmluZy5cbiAqIEZvbGRlciBjb250ZW50IGlzIHJlY3Vyc2l2ZWx5IHBhY2tlZCBpbnRvIGEgemlwIGFyY2hpdmUuXG4gKlxuICogQHBhcmFtIHtPYmplY3R9IGRldmljZSAtIFRoZSBkZXZpY2Ugb2JqZWN0LCB3aGljaCByZXByZXNlbnRzIHRoZSBkZXZpY2UgdW5kZXIgdGVzdC5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICBUaGlzIG9iamVjdCBpcyBleHBlY3RlZCB0byBoYXZlIHRoZSBgdWRpZGAgcHJvcGVydHkgY29udGFpbmluZyB0aGVcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICB2YWxpZCBkZXZpY2UgSUQuXG4gKiBAcGFyYW0ge3N0cmluZ30gcmVtb3RlUGF0aCAtIFRoZSBwYXRoIHRvIGFuIGV4aXN0aW5nIHJlbW90ZSBmaWxlIG9uIHRoZSBkZXZpY2UuIFRoaXMgdmFyaWFibGUgY2FuIGJlIHByZWZpeGVkIHdpdGhcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnVuZGxlIGlkLCBzbyB0aGVuIHRoZSBmaWxlIHdpbGwgYmUgZG93bmxvYWRlZCBmcm9tIHRoZSBjb3JyZXNwb25kaW5nXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFwcGxpY2F0aW9uIGNvbnRhaW5lciBpbnN0ZWFkIG9mIHRoZSBkZWZhdWx0IG1lZGlhIGZvbGRlciwgZm9yIGV4YW1wbGVcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ0Bjb20ubXlhcHAuYmxhL1JlbGF0aXZlUGF0aEluQ29udGFpbmVyLzExMS5wbmcnLiBUaGUgJ0AnIGNoYXJhY3RlciBhdCB0aGVcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmVnaW5uaW5nIG9mIHRoZSBhcmd1bWVudCBpcyBtYW5kYXRvcnkgaW4gc3VjaCBjYXNlLlxuICogQHBhcmFtIHtib29sZWFufSBpc0ZpbGUgLSBXaGV0aGVyIHRoZSBkZXN0aW5hdGlvbiBpdGVtIGlzIGEgZmlsZSBvciBhIGZvbGRlclxuICogQHJldHVybiB7c3RyaW5nfSBCYXNlLTY0IGVuY29kZWQgY29udGVudCBvZiB0aGUgcmVtb3RlIGZpbGVcbiAqL1xuYXN5bmMgZnVuY3Rpb24gcHVsbEZyb21SZWFsRGV2aWNlIChkZXZpY2UsIHJlbW90ZVBhdGgsIGlzRmlsZSkge1xuICBhd2FpdCB2ZXJpZnlJRnVzZVByZXNlbmNlKCk7XG4gIGNvbnN0IG1udFJvb3QgPSBhd2FpdCB0ZW1wRGlyLm9wZW5EaXIoKTtcbiAgbGV0IGlzVW5tb3VudFN1Y2Nlc3NmdWwgPSB0cnVlO1xuICB0cnkge1xuICAgIGxldCBkc3RQYXRoID0gcGF0aC5yZXNvbHZlKG1udFJvb3QsIHJlbW90ZVBhdGgpO1xuICAgIGxldCBpZnVzZUFyZ3MgPSBbJy11JywgZGV2aWNlLnVkaWQsIG1udFJvb3RdO1xuICAgIGlmIChDT05UQUlORVJfUEFUSF9QQVRURVJOLnRlc3QocmVtb3RlUGF0aCkpIHtcbiAgICAgIGNvbnN0IFtidW5kbGVJZCwgcGF0aEluQ29udGFpbmVyXSA9IGF3YWl0IHBhcnNlQ29udGFpbmVyUGF0aChyZW1vdGVQYXRoLCBtbnRSb290KTtcbiAgICAgIGRzdFBhdGggPSBwYXRoSW5Db250YWluZXI7XG4gICAgICBsb2cuaW5mbyhgUGFyc2VkIGJ1bmRsZSBpZGVudGlmaWVyICcke2J1bmRsZUlkfScgZnJvbSAnJHtyZW1vdGVQYXRofScuIGAgK1xuICAgICAgICBgV2lsbCBnZXQgdGhlIGRhdGEgZnJvbSAnJHtkc3RQYXRofSdgKTtcbiAgICAgIGlmdXNlQXJncyA9IFsnLXUnLCBkZXZpY2UudWRpZCwgJy0tY29udGFpbmVyJywgYnVuZGxlSWQsIG1udFJvb3RdO1xuICAgIH0gZWxzZSB7XG4gICAgICB2ZXJpZnlJc1N1YlBhdGgoZHN0UGF0aCwgbW50Um9vdCk7XG4gICAgfVxuICAgIGF3YWl0IG1vdW50RGV2aWNlKGRldmljZSwgaWZ1c2VBcmdzKTtcbiAgICBpc1VubW91bnRTdWNjZXNzZnVsID0gZmFsc2U7XG4gICAgdHJ5IHtcbiAgICAgIGlmICghYXdhaXQgZnMuZXhpc3RzKGRzdFBhdGgpKSB7XG4gICAgICAgIGxvZy5lcnJvckFuZFRocm93KGBUaGUgcmVtb3RlICR7aXNGaWxlID8gJ2ZpbGUnIDogJ2ZvbGRlcid9IGF0ICcke2RzdFBhdGh9JyBkb2VzIG5vdCBleGlzdGApO1xuICAgICAgfVxuICAgICAgY29uc3QgYnVmZmVyID0gaXNGaWxlXG4gICAgICAgID8gYXdhaXQgZnMucmVhZEZpbGUoZHN0UGF0aClcbiAgICAgICAgOiBhd2FpdCB6aXAudG9Jbk1lbW9yeVppcChkc3RQYXRoKTtcbiAgICAgIHJldHVybiBCdWZmZXIuZnJvbShidWZmZXIpLnRvU3RyaW5nKCdiYXNlNjQnKTtcbiAgICB9IGZpbmFsbHkge1xuICAgICAgYXdhaXQgZXhlYygndW1vdW50JywgW21udFJvb3RdKTtcbiAgICAgIGlzVW5tb3VudFN1Y2Nlc3NmdWwgPSB0cnVlO1xuICAgIH1cbiAgfSBmaW5hbGx5IHtcbiAgICBpZiAoaXNVbm1vdW50U3VjY2Vzc2Z1bCkge1xuICAgICAgYXdhaXQgZnMucmltcmFmKG1udFJvb3QpO1xuICAgIH0gZWxzZSB7XG4gICAgICBsb2cud2FybihgVW1vdW50IGhhcyBmYWlsZWQsIHNvIG5vdCByZW1vdmluZyAnJHttbnRSb290fSdgKTtcbiAgICB9XG4gIH1cbn1cblxuXG5jb21tYW5kcy5wdXNoRmlsZSA9IGFzeW5jIGZ1bmN0aW9uIHB1c2hGaWxlIChyZW1vdGVQYXRoLCBiYXNlNjREYXRhKSB7XG4gIGlmIChyZW1vdGVQYXRoLmVuZHNXaXRoKCcvJykpIHtcbiAgICBsb2cuZXJyb3JBbmRUaHJvdyhgSXQgaXMgZXhwZWN0ZWQgdGhhdCByZW1vdGUgcGF0aCBwb2ludHMgdG8gYSBmaWxlIGFuZCBub3QgdG8gYSBmb2xkZXIuIGAgK1xuICAgICAgICAgICAgICAgICAgICAgIGAnJHtyZW1vdGVQYXRofScgaXMgZ2l2ZW4gaW5zdGVhZGApO1xuICB9XG4gIGlmIChfLmlzQXJyYXkoYmFzZTY0RGF0YSkpIHtcbiAgICAvLyBzb21lIGNsaWVudHMgKGFoZW0pIGphdmEsIHNlbmQgYSBieXRlIGFycmF5IGVuY29kaW5nIHV0ZjggY2hhcmFjdGVyc1xuICAgIC8vIGluc3RlYWQgb2YgYSBzdHJpbmcsIHdoaWNoIHdvdWxkIGJlIGluZmluaXRlbHkgYmV0dGVyIVxuICAgIGJhc2U2NERhdGEgPSBCdWZmZXIuZnJvbShiYXNlNjREYXRhKS50b1N0cmluZygndXRmOCcpO1xuICB9XG4gIHJldHVybiB0aGlzLmlzU2ltdWxhdG9yKClcbiAgICA/IGF3YWl0IHB1c2hGaWxlVG9TaW11bGF0b3IodGhpcy5vcHRzLmRldmljZSwgcmVtb3RlUGF0aCwgYmFzZTY0RGF0YSlcbiAgICA6IGF3YWl0IHB1c2hGaWxlVG9SZWFsRGV2aWNlKHRoaXMub3B0cy5kZXZpY2UsIHJlbW90ZVBhdGgsIGJhc2U2NERhdGEpO1xufTtcblxuY29tbWFuZHMucHVsbEZpbGUgPSBhc3luYyBmdW5jdGlvbiBwdWxsRmlsZSAocmVtb3RlUGF0aCkge1xuICBpZiAocmVtb3RlUGF0aC5lbmRzV2l0aCgnLycpKSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coYEl0IGlzIGV4cGVjdGVkIHRoYXQgcmVtb3RlIHBhdGggcG9pbnRzIHRvIGEgZmlsZSBhbmQgbm90IHRvIGEgZm9sZGVyLiBgICtcbiAgICAgICAgICAgICAgICAgICAgICBgJyR7cmVtb3RlUGF0aH0nIGlzIGdpdmVuIGluc3RlYWRgKTtcbiAgfVxuICByZXR1cm4gdGhpcy5pc1NpbXVsYXRvcigpXG4gICAgPyBhd2FpdCBwdWxsRnJvbVNpbXVsYXRvcih0aGlzLm9wdHMuZGV2aWNlLCByZW1vdGVQYXRoLCB0cnVlKVxuICAgIDogYXdhaXQgcHVsbEZyb21SZWFsRGV2aWNlKHRoaXMub3B0cy5kZXZpY2UsIHJlbW90ZVBhdGgsIHRydWUpO1xufTtcblxuY29tbWFuZHMuZ2V0U2ltRmlsZUZ1bGxQYXRoID0gYXN5bmMgZnVuY3Rpb24gZ2V0U2ltRmlsZUZ1bGxQYXRoIChyZW1vdGVQYXRoKSB7XG4gIGxldCBiYXNlUGF0aCA9IHRoaXMub3B0cy5kZXZpY2UuZ2V0RGlyKCk7XG4gIGxldCBhcHBOYW1lID0gbnVsbDtcblxuICBpZiAodGhpcy5vcHRzLmFwcCkge1xuICAgIGxldCBhcHBOYW1lUmVnZXggPSBuZXcgUmVnRXhwKGBcXFxcJHtwYXRoLnNlcH0oW1xcXFx3LV0rXFxcXC5hcHApYCk7XG4gICAgbGV0IGFwcE5hbWVNYXRjaGVzID0gYXBwTmFtZVJlZ2V4LmV4ZWModGhpcy5vcHRzLmFwcCk7XG4gICAgaWYgKGFwcE5hbWVNYXRjaGVzKSB7XG4gICAgICBhcHBOYW1lID0gYXBwTmFtZU1hdGNoZXNbMV07XG4gICAgfVxuICB9XG4gIC8vIGRlLWFic29sdXRpemUgdGhlIHBhdGhcbiAgaWYgKHN5c3RlbS5pc1dpbmRvd3MoKSkge1xuICAgIGlmIChyZW1vdGVQYXRoLmluZGV4b2YoJzovLycpID09PSAxKSB7XG4gICAgICByZW1vdGVQYXRoID0gcmVtb3RlUGF0aC5zbGljZSg0KTtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgaWYgKHJlbW90ZVBhdGguaW5kZXhPZignLycpID09PSAwKSB7XG4gICAgICByZW1vdGVQYXRoID0gcmVtb3RlUGF0aC5zbGljZSgxKTtcbiAgICB9XG4gIH1cblxuICBpZiAocmVtb3RlUGF0aC5zdGFydHNXaXRoKGFwcE5hbWUpKSB7XG4gICAgbGV0IGZpbmRQYXRoID0gYmFzZVBhdGg7XG4gICAgaWYgKHV0aWwuY29tcGFyZVZlcnNpb25zKHRoaXMub3B0cy5wbGF0Zm9ybVZlcnNpb24sICc+PScsICc4LjAnKSkge1xuICAgICAgLy8gdGhlIC5hcHAgZmlsZSBhcHBlYXJzIGluIC9Db250YWluZXJzL0RhdGEgYW5kIC9Db250YWluZXJzL0J1bmRsZSBib3RoLiBXZSBvbmx5IHdhbnQgL0J1bmRsZVxuICAgICAgZmluZFBhdGggPSBwYXRoLnJlc29sdmUoYmFzZVBhdGgsICdDb250YWluZXJzJywgJ0J1bmRsZScpO1xuICAgIH1cbiAgICBmaW5kUGF0aCA9IGZpbmRQYXRoLnJlcGxhY2UoL1xccy9nLCAnXFxcXCAnKTtcblxuICAgIGxldCB7IHN0ZG91dCB9ID0gYXdhaXQgZXhlYygnZmluZCcsIFtmaW5kUGF0aCwgJy1uYW1lJywgYXBwTmFtZV0pO1xuICAgIGxldCBhcHBSb290ID0gc3Rkb3V0LnJlcGxhY2UoL1xcbiQvLCAnJyk7XG4gICAgbGV0IHN1YlBhdGggPSByZW1vdGVQYXRoLnN1YnN0cmluZyhhcHBOYW1lLmxlbmd0aCArIDEpO1xuICAgIGxldCBmdWxsUGF0aCA9IHBhdGgucmVzb2x2ZShhcHBSb290LCBzdWJQYXRoKTtcbiAgICBsb2cuZGVidWcoYEZpbmRpbmcgYXBwLXJlbGF0aXZlIGZpbGU6ICcke2Z1bGxQYXRofSdgKTtcbiAgICByZXR1cm4gZnVsbFBhdGg7XG4gIH1cblxuICBsZXQgZnVsbFBhdGggPSBwYXRoLnJlc29sdmUoYmFzZVBhdGgsIHJlbW90ZVBhdGgpO1xuICBsb2cuZGVidWcoYEZpbmRpbmcgc2ltLXJlbGF0aXZlIGZpbGU6ICR7ZnVsbFBhdGh9YCk7XG4gIHJldHVybiBmdWxsUGF0aDtcbn07XG5cbmNvbW1hbmRzLnB1bGxGb2xkZXIgPSBhc3luYyBmdW5jdGlvbiBwdWxsRm9sZGVyIChyZW1vdGVQYXRoKSB7XG4gIGlmICghcmVtb3RlUGF0aC5lbmRzV2l0aCgnLycpKSB7XG4gICAgcmVtb3RlUGF0aCA9IGAke3JlbW90ZVBhdGh9L2A7XG4gIH1cbiAgcmV0dXJuIHRoaXMuaXNTaW11bGF0b3IoKVxuICAgID8gYXdhaXQgcHVsbEZyb21TaW11bGF0b3IodGhpcy5vcHRzLmRldmljZSwgcmVtb3RlUGF0aCwgZmFsc2UpXG4gICAgOiBhd2FpdCBwdWxsRnJvbVJlYWxEZXZpY2UodGhpcy5vcHRzLmRldmljZSwgcmVtb3RlUGF0aCwgZmFsc2UpO1xufTtcblxuZXhwb3J0IHsgY29tbWFuZHMgfTtcbmV4cG9ydCBkZWZhdWx0IGNvbW1hbmRzO1xuIl0sImZpbGUiOiJsaWIvY29tbWFuZHMvZmlsZS1tb3ZlbWVudC5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
