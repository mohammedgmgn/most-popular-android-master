"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.appInfoFromDict = appInfoFromDict;
exports.pageArrayFromDict = pageArrayFromDict;
exports.getDebuggerAppKey = getDebuggerAppKey;
exports.getPossibleDebuggerAppKeys = getPossibleDebuggerAppKeys;
exports.checkParams = checkParams;
exports.wrapScriptForFrame = wrapScriptForFrame;
exports.getScriptForAtom = getScriptForAtom;
exports.simpleStringify = simpleStringify;
exports.deferredPromise = deferredPromise;

require("source-map-support/register");

var _logger = _interopRequireDefault(require("./logger"));

var _atoms = _interopRequireDefault(require("./atoms"));

var _lodash = _interopRequireDefault(require("lodash"));

var _assert = _interopRequireDefault(require("assert"));

var _bluebird = _interopRequireDefault(require("bluebird"));

const WEB_CONTENT_BUNDLE_ID = 'com.apple.WebKit.WebContent';

function appInfoFromDict(dict) {
  const id = dict.WIRApplicationIdentifierKey;
  const isProxy = _lodash.default.isString(dict.WIRIsApplicationProxyKey) ? dict.WIRIsApplicationProxyKey.toLowerCase() === 'true' : dict.WIRIsApplicationProxyKey;
  const entry = {
    id,
    isProxy,
    name: dict.WIRApplicationNameKey,
    bundleId: dict.WIRApplicationBundleIdentifierKey,
    hostId: dict.WIRHostApplicationIdentifierKey,
    isActive: dict.WIRIsApplicationActiveKey,
    isAutomationEnabled: !!dict.WIRRemoteAutomationEnabledKey
  };
  return [id, entry];
}

function pageArrayFromDict(pageDict) {
  if (pageDict.id) {
    return [pageDict];
  }

  let newPageArray = [];

  for (const dict of _lodash.default.values(pageDict)) {
    if (_lodash.default.isUndefined(dict.WIRTypeKey) || dict.WIRTypeKey === 'WIRTypeWeb') {
      newPageArray.push({
        id: dict.WIRPageIdentifierKey,
        title: dict.WIRTitleKey,
        url: dict.WIRURLKey,
        isKey: !_lodash.default.isUndefined(dict.WIRConnectionIdentifierKey)
      });
    }
  }

  return newPageArray;
}

function getDebuggerAppKey(bundleId, platformVersion, appDict) {
  let appId;

  if (parseFloat(platformVersion) >= 8) {
    for (const [key, data] of _lodash.default.toPairs(appDict)) {
      if (data.bundleId === bundleId) {
        appId = key;
        break;
      }
    }

    if (appId) {
      _logger.default.debug(`Found app id key '${appId}' for bundle '${bundleId}'`);

      let proxiedAppIds = [];

      for (const [key, data] of _lodash.default.toPairs(appDict)) {
        if (data.isProxy && data.hostId === appId) {
          _logger.default.debug(`Found separate bundleId '${data.bundleId}' ` + `acting as proxy for '${bundleId}', with app id '${key}'`);

          proxiedAppIds.push(key);
        }
      }

      if (proxiedAppIds.length) {
        appId = _lodash.default.last(proxiedAppIds);

        _logger.default.debug(`Using proxied app id '${appId}'`);
      }
    }
  } else {
    if (_lodash.default.has(appDict, bundleId)) {
      appId = bundleId;
    }
  }

  return appId;
}

function appIdForBundle(bundleId, appDict) {
  let appId;

  for (const [key, data] of _lodash.default.toPairs(appDict)) {
    if (data.bundleId === bundleId) {
      appId = key;
      break;
    }
  }

  if (!appId && bundleId !== WEB_CONTENT_BUNDLE_ID) {
    return appIdForBundle(WEB_CONTENT_BUNDLE_ID, appDict);
  }

  return appId;
}

function getPossibleDebuggerAppKeys(bundleId, platformVersion, appDict) {
  let proxiedAppIds = [];

  if (parseFloat(platformVersion) >= 8) {
    const appId = appIdForBundle(bundleId, appDict);

    if (appId) {
      proxiedAppIds.push(appId);

      _logger.default.debug(`Found app id key '${appId}' for bundle '${bundleId}'`);

      for (const [key, data] of _lodash.default.toPairs(appDict)) {
        if (data.isProxy && data.hostId === appId) {
          _logger.default.debug(`Found separate bundleId '${data.bundleId}' ` + `acting as proxy for '${bundleId}', with app id '${key}'`);

          proxiedAppIds.push(key);
        }
      }
    }
  } else {
    if (_lodash.default.has(appDict, bundleId)) {
      proxiedAppIds = [bundleId];
    }
  }

  return proxiedAppIds;
}

function checkParams(params) {
  let errors = [];

  for (const [param, value] of _lodash.default.toPairs(params)) {
    try {
      _assert.default.ok(value);
    } catch (err) {
      errors.push(param);
    }
  }

  if (errors.length) {
    return errors;
  }
}

async function wrapScriptForFrame(script, frame) {
  _logger.default.debug(`Wrapping script for frame '${frame}'`);

  let elFromCache = await (0, _atoms.default)('get_element_from_cache');
  return `(function (window) { var document = window.document; ` + `return (${script}); })((${elFromCache.toString('utf8')})(${JSON.stringify(frame)}))`;
}

async function getScriptForAtom(atom, args, frames, asyncCallBack = null) {
  let atomSrc = await (0, _atoms.default)(atom);
  let script;

  if (frames.length > 0) {
    script = atomSrc;

    for (const frame of frames) {
      script = await wrapScriptForFrame(script, frame);
    }
  } else {
    _logger.default.debug(`Executing '${atom}' atom in default context`);

    script = `(${atomSrc})`;
  }

  args = args.map(JSON.stringify);

  if (asyncCallBack) {
    script += `(${args.join(',')}, ${asyncCallBack}, true )`;
  } else {
    script += `(${args.join(',')})`;
  }

  return script;
}

function simpleStringify(value) {
  if (!value) {
    return JSON.stringify(value);
  }

  let cleanValue = _lodash.default.clone(value);

  for (const property of ['ceil', 'clone', 'floor', 'round', 'scale', 'toString']) {
    delete cleanValue[property];
  }

  return JSON.stringify(cleanValue);
}

function deferredPromise() {
  let resolve;
  let reject;
  const promise = new _bluebird.default((res, rej) => {
    resolve = res;
    reject = rej;
  });
  return {
    promise,
    resolve,
    reject
  };
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9oZWxwZXJzLmpzIl0sIm5hbWVzIjpbIldFQl9DT05URU5UX0JVTkRMRV9JRCIsImFwcEluZm9Gcm9tRGljdCIsImRpY3QiLCJpZCIsIldJUkFwcGxpY2F0aW9uSWRlbnRpZmllcktleSIsImlzUHJveHkiLCJfIiwiaXNTdHJpbmciLCJXSVJJc0FwcGxpY2F0aW9uUHJveHlLZXkiLCJ0b0xvd2VyQ2FzZSIsImVudHJ5IiwibmFtZSIsIldJUkFwcGxpY2F0aW9uTmFtZUtleSIsImJ1bmRsZUlkIiwiV0lSQXBwbGljYXRpb25CdW5kbGVJZGVudGlmaWVyS2V5IiwiaG9zdElkIiwiV0lSSG9zdEFwcGxpY2F0aW9uSWRlbnRpZmllcktleSIsImlzQWN0aXZlIiwiV0lSSXNBcHBsaWNhdGlvbkFjdGl2ZUtleSIsImlzQXV0b21hdGlvbkVuYWJsZWQiLCJXSVJSZW1vdGVBdXRvbWF0aW9uRW5hYmxlZEtleSIsInBhZ2VBcnJheUZyb21EaWN0IiwicGFnZURpY3QiLCJuZXdQYWdlQXJyYXkiLCJ2YWx1ZXMiLCJpc1VuZGVmaW5lZCIsIldJUlR5cGVLZXkiLCJwdXNoIiwiV0lSUGFnZUlkZW50aWZpZXJLZXkiLCJ0aXRsZSIsIldJUlRpdGxlS2V5IiwidXJsIiwiV0lSVVJMS2V5IiwiaXNLZXkiLCJXSVJDb25uZWN0aW9uSWRlbnRpZmllcktleSIsImdldERlYnVnZ2VyQXBwS2V5IiwicGxhdGZvcm1WZXJzaW9uIiwiYXBwRGljdCIsImFwcElkIiwicGFyc2VGbG9hdCIsImtleSIsImRhdGEiLCJ0b1BhaXJzIiwibG9nIiwiZGVidWciLCJwcm94aWVkQXBwSWRzIiwibGVuZ3RoIiwibGFzdCIsImhhcyIsImFwcElkRm9yQnVuZGxlIiwiZ2V0UG9zc2libGVEZWJ1Z2dlckFwcEtleXMiLCJjaGVja1BhcmFtcyIsInBhcmFtcyIsImVycm9ycyIsInBhcmFtIiwidmFsdWUiLCJhc3NlcnQiLCJvayIsImVyciIsIndyYXBTY3JpcHRGb3JGcmFtZSIsInNjcmlwdCIsImZyYW1lIiwiZWxGcm9tQ2FjaGUiLCJ0b1N0cmluZyIsIkpTT04iLCJzdHJpbmdpZnkiLCJnZXRTY3JpcHRGb3JBdG9tIiwiYXRvbSIsImFyZ3MiLCJmcmFtZXMiLCJhc3luY0NhbGxCYWNrIiwiYXRvbVNyYyIsIm1hcCIsImpvaW4iLCJzaW1wbGVTdHJpbmdpZnkiLCJjbGVhblZhbHVlIiwiY2xvbmUiLCJwcm9wZXJ0eSIsImRlZmVycmVkUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJwcm9taXNlIiwiQiIsInJlcyIsInJlaiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUdBLE1BQU1BLHFCQUFxQixHQUFHLDZCQUE5Qjs7QUFNQSxTQUFTQyxlQUFULENBQTBCQyxJQUExQixFQUFnQztBQUM5QixRQUFNQyxFQUFFLEdBQUdELElBQUksQ0FBQ0UsMkJBQWhCO0FBQ0EsUUFBTUMsT0FBTyxHQUFHQyxnQkFBRUMsUUFBRixDQUFXTCxJQUFJLENBQUNNLHdCQUFoQixJQUNaTixJQUFJLENBQUNNLHdCQUFMLENBQThCQyxXQUE5QixPQUFnRCxNQURwQyxHQUVaUCxJQUFJLENBQUNNLHdCQUZUO0FBR0EsUUFBTUUsS0FBSyxHQUFHO0FBQ1pQLElBQUFBLEVBRFk7QUFFWkUsSUFBQUEsT0FGWTtBQUdaTSxJQUFBQSxJQUFJLEVBQUVULElBQUksQ0FBQ1UscUJBSEM7QUFJWkMsSUFBQUEsUUFBUSxFQUFFWCxJQUFJLENBQUNZLGlDQUpIO0FBS1pDLElBQUFBLE1BQU0sRUFBRWIsSUFBSSxDQUFDYywrQkFMRDtBQU1aQyxJQUFBQSxRQUFRLEVBQUVmLElBQUksQ0FBQ2dCLHlCQU5IO0FBT1pDLElBQUFBLG1CQUFtQixFQUFFLENBQUMsQ0FBQ2pCLElBQUksQ0FBQ2tCO0FBUGhCLEdBQWQ7QUFVQSxTQUFPLENBQUNqQixFQUFELEVBQUtPLEtBQUwsQ0FBUDtBQUNEOztBQU1ELFNBQVNXLGlCQUFULENBQTRCQyxRQUE1QixFQUFzQztBQUNwQyxNQUFJQSxRQUFRLENBQUNuQixFQUFiLEVBQWlCO0FBRWYsV0FBTyxDQUFDbUIsUUFBRCxDQUFQO0FBQ0Q7O0FBQ0QsTUFBSUMsWUFBWSxHQUFHLEVBQW5COztBQUNBLE9BQUssTUFBTXJCLElBQVgsSUFBbUJJLGdCQUFFa0IsTUFBRixDQUFTRixRQUFULENBQW5CLEVBQXVDO0FBRXJDLFFBQUloQixnQkFBRW1CLFdBQUYsQ0FBY3ZCLElBQUksQ0FBQ3dCLFVBQW5CLEtBQWtDeEIsSUFBSSxDQUFDd0IsVUFBTCxLQUFvQixZQUExRCxFQUF3RTtBQUN0RUgsTUFBQUEsWUFBWSxDQUFDSSxJQUFiLENBQWtCO0FBQ2hCeEIsUUFBQUEsRUFBRSxFQUFFRCxJQUFJLENBQUMwQixvQkFETztBQUVoQkMsUUFBQUEsS0FBSyxFQUFFM0IsSUFBSSxDQUFDNEIsV0FGSTtBQUdoQkMsUUFBQUEsR0FBRyxFQUFFN0IsSUFBSSxDQUFDOEIsU0FITTtBQUloQkMsUUFBQUEsS0FBSyxFQUFFLENBQUMzQixnQkFBRW1CLFdBQUYsQ0FBY3ZCLElBQUksQ0FBQ2dDLDBCQUFuQjtBQUpRLE9BQWxCO0FBTUQ7QUFDRjs7QUFDRCxTQUFPWCxZQUFQO0FBQ0Q7O0FBTUQsU0FBU1ksaUJBQVQsQ0FBNEJ0QixRQUE1QixFQUFzQ3VCLGVBQXRDLEVBQXVEQyxPQUF2RCxFQUFnRTtBQUM5RCxNQUFJQyxLQUFKOztBQUNBLE1BQUlDLFVBQVUsQ0FBQ0gsZUFBRCxDQUFWLElBQStCLENBQW5DLEVBQXNDO0FBQ3BDLFNBQUssTUFBTSxDQUFDSSxHQUFELEVBQU1DLElBQU4sQ0FBWCxJQUEwQm5DLGdCQUFFb0MsT0FBRixDQUFVTCxPQUFWLENBQTFCLEVBQThDO0FBQzVDLFVBQUlJLElBQUksQ0FBQzVCLFFBQUwsS0FBa0JBLFFBQXRCLEVBQWdDO0FBQzlCeUIsUUFBQUEsS0FBSyxHQUFHRSxHQUFSO0FBQ0E7QUFDRDtBQUNGOztBQUVELFFBQUlGLEtBQUosRUFBVztBQUNUSyxzQkFBSUMsS0FBSixDQUFXLHFCQUFvQk4sS0FBTSxpQkFBZ0J6QixRQUFTLEdBQTlEOztBQUNBLFVBQUlnQyxhQUFhLEdBQUcsRUFBcEI7O0FBQ0EsV0FBSyxNQUFNLENBQUNMLEdBQUQsRUFBTUMsSUFBTixDQUFYLElBQTBCbkMsZ0JBQUVvQyxPQUFGLENBQVVMLE9BQVYsQ0FBMUIsRUFBOEM7QUFDNUMsWUFBSUksSUFBSSxDQUFDcEMsT0FBTCxJQUFnQm9DLElBQUksQ0FBQzFCLE1BQUwsS0FBZ0J1QixLQUFwQyxFQUEyQztBQUN6Q0ssMEJBQUlDLEtBQUosQ0FBVyw0QkFBMkJILElBQUksQ0FBQzVCLFFBQVMsSUFBMUMsR0FDQyx3QkFBdUJBLFFBQVMsbUJBQWtCMkIsR0FBSSxHQURqRTs7QUFFQUssVUFBQUEsYUFBYSxDQUFDbEIsSUFBZCxDQUFtQmEsR0FBbkI7QUFDRDtBQUNGOztBQUNELFVBQUlLLGFBQWEsQ0FBQ0MsTUFBbEIsRUFBMEI7QUFFeEJSLFFBQUFBLEtBQUssR0FBR2hDLGdCQUFFeUMsSUFBRixDQUFPRixhQUFQLENBQVI7O0FBQ0FGLHdCQUFJQyxLQUFKLENBQVcseUJBQXdCTixLQUFNLEdBQXpDO0FBQ0Q7QUFDRjtBQUNGLEdBeEJELE1Bd0JPO0FBQ0wsUUFBSWhDLGdCQUFFMEMsR0FBRixDQUFNWCxPQUFOLEVBQWV4QixRQUFmLENBQUosRUFBOEI7QUFDNUJ5QixNQUFBQSxLQUFLLEdBQUd6QixRQUFSO0FBQ0Q7QUFDRjs7QUFFRCxTQUFPeUIsS0FBUDtBQUNEOztBQUVELFNBQVNXLGNBQVQsQ0FBeUJwQyxRQUF6QixFQUFtQ3dCLE9BQW5DLEVBQTRDO0FBQzFDLE1BQUlDLEtBQUo7O0FBQ0EsT0FBSyxNQUFNLENBQUNFLEdBQUQsRUFBTUMsSUFBTixDQUFYLElBQTBCbkMsZ0JBQUVvQyxPQUFGLENBQVVMLE9BQVYsQ0FBMUIsRUFBOEM7QUFDNUMsUUFBSUksSUFBSSxDQUFDNUIsUUFBTCxLQUFrQkEsUUFBdEIsRUFBZ0M7QUFDOUJ5QixNQUFBQSxLQUFLLEdBQUdFLEdBQVI7QUFDQTtBQUNEO0FBQ0Y7O0FBR0QsTUFBSSxDQUFDRixLQUFELElBQVV6QixRQUFRLEtBQUtiLHFCQUEzQixFQUFrRDtBQUNoRCxXQUFPaUQsY0FBYyxDQUFDakQscUJBQUQsRUFBd0JxQyxPQUF4QixDQUFyQjtBQUNEOztBQUVELFNBQU9DLEtBQVA7QUFDRDs7QUFFRCxTQUFTWSwwQkFBVCxDQUFxQ3JDLFFBQXJDLEVBQStDdUIsZUFBL0MsRUFBZ0VDLE9BQWhFLEVBQXlFO0FBQ3ZFLE1BQUlRLGFBQWEsR0FBRyxFQUFwQjs7QUFDQSxNQUFJTixVQUFVLENBQUNILGVBQUQsQ0FBVixJQUErQixDQUFuQyxFQUFzQztBQUNwQyxVQUFNRSxLQUFLLEdBQUdXLGNBQWMsQ0FBQ3BDLFFBQUQsRUFBV3dCLE9BQVgsQ0FBNUI7O0FBR0EsUUFBSUMsS0FBSixFQUFXO0FBQ1RPLE1BQUFBLGFBQWEsQ0FBQ2xCLElBQWQsQ0FBbUJXLEtBQW5COztBQUNBSyxzQkFBSUMsS0FBSixDQUFXLHFCQUFvQk4sS0FBTSxpQkFBZ0J6QixRQUFTLEdBQTlEOztBQUNBLFdBQUssTUFBTSxDQUFDMkIsR0FBRCxFQUFNQyxJQUFOLENBQVgsSUFBMEJuQyxnQkFBRW9DLE9BQUYsQ0FBVUwsT0FBVixDQUExQixFQUE4QztBQUM1QyxZQUFJSSxJQUFJLENBQUNwQyxPQUFMLElBQWdCb0MsSUFBSSxDQUFDMUIsTUFBTCxLQUFnQnVCLEtBQXBDLEVBQTJDO0FBQ3pDSywwQkFBSUMsS0FBSixDQUFXLDRCQUEyQkgsSUFBSSxDQUFDNUIsUUFBUyxJQUExQyxHQUNDLHdCQUF1QkEsUUFBUyxtQkFBa0IyQixHQUFJLEdBRGpFOztBQUVBSyxVQUFBQSxhQUFhLENBQUNsQixJQUFkLENBQW1CYSxHQUFuQjtBQUNEO0FBQ0Y7QUFDRjtBQUNGLEdBZkQsTUFlTztBQUNMLFFBQUlsQyxnQkFBRTBDLEdBQUYsQ0FBTVgsT0FBTixFQUFleEIsUUFBZixDQUFKLEVBQThCO0FBQzVCZ0MsTUFBQUEsYUFBYSxHQUFHLENBQUNoQyxRQUFELENBQWhCO0FBQ0Q7QUFDRjs7QUFFRCxTQUFPZ0MsYUFBUDtBQUNEOztBQUVELFNBQVNNLFdBQVQsQ0FBc0JDLE1BQXRCLEVBQThCO0FBQzVCLE1BQUlDLE1BQU0sR0FBRyxFQUFiOztBQUNBLE9BQUssTUFBTSxDQUFDQyxLQUFELEVBQVFDLEtBQVIsQ0FBWCxJQUE2QmpELGdCQUFFb0MsT0FBRixDQUFVVSxNQUFWLENBQTdCLEVBQWdEO0FBQzlDLFFBQUk7QUFDRkksc0JBQU9DLEVBQVAsQ0FBVUYsS0FBVjtBQUNELEtBRkQsQ0FFRSxPQUFPRyxHQUFQLEVBQVk7QUFDWkwsTUFBQUEsTUFBTSxDQUFDMUIsSUFBUCxDQUFZMkIsS0FBWjtBQUNEO0FBQ0Y7O0FBQ0QsTUFBSUQsTUFBTSxDQUFDUCxNQUFYLEVBQW1CO0FBQ2pCLFdBQU9PLE1BQVA7QUFDRDtBQUNGOztBQUVELGVBQWVNLGtCQUFmLENBQW1DQyxNQUFuQyxFQUEyQ0MsS0FBM0MsRUFBa0Q7QUFDaERsQixrQkFBSUMsS0FBSixDQUFXLDhCQUE2QmlCLEtBQU0sR0FBOUM7O0FBQ0EsTUFBSUMsV0FBVyxHQUFHLE1BQU0sb0JBQVEsd0JBQVIsQ0FBeEI7QUFDQSxTQUFRLHVEQUFELEdBQ0MsV0FBVUYsTUFBTyxVQUFTRSxXQUFXLENBQUNDLFFBQVosQ0FBcUIsTUFBckIsQ0FBNkIsS0FBSUMsSUFBSSxDQUFDQyxTQUFMLENBQWVKLEtBQWYsQ0FBc0IsSUFEekY7QUFFRDs7QUFFRCxlQUFlSyxnQkFBZixDQUFpQ0MsSUFBakMsRUFBdUNDLElBQXZDLEVBQTZDQyxNQUE3QyxFQUFxREMsYUFBYSxHQUFHLElBQXJFLEVBQTJFO0FBQ3pFLE1BQUlDLE9BQU8sR0FBRyxNQUFNLG9CQUFRSixJQUFSLENBQXBCO0FBQ0EsTUFBSVAsTUFBSjs7QUFDQSxNQUFJUyxNQUFNLENBQUN2QixNQUFQLEdBQWdCLENBQXBCLEVBQXVCO0FBQ3JCYyxJQUFBQSxNQUFNLEdBQUdXLE9BQVQ7O0FBQ0EsU0FBSyxNQUFNVixLQUFYLElBQW9CUSxNQUFwQixFQUE0QjtBQUMxQlQsTUFBQUEsTUFBTSxHQUFHLE1BQU1ELGtCQUFrQixDQUFDQyxNQUFELEVBQVNDLEtBQVQsQ0FBakM7QUFDRDtBQUNGLEdBTEQsTUFLTztBQUNMbEIsb0JBQUlDLEtBQUosQ0FBVyxjQUFhdUIsSUFBSywyQkFBN0I7O0FBQ0FQLElBQUFBLE1BQU0sR0FBSSxJQUFHVyxPQUFRLEdBQXJCO0FBQ0Q7O0FBR0RILEVBQUFBLElBQUksR0FBR0EsSUFBSSxDQUFDSSxHQUFMLENBQVNSLElBQUksQ0FBQ0MsU0FBZCxDQUFQOztBQUNBLE1BQUlLLGFBQUosRUFBbUI7QUFDakJWLElBQUFBLE1BQU0sSUFBSyxJQUFHUSxJQUFJLENBQUNLLElBQUwsQ0FBVSxHQUFWLENBQWUsS0FBSUgsYUFBYyxVQUEvQztBQUNELEdBRkQsTUFFTztBQUNMVixJQUFBQSxNQUFNLElBQUssSUFBR1EsSUFBSSxDQUFDSyxJQUFMLENBQVUsR0FBVixDQUFlLEdBQTdCO0FBQ0Q7O0FBRUQsU0FBT2IsTUFBUDtBQUNEOztBQUVELFNBQVNjLGVBQVQsQ0FBMEJuQixLQUExQixFQUFpQztBQUMvQixNQUFJLENBQUNBLEtBQUwsRUFBWTtBQUNWLFdBQU9TLElBQUksQ0FBQ0MsU0FBTCxDQUFlVixLQUFmLENBQVA7QUFDRDs7QUFJRCxNQUFJb0IsVUFBVSxHQUFHckUsZ0JBQUVzRSxLQUFGLENBQVFyQixLQUFSLENBQWpCOztBQUNBLE9BQUssTUFBTXNCLFFBQVgsSUFBdUIsQ0FBQyxNQUFELEVBQVMsT0FBVCxFQUFrQixPQUFsQixFQUEyQixPQUEzQixFQUFvQyxPQUFwQyxFQUE2QyxVQUE3QyxDQUF2QixFQUFpRjtBQUMvRSxXQUFPRixVQUFVLENBQUNFLFFBQUQsQ0FBakI7QUFDRDs7QUFDRCxTQUFPYixJQUFJLENBQUNDLFNBQUwsQ0FBZVUsVUFBZixDQUFQO0FBQ0Q7O0FBRUQsU0FBU0csZUFBVCxHQUE0QjtBQUUxQixNQUFJQyxPQUFKO0FBQ0EsTUFBSUMsTUFBSjtBQUNBLFFBQU1DLE9BQU8sR0FBRyxJQUFJQyxpQkFBSixDQUFNLENBQUNDLEdBQUQsRUFBTUMsR0FBTixLQUFjO0FBQ2xDTCxJQUFBQSxPQUFPLEdBQUdJLEdBQVY7QUFDQUgsSUFBQUEsTUFBTSxHQUFHSSxHQUFUO0FBQ0QsR0FIZSxDQUFoQjtBQUlBLFNBQU87QUFDTEgsSUFBQUEsT0FESztBQUVMRixJQUFBQSxPQUZLO0FBR0xDLElBQUFBO0FBSEssR0FBUDtBQUtEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGxvZyBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgZ2V0QXRvbSBmcm9tICcuL2F0b21zJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgYXNzZXJ0IGZyb20gJ2Fzc2VydCc7XG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5cblxuY29uc3QgV0VCX0NPTlRFTlRfQlVORExFX0lEID0gJ2NvbS5hcHBsZS5XZWJLaXQuV2ViQ29udGVudCc7XG5cbi8qXG4gKiBUYWtlcyBhIGRpY3Rpb25hcnkgZnJvbSB0aGUgcmVtb3RlIGRlYnVnZ2VyIGFuZCBtYWtlcyBhIG1vcmUgbWFuYWdlYWJsZVxuICogZGljdGlvbmFyeSB3aG9zZSBrZXlzIGFyZSB1bmRlcnN0YW5kYWJsZVxuICovXG5mdW5jdGlvbiBhcHBJbmZvRnJvbURpY3QgKGRpY3QpIHtcbiAgY29uc3QgaWQgPSBkaWN0LldJUkFwcGxpY2F0aW9uSWRlbnRpZmllcktleTtcbiAgY29uc3QgaXNQcm94eSA9IF8uaXNTdHJpbmcoZGljdC5XSVJJc0FwcGxpY2F0aW9uUHJveHlLZXkpXG4gICAgPyBkaWN0LldJUklzQXBwbGljYXRpb25Qcm94eUtleS50b0xvd2VyQ2FzZSgpID09PSAndHJ1ZSdcbiAgICA6IGRpY3QuV0lSSXNBcHBsaWNhdGlvblByb3h5S2V5O1xuICBjb25zdCBlbnRyeSA9IHtcbiAgICBpZCxcbiAgICBpc1Byb3h5LFxuICAgIG5hbWU6IGRpY3QuV0lSQXBwbGljYXRpb25OYW1lS2V5LFxuICAgIGJ1bmRsZUlkOiBkaWN0LldJUkFwcGxpY2F0aW9uQnVuZGxlSWRlbnRpZmllcktleSxcbiAgICBob3N0SWQ6IGRpY3QuV0lSSG9zdEFwcGxpY2F0aW9uSWRlbnRpZmllcktleSxcbiAgICBpc0FjdGl2ZTogZGljdC5XSVJJc0FwcGxpY2F0aW9uQWN0aXZlS2V5LFxuICAgIGlzQXV0b21hdGlvbkVuYWJsZWQ6ICEhZGljdC5XSVJSZW1vdGVBdXRvbWF0aW9uRW5hYmxlZEtleSxcbiAgfTtcblxuICByZXR1cm4gW2lkLCBlbnRyeV07XG59XG5cbi8qXG4gKiBUYWtlIGEgZGljdGlvbmFyeSBmcm9tIHRoZSByZW1vdGUgZGVidWdnZXIgYW5kIG1ha2VzIGEgbW9yZSBtYW5hZ2VhYmxlXG4gKiBkaWN0aW9uYXJ5IG9mIHBhZ2VzIGF2YWlsYWJsZS5cbiAqL1xuZnVuY3Rpb24gcGFnZUFycmF5RnJvbURpY3QgKHBhZ2VEaWN0KSB7XG4gIGlmIChwYWdlRGljdC5pZCkge1xuICAgIC8vIHRoZSBwYWdlIGlzIGFscmVhZHkgdHJhbnNsYXRlZCwgc28gd3JhcCBpbiBhbiBhcnJheSBhbmQgcGFzcyBiYWNrXG4gICAgcmV0dXJuIFtwYWdlRGljdF07XG4gIH1cbiAgbGV0IG5ld1BhZ2VBcnJheSA9IFtdO1xuICBmb3IgKGNvbnN0IGRpY3Qgb2YgXy52YWx1ZXMocGFnZURpY3QpKSB7XG4gICAgLy8gY291bnQgb25seSBXSVJUeXBlV2ViIHBhZ2VzIGFuZCBpZ25vcmUgYWxsIG90aGVycyAoV0lSVHlwZUphdmFTY3JpcHQgZXRjKVxuICAgIGlmIChfLmlzVW5kZWZpbmVkKGRpY3QuV0lSVHlwZUtleSkgfHwgZGljdC5XSVJUeXBlS2V5ID09PSAnV0lSVHlwZVdlYicpIHtcbiAgICAgIG5ld1BhZ2VBcnJheS5wdXNoKHtcbiAgICAgICAgaWQ6IGRpY3QuV0lSUGFnZUlkZW50aWZpZXJLZXksXG4gICAgICAgIHRpdGxlOiBkaWN0LldJUlRpdGxlS2V5LFxuICAgICAgICB1cmw6IGRpY3QuV0lSVVJMS2V5LFxuICAgICAgICBpc0tleTogIV8uaXNVbmRlZmluZWQoZGljdC5XSVJDb25uZWN0aW9uSWRlbnRpZmllcktleSksXG4gICAgICB9KTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIG5ld1BhZ2VBcnJheTtcbn1cblxuLypcbiAqIEdpdmVuIGEgYnVuZGxlIGlkLCBmaW5kcyB0aGUgY29ycmVjdCByZW1vdGUgZGVidWdnZXIgYXBwIHRoYXQgaXNcbiAqIGNvbm5lY3RlZC5cbiAqL1xuZnVuY3Rpb24gZ2V0RGVidWdnZXJBcHBLZXkgKGJ1bmRsZUlkLCBwbGF0Zm9ybVZlcnNpb24sIGFwcERpY3QpIHtcbiAgbGV0IGFwcElkO1xuICBpZiAocGFyc2VGbG9hdChwbGF0Zm9ybVZlcnNpb24pID49IDgpIHtcbiAgICBmb3IgKGNvbnN0IFtrZXksIGRhdGFdIG9mIF8udG9QYWlycyhhcHBEaWN0KSkge1xuICAgICAgaWYgKGRhdGEuYnVuZGxlSWQgPT09IGJ1bmRsZUlkKSB7XG4gICAgICAgIGFwcElkID0ga2V5O1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICB9XG4gICAgLy8gbm93IHdlIG5lZWQgdG8gZGV0ZXJtaW5lIGlmIHdlIHNob3VsZCBwaWNrIGEgcHJveHkgZm9yIHRoaXMgaW5zdGVhZFxuICAgIGlmIChhcHBJZCkge1xuICAgICAgbG9nLmRlYnVnKGBGb3VuZCBhcHAgaWQga2V5ICcke2FwcElkfScgZm9yIGJ1bmRsZSAnJHtidW5kbGVJZH0nYCk7XG4gICAgICBsZXQgcHJveGllZEFwcElkcyA9IFtdO1xuICAgICAgZm9yIChjb25zdCBba2V5LCBkYXRhXSBvZiBfLnRvUGFpcnMoYXBwRGljdCkpIHtcbiAgICAgICAgaWYgKGRhdGEuaXNQcm94eSAmJiBkYXRhLmhvc3RJZCA9PT0gYXBwSWQpIHtcbiAgICAgICAgICBsb2cuZGVidWcoYEZvdW5kIHNlcGFyYXRlIGJ1bmRsZUlkICcke2RhdGEuYnVuZGxlSWR9JyBgICtcbiAgICAgICAgICAgICAgICAgICAgYGFjdGluZyBhcyBwcm94eSBmb3IgJyR7YnVuZGxlSWR9Jywgd2l0aCBhcHAgaWQgJyR7a2V5fSdgKTtcbiAgICAgICAgICBwcm94aWVkQXBwSWRzLnB1c2goa2V5KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgaWYgKHByb3hpZWRBcHBJZHMubGVuZ3RoKSB7XG4gICAgICAgIC8vIHVzZSB0aGUgbGFzdCBhcHAgYmVpbmcgcHJveGllZFxuICAgICAgICBhcHBJZCA9IF8ubGFzdChwcm94aWVkQXBwSWRzKTtcbiAgICAgICAgbG9nLmRlYnVnKGBVc2luZyBwcm94aWVkIGFwcCBpZCAnJHthcHBJZH0nYCk7XG4gICAgICB9XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIGlmIChfLmhhcyhhcHBEaWN0LCBidW5kbGVJZCkpIHtcbiAgICAgIGFwcElkID0gYnVuZGxlSWQ7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIGFwcElkO1xufVxuXG5mdW5jdGlvbiBhcHBJZEZvckJ1bmRsZSAoYnVuZGxlSWQsIGFwcERpY3QpIHtcbiAgbGV0IGFwcElkO1xuICBmb3IgKGNvbnN0IFtrZXksIGRhdGFdIG9mIF8udG9QYWlycyhhcHBEaWN0KSkge1xuICAgIGlmIChkYXRhLmJ1bmRsZUlkID09PSBidW5kbGVJZCkge1xuICAgICAgYXBwSWQgPSBrZXk7XG4gICAgICBicmVhaztcbiAgICB9XG4gIH1cblxuICAvLyBpZiBub3RoaW5nIGlzIGZvdW5kLCB0cnkgdG8gZ2V0IHRoZSBnZW5lcmljIGFwcFxuICBpZiAoIWFwcElkICYmIGJ1bmRsZUlkICE9PSBXRUJfQ09OVEVOVF9CVU5ETEVfSUQpIHtcbiAgICByZXR1cm4gYXBwSWRGb3JCdW5kbGUoV0VCX0NPTlRFTlRfQlVORExFX0lELCBhcHBEaWN0KTtcbiAgfVxuXG4gIHJldHVybiBhcHBJZDtcbn1cblxuZnVuY3Rpb24gZ2V0UG9zc2libGVEZWJ1Z2dlckFwcEtleXMgKGJ1bmRsZUlkLCBwbGF0Zm9ybVZlcnNpb24sIGFwcERpY3QpIHtcbiAgbGV0IHByb3hpZWRBcHBJZHMgPSBbXTtcbiAgaWYgKHBhcnNlRmxvYXQocGxhdGZvcm1WZXJzaW9uKSA+PSA4KSB7XG4gICAgY29uc3QgYXBwSWQgPSBhcHBJZEZvckJ1bmRsZShidW5kbGVJZCwgYXBwRGljdCk7XG5cbiAgICAvLyBub3cgd2UgbmVlZCB0byBkZXRlcm1pbmUgaWYgd2Ugc2hvdWxkIHBpY2sgYSBwcm94eSBmb3IgdGhpcyBpbnN0ZWFkXG4gICAgaWYgKGFwcElkKSB7XG4gICAgICBwcm94aWVkQXBwSWRzLnB1c2goYXBwSWQpO1xuICAgICAgbG9nLmRlYnVnKGBGb3VuZCBhcHAgaWQga2V5ICcke2FwcElkfScgZm9yIGJ1bmRsZSAnJHtidW5kbGVJZH0nYCk7XG4gICAgICBmb3IgKGNvbnN0IFtrZXksIGRhdGFdIG9mIF8udG9QYWlycyhhcHBEaWN0KSkge1xuICAgICAgICBpZiAoZGF0YS5pc1Byb3h5ICYmIGRhdGEuaG9zdElkID09PSBhcHBJZCkge1xuICAgICAgICAgIGxvZy5kZWJ1ZyhgRm91bmQgc2VwYXJhdGUgYnVuZGxlSWQgJyR7ZGF0YS5idW5kbGVJZH0nIGAgK1xuICAgICAgICAgICAgICAgICAgICBgYWN0aW5nIGFzIHByb3h5IGZvciAnJHtidW5kbGVJZH0nLCB3aXRoIGFwcCBpZCAnJHtrZXl9J2ApO1xuICAgICAgICAgIHByb3hpZWRBcHBJZHMucHVzaChrZXkpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIGlmIChfLmhhcyhhcHBEaWN0LCBidW5kbGVJZCkpIHtcbiAgICAgIHByb3hpZWRBcHBJZHMgPSBbYnVuZGxlSWRdO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiBwcm94aWVkQXBwSWRzO1xufVxuXG5mdW5jdGlvbiBjaGVja1BhcmFtcyAocGFyYW1zKSB7XG4gIGxldCBlcnJvcnMgPSBbXTtcbiAgZm9yIChjb25zdCBbcGFyYW0sIHZhbHVlXSBvZiBfLnRvUGFpcnMocGFyYW1zKSkge1xuICAgIHRyeSB7XG4gICAgICBhc3NlcnQub2sodmFsdWUpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgZXJyb3JzLnB1c2gocGFyYW0pO1xuICAgIH1cbiAgfVxuICBpZiAoZXJyb3JzLmxlbmd0aCkge1xuICAgIHJldHVybiBlcnJvcnM7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gd3JhcFNjcmlwdEZvckZyYW1lIChzY3JpcHQsIGZyYW1lKSB7XG4gIGxvZy5kZWJ1ZyhgV3JhcHBpbmcgc2NyaXB0IGZvciBmcmFtZSAnJHtmcmFtZX0nYCk7XG4gIGxldCBlbEZyb21DYWNoZSA9IGF3YWl0IGdldEF0b20oJ2dldF9lbGVtZW50X2Zyb21fY2FjaGUnKTtcbiAgcmV0dXJuIGAoZnVuY3Rpb24gKHdpbmRvdykgeyB2YXIgZG9jdW1lbnQgPSB3aW5kb3cuZG9jdW1lbnQ7IGAgK1xuICAgICAgICAgYHJldHVybiAoJHtzY3JpcHR9KTsgfSkoKCR7ZWxGcm9tQ2FjaGUudG9TdHJpbmcoJ3V0ZjgnKX0pKCR7SlNPTi5zdHJpbmdpZnkoZnJhbWUpfSkpYDtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0U2NyaXB0Rm9yQXRvbSAoYXRvbSwgYXJncywgZnJhbWVzLCBhc3luY0NhbGxCYWNrID0gbnVsbCkge1xuICBsZXQgYXRvbVNyYyA9IGF3YWl0IGdldEF0b20oYXRvbSk7XG4gIGxldCBzY3JpcHQ7XG4gIGlmIChmcmFtZXMubGVuZ3RoID4gMCkge1xuICAgIHNjcmlwdCA9IGF0b21TcmM7XG4gICAgZm9yIChjb25zdCBmcmFtZSBvZiBmcmFtZXMpIHtcbiAgICAgIHNjcmlwdCA9IGF3YWl0IHdyYXBTY3JpcHRGb3JGcmFtZShzY3JpcHQsIGZyYW1lKTtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgbG9nLmRlYnVnKGBFeGVjdXRpbmcgJyR7YXRvbX0nIGF0b20gaW4gZGVmYXVsdCBjb250ZXh0YCk7XG4gICAgc2NyaXB0ID0gYCgke2F0b21TcmN9KWA7XG4gIH1cblxuICAvLyBhZGQgdGhlIGFyZ3VtZW50cywgYXMgc3RyaW5nc1xuICBhcmdzID0gYXJncy5tYXAoSlNPTi5zdHJpbmdpZnkpO1xuICBpZiAoYXN5bmNDYWxsQmFjaykge1xuICAgIHNjcmlwdCArPSBgKCR7YXJncy5qb2luKCcsJyl9LCAke2FzeW5jQ2FsbEJhY2t9LCB0cnVlIClgO1xuICB9IGVsc2Uge1xuICAgIHNjcmlwdCArPSBgKCR7YXJncy5qb2luKCcsJyl9KWA7XG4gIH1cblxuICByZXR1cm4gc2NyaXB0O1xufVxuXG5mdW5jdGlvbiBzaW1wbGVTdHJpbmdpZnkgKHZhbHVlKSB7XG4gIGlmICghdmFsdWUpIHtcbiAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkodmFsdWUpO1xuICB9XG5cbiAgLy8gd2UgZ2V0IGJhY2sgb2JqZWN0cyBzb21ldGltZXMgd2l0aCBzdHJpbmcgdmVyc2lvbnMgb2YgZnVuY3Rpb25zXG4gIC8vIHdoaWNoIG11ZGR5IHRoZSBsb2dzXG4gIGxldCBjbGVhblZhbHVlID0gXy5jbG9uZSh2YWx1ZSk7XG4gIGZvciAoY29uc3QgcHJvcGVydHkgb2YgWydjZWlsJywgJ2Nsb25lJywgJ2Zsb29yJywgJ3JvdW5kJywgJ3NjYWxlJywgJ3RvU3RyaW5nJ10pIHtcbiAgICBkZWxldGUgY2xlYW5WYWx1ZVtwcm9wZXJ0eV07XG4gIH1cbiAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KGNsZWFuVmFsdWUpO1xufVxuXG5mdW5jdGlvbiBkZWZlcnJlZFByb21pc2UgKCkge1xuICAvLyBodHRwOi8vYmx1ZWJpcmRqcy5jb20vZG9jcy9hcGkvZGVmZXJyZWQtbWlncmF0aW9uLmh0bWxcbiAgbGV0IHJlc29sdmU7XG4gIGxldCByZWplY3Q7XG4gIGNvbnN0IHByb21pc2UgPSBuZXcgQigocmVzLCByZWopID0+IHsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBwcm9taXNlL3BhcmFtLW5hbWVzXG4gICAgcmVzb2x2ZSA9IHJlcztcbiAgICByZWplY3QgPSByZWo7XG4gIH0pO1xuICByZXR1cm4ge1xuICAgIHByb21pc2UsXG4gICAgcmVzb2x2ZSxcbiAgICByZWplY3RcbiAgfTtcbn1cblxuZXhwb3J0IHtcbiAgYXBwSW5mb0Zyb21EaWN0LCBwYWdlQXJyYXlGcm9tRGljdCwgZ2V0RGVidWdnZXJBcHBLZXksXG4gIGdldFBvc3NpYmxlRGVidWdnZXJBcHBLZXlzLCBjaGVja1BhcmFtcywgd3JhcFNjcmlwdEZvckZyYW1lLCBnZXRTY3JpcHRGb3JBdG9tLFxuICBzaW1wbGVTdHJpbmdpZnksIGRlZmVycmVkUHJvbWlzZSxcbn07XG4iXSwiZmlsZSI6ImxpYi9oZWxwZXJzLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uIn0=
