"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.updateProjectFile = updateProjectFile;
exports.resetProjectFile = resetProjectFile;
exports.checkForDependencies = checkForDependencies;
exports.setRealDeviceSecurity = setRealDeviceSecurity;
exports.fixForXcode7 = fixForXcode7;
exports.fixForXcode9 = fixForXcode9;
exports.generateXcodeConfigFile = generateXcodeConfigFile;
exports.setXctestrunFile = setXctestrunFile;
exports.getXctestrunFilePath = getXctestrunFilePath;
exports.killProcess = killProcess;
exports.randomInt = randomInt;
exports.getWDAUpgradeTimestamp = getWDAUpgradeTimestamp;
exports.WDA_RUNNER_BUNDLE_ID = void 0;

require("source-map-support/register");

var _appiumSupport = require("appium-support");

var _teen_process = require("teen_process");

var _path = _interopRequireDefault(require("path"));

var _logger = _interopRequireDefault(require("../logger"));

var _lodash = _interopRequireDefault(require("lodash"));

const WDA_RUNNER_BUNDLE_ID = 'com.facebook.WebDriverAgentRunner';
exports.WDA_RUNNER_BUNDLE_ID = WDA_RUNNER_BUNDLE_ID;
const PROJECT_FILE = 'project.pbxproj';
const XCUICOORDINATE_FILE = 'PrivateHeaders/XCTest/XCUICoordinate.h';
const FBMACROS_FILE = 'WebDriverAgentLib/Utilities/FBMacros.h';
const XCUIAPPLICATION_FILE = 'PrivateHeaders/XCTest/XCUIApplication.h';
const FBSESSION_FILE = 'WebDriverAgentLib/Routing/FBSession.m';
const CARTHAGE_ROOT = 'Carthage';

async function replaceInFile(file, find, replace) {
  let contents = await _appiumSupport.fs.readFile(file, 'utf8');
  let newContents = contents.replace(find, replace);

  if (newContents !== contents) {
    await _appiumSupport.fs.writeFile(file, newContents, 'utf8');
  }
}

async function updateProjectFile(agentPath, newBundleId) {
  let projectFilePath = `${agentPath}/${PROJECT_FILE}`;

  try {
    await _appiumSupport.fs.copyFile(projectFilePath, `${projectFilePath}.old`);
    await replaceInFile(projectFilePath, new RegExp(WDA_RUNNER_BUNDLE_ID.replace('.', '\.'), 'g'), newBundleId);

    _logger.default.debug(`Successfully updated '${projectFilePath}' with bundle id '${newBundleId}'`);
  } catch (err) {
    _logger.default.debug(`Error updating project file: ${err.message}`);

    _logger.default.warn(`Unable to update project file '${projectFilePath}' with ` + `bundle id '${newBundleId}'. WebDriverAgent may not start`);
  }
}

async function resetProjectFile(agentPath) {
  let projectFilePath = `${agentPath}/${PROJECT_FILE}`;

  try {
    if (!(await _appiumSupport.fs.exists(`${projectFilePath}.old`))) {
      return;
    }

    await _appiumSupport.fs.mv(`${projectFilePath}.old`, projectFilePath);

    _logger.default.debug(`Successfully reset '${projectFilePath}' with bundle id '${WDA_RUNNER_BUNDLE_ID}'`);
  } catch (err) {
    _logger.default.debug(`Error resetting project file: ${err.message}`);

    _logger.default.warn(`Unable to reset project file '${projectFilePath}' with ` + `bundle id '${WDA_RUNNER_BUNDLE_ID}'. WebDriverAgent has been ` + `modified and not returned to the original state.`);
  }
}

async function checkForDependencies(bootstrapPath, useSsl = false) {
  try {
    let carthagePath = await _appiumSupport.fs.which('carthage');

    _logger.default.debug(`Carthage found: '${carthagePath}'`);
  } catch (err) {
    _logger.default.errorAndThrow('Carthage binary is not found. Install using `brew install carthage` if it is not installed ' + 'and make sure the root folder, where carthage binary is installed, is present in PATH environment variable. ' + `The current PATH value: '${process.env.PATH ? process.env.PATH : '<not defined for the Appium process>'}'`);
  }

  const carthageRoot = _path.default.resolve(bootstrapPath, CARTHAGE_ROOT);

  let areDependenciesUpdated = false;

  if (!(await _appiumSupport.fs.hasAccess(carthageRoot))) {
    _logger.default.debug('Running WebDriverAgent bootstrap script to install dependencies');

    try {
      let args = useSsl ? ['-d', '-D'] : ['-d'];
      await (0, _teen_process.exec)('Scripts/bootstrap.sh', args, {
        cwd: bootstrapPath
      });
      areDependenciesUpdated = true;
    } catch (err) {
      for (let std of ['stdout', 'stderr']) {
        for (let line of (err[std] || '').split('\n')) {
          if (!line.length) {
            continue;
          }

          _logger.default.error(line);
        }
      }

      await _appiumSupport.fs.rimraf(carthageRoot);
      throw err;
    }
  }

  if (!(await _appiumSupport.fs.hasAccess(`${bootstrapPath}/Resources`))) {
    _logger.default.debug('Creating WebDriverAgent resources directory');

    await _appiumSupport.fs.mkdir(`${bootstrapPath}/Resources`);
    areDependenciesUpdated = true;
  }

  if (!(await _appiumSupport.fs.hasAccess(`${bootstrapPath}/Resources/WebDriverAgent.bundle`))) {
    _logger.default.debug('Creating WebDriverAgent resource bundle directory');

    await _appiumSupport.fs.mkdir(`${bootstrapPath}/Resources/WebDriverAgent.bundle`);
    areDependenciesUpdated = true;
  }

  return areDependenciesUpdated;
}

async function setRealDeviceSecurity(keychainPath, keychainPassword) {
  _logger.default.debug('Setting security for iOS device');

  await (0, _teen_process.exec)('security', ['-v', 'list-keychains', '-s', keychainPath]);
  await (0, _teen_process.exec)('security', ['-v', 'unlock-keychain', '-p', keychainPassword, keychainPath]);
  await (0, _teen_process.exec)('security', ['set-keychain-settings', '-t', '3600', '-l', keychainPath]);
}

async function fixXCUICoordinateFile(bootstrapPath, initial = true) {
  const file = _path.default.resolve(bootstrapPath, XCUICOORDINATE_FILE);

  let oldDef = '- (void)pressForDuration:(double)arg1 thenDragToCoordinate:(id)arg2;';
  let newDef = '- (void)pressForDuration:(NSTimeInterval)duration thenDragToCoordinate:(XCUICoordinate *)otherCoordinate;';

  if (!initial) {
    [oldDef, newDef] = [newDef, oldDef];
  }

  await replaceInFile(file, oldDef, newDef);
}

async function fixFBSessionFile(bootstrapPath, initial = true) {
  const file = _path.default.resolve(bootstrapPath, FBSESSION_FILE);

  let oldLine = 'return [FBApplication fb_activeApplication] ?: self.testedApplication;';
  let newLine = 'FBApplication *application = [FBApplication fb_activeApplication] ?: self.testedApplication;\n' + '  return application;';

  if (!initial) {
    [oldLine, newLine] = [newLine, oldLine];
  }

  await replaceInFile(file, oldLine, newLine);
}

async function fixForXcode7(bootstrapPath, initial = true, fixXcode9 = true) {
  if (fixXcode9) {
    await fixForXcode9(bootstrapPath, !initial, false);
  }

  await fixXCUICoordinateFile(bootstrapPath, initial);
  await fixFBSessionFile(bootstrapPath, initial);
}

async function fixFBMacrosFile(bootstrapPath, initial = true) {
  const file = _path.default.resolve(bootstrapPath, FBMACROS_FILE);

  let oldDef = '#define FBStringify(class, property) ({if(NO){[class.new property];} @#property;})';
  let newDef = '#define FBStringify(class, property) ({@#property;})';

  if (!initial) {
    [oldDef, newDef] = [newDef, oldDef];
  }

  await replaceInFile(file, oldDef, newDef);
}

async function fixXCUIApplicationFile(bootstrapPath, initial = true) {
  const file = _path.default.resolve(bootstrapPath, XCUIAPPLICATION_FILE);

  let oldDef = '@property(nonatomic, readonly) NSUInteger state; // @synthesize state=_state;';
  let newDef = '@property XCUIApplicationState state;';

  if (!initial) {
    [oldDef, newDef] = [newDef, oldDef];
  }

  await replaceInFile(file, oldDef, newDef);
}

async function fixForXcode9(bootstrapPath, initial = true, fixXcode7 = true) {
  if (fixXcode7) {
    await fixForXcode7(bootstrapPath, !initial, false);
  }

  await fixFBMacrosFile(bootstrapPath, initial);
  await fixXCUIApplicationFile(bootstrapPath, initial);
}

async function generateXcodeConfigFile(orgId, signingId) {
  _logger.default.debug(`Generating xcode config file for orgId '${orgId}' and signingId ` + `'${signingId}'`);

  let contents = `DEVELOPMENT_TEAM = ${orgId}
CODE_SIGN_IDENTITY = ${signingId}
`;
  let xcconfigPath = await _appiumSupport.tempDir.path('appium-temp.xcconfig');

  _logger.default.debug(`Writing xcode config file to ${xcconfigPath}`);

  await _appiumSupport.fs.writeFile(xcconfigPath, contents, 'utf8');
  return xcconfigPath;
}

async function setXctestrunFile(deviceInfo, sdkVersion, bootstrapPath, wdaRemotePort) {
  const xctestrunFilePath = await getXctestrunFilePath(deviceInfo, sdkVersion, bootstrapPath);
  const xctestRunContent = await _appiumSupport.plist.parsePlistFile(xctestrunFilePath);
  const updateWDAPort = {
    WebDriverAgentRunner: {
      EnvironmentVariables: {
        USE_PORT: wdaRemotePort
      }
    }
  };

  const newXctestRunContent = _lodash.default.merge(xctestRunContent, updateWDAPort);

  await _appiumSupport.plist.updatePlistFile(xctestrunFilePath, newXctestRunContent, true);
  return xctestrunFilePath;
}

async function getXctestrunFilePath(deviceInfo, sdkVersion, bootstrapPath) {
  const sdkBased = [_path.default.resolve(bootstrapPath, `${deviceInfo.udid}_${sdkVersion}.xctestrun`), sdkVersion];
  const platformBased = [_path.default.resolve(bootstrapPath, `${deviceInfo.udid}_${deviceInfo.platformVersion}.xctestrun`), deviceInfo.platformVersion];

  for (const [filePath, version] of [sdkBased, platformBased]) {
    if (await _appiumSupport.fs.exists(filePath)) {
      return filePath;
    }

    const originalXctestrunFile = _path.default.resolve(bootstrapPath, getXctestrunFilePathName(deviceInfo.isRealDevice, version));

    if (await _appiumSupport.fs.exists(originalXctestrunFile)) {
      await _appiumSupport.fs.copyFile(originalXctestrunFile, filePath);
      return filePath;
    }
  }

  _logger.default.errorAndThrow(`If you are using 'useXctestrunFile' capability then you ` + `need to have a xctestrun file (expected: ` + `'${_path.default.resolve(bootstrapPath, getXctestrunFilePathName(deviceInfo.isRealDevice, sdkVersion))}')`);
}

function getXctestrunFilePathName(isRealDevice, version) {
  return `WebDriverAgentRunner_iphone${isRealDevice ? `os${version}-arm64` : `simulator${version}-x86_64`}.xctestrun`;
}

async function killProcess(name, proc) {
  if (proc && proc.proc) {
    _logger.default.info(`Shutting down ${name} process (pid ${proc.proc.pid})`);

    try {
      await proc.stop('SIGTERM', 1000);
    } catch (err) {
      if (!err.message.includes(`Process didn't end after`)) {
        throw err;
      }

      _logger.default.debug(`${name} process did not end in a timely fashion: '${err.message}'. ` + `Sending 'SIGKILL'...`);

      try {
        await proc.stop('SIGKILL');
      } catch (err) {
        if (err.message.includes('not currently running')) {
          return;
        }

        throw err;
      }
    }
  }
}

function randomInt(low, high) {
  return Math.floor(Math.random() * (high - low) + low);
}

async function getWDAUpgradeTimestamp(bootstrapPath) {
  const carthageRootPath = _path.default.resolve(bootstrapPath, CARTHAGE_ROOT);

  if (await _appiumSupport.fs.exists(carthageRootPath)) {
    const {
      mtime
    } = await _appiumSupport.fs.stat(carthageRootPath);
    return mtime.getTime();
  }

  return null;
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi93ZGEvdXRpbHMuanMiXSwibmFtZXMiOlsiV0RBX1JVTk5FUl9CVU5ETEVfSUQiLCJQUk9KRUNUX0ZJTEUiLCJYQ1VJQ09PUkRJTkFURV9GSUxFIiwiRkJNQUNST1NfRklMRSIsIlhDVUlBUFBMSUNBVElPTl9GSUxFIiwiRkJTRVNTSU9OX0ZJTEUiLCJDQVJUSEFHRV9ST09UIiwicmVwbGFjZUluRmlsZSIsImZpbGUiLCJmaW5kIiwicmVwbGFjZSIsImNvbnRlbnRzIiwiZnMiLCJyZWFkRmlsZSIsIm5ld0NvbnRlbnRzIiwid3JpdGVGaWxlIiwidXBkYXRlUHJvamVjdEZpbGUiLCJhZ2VudFBhdGgiLCJuZXdCdW5kbGVJZCIsInByb2plY3RGaWxlUGF0aCIsImNvcHlGaWxlIiwiUmVnRXhwIiwibG9nIiwiZGVidWciLCJlcnIiLCJtZXNzYWdlIiwid2FybiIsInJlc2V0UHJvamVjdEZpbGUiLCJleGlzdHMiLCJtdiIsImNoZWNrRm9yRGVwZW5kZW5jaWVzIiwiYm9vdHN0cmFwUGF0aCIsInVzZVNzbCIsImNhcnRoYWdlUGF0aCIsIndoaWNoIiwiZXJyb3JBbmRUaHJvdyIsInByb2Nlc3MiLCJlbnYiLCJQQVRIIiwiY2FydGhhZ2VSb290IiwicGF0aCIsInJlc29sdmUiLCJhcmVEZXBlbmRlbmNpZXNVcGRhdGVkIiwiaGFzQWNjZXNzIiwiYXJncyIsImN3ZCIsInN0ZCIsImxpbmUiLCJzcGxpdCIsImxlbmd0aCIsImVycm9yIiwicmltcmFmIiwibWtkaXIiLCJzZXRSZWFsRGV2aWNlU2VjdXJpdHkiLCJrZXljaGFpblBhdGgiLCJrZXljaGFpblBhc3N3b3JkIiwiZml4WENVSUNvb3JkaW5hdGVGaWxlIiwiaW5pdGlhbCIsIm9sZERlZiIsIm5ld0RlZiIsImZpeEZCU2Vzc2lvbkZpbGUiLCJvbGRMaW5lIiwibmV3TGluZSIsImZpeEZvclhjb2RlNyIsImZpeFhjb2RlOSIsImZpeEZvclhjb2RlOSIsImZpeEZCTWFjcm9zRmlsZSIsImZpeFhDVUlBcHBsaWNhdGlvbkZpbGUiLCJmaXhYY29kZTciLCJnZW5lcmF0ZVhjb2RlQ29uZmlnRmlsZSIsIm9yZ0lkIiwic2lnbmluZ0lkIiwieGNjb25maWdQYXRoIiwidGVtcERpciIsInNldFhjdGVzdHJ1bkZpbGUiLCJkZXZpY2VJbmZvIiwic2RrVmVyc2lvbiIsIndkYVJlbW90ZVBvcnQiLCJ4Y3Rlc3RydW5GaWxlUGF0aCIsImdldFhjdGVzdHJ1bkZpbGVQYXRoIiwieGN0ZXN0UnVuQ29udGVudCIsInBsaXN0IiwicGFyc2VQbGlzdEZpbGUiLCJ1cGRhdGVXREFQb3J0IiwiV2ViRHJpdmVyQWdlbnRSdW5uZXIiLCJFbnZpcm9ubWVudFZhcmlhYmxlcyIsIlVTRV9QT1JUIiwibmV3WGN0ZXN0UnVuQ29udGVudCIsIl8iLCJtZXJnZSIsInVwZGF0ZVBsaXN0RmlsZSIsInNka0Jhc2VkIiwidWRpZCIsInBsYXRmb3JtQmFzZWQiLCJwbGF0Zm9ybVZlcnNpb24iLCJmaWxlUGF0aCIsInZlcnNpb24iLCJvcmlnaW5hbFhjdGVzdHJ1bkZpbGUiLCJnZXRYY3Rlc3RydW5GaWxlUGF0aE5hbWUiLCJpc1JlYWxEZXZpY2UiLCJraWxsUHJvY2VzcyIsIm5hbWUiLCJwcm9jIiwiaW5mbyIsInBpZCIsInN0b3AiLCJpbmNsdWRlcyIsInJhbmRvbUludCIsImxvdyIsImhpZ2giLCJNYXRoIiwiZmxvb3IiLCJyYW5kb20iLCJnZXRXREFVcGdyYWRlVGltZXN0YW1wIiwiY2FydGhhZ2VSb290UGF0aCIsIm10aW1lIiwic3RhdCIsImdldFRpbWUiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUEsTUFBTUEsb0JBQW9CLEdBQUcsbUNBQTdCOztBQUNBLE1BQU1DLFlBQVksR0FBRyxpQkFBckI7QUFDQSxNQUFNQyxtQkFBbUIsR0FBRyx3Q0FBNUI7QUFDQSxNQUFNQyxhQUFhLEdBQUcsd0NBQXRCO0FBQ0EsTUFBTUMsb0JBQW9CLEdBQUcseUNBQTdCO0FB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T0FBTixFQUFQO0FBQ0Q7O0FBQ0QsU0FBTyxJQUFQO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBmcywgdGVtcERpciwgcGxpc3QgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgeyBleGVjIH0gZnJvbSAndGVlbl9wcm9jZXNzJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IGxvZyBmcm9tICcuLi9sb2dnZXInO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcblxuY29uc3QgV0RBX1JVTk5FUl9CVU5ETEVfSUQgPSAnY29tLmZhY2Vib29rLldlYkRyaXZlckFnZW50UnVubmVyJztcbmNvbnN0IFBST0pFQ1RfRklMRSA9ICdwcm9qZWN0LnBieHByb2onO1xuY29uc3QgWENVSUNPT1JESU5BVEVfRklMRSA9ICdQcml2YXRlSGVhZGVycy9YQ1Rlc3QvWENVSUNvb3JkaW5hdGUuaCc7XG5jb25zdCBGQk1BQ1JPU19GSUxFID0gJ1dlYkRyaXZlckFnZW50TGliL1V0aWxpdGllcy9GQk1hY3Jvcy5oJztcbmNvbnN0IFhDVUlBUFBMSUNBVElPTl9GSUxFID0gJ1ByaXZhdGVIZWFkZXJzL1hDVGVzdC9YQ1VJQXBwbGljYXRpb24uaCc7XG5jb25zdCBGQlNFU1NJT05fRklMRSA9ICdXZWJEcml2ZXJBZ2VudExpYi9Sb3V0aW5nL0ZCU2Vzc2lvbi5tJztcbmNvbnN0IENBUlRIQUdFX1JPT1QgPSAnQ2FydGhhZ2UnO1xuXG5hc3luYyBmdW5jdGlvbiByZXBsYWNlSW5GaWxlIChmaWxlLCBmaW5kLCByZXBsYWNlKSB7XG4gIGxldCBjb250ZW50cyA9IGF3YWl0IGZzLnJlYWRGaWxlKGZpbGUsICd1dGY4Jyk7XG5cbiAgbGV0IG5ld0NvbnRlbnRzID0gY29udGVudHMucmVwbGFjZShmaW5kLCByZXBsYWNlKTtcbiAgaWYgKG5ld0NvbnRlbnRzICE9PSBjb250ZW50cykge1xuICAgIGF3YWl0IGZzLndyaXRlRmlsZShmaWxlLCBuZXdDb250ZW50cywgJ3V0ZjgnKTtcbiAgfVxufVxuXG4vKipcbiAqIFVwZGF0ZSBXZWJEcml2ZXJBZ2VudFJ1bm5lciBwcm9qZWN0IGJ1bmRsZSBJRCB3aXRoIG5ld0J1bmRsZUlkLlxuICogVGhpcyBtZXRob2QgYXNzdW1lcyBwcm9qZWN0IGZpbGUgaXMgaW4gdGhlIGNvcnJlY3Qgc3RhdGUuXG4gKiBAcGFyYW0ge3N0cmluZ30gYWdlbnRQYXRoIC0gUGF0aCB0byB0aGUgLnhjb2RlcHJvaiBkaXJlY3RvcnkuXG4gKiBAcGFyYW0ge3N0cmluZ30gbmV3QnVuZGxlSWQgdGhlIG5ldyBidW5kbGUgSUQgdXNlZCB0byB1cGRhdGUuXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIHVwZGF0ZVByb2plY3RGaWxlIChhZ2VudFBhdGgsIG5ld0J1bmRsZUlkKSB7XG4gIGxldCBwcm9qZWN0RmlsZVBhdGggPSBgJHthZ2VudFBhdGh9LyR7UFJPSkVDVF9GSUxFfWA7XG4gIHRyeSB7XG4gICAgLy8gQXNzdW1pbmcgcHJvamVjdEZpbGVQYXRoIGlzIGluIHRoZSBjb3JyZWN0IHN0YXRlLCBjcmVhdGUgLm9sZCBmcm9tIHByb2plY3RGaWxlUGF0aFxuICAgIGF3YWl0IGZzLmNvcHlGaWxlKHByb2plY3RGaWxlUGF0aCwgYCR7cHJvamVjdEZpbGVQYXRofS5vbGRgKTtcbiAgICBhd2FpdCByZXBsYWNlSW5GaWxlKHByb2plY3RGaWxlUGF0aCwgbmV3IFJlZ0V4cChXREFfUlVOTkVSX0JVTkRMRV9JRC5yZXBsYWNlKCcuJywgJ1xcLicpLCAnZycpLCBuZXdCdW5kbGVJZCk7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgbm8tdXNlbGVzcy1lc2NhcGVcbiAgICBsb2cuZGVidWcoYFN1Y2Nlc3NmdWxseSB1cGRhdGVkICcke3Byb2plY3RGaWxlUGF0aH0nIHdpdGggYnVuZGxlIGlkICcke25ld0J1bmRsZUlkfSdgKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgbG9nLmRlYnVnKGBFcnJvciB1cGRhdGluZyBwcm9qZWN0IGZpbGU6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gICAgbG9nLndhcm4oYFVuYWJsZSB0byB1cGRhdGUgcHJvamVjdCBmaWxlICcke3Byb2plY3RGaWxlUGF0aH0nIHdpdGggYCArXG4gICAgICAgICAgICAgYGJ1bmRsZSBpZCAnJHtuZXdCdW5kbGVJZH0nLiBXZWJEcml2ZXJBZ2VudCBtYXkgbm90IHN0YXJ0YCk7XG4gIH1cbn1cblxuLyoqXG4gKiBSZXNldCBXZWJEcml2ZXJBZ2VudFJ1bm5lciBwcm9qZWN0IGJ1bmRsZSBJRCB0byBjb3JyZWN0IHN0YXRlLlxuICogQHBhcmFtIHtzdHJpbmd9IGFnZW50UGF0aCAtIFBhdGggdG8gdGhlIC54Y29kZXByb2ogZGlyZWN0b3J5LlxuICovXG5hc3luYyBmdW5jdGlvbiByZXNldFByb2plY3RGaWxlIChhZ2VudFBhdGgpIHtcbiAgbGV0IHByb2plY3RGaWxlUGF0aCA9IGAke2FnZW50UGF0aH0vJHtQUk9KRUNUX0ZJTEV9YDtcbiAgdHJ5IHtcbiAgICAvLyByZXN0b3JlIHByb2plY3RGaWxlUGF0aCBmcm9tIC5vbGQgZmlsZVxuICAgIGlmICghYXdhaXQgZnMuZXhpc3RzKGAke3Byb2plY3RGaWxlUGF0aH0ub2xkYCkpIHtcbiAgICAgIHJldHVybjsgLy8gbm8gbmVlZCB0byByZXNldFxuICAgIH1cbiAgICBhd2FpdCBmcy5tdihgJHtwcm9qZWN0RmlsZVBhdGh9Lm9sZGAsIHByb2plY3RGaWxlUGF0aCk7XG4gICAgbG9nLmRlYnVnKGBTdWNjZXNzZnVsbHkgcmVzZXQgJyR7cHJvamVjdEZpbGVQYXRofScgd2l0aCBidW5kbGUgaWQgJyR7V0RBX1JVTk5FUl9CVU5ETEVfSUR9J2ApO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsb2cuZGVidWcoYEVycm9yIHJlc2V0dGluZyBwcm9qZWN0IGZpbGU6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gICAgbG9nLndhcm4oYFVuYWJsZSB0byByZXNldCBwcm9qZWN0IGZpbGUgJyR7cHJvamVjdEZpbGVQYXRofScgd2l0aCBgICtcbiAgICAgICAgICAgICBgYnVuZGxlIGlkICcke1dEQV9SVU5ORVJfQlVORExFX0lEfScuIFdlYkRyaXZlckFnZW50IGhhcyBiZWVuIGAgK1xuICAgICAgICAgICAgIGBtb2RpZmllZCBhbmQgbm90IHJldHVybmVkIHRvIHRoZSBvcmlnaW5hbCBzdGF0ZS5gKTtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBjaGVja0ZvckRlcGVuZGVuY2llcyAoYm9vdHN0cmFwUGF0aCwgdXNlU3NsID0gZmFsc2UpIHtcbiAgdHJ5IHtcbiAgICBsZXQgY2FydGhhZ2VQYXRoID0gYXdhaXQgZnMud2hpY2goJ2NhcnRoYWdlJyk7XG4gICAgbG9nLmRlYnVnKGBDYXJ0aGFnZSBmb3VuZDogJyR7Y2FydGhhZ2VQYXRofSdgKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coJ0NhcnRoYWdlIGJpbmFyeSBpcyBub3QgZm91bmQuIEluc3RhbGwgdXNpbmcgYGJyZXcgaW5zdGFsbCBjYXJ0aGFnZWAgaWYgaXQgaXMgbm90IGluc3RhbGxlZCAnICtcbiAgICAgICdhbmQgbWFrZSBzdXJlIHRoZSByb290IGZvbGRlciwgd2hlcmUgY2FydGhhZ2UgYmluYXJ5IGlzIGluc3RhbGxlZCwgaXMgcHJlc2VudCBpbiBQQVRIIGVudmlyb25tZW50IHZhcmlhYmxlLiAnICtcbiAgICAgIGBUaGUgY3VycmVudCBQQVRIIHZhbHVlOiAnJHtwcm9jZXNzLmVudi5QQVRIID8gcHJvY2Vzcy5lbnYuUEFUSCA6ICc8bm90IGRlZmluZWQgZm9yIHRoZSBBcHBpdW0gcHJvY2Vzcz4nfSdgKTtcbiAgfVxuICBjb25zdCBjYXJ0aGFnZVJvb3QgPSBwYXRoLnJlc29sdmUoYm9vdHN0cmFwUGF0aCwgQ0FSVEhBR0VfUk9PVCk7XG4gIGxldCBhcmVEZXBlbmRlbmNpZXNVcGRhdGVkID0gZmFsc2U7XG4gIGlmICghYXdhaXQgZnMuaGFzQWNjZXNzKGNhcnRoYWdlUm9vdCkpIHtcbiAgICBsb2cuZGVidWcoJ1J1bm5pbmcgV2ViRHJpdmVyQWdlbnQgYm9vdHN0cmFwIHNjcmlwdCB0byBpbnN0YWxsIGRlcGVuZGVuY2llcycpO1xuICAgIHRyeSB7XG4gICAgICBsZXQgYXJncyA9IHVzZVNzbCA/IFsnLWQnLCAnLUQnXSA6IFsnLWQnXTtcbiAgICAgIGF3YWl0IGV4ZWMoJ1NjcmlwdHMvYm9vdHN0cmFwLnNoJywgYXJncywge2N3ZDogYm9vdHN0cmFwUGF0aH0pO1xuICAgICAgYXJlRGVwZW5kZW5jaWVzVXBkYXRlZCA9IHRydWU7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAvLyBwcmludCBvdXQgdGhlIHN0ZG91dCBhbmQgc3RkZXJyIHJlcG9ydHNcbiAgICAgIGZvciAobGV0IHN0ZCBvZiBbJ3N0ZG91dCcsICdzdGRlcnInXSkge1xuICAgICAgICBmb3IgKGxldCBsaW5lIG9mIChlcnJbc3RkXSB8fCAnJykuc3BsaXQoJ1xcbicpKSB7XG4gICAgICAgICAgaWYgKCFsaW5lLmxlbmd0aCkge1xuICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgfVxuICAgICAgICAgIGxvZy5lcnJvcihsaW5lKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgLy8gcmVtb3ZlIHRoZSBjYXJ0aGFnZSBkaXJlY3RvcnksIG9yIGVsc2Ugc3Vic2VxdWVudCBydW5zIHdpbGwgc2VlIGl0IGFuZFxuICAgICAgLy8gYXNzdW1lIHRoZSBkZXBlbmRlbmNpZXMgYXJlIGFscmVhZHkgZG93bmxvYWRlZFxuICAgICAgYXdhaXQgZnMucmltcmFmKGNhcnRoYWdlUm9vdCk7XG5cbiAgICAgIHRocm93IGVycjtcbiAgICB9XG4gIH1cbiAgaWYgKCFhd2FpdCBmcy5oYXNBY2Nlc3MoYCR7Ym9vdHN0cmFwUGF0aH0vUmVzb3VyY2VzYCkpIHtcbiAgICBsb2cuZGVidWcoJ0NyZWF0aW5nIFdlYkRyaXZlckFnZW50IHJlc291cmNlcyBkaXJlY3RvcnknKTtcbiAgICBhd2FpdCBmcy5ta2RpcihgJHtib290c3RyYXBQYXRofS9SZXNvdXJjZXNgKTtcbiAgICBhcmVEZXBlbmRlbmNpZXNVcGRhdGVkID0gdHJ1ZTtcbiAgfVxuICBpZiAoIWF3YWl0IGZzLmhhc0FjY2VzcyhgJHtib290c3RyYXBQYXRofS9SZXNvdXJjZXMvV2ViRHJpdmVyQWdlbnQuYnVuZGxlYCkpIHtcbiAgICBsb2cuZGVidWcoJ0NyZWF0aW5nIFdlYkRyaXZlckFnZW50IHJlc291cmNlIGJ1bmRsZSBkaXJlY3RvcnknKTtcbiAgICBhd2FpdCBmcy5ta2RpcihgJHtib290c3RyYXBQYXRofS9SZXNvdXJjZXMvV2ViRHJpdmVyQWdlbnQuYnVuZGxlYCk7XG4gICAgYXJlRGVwZW5kZW5jaWVzVXBkYXRlZCA9IHRydWU7XG4gIH1cbiAgcmV0dXJuIGFyZURlcGVuZGVuY2llc1VwZGF0ZWQ7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHNldFJlYWxEZXZpY2VTZWN1cml0eSAoa2V5Y2hhaW5QYXRoLCBrZXljaGFpblBhc3N3b3JkKSB7XG4gIGxvZy5kZWJ1ZygnU2V0dGluZyBzZWN1cml0eSBmb3IgaU9TIGRldmljZScpO1xuICBhd2FpdCBleGVjKCdzZWN1cml0eScsIFsnLXYnLCAnbGlzdC1rZXljaGFpbnMnLCAnLXMnLCBrZXljaGFpblBhdGhdKTtcbiAgYXdhaXQgZXhlYygnc2VjdXJpdHknLCBbJy12JywgJ3VubG9jay1rZXljaGFpbicsICctcCcsIGtleWNoYWluUGFzc3dvcmQsIGtleWNoYWluUGF0aF0pO1xuICBhd2FpdCBleGVjKCdzZWN1cml0eScsIFsnc2V0LWtleWNoYWluLXNldHRpbmdzJywgJy10JywgJzM2MDAnLCAnLWwnLCBrZXljaGFpblBhdGhdKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZml4WENVSUNvb3JkaW5hdGVGaWxlIChib290c3RyYXBQYXRoLCBpbml0aWFsID0gdHJ1ZSkge1xuICAvLyB0aGUgd2F5IHRoZSB1cGRhdGVkIFhDVGVzdCBoZWFkZXJzIGFyZSBpbiB0aGUgV0RBIHByb2plY3QsIGJ1aWxkaW5nIGluXG4gIC8vIFhjb2RlIDguMCBjYXVzZXMgYSBkdXBsaWNhdGUgZGVjbGFyYXRpb24gb2YgbWV0aG9kXG4gIC8vIHNvIGZpeCB0aGUgb2ZmZW5kaW5nIGxpbmUgaW4gdGhlIGxvY2FsIGhlYWRlcnNcbiAgY29uc3QgZmlsZSA9IHBhdGgucmVzb2x2ZShib290c3RyYXBQYXRoLCBYQ1VJQ09PUkRJTkFURV9GSUxFKTtcblxuICBsZXQgb2xkRGVmID0gJy0gKHZvaWQpcHJlc3NGb3JEdXJhdGlvbjooZG91YmxlKWFyZzEgdGhlbkRyYWdUb0Nvb3JkaW5hdGU6KGlkKWFyZzI7JztcbiAgbGV0IG5ld0RlZiA9ICctICh2b2lkKXByZXNzRm9yRHVyYXRpb246KE5TVGltZUludGVydmFsKWR1cmF0aW9uIHRoZW5EcmFnVG9Db29yZGluYXRlOihYQ1VJQ29vcmRpbmF0ZSAqKW90aGVyQ29vcmRpbmF0ZTsnO1xuICBpZiAoIWluaXRpYWwpIHtcbiAgICBbb2xkRGVmLCBuZXdEZWZdID0gW25ld0RlZiwgb2xkRGVmXTtcbiAgfVxuICBhd2FpdCByZXBsYWNlSW5GaWxlKGZpbGUsIG9sZERlZiwgbmV3RGVmKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZml4RkJTZXNzaW9uRmlsZSAoYm9vdHN0cmFwUGF0aCwgaW5pdGlhbCA9IHRydWUpIHtcbiAgY29uc3QgZmlsZSA9IHBhdGgucmVzb2x2ZShib290c3RyYXBQYXRoLCBGQlNFU1NJT05fRklMRSk7XG5cbiAgbGV0IG9sZExpbmUgPSAncmV0dXJuIFtGQkFwcGxpY2F0aW9uIGZiX2FjdGl2ZUFwcGxpY2F0aW9uXSA/OiBzZWxmLnRlc3RlZEFwcGxpY2F0aW9uOyc7XG4gIGxldCBuZXdMaW5lID0gJ0ZCQXBwbGljYXRpb24gKmFwcGxpY2F0aW9uID0gW0ZCQXBwbGljYXRpb24gZmJfYWN0aXZlQXBwbGljYXRpb25dID86IHNlbGYudGVzdGVkQXBwbGljYXRpb247XFxuJyArXG4gICAgICAgICAgICAgICAgJyAgcmV0dXJuIGFwcGxpY2F0aW9uOyc7XG4gIGlmICghaW5pdGlhbCkge1xuICAgIFtvbGRMaW5lLCBuZXdMaW5lXSA9IFtuZXdMaW5lLCBvbGRMaW5lXTtcbiAgfVxuICBhd2FpdCByZXBsYWNlSW5GaWxlKGZpbGUsIG9sZExpbmUsIG5ld0xpbmUpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBmaXhGb3JYY29kZTcgKGJvb3RzdHJhcFBhdGgsIGluaXRpYWwgPSB0cnVlLCBmaXhYY29kZTkgPSB0cnVlKSB7XG4gIGlmIChmaXhYY29kZTkpIHtcbiAgICBhd2FpdCBmaXhGb3JYY29kZTkoYm9vdHN0cmFwUGF0aCwgIWluaXRpYWwsIGZhbHNlKTtcbiAgfVxuICBhd2FpdCBmaXhYQ1VJQ29vcmRpbmF0ZUZpbGUoYm9vdHN0cmFwUGF0aCwgaW5pdGlhbCk7XG4gIGF3YWl0IGZpeEZCU2Vzc2lvbkZpbGUoYm9vdHN0cmFwUGF0aCwgaW5pdGlhbCk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGZpeEZCTWFjcm9zRmlsZSAoYm9vdHN0cmFwUGF0aCwgaW5pdGlhbCA9IHRydWUpIHtcbiAgY29uc3QgZmlsZSA9IHBhdGgucmVzb2x2ZShib290c3RyYXBQYXRoLCBGQk1BQ1JPU19GSUxFKTtcblxuICBsZXQgb2xkRGVmID0gJyNkZWZpbmUgRkJTdHJpbmdpZnkoY2xhc3MsIHByb3BlcnR5KSAoe2lmKE5PKXtbY2xhc3MubmV3IHByb3BlcnR5XTt9IEAjcHJvcGVydHk7fSknO1xuICBsZXQgbmV3RGVmID0gJyNkZWZpbmUgRkJTdHJpbmdpZnkoY2xhc3MsIHByb3BlcnR5KSAoe0AjcHJvcGVydHk7fSknO1xuICBpZiAoIWluaXRpYWwpIHtcbiAgICBbb2xkRGVmLCBuZXdEZWZdID0gW25ld0RlZiwgb2xkRGVmXTtcbiAgfVxuICBhd2FpdCByZXBsYWNlSW5GaWxlKGZpbGUsIG9sZERlZiwgbmV3RGVmKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZml4WENVSUFwcGxpY2F0aW9uRmlsZSAoYm9vdHN0cmFwUGF0aCwgaW5pdGlhbCA9IHRydWUpIHtcbiAgY29uc3QgZmlsZSA9IHBhdGgucmVzb2x2ZShib290c3RyYXBQYXRoLCBYQ1VJQVBQTElDQVRJT05fRklMRSk7XG5cbiAgbGV0IG9sZERlZiA9ICdAcHJvcGVydHkobm9uYXRvbWljLCByZWFkb25seSkgTlNVSW50ZWdlciBzdGF0ZTsgLy8gQHN5bnRoZXNpemUgc3RhdGU9X3N0YXRlOyc7XG4gIGxldCBuZXdEZWYgPSAnQHByb3BlcnR5IFhDVUlBcHBsaWNhdGlvblN0YXRlIHN0YXRlOyc7XG4gIGlmICghaW5pdGlhbCkge1xuICAgIFtvbGREZWYsIG5ld0RlZl0gPSBbbmV3RGVmLCBvbGREZWZdO1xuICB9XG4gIGF3YWl0IHJlcGxhY2VJbkZpbGUoZmlsZSwgb2xkRGVmLCBuZXdEZWYpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBmaXhGb3JYY29kZTkgKGJvb3RzdHJhcFBhdGgsIGluaXRpYWwgPSB0cnVlLCBmaXhYY29kZTcgPSB0cnVlKSB7XG4gIGlmIChmaXhYY29kZTcpIHtcbiAgICBhd2FpdCBmaXhGb3JYY29kZTcoYm9vdHN0cmFwUGF0aCwgIWluaXRpYWwsIGZhbHNlKTtcbiAgfVxuICBhd2FpdCBmaXhGQk1hY3Jvc0ZpbGUoYm9vdHN0cmFwUGF0aCwgaW5pdGlhbCk7XG4gIGF3YWl0IGZpeFhDVUlBcHBsaWNhdGlvbkZpbGUoYm9vdHN0cmFwUGF0aCwgaW5pdGlhbCk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdlbmVyYXRlWGNvZGVDb25maWdGaWxlIChvcmdJZCwgc2lnbmluZ0lkKSB7XG4gIGxvZy5kZWJ1ZyhgR2VuZXJhdGluZyB4Y29kZSBjb25maWcgZmlsZSBmb3Igb3JnSWQgJyR7b3JnSWR9JyBhbmQgc2lnbmluZ0lkIGAgK1xuICAgICAgICAgICAgYCcke3NpZ25pbmdJZH0nYCk7XG4gIGxldCBjb250ZW50cyA9IGBERVZFTE9QTUVOVF9URUFNID0gJHtvcmdJZH1cbkNPREVfU0lHTl9JREVOVElUWSA9ICR7c2lnbmluZ0lkfVxuYDtcbiAgbGV0IHhjY29uZmlnUGF0aCA9IGF3YWl0IHRlbXBEaXIucGF0aCgnYXBwaXVtLXRlbXAueGNjb25maWcnKTtcbiAgbG9nLmRlYnVnKGBXcml0aW5nIHhjb2RlIGNvbmZpZyBmaWxlIHRvICR7eGNjb25maWdQYXRofWApO1xuICBhd2FpdCBmcy53cml0ZUZpbGUoeGNjb25maWdQYXRoLCBjb250ZW50cywgJ3V0ZjgnKTtcbiAgcmV0dXJuIHhjY29uZmlnUGF0aDtcbn1cblxuLyoqXG4gKiBJbmZvcm1hdGlvbiBvZiB0aGUgZGV2aWNlIHVuZGVyIHRlc3RcbiAqIEB0eXBlZGVmIHtPYmplY3R9IERldmljZUluZm9cbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBpc1JlYWxEZXZpY2UgLSBFcXVhbHMgdG8gdHJ1ZSBpZiB0aGUgY3VycmVudCBkZXZpY2UgaXMgYSByZWFsIGRldmljZVxuICogQHByb3BlcnR5IHtzdHJpbmd9IHVkaWQgLSBUaGUgZGV2aWNlIFVESUQuXG4gKiBAcHJvcGVydHkge3N0cmluZ30gcGxhdGZvcm1WZXJzaW9uIC0gVGhlIHBsYXRmb3JtIHZlcnNpb24gb2YgT1MuXG4qL1xuLyoqXG4gKiBDcmVhdGVzIHhjdGVzdHJ1biBmaWxlIHBlciBkZXZpY2UgJiBwbGF0Zm9ybSB2ZXJzaW9uLlxuICogV2UgZXhwZWN0cyB0byBoYXZlIFdlYkRyaXZlckFnZW50UnVubmVyX2lwaG9uZW9zJHtzZGtWZXJzaW9ufHBsYXRmb3JtVmVyc2lvbn0tYXJtNjQueGN0ZXN0cnVuIGZvciByZWFsIGRldmljZVxuICogYW5kIFdlYkRyaXZlckFnZW50UnVubmVyX2lwaG9uZXNpbXVsYXRvciR7c2RrVmVyc2lvbnxwbGF0Zm9ybVZlcnNpb259LXg4Nl82NC54Y3Rlc3RydW4gZm9yIHNpbXVsYXRvciBsb2NhdGVkIEBib290c3RyYXBQYXRoXG4gKiBOZXdlciBYY29kZSAoWGNvZGUgMTAuMCBhdCBsZWFzdCkgZ2VuZXJhdGUgeGN0ZXN0cnVuIGZpbGUgZm9sbG93aW5nIHNka1ZlcnNpb24uXG4gKiBlLmcuIFhjb2RlIHdoaWNoIGhhcyBpT1MgU0RLIFZlcnNpb24gMTIuMiBnZW5lcmF0ZSBXZWJEcml2ZXJBZ2VudFJ1bm5lcl9pcGhvbmVzaW11bGF0b3IuMi14ODZfNjQueGN0ZXN0cnVuXG4gKiAgICAgIGV2ZW4gaWYgdGhlIGNhcCBoYXMgcGxhdGZvcm0gdmVyc2lvbiAxMS40XG4gKlxuICogQHBhcmFtIHtEZXZpY2VJbmZvfVxuICogQHBhcmFtIHtzdHJpbmd9IHNka1ZlcnNpb24gLSBUaGUgWGNvZGUgU0RLIHZlcnNpb24gb2YgT1MuXG4gKiBAcGFyYW0ge3N0cmluZ30gYm9vdHN0cmFwUGF0aCAtIFRoZSBmb2xkZXIgcGF0aCBjb250YWluaW5nIHhjdGVzdHJ1biBmaWxlLlxuICogQHBhcmFtIHtzdHJpbmd9IHdkYVJlbW90ZVBvcnQgLSBUaGUgcmVtb3RlIHBvcnQgV0RBIGlzIGxpc3RlbmluZyBvbi5cbiAqIEByZXR1cm4ge3N0cmluZ30gcmV0dXJucyB4Y3Rlc3RydW5GaWxlUGF0aCBmb3IgZ2l2ZW4gZGV2aWNlXG4gKiBAdGhyb3dzIGlmIFdlYkRyaXZlckFnZW50UnVubmVyX2lwaG9uZW9zJHtzZGtWZXJzaW9ufHBsYXRmb3JtVmVyc2lvbn0tYXJtNjQueGN0ZXN0cnVuIGZvciByZWFsIGRldmljZVxuICogb3IgV2ViRHJpdmVyQWdlbnRSdW5uZXJfaXBob25lc2ltdWxhdG9yJHtzZGtWZXJzaW9ufHBsYXRmb3JtVmVyc2lvbn0teDg2XzY0LnhjdGVzdHJ1biBmb3Igc2ltdWxhdG9yIGlzIG5vdCBmb3VuZCBAYm9vdHN0cmFwUGF0aCxcbiAqIHRoZW4gaXQgd2lsbCB0aHJvdyBmaWxlIG5vdCBmb3VuZCBleGNlcHRpb25cbiAqL1xuYXN5bmMgZnVuY3Rpb24gc2V0WGN0ZXN0cnVuRmlsZSAoZGV2aWNlSW5mbywgc2RrVmVyc2lvbiwgYm9vdHN0cmFwUGF0aCwgd2RhUmVtb3RlUG9ydCkge1xuICBjb25zdCB4Y3Rlc3RydW5GaWxlUGF0aCA9IGF3YWl0IGdldFhjdGVzdHJ1bkZpbGVQYXRoKGRldmljZUluZm8sIHNka1ZlcnNpb24sIGJvb3RzdHJhcFBhdGgpO1xuICBjb25zdCB4Y3Rlc3RSdW5Db250ZW50ID0gYXdhaXQgcGxpc3QucGFyc2VQbGlzdEZpbGUoeGN0ZXN0cnVuRmlsZVBhdGgpO1xuICBjb25zdCB1cGRhdGVXREFQb3J0ID0ge1xuICAgIFdlYkRyaXZlckFnZW50UnVubmVyOiB7XG4gICAgICBFbnZpcm9ubWVudFZhcmlhYmxlczoge1xuICAgICAgICBVU0VfUE9SVDogd2RhUmVtb3RlUG9ydFxuICAgICAgfVxuICAgIH1cbiAgfTtcblxuICBjb25zdCBuZXdYY3Rlc3RSdW5Db250ZW50ID0gXy5tZXJnZSh4Y3Rlc3RSdW5Db250ZW50LCB1cGRhdGVXREFQb3J0KTtcbiAgYXdhaXQgcGxpc3QudXBkYXRlUGxpc3RGaWxlKHhjdGVzdHJ1bkZpbGVQYXRoLCBuZXdYY3Rlc3RSdW5Db250ZW50LCB0cnVlKTtcblxuICByZXR1cm4geGN0ZXN0cnVuRmlsZVBhdGg7XG59XG5cbi8qKlxuICogUmV0dXJuIHRoZSBwYXRoIG9mIHhjdGVzdHJ1biBpZiBpdCBleGlzdHNcbiAqIEBwYXJhbSB7RGV2aWNlSW5mb31cbiAqIEBwYXJhbSB7c3RyaW5nfSBzZGtWZXJzaW9uIC0gVGhlIFhjb2RlIFNESyB2ZXJzaW9uIG9mIE9TLlxuICogQHBhcmFtIHtzdHJpbmd9IGJvb3RzdHJhcFBhdGggLSBUaGUgZm9sZGVyIHBhdGggY29udGFpbmluZyB4Y3Rlc3RydW4gZmlsZS5cbiAqL1xuYXN5bmMgZnVuY3Rpb24gZ2V0WGN0ZXN0cnVuRmlsZVBhdGggKGRldmljZUluZm8sIHNka1ZlcnNpb24sIGJvb3RzdHJhcFBhdGgpIHtcbiAgLy8gRmlyc3QgdHJ5IHRoZSBTREsgcGF0aCwgZm9yIFhjb2RlIDEwIChhdCBsZWFzdClcbiAgY29uc3Qgc2RrQmFzZWQgPSBbXG4gICAgcGF0aC5yZXNvbHZlKGJvb3RzdHJhcFBhdGgsIGAke2RldmljZUluZm8udWRpZH1fJHtzZGtWZXJzaW9ufS54Y3Rlc3RydW5gKSxcbiAgICBzZGtWZXJzaW9uLFxuICBdO1xuICAvLyBOZXh0IHRyeSBQbGF0Zm9ybSBwYXRoLCBmb3IgZWFybGllciBYY29kZSB2ZXJzaW9uc1xuICBjb25zdCBwbGF0Zm9ybUJhc2VkID0gW1xuICAgIHBhdGgucmVzb2x2ZShib290c3RyYXBQYXRoLCBgJHtkZXZpY2VJbmZvLnVkaWR9XyR7ZGV2aWNlSW5mby5wbGF0Zm9ybVZlcnNpb259LnhjdGVzdHJ1bmApLFxuICAgIGRldmljZUluZm8ucGxhdGZvcm1WZXJzaW9uLFxuICBdO1xuXG4gIGZvciAoY29uc3QgW2ZpbGVQYXRoLCB2ZXJzaW9uXSBvZiBbc2RrQmFzZWQsIHBsYXRmb3JtQmFzZWRdKSB7XG4gICAgaWYgKGF3YWl0IGZzLmV4aXN0cyhmaWxlUGF0aCkpIHtcbiAgICAgIHJldHVybiBmaWxlUGF0aDtcbiAgICB9XG4gICAgY29uc3Qgb3JpZ2luYWxYY3Rlc3RydW5GaWxlID0gcGF0aC5yZXNvbHZlKGJvb3RzdHJhcFBhdGgsIGdldFhjdGVzdHJ1bkZpbGVQYXRoTmFtZShkZXZpY2VJbmZvLmlzUmVhbERldmljZSwgdmVyc2lvbikpO1xuICAgIGlmIChhd2FpdCBmcy5leGlzdHMob3JpZ2luYWxYY3Rlc3RydW5GaWxlKSkge1xuICAgICAgLy8gSWYgdGhpcyBpcyBmaXJzdCB0aW1lIHJ1biBmb3IgZ2l2ZW4gZGV2aWNlLCB0aGVuIGZpcnN0IGdlbmVyYXRlIHhjdGVzdHJ1biBmaWxlIGZvciBkZXZpY2UuXG4gICAgICAvLyBXZSBuZWVkIHRvIGhhdmUgYSB4Y3Rlc3RydW4gZmlsZSAqKnBlciBkZXZpY2UqKiBiZWNhdXNlIHdlIGNhbnQgbm90IGhhdmUgc2FtZSB3ZGEgcG9ydCBmb3IgYWxsIGRldmljZXMuXG4gICAgICBhd2FpdCBmcy5jb3B5RmlsZShvcmlnaW5hbFhjdGVzdHJ1bkZpbGUsIGZpbGVQYXRoKTtcbiAgICAgIHJldHVybiBmaWxlUGF0aDtcbiAgICB9XG4gIH1cblxuICBsb2cuZXJyb3JBbmRUaHJvdyhgSWYgeW91IGFyZSB1c2luZyAndXNlWGN0ZXN0cnVuRmlsZScgY2FwYWJpbGl0eSB0aGVuIHlvdSBgICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBgbmVlZCB0byBoYXZlIGEgeGN0ZXN0cnVuIGZpbGUgKGV4cGVjdGVkOiBgICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBgJyR7cGF0aC5yZXNvbHZlKGJvb3RzdHJhcFBhdGgsIGdldFhjdGVzdHJ1bkZpbGVQYXRoTmFtZShkZXZpY2VJbmZvLmlzUmVhbERldmljZSwgc2RrVmVyc2lvbikpfScpYCk7XG59XG5cbmZ1bmN0aW9uIGdldFhjdGVzdHJ1bkZpbGVQYXRoTmFtZSAoaXNSZWFsRGV2aWNlLCB2ZXJzaW9uKSB7XG4gIHJldHVybiBgV2ViRHJpdmVyQWdlbnRSdW5uZXJfaXBob25lJHtpc1JlYWxEZXZpY2UgPyBgb3Mke3ZlcnNpb259LWFybTY0YCA6IGBzaW11bGF0b3Ike3ZlcnNpb259LXg4Nl82NGB9LnhjdGVzdHJ1bmA7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGtpbGxQcm9jZXNzIChuYW1lLCBwcm9jKSB7XG4gIGlmIChwcm9jICYmIHByb2MucHJvYykge1xuICAgIGxvZy5pbmZvKGBTaHV0dGluZyBkb3duICR7bmFtZX0gcHJvY2VzcyAocGlkICR7cHJvYy5wcm9jLnBpZH0pYCk7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHByb2Muc3RvcCgnU0lHVEVSTScsIDEwMDApO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgaWYgKCFlcnIubWVzc2FnZS5pbmNsdWRlcyhgUHJvY2VzcyBkaWRuJ3QgZW5kIGFmdGVyYCkpIHtcbiAgICAgICAgdGhyb3cgZXJyO1xuICAgICAgfVxuICAgICAgbG9nLmRlYnVnKGAke25hbWV9IHByb2Nlc3MgZGlkIG5vdCBlbmQgaW4gYSB0aW1lbHkgZmFzaGlvbjogJyR7ZXJyLm1lc3NhZ2V9Jy4gYCArXG4gICAgICAgICAgICAgICAgYFNlbmRpbmcgJ1NJR0tJTEwnLi4uYCk7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCBwcm9jLnN0b3AoJ1NJR0tJTEwnKTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICBpZiAoZXJyLm1lc3NhZ2UuaW5jbHVkZXMoJ25vdCBjdXJyZW50bHkgcnVubmluZycpKSB7XG4gICAgICAgICAgLy8gdGhlIHByb2Nlc3MgZW5kZWQgYnV0IGZvciBzb21lIHJlYXNvbiB3ZSB3ZXJlIG5vdCBpbmZvcm1lZFxuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICB0aHJvdyBlcnI7XG4gICAgICB9XG4gICAgfVxuICB9XG59XG5cbi8qKlxuICogR2VuZXJhdGUgYSByYW5kb20gaW50ZWdlci5cbiAqXG4gKiBAcmV0dXJuIHtudW1iZXJ9IEEgcmFuZG9tIGludGVnZXIgbnVtYmVyIGluIHJhbmdlIFtsb3csIGhpZ2h0KS4gYGxvd2BgIGlzIGluY2x1c2l2ZSBhbmQgYGhpZ2hgIGlzIGV4Y2x1c2l2ZS5cbiAqL1xuZnVuY3Rpb24gcmFuZG9tSW50IChsb3csIGhpZ2gpIHtcbiAgcmV0dXJuIE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIChoaWdoIC0gbG93KSArIGxvdyk7XG59XG5cbi8qKlxuICogUmV0cmlldmVzIFdEQSB1cGdyYWRlIHRpbWVzdGFtcFxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBib290c3RyYXBQYXRoIFRoZSBmdWxsIHBhdGggdG8gdGhlIGZvbGRlciB3aGVyZSBXREEgc291cmNlIGlzIGxvY2F0ZWRcbiAqIEByZXR1cm4gez9udW1iZXJ9IFRoZSBVTklYIHRpbWVzdGFtcCBvZiB0aGUgY2FydGhhZ2Ugcm9vdCBmb2xkZXIsIHdoZXJlIGRlcGVuZGVuY2llcyBhcmUgZG93bmxvYWRlZC5cbiAqIFRoaXMgZm9sZGVyIGlzIGNyZWF0ZWQgb25seSBvbmNlIG9uIG1vZHVsZSB1cGdyYWRlL2ZpcnN0IGluc3RhbGwuXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIGdldFdEQVVwZ3JhZGVUaW1lc3RhbXAgKGJvb3RzdHJhcFBhdGgpIHtcbiAgY29uc3QgY2FydGhhZ2VSb290UGF0aCA9IHBhdGgucmVzb2x2ZShib290c3RyYXBQYXRoLCBDQVJUSEFHRV9ST09UKTtcbiAgaWYgKGF3YWl0IGZzLmV4aXN0cyhjYXJ0aGFnZVJvb3RQYXRoKSkge1xuICAgIGNvbnN0IHttdGltZX0gPSBhd2FpdCBmcy5zdGF0KGNhcnRoYWdlUm9vdFBhdGgpO1xuICAgIHJldHVybiBtdGltZS5nZXRUaW1lKCk7XG4gIH1cbiAgcmV0dXJuIG51bGw7XG59XG5cbmV4cG9ydCB7IHVwZGF0ZVByb2plY3RGaWxlLCByZXNldFByb2plY3RGaWxlLCBjaGVja0ZvckRlcGVuZGVuY2llcyxcbiAgc2V0UmVhbERldmljZVNlY3VyaXR5LCBmaXhGb3JYY29kZTcsIGZpeEZvclhjb2RlOSxcbiAgZ2VuZXJhdGVYY29kZUNvbmZpZ0ZpbGUsIHNldFhjdGVzdHJ1bkZpbGUsIGdldFhjdGVzdHJ1bkZpbGVQYXRoLFxuICBraWxsUHJvY2VzcywgcmFuZG9tSW50LCBXREFfUlVOTkVSX0JVTkRMRV9JRCwgZ2V0V0RBVXBncmFkZVRpbWVzdGFtcCB9O1xuIl0sImZpbGUiOiJsaWIvd2RhL3V0aWxzLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
