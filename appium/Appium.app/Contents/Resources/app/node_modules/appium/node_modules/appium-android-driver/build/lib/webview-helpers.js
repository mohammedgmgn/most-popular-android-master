"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.CHROMIUM_WIN = exports.WEBVIEW_BASE = exports.WEBVIEW_WIN = exports.NATIVE_WIN = exports.helpers = exports.default = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _logger = _interopRequireDefault(require("./logger"));

var _asyncbox = require("asyncbox");

const NATIVE_WIN = 'NATIVE_APP';
exports.NATIVE_WIN = NATIVE_WIN;
const WEBVIEW_WIN = 'WEBVIEW';
exports.WEBVIEW_WIN = WEBVIEW_WIN;
const WEBVIEW_BASE = `${WEBVIEW_WIN}_`;
exports.WEBVIEW_BASE = WEBVIEW_BASE;
const WEBVIEW_REGEXP = new RegExp(`@?webview_devtools_remote_(\\d+)`);
const WEBVIEW_PID_REGEXP = new RegExp(`${WEBVIEW_BASE}(\\d+)`);
const CHROMIUM_WIN = 'CHROMIUM';
exports.CHROMIUM_WIN = CHROMIUM_WIN;
const CROSSWALK_SOCKET_SUFFIX = '_devtools_remote';
const CROSSWALK_REGEXP_STRING = `(\\S*)${CROSSWALK_SOCKET_SUFFIX}`;
const CROSSWALK_REGEXP = new RegExp(`@${CROSSWALK_REGEXP_STRING}`);
const CROSSWALK_PROCESS_REGEXP = new RegExp(WEBVIEW_BASE + CROSSWALK_REGEXP_STRING);
let helpers = {};
exports.helpers = helpers;

async function webviewsFromProcs(adb, deviceSocket) {
  let webviews = [];
  let out = await adb.shell(['cat', '/proc/net/unix']);

  for (let line of out.split('\n')) {
    line = line.trim();

    if (deviceSocket) {
      if (line.indexOf(`@${deviceSocket}`) === line.length - deviceSocket.length - 1) {
        if (deviceSocket === 'chrome_devtools_remote') {
          webviews.push(CHROMIUM_WIN);
          continue;
        }
      }
    }

    let webviewPid;
    let crosswalkWebviewSocket;

    if (webviewPid = line.match(WEBVIEW_REGEXP)) {
      webviews.push(`${WEBVIEW_BASE}${webviewPid[1]}`);
    } else if (crosswalkWebviewSocket = line.match(CROSSWALK_REGEXP)) {
      if (deviceSocket) {
        if (crosswalkWebviewSocket[0].slice(1) === deviceSocket) {
          webviews.push(`${WEBVIEW_BASE}${crosswalkWebviewSocket[1]}`);
        }
      } else {
        webviews.push(`${WEBVIEW_BASE}${crosswalkWebviewSocket[1]}${CROSSWALK_SOCKET_SUFFIX}`);
      }
    }
  }

  return _lodash.default.uniq(webviews);
}

helpers.procFromWebview = async function (adb, webview) {
  if (webview.match(WEBVIEW_PID_REGEXP) === null) {
    let processName = webview.match(CROSSWALK_PROCESS_REGEXP);

    if (processName === null) {
      throw new Error(`Could not find process name for webview ${webview}`);
    }

    return processName[1];
  }

  let pid = webview.match(/\d+$/);

  if (!pid) {
    throw new Error(`Could not find PID for webview ${webview}`);
  }

  pid = pid[0];

  _logger.default.debug(`${webview} mapped to pid ${pid}`);

  _logger.default.debug('Getting process name for webview');

  let out = await adb.shell('ps');
  let pkg = 'unknown';
  let lines = out.split(/\r?\n/);
  const fullHeader = lines[0].trim();
  const header = fullHeader.split(/\s+/);
  const pidColumn = header.indexOf('PID');

  for (let line of lines) {
    const entries = line.trim().split(/\s+/);
    const pidEntry = entries[pidColumn];

    if (pidEntry === pid) {
      pkg = _lodash.default.last(entries);

      _logger.default.debug(`Parsed pid: '${pidEntry}' pkg: '${pkg}' from`);

      _logger.default.debug(`    ${fullHeader}`);

      _logger.default.debug(`    ${line}`);

      break;
    }
  }

  _logger.default.debug(`Returning process name: '${pkg}'`);

  return pkg;
};

helpers.getWebviews = async function (adb, deviceSocket) {
  _logger.default.debug('Getting a list of available webviews');

  let webviews = await webviewsFromProcs(adb, deviceSocket);

  if (deviceSocket) {
    return webviews;
  }

  webviews = await (0, _asyncbox.asyncmap)(webviews, async webviewName => {
    let pkg = await helpers.procFromWebview(adb, webviewName);
    return WEBVIEW_BASE + pkg;
  });

  _logger.default.debug(`Found webviews: ${JSON.stringify(webviews)}`);

  return webviews;
};

helpers.decorateChromeOptions = function (caps, opts, deviceId) {
  if (opts.chromeOptions) {
    if (opts.chromeOptions.Arguments) {
      opts.chromeOptions.args = [...(opts.chromeOptions.args || []), ...opts.chromeOptions.Arguments];
      delete opts.chromeOptions.Arguments;
    }

    for (let [opt, val] of _lodash.default.toPairs(opts.chromeOptions)) {
      if (_lodash.default.isUndefined(caps.chromeOptions[opt])) {
        caps.chromeOptions[opt] = val;
      } else {
        _logger.default.warn(`Cannot pass option ${caps.chromeOptions[opt]} because ` + 'Appium needs it to make chromeDriver work');
      }
    }
  }

  caps.chromeOptions.androidDeviceSerial = deviceId;
  return caps;
};

var _default = helpers;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi93ZWJ2aWV3LWhlbHBlcnMuanMiXSwibmFtZXMiOlsiTkFUSVZFX1dJTiIsIldFQlZJRVdfV0lOIiwiV0VCVklFV19CQVNFIiwiV0VCVklFV19SRUdFWFAiLCJSZWdFeHAiLCJXRUJWSUVXX1BJRF9SRUdFWFAiLCJDSFJPTUlVTV9XSU4iLCJDUk9TU1dBTEtfU09DS0VUX1NVRkZJWCIsIkNST1NTV0FMS19SRUdFWFBfU1RSSU5HIiwiQ1JPU1NXQUxLX1JFR0VYUCIsIkNST1NTV0FMS19QUk9DRVNTX1JFR0VYUCIsImhlbHBlcnMiLCJ3ZWJ2aWV3c0Zyb21Qcm9jcyIsImFkYiIsImRldmljZVNvY2tldCIsIndlYnZpZXdzIiwib3V0Iiwic2hlbGwiLCJsaW5lIiwic3BsaXQiLCJ0cmltIiwiaW5kZXhPZiIsImxlbmd0aCIsInB1c2giLCJ3ZWJ2aWV3UGlkIiwiY3Jvc3N3YWxrV2Vidmlld1NvY2tldCIsIm1hdGNoIiwic2xpY2UiLCJfIiwidW5pcSIsInByb2NGcm9tV2VidmlldyIsIndlYnZpZXciLCJwcm9jZXNzTmFtZSIsIkVycm9yIiwicGlkIiwibG9nZ2VyIiwiZGVidWciLCJwa2ciLCJsaW5lcyIsImZ1bGxIZWFkZXIiLCJoZWFkZXIiLCJwaWRDb2x1bW4iLCJlbnRyaWVzIiwicGlkRW50cnkiLCJsYXN0IiwiZ2V0V2Vidmlld3MiLCJ3ZWJ2aWV3TmFtZSIsIkpTT04iLCJzdHJpbmdpZnkiLCJkZWNvcmF0ZUNocm9tZU9wdGlvbnMiLCJjYXBzIiwib3B0cyIsImRldmljZUlkIiwiY2hyb21lT3B0aW9ucyIsIkFyZ3VtZW50cyIsImFyZ3MiLCJvcHQiLCJ2YWwiLCJ0b1BhaXJzIiwiaXNVbmRlZmluZWQiLCJ3YXJuIiwiYW5kcm9pZERldmljZVNlcmlhbCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFFQSxNQUFNQSxVQUFVLEdBQUcsWUFBbkI7O0FBQ0EsTUFBTUMsV0FBVyxHQUFHLFNBQXBCOztBQUNBLE1B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bUJFLElBQW5CLElBQTJCLEVBQS9CLENBQUQsRUFBcUMsR0FBR0osSUFBSSxDQUFDRSxhQUFMLENBQW1CQyxTQUEzRCxDQUExQjtBQUNBLGFBQU9ILElBQUksQ0FBQ0UsYUFBTCxDQUFtQkMsU0FBMUI7QUFDRDs7QUFDRCxTQUFLLElBQUksQ0FBQ0UsR0FBRCxFQUFNQyxHQUFOLENBQVQsSUFBdUI3QixnQkFBRThCLE9BQUYsQ0FBVVAsSUFBSSxDQUFDRSxhQUFmLENBQXZCLEVBQXNEO0FBQ3BELFVBQUl6QixnQkFBRStCLFdBQUYsQ0FBY1QsSUFBSSxDQUFDRyxhQUFMLENBQW1CRyxHQUFuQixDQUFkLENBQUosRUFBNEM7QUFDMUNOLFFBQUFBLElBQUksQ0FBQ0csYUFBTCxDQUFtQkcsR0FBbkIsSUFBMEJDLEdBQTFCO0FBQ0QsT0FGRCxNQUVPO0FBQ0x0Qix3QkFBT3lCLElBQVAsQ0FBYSxzQkFBcUJWLElBQUksQ0FBQ0csYUFBTCxDQUFtQkcsR0FBbkIsQ0FBd0IsV0FBOUMsR0FDQSwyQ0FEWjtBQUVEO0FBQ0Y7QUFDRjs7QUFHRE4sRUFBQUEsSUFBSSxDQUFDRyxhQUFMLENBQW1CUSxtQkFBbkIsR0FBeUNULFFBQXpDO0FBQ0EsU0FBT0YsSUFBUDtBQUNELENBckJEOztlQXVCZXZDLE8iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IGxvZ2dlciBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgeyBhc3luY21hcCB9IGZyb20gJ2FzeW5jYm94JztcblxuY29uc3QgTkFUSVZFX1dJTiA9ICdOQVRJVkVfQVBQJztcbmNvbnN0IFdFQlZJRVdfV0lOID0gJ1dFQlZJRVcnO1xuY29uc3QgV0VCVklFV19CQVNFID0gYCR7V0VCVklFV19XSU59X2A7XG5jb25zdCBXRUJWSUVXX1JFR0VYUCA9IG5ldyBSZWdFeHAoYEA/d2Vidmlld19kZXZ0b29sc19yZW1vdGVfKFxcXFxkKylgKTtcbmNvbnN0IFdFQlZJRVdfUElEX1JFR0VYUCA9IG5ldyBSZWdFeHAoYCR7V0VCVklFV19CQVNFfShcXFxcZCspYCk7XG5jb25zdCBDSFJPTUlVTV9XSU4gPSAnQ0hST01JVU0nO1xuY29uc3QgQ1JPU1NXQUxLX1NPQ0tFVF9TVUZGSVggPSAnX2RldnRvb2xzX3JlbW90ZSc7XG5jb25zdCBDUk9TU1dBTEtfUkVHRVhQX1NUUklORyA9IGAoXFxcXFMqKSR7Q1JPU1NXQUxLX1NPQ0tFVF9TVUZGSVh9YDtcbmNvbnN0IENST1NTV0FMS19SRUdFWFAgPSBuZXcgUmVnRXhwKGBAJHtDUk9TU1dBTEtfUkVHRVhQX1NUUklOR31gKTtcbmNvbnN0IENST1NTV0FMS19QUk9DRVNTX1JFR0VYUCA9IG5ldyBSZWdFeHAoV0VCVklFV19CQVNFICsgQ1JPU1NXQUxLX1JFR0VYUF9TVFJJTkcpO1xuXG5cbmxldCBoZWxwZXJzID0ge307XG5cbi8vIFRoaXMgZnVuY3Rpb24gZ2V0cyBhIGxpc3Qgb2YgYW5kcm9pZCBzeXN0ZW0gcHJvY2Vzc2VzIGFuZCByZXR1cm5zIG9uZXNcbi8vIHRoYXQgbG9vayBsaWtlIHdlYnZpZXdzLCB3aXRoIHRoZSBhcHByb3ByaWF0ZSB3ZWJ2aWV3IHByZWZpeCBhbmQgdGhlaXIgUElELlxuLy8gSWYgd2UgcGFzcyBpbiBhIGRldmljZVNvY2tldCwgd2Ugb25seSBhdHRlbXB0IHRvIGZpbmQgd2Vidmlld3Mgd2hpY2ggbWF0Y2hcbi8vIHRoYXQgc29ja2V0IG5hbWUgKHRoaXMgaXMgZm9yIGFwcHMgd2hpY2ggZW1iZWQgQ2hyb21pdW0sIHdoaWNoIGlzbid0IHRoZVxuLy8gc2FtZSBhcyBjaHJvbWUtYmFja2VkIHdlYnZpZXdzKVxuLy8gVE9ETzogc29tZSBvZiB0aGlzIGZ1bmN0aW9uIGJlbG9uZ3MgaW4gYXBwaXVtLWFkYlxuYXN5bmMgZnVuY3Rpb24gd2Vidmlld3NGcm9tUHJvY3MgKGFkYiwgZGV2aWNlU29ja2V0KSB7XG4gIGxldCB3ZWJ2aWV3cyA9IFtdO1xuICBsZXQgb3V0ID0gYXdhaXQgYWRiLnNoZWxsKFsnY2F0JywgJy9wcm9jL25ldC91bml4J10pO1xuICBmb3IgKGxldCBsaW5lIG9mIG91dC5zcGxpdCgnXFxuJykpIHtcbiAgICBsaW5lID0gbGluZS50cmltKCk7XG5cbiAgICBpZiAoZGV2aWNlU29ja2V0KSB7XG4gICAgICBpZiAobGluZS5pbmRleE9mKGBAJHtkZXZpY2VTb2NrZXR9YCkgPT09IGxpbmUubGVuZ3RoIC0gZGV2aWNlU29ja2V0Lmxlbmd0aCAtIDEpIHtcbiAgICAgICAgaWYgKGRldmljZVNvY2tldCA9PT0gJ2Nocm9tZV9kZXZ0b29sc19yZW1vdGUnKSB7XG4gICAgICAgICAgd2Vidmlld3MucHVzaChDSFJPTUlVTV9XSU4pO1xuICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgbGV0IHdlYnZpZXdQaWQ7XG4gICAgbGV0IGNyb3Nzd2Fsa1dlYnZpZXdTb2NrZXQ7XG4gICAgaWYgKCh3ZWJ2aWV3UGlkID0gbGluZS5tYXRjaChXRUJWSUVXX1JFR0VYUCkpKSB7XG4gICAgICAvLyBmb3IgbXVsdGlwbGUgd2Vidmlld3MgYSBsaXN0IG9mICdXRUJWSUVXXzxpbmRleD4nIHdpbGwgYmUgcmV0dXJuZWRcbiAgICAgIC8vIHdoZXJlIDxpbmRleD4gaXMgemVybyBiYXNlZCAoc2FtZSBpcyBpbiBzZWxlbmRyb2lkKVxuICAgICAgd2Vidmlld3MucHVzaChgJHtXRUJWSUVXX0JBU0V9JHt3ZWJ2aWV3UGlkWzFdfWApO1xuICAgIH0gZWxzZSBpZiAoKGNyb3Nzd2Fsa1dlYnZpZXdTb2NrZXQgPSBsaW5lLm1hdGNoKENST1NTV0FMS19SRUdFWFApKSkge1xuICAgICAgaWYgKGRldmljZVNvY2tldCkge1xuICAgICAgICBpZiAoY3Jvc3N3YWxrV2Vidmlld1NvY2tldFswXS5zbGljZSgxKSA9PT0gZGV2aWNlU29ja2V0KSB7XG4gICAgICAgICAgd2Vidmlld3MucHVzaChgJHtXRUJWSUVXX0JBU0V9JHtjcm9zc3dhbGtXZWJ2aWV3U29ja2V0WzFdfWApO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB3ZWJ2aWV3cy5wdXNoKGAke1dFQlZJRVdfQkFTRX0ke2Nyb3Nzd2Fsa1dlYnZpZXdTb2NrZXRbMV19JHtDUk9TU1dBTEtfU09DS0VUX1NVRkZJWH1gKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgcmV0dXJuIF8udW5pcSh3ZWJ2aWV3cyk7XG59XG5cbi8vIFRha2UgYSB3ZWJ2aWV3IG5hbWUgbGlrZSBXRUJWSUVXXzQyOTYgYW5kIHVzZSAnYWRiIHNoZWxsIHBzJyB0byBmaWd1cmUgb3V0XG4vLyB3aGljaCBhcHAgcGFja2FnZSBpcyBhc3NvY2lhdGVkIHdpdGggdGhhdCB3ZWJ2aWV3LiBPbmUgb2YgdGhlIHJlYXNvbnMgd2Vcbi8vIHdhbnQgdG8gZG8gdGhpcyBpcyB0byBtYWtlIHN1cmUgd2UncmUgbGlzdGluZyB3ZWJ2aWV3cyBmb3IgdGhlIGFjdHVhbCBBVVQsXG4vLyBub3Qgc29tZSBvdGhlciBydW5uaW5nIGFwcFxuLy8gVE9ETzogdGhpcyBzaG91bGQgYmUgY2FsbGVkIHByb2NGcm9tUGlkIGFuZCBleGlzdCBpbiBhcHBpdW0tYWRiXG5oZWxwZXJzLnByb2NGcm9tV2VidmlldyA9IGFzeW5jIGZ1bmN0aW9uIChhZGIsIHdlYnZpZXcpIHtcbiAgaWYgKHdlYnZpZXcubWF0Y2goV0VCVklFV19QSURfUkVHRVhQKSA9PT0gbnVsbCkge1xuICAgIGxldCBwcm9jZXNzTmFtZSA9IHdlYnZpZXcubWF0Y2goQ1JPU1NXQUxLX1BST0NFU1NfUkVHRVhQKTtcbiAgICBpZiAocHJvY2Vzc05hbWUgPT09IG51bGwpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgQ291bGQgbm90IGZpbmQgcHJvY2VzcyBuYW1lIGZvciB3ZWJ2aWV3ICR7d2Vidmlld31gKTtcbiAgICB9XG4gICAgcmV0dXJuIHByb2Nlc3NOYW1lWzFdO1xuICB9XG5cbiAgLy8gd2Vidmlld19kZXZ0b29sc19yZW1vdGVfNDI5NiA9PiA0Mjk2XG4gIGxldCBwaWQgPSB3ZWJ2aWV3Lm1hdGNoKC9cXGQrJC8pO1xuICBpZiAoIXBpZCkge1xuICAgIHRocm93IG5ldyBFcnJvcihgQ291bGQgbm90IGZpbmQgUElEIGZvciB3ZWJ2aWV3ICR7d2Vidmlld31gKTtcbiAgfVxuICBwaWQgPSBwaWRbMF07XG4gIGxvZ2dlci5kZWJ1ZyhgJHt3ZWJ2aWV3fSBtYXBwZWQgdG8gcGlkICR7cGlkfWApO1xuICBsb2dnZXIuZGVidWcoJ0dldHRpbmcgcHJvY2VzcyBuYW1lIGZvciB3ZWJ2aWV3Jyk7XG4gIGxldCBvdXQgPSBhd2FpdCBhZGIuc2hlbGwoJ3BzJyk7XG4gIGxldCBwa2cgPSAndW5rbm93bic7XG4gIGxldCBsaW5lcyA9IG91dC5zcGxpdCgvXFxyP1xcbi8pO1xuXG4gIC8qIE91dHB1dCBvZiBwcyBpcyBsaWtlOlxuICAgVVNFUiAgICAgICBQSUQgIFBQSUQgIFZTSVpFICBSU1MgICBXQ0hBTiAgICBQQyAgICAgICAgIE5BTUUgIF9vcl9cbiAgIFVTRVIgICAgICAgUElEICBQUElEICBWU1ogICAgUlNTICAgV0NIQU4gICAgQUREUiAgICAgUyBOQU1FXG4gICB1MF9hMTM2ICAgNjI0OCAgMTc5ICAgOTQ2MDAwIDQ4MTQ0IGZmZmZmZmZmIDQwMDU5MDNlIFIgY29tLmV4YW1wbGUudGVzdFxuICAgdTBfYTEzNiAgIDYyNDkgIDE3OSAgIDk0NjAwMCA0ODE0NCBmZmZmZmZmZiAgICAgICAgICBSIGNvbS5leGFtcGxlLnRlc3RcbiAgKi9cbiAgY29uc3QgZnVsbEhlYWRlciA9IGxpbmVzWzBdLnRyaW0oKTtcbiAgY29uc3QgaGVhZGVyID0gZnVsbEhlYWRlci5zcGxpdCgvXFxzKy8pO1xuICBjb25zdCBwaWRDb2x1bW4gPSBoZWFkZXIuaW5kZXhPZignUElEJyk7XG5cbiAgZm9yIChsZXQgbGluZSBvZiBsaW5lcykge1xuICAgIGNvbnN0IGVudHJpZXMgPSBsaW5lLnRyaW0oKS5zcGxpdCgvXFxzKy8pO1xuICAgIGNvbnN0IHBpZEVudHJ5ID0gZW50cmllc1twaWRDb2x1bW5dO1xuICAgIGlmIChwaWRFbnRyeSA9PT0gcGlkKSB7XG4gICAgICBwa2cgPSBfLmxhc3QoZW50cmllcyk7XG4gICAgICBsb2dnZXIuZGVidWcoYFBhcnNlZCBwaWQ6ICcke3BpZEVudHJ5fScgcGtnOiAnJHtwa2d9JyBmcm9tYCk7XG4gICAgICBsb2dnZXIuZGVidWcoYCAgICAke2Z1bGxIZWFkZXJ9YCk7XG4gICAgICBsb2dnZXIuZGVidWcoYCAgICAke2xpbmV9YCk7XG5cbiAgICAgIGJyZWFrO1xuICAgIH1cbiAgfVxuXG4gIGxvZ2dlci5kZWJ1ZyhgUmV0dXJuaW5nIHByb2Nlc3MgbmFtZTogJyR7cGtnfSdgKTtcbiAgcmV0dXJuIHBrZztcbn07XG5cbi8vIEdldCBhIGxpc3Qgb2YgYXZhaWxhYmxlIHdlYnZpZXdzIGJ5IGludHJvc3BlY3RpbmcgcHJvY2Vzc2VzIHdpdGggYWRiLCB3aGVyZVxuLy8gd2Vidmlld3MgYXJlIGxpc3RlZC4gSXQncyBwb3NzaWJsZSB0byBwYXNzIGluIGEgJ2RldmljZVNvY2tldCcgYXJnLCB3aGljaFxuLy8gbGltaXRzIHRoZSB3ZWJ2aWV3IHBvc3NpYmlsaXRpZXMgdG8gdGhlIG9uZSBydW5uaW5nIG9uIHRoZSBDaHJvbWl1bSBkZXZ0b29sc1xuLy8gc29ja2V0IHdlJ3JlIGludGVyZXN0ZWQgaW4gKHNlZSBub3RlIG9uIHdlYnZpZXdzRnJvbVByb2NzKVxuaGVscGVycy5nZXRXZWJ2aWV3cyA9IGFzeW5jIGZ1bmN0aW9uIChhZGIsIGRldmljZVNvY2tldCkge1xuICBsb2dnZXIuZGVidWcoJ0dldHRpbmcgYSBsaXN0IG9mIGF2YWlsYWJsZSB3ZWJ2aWV3cycpO1xuICBsZXQgd2Vidmlld3MgPSBhd2FpdCB3ZWJ2aWV3c0Zyb21Qcm9jcyhhZGIsIGRldmljZVNvY2tldCk7XG5cbiAgaWYgKGRldmljZVNvY2tldCkge1xuICAgIHJldHVybiB3ZWJ2aWV3cztcbiAgfVxuXG4gIHdlYnZpZXdzID0gYXdhaXQgYXN5bmNtYXAod2Vidmlld3MsIGFzeW5jICh3ZWJ2aWV3TmFtZSkgPT4ge1xuICAgIGxldCBwa2cgPSBhd2FpdCBoZWxwZXJzLnByb2NGcm9tV2VidmlldyhhZGIsIHdlYnZpZXdOYW1lKTtcbiAgICByZXR1cm4gV0VCVklFV19CQVNFICsgcGtnO1xuICB9KTtcbiAgbG9nZ2VyLmRlYnVnKGBGb3VuZCB3ZWJ2aWV3czogJHtKU09OLnN0cmluZ2lmeSh3ZWJ2aWV3cyl9YCk7XG4gIHJldHVybiB3ZWJ2aWV3cztcbn07XG5cbmhlbHBlcnMuZGVjb3JhdGVDaHJvbWVPcHRpb25zID0gZnVuY3Rpb24gKGNhcHMsIG9wdHMsIGRldmljZUlkKSB7XG4gIC8vIGFkZCBvcHRpb25zIGZyb20gYXBwaXVtIHNlc3Npb24gY2Fwc1xuICBpZiAob3B0cy5jaHJvbWVPcHRpb25zKSB7XG4gICAgaWYgKG9wdHMuY2hyb21lT3B0aW9ucy5Bcmd1bWVudHMpIHtcbiAgICAgIC8vIG1lcmdlIGBBcmd1bWVudHNgIGFuZCBgYXJnc2BcbiAgICAgIG9wdHMuY2hyb21lT3B0aW9ucy5hcmdzID0gWy4uLihvcHRzLmNocm9tZU9wdGlvbnMuYXJncyB8fCBbXSksIC4uLm9wdHMuY2hyb21lT3B0aW9ucy5Bcmd1bWVudHNdO1xuICAgICAgZGVsZXRlIG9wdHMuY2hyb21lT3B0aW9ucy5Bcmd1bWVudHM7XG4gICAgfVxuICAgIGZvciAobGV0IFtvcHQsIHZhbF0gb2YgXy50b1BhaXJzKG9wdHMuY2hyb21lT3B0aW9ucykpIHtcbiAgICAgIGlmIChfLmlzVW5kZWZpbmVkKGNhcHMuY2hyb21lT3B0aW9uc1tvcHRdKSkge1xuICAgICAgICBjYXBzLmNocm9tZU9wdGlvbnNbb3B0XSA9IHZhbDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGxvZ2dlci53YXJuKGBDYW5ub3QgcGFzcyBvcHRpb24gJHtjYXBzLmNocm9tZU9wdGlvbnNbb3B0XX0gYmVjYXVzZSBgICtcbiAgICAgICAgICAgICAgICAgICAgJ0FwcGl1bSBuZWVkcyBpdCB0byBtYWtlIGNocm9tZURyaXZlciB3b3JrJyk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgLy8gYWRkIGRldmljZSBpZCBmcm9tIGFkYlxuICBjYXBzLmNocm9tZU9wdGlvbnMuYW5kcm9pZERldmljZVNlcmlhbCA9IGRldmljZUlkO1xuICByZXR1cm4gY2Fwcztcbn07XG5cbmV4cG9ydCBkZWZhdWx0IGhlbHBlcnM7XG5leHBvcnQgeyBoZWxwZXJzLCBOQVRJVkVfV0lOLCBXRUJWSUVXX1dJTiwgV0VCVklFV19CQVNFLCBDSFJPTUlVTV9XSU4gfTtcbiJdLCJmaWxlIjoibGliL3dlYnZpZXctaGVscGVycy5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLiJ9
